<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SUAN KHANOM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
 <style>
  :root {
    --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --bg-gradient: linear-gradient(135deg, #fdfbf7 0%, #fff1eb 100%);
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-border: 1px solid rgba(255, 255, 255, 0.5);
  }

  body {
    font-family: "Prompt", sans-serif;
    background: var(--bg-gradient);
    min-height: 100vh;
    color: #334155;
    -webkit-tap-highlight-color: transparent; /* ‡∏•‡∏ö‡∏™‡∏µ highlight ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
  }

  /* Smooth Transitions */
  * { transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }

  /* Glassmorphism Header */
  .glass {
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: var(--glass-border);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
  }

  /* Cards */
  .card {
    background: white;
    border-radius: 24px;
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
    border: 1px solid rgba(241, 245, 249, 0.8);
  }

  .hover-lift:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
  }

  /* Menu Cards */
  .menu-card {
    background: white;
    border-radius: 20px;
    border: 2px solid transparent;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .menu-card:hover {
    border-color: #e0e7ff;
    transform: translateY(-4px);
    box-shadow: 0 12px 25px rgba(99, 102, 241, 0.1);
  }

  .menu-card.selected {
    border-color: #6366f1;
    background: #eef2ff;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    transform: scale(1.02);
  }

  .menu-card .check-icon {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #6366f1;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    opacity: 0;
    transform: scale(0);
    transition: all 0.2s ease;
  }

  .menu-card.selected .check-icon {
    opacity: 1;
    transform: scale(1);
  }

  /* Buttons */
  .btn-primary {
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: 16px;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
  }

  .btn-primary:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
  }

  .btn-primary:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }

  .btn-secondary {
    background: white;
    color: #475569;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    font-weight: 500;
  }
  
  .btn-secondary:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
  }

  /* Quantity Buttons */
  .quantity-btn {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }

  /* Toggle Switch */
  .toggle-checkbox:checked {
    right: 0;
    border-color: #68D391;
  }
  .toggle-checkbox:checked + .toggle-label {
    background-color: #68D391;
  }

  /* Animations */
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
  }
  .float { animation: float 4s ease-in-out infinite; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in { animation: fadeIn 0.4s ease-out forwards; }

  /* Loading */
  .loading-screen {
    position: fixed;
    inset: 0;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  
  .loader {
    width: 48px;
    height: 48px;
    border: 5px solid #e0e7ff;
    border-bottom-color: #6366f1;
    border-radius: 50%;
    animation: rotation 1s linear infinite;
  }

  @keyframes rotation {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Scrollbar - Custom Styling */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

  /* Hide scrollbar for horizontal scroll areas on mobile */
  .no-scrollbar::-webkit-scrollbar {
      display: none;
  }
  .no-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
  }

  /* Logo Image */
  .logo-image {
    width: 6rem;
    height: 6rem;
    border-radius: 50%;
    object-fit: cover;
    background: white;
    padding: 4px;
    border: 2px solid white;
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
  }
  @media (min-width: 640px) {
    .logo-image { width: 8rem; height: 8rem; }
  }

  /* Responsive Grid */
  .custom-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* Mobile: 2 columns */
    gap: 0.75rem;
  }
  @media (min-width: 640px) { /* SM */
    .custom-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
  }
  @media (min-width: 1024px) { /* LG */
    .custom-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
    }
  }

  /* Overlay */
  .shop-closed-overlay {
    backdrop-filter: blur(8px);
    background: rgba(15, 23, 42, 0.8);
  }
</style>

</head>
<body class="min-h-full pb-28 md:pb-10">
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen flex-col gap-4">
    <div class="loader"></div>
    <p class="text-slate-500 font-medium animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô...</p>
  </div>

  <!-- Shop Closed Overlay -->
  <div id="shop-closed-overlay" class="shop-closed-overlay fixed inset-0 flex items-center justify-center z-[60] hidden p-4">
    <div class="bg-white rounded-3xl p-8 max-w-sm text-center shadow-2xl animate-[fadeIn_0.3s_ease-out]">
      <div class="text-6xl mb-4 animate-bounce">üò¥</div>
      <h3 class="text-2xl font-bold text-slate-800 mb-2">‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
      <p class="text-slate-500 mb-6">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß<br>‡πÑ‡∏ß‡πâ‡∏°‡∏≤‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
      <button onclick="closeShopClosedOverlay()" class="w-full btn-primary py-3 rounded-xl font-medium">
        ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö
      </button>
    </div>
  </div>

<header id="main-header" class="glass sticky top-0 z-40 hidden transition-all duration-300">
  <div class="max-w-7xl mx-auto px-4 py-3">
    <div class="flex items-center justify-between gap-3">

      <!-- Left: Brand & Points -->
      <div class="flex items-center gap-3">
         <div class="bg-gradient-to-br from-amber-400 to-orange-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md flex-shrink-0">
           <i class="fa-solid fa-coins text-lg"></i>
         </div>
         <div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">My Points</div>
            <div class="font-bold text-slate-800 leading-tight">
              <span id="userPoints" class="text-orange-500 text-lg">0</span> ‡πÅ‡∏ï‡πâ‡∏°
            </div>
         </div>
      </div>

      <!-- Right: Actions -->
      <div class="flex items-center gap-2">
        <!-- Rewards -->
        <button onclick="showRewards()" class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center hover:bg-purple-200 transition" title="‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•">
          <i class="fa-solid fa-gift text-lg"></i>
        </button>

        <!-- History -->
        <button onclick="openOrderHistory()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 transition" title="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠">
          <i class="fa-solid fa-clock-rotate-left text-lg"></i>
        </button>

        <!-- Cart -->
        <button onclick="showCart()" class="relative w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center hover:bg-indigo-200 transition" title="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
          <i class="fa-solid fa-cart-shopping text-lg"></i>
          <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center border-2 border-white hidden transform scale-100 transition-transform">0</span>
        </button>

        <!-- Profile Pic (Hidden on very small screens if needed, but good to keep) -->
        <div class="pl-2 border-l border-slate-200 ml-1 hidden sm:block">
          <img id="userPic" src="" alt="Profile" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover bg-slate-200" />
        </div>
      </div>
    </div>
    
    <!-- Admin Button (Hidden by default, shown if admin) -->
    <div id="admin-container" class="mt-2 text-right hidden">
       <button id="admin-btn" onclick="showAdmin()" class="text-xs bg-slate-800 text-white px-3 py-1 rounded-full hover:bg-slate-700 transition-all shadow-lg transform hover:scale-105">
         <i class="fa-solid fa-user-gear mr-1"></i> Admin Panel
       </button>
    </div>
  </div>
</header>

<main id="main-app" class="max-w-5xl w-full mx-auto px-4 py-6 hidden fade-in">
  
  <!-- Hero Section -->
  <div class="text-center mb-8 sm:mb-10 relative">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 sm:w-64 sm:h-64 bg-indigo-500/10 rounded-full blur-3xl -z-10"></div>
    <img src="https://i.postimg.cc/8PwWyXdd/s-thxng-thangkar-re-ybng-ay-w-np-ym-ha-rach-Instagram-phost-1.png" 
         alt="SUAN KHANOM Logo" 
         class="logo-image mx-auto mb-4 float" />
    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-2 tracking-tight text-slate-800">
      SUAN KHANOM
    </h1>
    <p class="text-slate-500 font-medium text-sm sm:text-base">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡πâ</p>
  </div>

  <!-- Step 1: Select Dessert -->
  <section id="dessert-selection" class="mb-10">
    <div class="flex items-center gap-3 mb-4 sm:mb-6">
      <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm shadow-md">1</div>
      <h2 class="text-lg sm:text-xl font-bold text-slate-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°</h2>
    </div>
    <div id="dessert-list" class="custom-grid"></div>
  </section>

  <!-- Step 2: Customization (Hidden initially) -->
  <section id="menu-selection" class="mb-24 hidden animate-[fadeIn_0.5s_ease-out]">
    <div class="flex items-center gap-3 mb-4 sm:mb-6">
      <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm shadow-md">2</div>
      <h2 class="text-lg sm:text-xl font-bold text-slate-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</h2>
    </div>

    <div class="grid md:grid-cols-2 gap-6 sm:gap-8 mb-8">
      <!-- Base Selection -->
      <div class="bg-white/60 p-4 rounded-3xl border border-white shadow-sm">
        <h3 class="text-base sm:text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2">
          <i class="fa-solid fa-layer-group text-indigo-500"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ (Base)
        </h3>
        <div id="base-list" class="custom-grid"></div>
      </div>

      <!-- Topping Selection -->
      <div class="bg-white/60 p-4 rounded-3xl border border-white shadow-sm">
        <h3 class="text-base sm:text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2">
          <i class="fa-solid fa-ice-cream text-pink-500"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (Topping)
        </h3>
        <div id="topping-list" class="custom-grid"></div>
      </div>
    </div>
  </section>
  
  <!-- Floating Bottom Bar for Action (Mobile First) -->
  <div id="action-bar" class="fixed bottom-0 left-0 right-0 p-3 sm:p-4 z-30 bg-white/95 backdrop-blur-md border-t border-slate-200 hidden shadow-[0_-10px_40px_rgba(0,0,0,0.1)] transition-transform duration-300 translate-y-full pb-safe">
    <div class="max-w-5xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-3 sm:gap-4">
      
      <!-- Quantity Control -->
      <div class="flex items-center gap-4 sm:gap-6 bg-slate-50 rounded-2xl p-1.5 sm:p-2 border border-slate-100 w-full sm:w-auto justify-center">
        <button onclick="changeQuantity(-1)" class="quantity-btn bg-white text-red-500 hover:bg-red-50 hover:text-red-600 active:scale-95 transition-transform border border-slate-200 shadow-sm">
          <i class="fa-solid fa-minus"></i>
        </button>
        <div class="text-center min-w-[3rem]">
          <div class="text-xl sm:text-2xl font-bold text-slate-800" id="quantity">1</div>
          <div class="text-[10px] text-slate-400 font-medium">‡∏ä‡∏¥‡πâ‡∏ô</div>
        </div>
        <button onclick="changeQuantity(1)" class="quantity-btn bg-white text-green-500 hover:bg-green-50 hover:text-green-600 active:scale-95 transition-transform border border-slate-200 shadow-sm">
          <i class="fa-solid fa-plus"></i>
        </button>
      </div>

      <!-- Total & Add Button -->
      <div class="flex items-center gap-3 sm:gap-4 w-full sm:w-auto">
        <div class="text-right hidden sm:block min-w-[100px]">
          <div class="text-xs text-slate-400 font-medium">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</div>
          <div class="text-xl font-bold text-indigo-600"><span id="total-price">0</span> ‡∏ö‡∏≤‡∏ó</div>
        </div>
        
        <button id="add-to-cart" onclick="addToCart()" class="btn-primary flex-1 sm:flex-none py-3 sm:py-4 px-6 sm:px-8 rounded-2xl flex items-center justify-center gap-3 text-base sm:text-lg disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto shadow-lg shadow-indigo-200/50">
          <span class="sm:hidden font-bold mr-auto"><span id="mobile-total-price">0</span> ‡∏ø</span>
          <span class="font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
          <i class="fa-solid fa-cart-plus"></i>
        </button>
      </div>
    </div>
  </div>

</main>

  <!-- Order History View -->
  <section id="order-history" class="hidden min-h-screen bg-slate-50 px-4 py-8 pb-20">
    <div class="max-w-4xl mx-auto">
      <div class="flex items-center gap-4 mb-8">
        <button onclick="backToMain()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center hover:bg-slate-100 shadow-sm transition">
          <i class="fa-solid fa-arrow-left text-slate-600"></i>
        </button>
        <h2 class="text-xl sm:text-2xl font-bold text-slate-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
      </div>
      <div id="order-list" class="space-y-4"></div>
    </div>
  </section>

  <!-- Global Modal Backdrop -->
  <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 transition-opacity opacity-0" aria-hidden="true"></div>

  <!-- Rewards Modal -->
  <div id="rewards-modal" class="fixed inset-0 z-[51] hidden flex items-end sm:items-center justify-center pointer-events-none">
    <div class="bg-white w-full max-w-lg h-[90vh] sm:h-auto sm:max-h-[85vh] sm:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden flex flex-col pointer-events-auto transform translate-y-full transition-transform duration-300">
      
      <!-- Modal Header -->
      <div class="p-5 sm:p-6 border-b border-slate-100 flex items-center justify-between bg-white sticky top-0 z-10">
        <h3 class="text-lg sm:text-xl font-bold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-gift text-purple-500"></i> ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
        </h3>
        <button onclick="closeRewards()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition">
          <i class="fa-solid fa-xmark text-slate-500"></i>
        </button>
      </div>
      
      <!-- Modal Content -->
      <div class="p-5 sm:p-6 overflow-y-auto custom-scrollbar">
        <!-- Points Card -->
        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-5 sm:p-6 text-white mb-6 shadow-lg relative overflow-hidden">
          <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
          <div class="relative z-10">
            <div class="text-sm font-medium opacity-90 mb-1">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div class="text-3xl sm:text-4xl font-bold tracking-tight"><span id="modal-user-points">0</span> <span class="text-lg font-normal">‡πÅ‡∏ï‡πâ‡∏°</span></div>
          </div>
        </div>

        <button onclick="showMyCoupons()" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 py-3 rounded-xl font-semibold mb-6 border border-indigo-200 transition flex items-center justify-center gap-2 shadow-sm">
          <i class="fa-solid fa-ticket"></i> ‡∏î‡∏π‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
        </button>

        <h4 class="font-bold text-slate-800 mb-4 border-l-4 border-purple-500 pl-3">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÑ‡∏î‡πâ</h4>
        <div id="rewards-content" class="grid grid-cols-1 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- My Coupons Modal -->
  <div id="my-coupons-modal" class="fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center pointer-events-none">
    <div class="bg-white w-full max-w-lg h-[85vh] sm:h-[80vh] sm:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden flex flex-col pointer-events-auto transform translate-y-full transition-transform duration-300">
      <div class="p-5 sm:p-6 border-b border-slate-100 flex items-center justify-between bg-white">
        <h3 class="text-lg sm:text-xl font-bold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-ticket text-indigo-500"></i> ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
        </h3>
        <button onclick="closeMyCoupons()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition">
          <i class="fa-solid fa-xmark text-slate-500"></i>
        </button>
      </div>
      <div id="my-coupons-content" class="p-5 sm:p-6 overflow-y-auto custom-scrollbar grid grid-cols-1 gap-3"></div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 z-[55] hidden flex items-end sm:items-center justify-center pointer-events-none">
    <div class="bg-white w-full max-w-2xl h-[95vh] sm:h-auto sm:max-h-[85vh] sm:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden flex flex-col pointer-events-auto transform translate-y-full transition-transform duration-300">
      
      <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-white z-10">
        <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-basket-shopping text-orange-500"></i> ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </h3>
        <button onclick="closeCart()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition">
          <i class="fa-solid fa-xmark text-slate-500"></i>
        </button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-5 custom-scrollbar">
        <div id="cart-content" class="space-y-4 mb-6"></div>
        
        <!-- Coupon Section -->
        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-4">
          <div class="flex justify-between items-center mb-3">
            <span class="text-sm font-semibold text-slate-700"><i class="fa-solid fa-tag mr-1"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î / ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</span>
            <button onclick="showMyCouponsForCart()" class="text-xs text-indigo-600 font-medium hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ</button>
          </div>
          
          <div id="selected-coupon" class="hidden bg-white border border-indigo-200 rounded-xl p-3 mb-3 flex items-center justify-between shadow-sm">
             <div class="flex items-center gap-3">
               <div class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-full flex items-center justify-center">
                 <i class="fa-solid fa-check"></i>
               </div>
               <div>
                 <div class="text-sm font-bold text-indigo-900" id="coupon-name"></div>
                 <div class="text-xs text-indigo-500" id="coupon-desc"></div>
               </div>
             </div>
             <button onclick="removeCoupon()" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
          </div>

          <div class="flex gap-2">
            <input type="text" id="coupon-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" class="flex-1 px-4 py-2 rounded-xl border border-slate-300 text-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
            <button onclick="applyCouponCode()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-slate-700 transition">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
          </div>
          <div id="coupon-message" class="hidden mt-2 text-xs font-medium"></div>
        </div>

        <!-- Delivery Date -->
        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 mb-4">
          <h4 class="text-sm font-semibold text-blue-900 mb-2"><i class="fa-solid fa-truck-fast mr-1"></i> ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h4>
          <select id="delivery-date" class="w-full p-2.5 rounded-xl border-blue-200 text-sm text-slate-700 focus:ring-2 focus:ring-blue-300 outline-none bg-white">
            <option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á...</option>
          </select>
          <div id="delivery-message" class="hidden mt-2 text-xs text-red-500 font-medium"></div>
        </div>
      </div>

      <!-- Footer Summary -->
      <div class="p-5 border-t border-slate-100 bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-10">
        <div class="space-y-2 mb-4">
          <div class="flex justify-between text-slate-500 text-sm">
            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            <span id="cart-subtotal" class="font-medium">0 ‡∏ø</span>
          </div>
          <div id="discount-row" class="flex justify-between text-green-600 text-sm hidden">
            <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
            <span id="discount-amount">-0 ‡∏ø</span>
          </div>
          <div class="flex justify-between items-end pt-2">
            <span class="font-bold text-slate-800">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
            <span id="cart-total" class="text-2xl font-bold text-indigo-600">0 ‡∏ø</span>
          </div>
        </div>
        <button onclick="checkout()" class="btn-primary w-full py-4 rounded-xl font-bold text-lg shadow-lg shadow-indigo-200 active:scale-95 transition-transform">
          ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        </button>
      </div>
    </div>
  </div>

  <!-- Coupon History Modal -->
  <div id="coupon-history-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl flex flex-col max-h-[80vh]">
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
        <h3 class="text-lg font-bold text-slate-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h3>
        <button onclick="toggleModal('coupon-history-modal', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="mb-2">
          <span class="text-xs text-slate-500">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á:</span> <span id="history-coupon-code" class="font-bold text-indigo-600"></span>
      </div>
      <div id="coupon-history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-3">
         <!-- User list -->
      </div>
    </div>
  </div>

  <!-- Admin Modal (Full Screen) -->
  <div id="admin-modal" class="fixed inset-0 z-[70] hidden bg-white overflow-hidden flex flex-col">
    <div class="bg-slate-900 text-white px-4 py-3 md:py-4 flex justify-between items-center shadow-md shrink-0">
       <h3 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-gauge-high"></i> <span class="hidden xs:inline">Admin Dashboard</span><span class="inline xs:hidden">Admin</span></h3>
       <button onclick="closeAdmin()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition">
         <i class="fa-solid fa-xmark"></i>
       </button>
    </div>
    
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
      <!-- Sidebar (Responsive: Side on MD+, Top Horizontal on Mobile) -->
      <nav class="w-full md:w-64 bg-slate-50 border-b md:border-b-0 md:border-r border-slate-200 flex-shrink-0 overflow-x-auto md:overflow-y-auto flex md:flex-col p-2 md:p-4 gap-2 no-scrollbar h-auto md:h-full">
          <!-- Shop status tab restored -->
          <button onclick="showAdminTab('shop-status')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="shop-status">
            <i class="fa-solid fa-store w-5 text-center"></i> <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô</span>
          </button>
          <button onclick="showAdminTab('delivery')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="delivery">
            <i class="fa-solid fa-calendar-days w-5 text-center"></i> <span>‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>
          </button>
          <button onclick="showAdminTab('orders')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="orders">
            <i class="fa-solid fa-box-open w-5 text-center"></i> <span>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
          </button>
          <button onclick="showAdminTab('users')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="users">
            <i class="fa-solid fa-users w-5 text-center"></i> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
          </button>
          <button onclick="showAdminTab('summary')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="summary">
            <i class="fa-solid fa-chart-pie w-5 text-center"></i> <span>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</span>
          </button>
           <div class="border-l md:border-l-0 md:border-t border-slate-200 mx-2 md:mx-0 my-0 md:my-2 h-6 md:h-0 flex-shrink-0"></div>
          <button onclick="showAdminTab('desserts')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="desserts">
            <i class="fa-solid fa-utensils w-5 text-center"></i> <span>‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°</span>
          </button>
          <button onclick="showAdminTab('brownie')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="brownie">
            <i class="fa-solid fa-layer-group w-5 text-center"></i> <span>‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</span>
          </button>
          <div class="border-l md:border-l-0 md:border-t border-slate-200 mx-2 md:mx-0 my-0 md:my-2 h-6 md:h-0 flex-shrink-0"></div>
          <button onclick="showAdminTab('rewards')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="rewards">
            <i class="fa-solid fa-gift w-5 text-center"></i> <span>‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>
          </button>
          <button onclick="showAdminTab('coupons')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="coupons">
            <i class="fa-solid fa-ticket w-5 text-center"></i> <span>‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</span>
          </button>
          <button onclick="showAdminTab('stats')" class="admin-nav-btn w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl text-xs md:text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition flex items-center gap-2 md:gap-3 whitespace-nowrap flex-shrink-0" data-tab="stats">
            <i class="fa-solid fa-chart-line w-5 text-center"></i> <span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
          </button>
      </nav>

      <!-- Main Admin Content -->
      <main class="flex-1 overflow-y-auto p-4 sm:p-8 bg-slate-50 custom-scrollbar">
        <!-- Shop status content restored -->
        <section id="admin-shop-status-tab" class="admin-tab-content h-full flex flex-col items-center justify-center text-center">
            <div class="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full border border-slate-100">
               <div class="text-7xl mb-6 transition-transform hover:scale-110 duration-300 cursor-default" id="shop-status-icon"></div>
               <h3 class="text-2xl font-bold text-slate-800 mb-2" id="shop-status-text">...</h3>
               <p class="text-slate-500 mb-8 text-sm">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</p>
               <button id="toggle-shop-btn" onclick="toggleShopStatus()" class="w-full py-3 rounded-xl font-bold text-lg shadow-lg transition-all"></button>
            </div>
        </section>

        <!-- New Delivery Management Tab -->
        <div id="admin-delivery-tab" class="admin-tab-content hidden">
           <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
              <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2">
                 <i class="fa-solid fa-calendar-check text-indigo-600"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (Delivery Rounds)
              </h3>
              <p class="text-sm text-slate-500 mb-6">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå, ‡∏û‡∏∏‡∏ò, ‡∏®‡∏∏‡∏Å‡∏£‡πå)</p>
              
              <div id="delivery-rounds-list" class="space-y-3">
                 <!-- Generated rounds will be here -->
                 <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-4 py-1">
                      <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                      <div class="space-y-2">
                        <div class="h-4 bg-slate-200 rounded"></div>
                        <div class="h-4 bg-slate-200 rounded w-5/6"></div>
                      </div>
                    </div>
                 </div>
              </div>
           </div>
        </div>

        <div id="admin-orders-tab" class="admin-tab-content hidden space-y-4">
           <div class="flex flex-wrap gap-3 bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-0 z-10">
              <input type="date" id="admin-order-date" class="border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
              <input type="text" id="admin-order-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå..." class="flex-1 min-w-[200px] border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
              <button onclick="filterAdminOrders()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 shadow-md">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              <button onclick="clearOrderFilters()" class="text-slate-500 hover:text-slate-700 px-3 py-2 text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
           </div>
           <div id="admin-orders-content" class="grid gap-4"></div>
        </div>

        <div id="admin-users-tab" class="admin-tab-content hidden">
           <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                 <i class="fa-solid fa-users text-blue-600"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
              </h3>
              <div class="flex gap-3 mb-6">
                 <input type="text" id="admin-user-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." class="border border-slate-300 rounded-lg px-3 py-2 text-sm w-full max-w-sm focus:ring-2 focus:ring-blue-500 outline-none">
                 <button onclick="filterAdminUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              </div>
              <div id="admin-users-list" class="grid gap-4 grid-cols-1 lg:grid-cols-2">
                 <!-- User list here -->
              </div>
           </div>
        </div>

        <div id="admin-summary-tab" class="admin-tab-content hidden">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
             <h3 class="text-lg font-bold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
             <div class="flex flex-wrap gap-3 mb-6">
                <div class="flex flex-col">
                    <label class="text-xs text-slate-500 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
                    <select id="summary-delivery-round" class="border border-slate-300 rounded-lg px-3 py-2 text-sm min-w-[200px]">
                        <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label class="text-xs text-slate-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)</label>
                    <select id="summary-status" class="border border-slate-300 rounded-lg px-3 py-2 text-sm">
                       <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)</option>
                       <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                       <option value="preparing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                       <option value="ready">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
                       <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    </select>
                </div>
                <button onclick="loadOrderSummary()" class="mt-auto bg-purple-600 text-white px-4 py-2 rounded-lg text-sm shadow hover:bg-purple-700 h-[38px]">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ</button>
             </div>
             <div id="summary-content" class="bg-slate-50 rounded-xl p-4 border border-slate-200 min-h-[200px]">
                <p class="text-slate-400 text-center mt-10">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ</p>
             </div>
             
             <!-- Update Status Bulk -->
             <div class="mt-6 pt-6 border-t border-slate-200">
               <h4 class="font-bold text-slate-800 mb-3">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏ô‡∏µ‡πâ</h4>
               <div class="flex gap-3 items-center">
                 <select id="update-status-select" class="border border-slate-300 rounded-lg px-3 py-2 text-sm w-full max-w-xs">
                   <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà --</option>
                   <option value="preparing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                   <option value="ready">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
                   <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                 </select>
                 <button onclick="updateAllFilteredOrders()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
               </div>
             </div>
          </div>
        </div>
        
        <div id="admin-stats-tab" class="admin-tab-content hidden">
           <div id="admin-stats-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="admin-desserts-tab" class="admin-tab-content hidden">
           <div class="flex justify-between items-center mb-6">
             <h3 class="text-xl font-bold text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</h3>
             <button onclick="openDessertModal('new')" class="btn-primary px-4 py-2 text-sm shadow-md">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
           </div>
           <div id="admin-dessert-list" class="grid gap-3 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
        </div>
        
        <div id="admin-brownie-tab" class="admin-tab-content hidden">
          <div class="mb-6">
            <h3 class="text-xl font-bold text-slate-800 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</h3>
            <p class="text-slate-500 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ç‡∏ô‡∏° (Base) ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏ô‡∏° (Topping)</p>
          </div>
          <div class="flex gap-3 mb-6 flex-wrap">
            <button class="bg-white border border-slate-200 text-slate-700 hover:border-indigo-500 hover:text-indigo-600 px-4 py-2 rounded-xl text-sm font-medium transition shadow-sm" onclick="openBrownieModal('base', null)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ (Base)</button>
            <button class="bg-white border border-slate-200 text-slate-700 hover:border-pink-500 hover:text-pink-600 px-4 py-2 rounded-xl text-sm font-medium transition shadow-sm" onclick="openBrownieModal('topping', null)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤ (Topping)</button>
          </div>
          <div id="admin-brownie-list" class="grid gap-3 grid-cols-1 sm:grid-cols-2"></div>
        </div>
        
        <div id="admin-rewards-tab" class="admin-tab-content hidden">
           <button onclick="showCreateRewardForm()" class="btn-primary w-full sm:w-auto px-6 py-2 mb-6 shadow-md">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
           <div id="admin-rewards-content" class="grid gap-4 grid-cols-1 sm:grid-cols-2"></div>
        </div>
        
        <div id="admin-coupons-tab" class="admin-tab-content hidden">
           <button onclick="showCreateCouponForm()" class="btn-primary w-full sm:w-auto px-6 py-2 mb-6 shadow-md">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</button>
           <div id="admin-coupons-content" class="grid gap-4 grid-cols-1 sm:grid-cols-2"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Forms Modals (Reused structure with better styling) -->
  <div id="create-reward-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100">
      <div class="flex justify-between items-center mb-4">
        <h3 id="reward-modal-title" class="text-lg font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
        <button onclick="closeCreateReward()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <form onsubmit="createReward(event)" class="space-y-4">
        <input type="hidden" id="reward-id">
        <input type="text" id="reward-name" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition">
        <input type="text" id="reward-description" required placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition">
        <div class="grid grid-cols-2 gap-4">
           <input type="number" id="reward-points" required min="1" placeholder="‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition">
           <input type="number" id="reward-value" required min="1" placeholder="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <select id="reward-type" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition">
            <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</option>
            <option value="fixed">‡∏ö‡∏≤‡∏ó (Fixed)</option>
          </select>
          <input type="number" id="reward-min" value="0" min="0" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition">
        </div>
        
        <!-- Checkbox for is_active -->
        <div class="flex items-center gap-2 mt-2">
             <input type="checkbox" id="reward-active" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" checked />
             <label for="reward-active" class="text-sm font-medium text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ</label>
        </div>

        <button type="submit" class="w-full btn-primary py-3 rounded-xl shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </form>
    </div>
  </div>

  <!-- Add Points Modal -->
  <div id="add-points-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
     <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
        <h3 class="text-lg font-bold mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î ‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
        <p id="add-points-user-name" class="text-sm text-slate-500 mb-4"></p>
        <input type="hidden" id="add-points-user-id">
        <div class="mb-4">
           <label class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏° (‡πÉ‡∏™‡πà‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î)</label>
           <input type="number" id="points-amount" class="w-full p-3 border rounded-xl text-center text-xl font-bold text-indigo-600" placeholder="0">
        </div>
        <div class="flex gap-3">
           <button onclick="toggleModal('add-points-modal', false)" class="flex-1 py-2 rounded-lg border border-slate-200 text-slate-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
           <button onclick="submitAddPoints()" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
     </div>
  </div>

  <!-- Give Coupon Modal -->
  <div id="give-coupon-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
     <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
        <h3 class="text-lg font-bold mb-2">‡∏°‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
        <p id="give-coupon-user-name" class="text-sm text-slate-500 mb-4"></p>
        <input type="hidden" id="give-coupon-user-id">
        
        <div class="mb-4">
           <label class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö</label>
           <select id="reward-select" class="w-full p-3 border rounded-xl bg-slate-50">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• --</option>
           </select>
        </div>
        
        <div class="flex gap-3">
           <button onclick="toggleModal('give-coupon-modal', false)" class="flex-1 py-2 rounded-lg border border-slate-200 text-slate-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
           <button onclick="submitGiveCoupon()" class="flex-1 py-2 rounded-lg bg-purple-600 text-white font-bold">‡∏°‡∏≠‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
        </div>
     </div>
  </div>

  <!-- View User Details Modal -->
  <div id="user-details-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
     <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl flex flex-col max-h-[90vh]">
        <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
           <h3 class="text-xl font-bold text-slate-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
           <button onclick="toggleModal('user-details-modal', false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scrollbar">
             <div class="flex flex-col items-center mb-6">
                <img id="ud-pic" src="" class="w-24 h-24 rounded-full border-4 border-indigo-50 shadow-md mb-3 object-cover">
                <h4 id="ud-name" class="text-xl font-bold text-slate-800"></h4>
                <p id="ud-line-id" class="text-sm text-slate-500 cursor-pointer hover:text-indigo-600 transition" onclick="copyToClipboard(this.innerText.replace('Line ID: ', ''))" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"></p>
             </div>
             
             <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-indigo-50 p-4 rounded-xl text-center">
                   <div class="text-xs text-slate-500 mb-1">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
                   <div id="ud-points" class="text-2xl font-bold text-indigo-600">0</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-xl text-center">
                   <div class="text-xs text-slate-500 mb-1">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                   <div id="ud-total-orders" class="text-2xl font-bold text-orange-600">0</div>
                </div>
             </div>

             <div class="space-y-2">
                <h5 class="font-semibold text-slate-700 text-sm border-b pb-1 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
                <div id="ud-order-history" class="space-y-2">
                   <!-- Orders will be injected here -->
                </div>
             </div>
        </div>
     </div>
  </div>

  <div id="create-coupon-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
     <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
        <div class="flex justify-between items-center mb-4">
          <h3 id="coupon-modal-title" class="text-lg font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h3>
          <button onclick="closeCreateCoupon()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <form onsubmit="createCoupon(event)" class="space-y-3">
           <input type="hidden" id="coupon-id">
           
           <div>
             <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
             <input id="coupon-code" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô SALE50)" required />
           </div>

           <div>
             <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
             <input id="coupon-title" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á" required />
           </div>

           <div>
             <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
             <input id="coupon-description" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" required />
           </div>

           <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select id="coupon-type" class="w-full p-3 bg-slate-50 border rounded-xl"><option value="percent">%</option><option value="fixed">‡∏ö‡∏≤‡∏ó</option></select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                <input id="coupon-value" type="number" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤" required />
              </div>
           </div>

           <div class="grid grid-cols-2 gap-3">
             <div>
               <label class="block text-sm font-medium text-gray-700 mb-1">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
               <input id="coupon-min" type="number" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥" value="0"/>
             </div>
             <div>
               <label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label>
               <input id="coupon-usage" type="number" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå" value="100"/>
             </div>
           </div>

           <div class="flex items-center gap-2 mt-2">
                <input type="checkbox" id="coupon-active" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500" checked />
                <label for="coupon-active" class="text-sm font-medium text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</label>
           </div>

           <button type="submit" class="w-full btn-primary py-3 rounded-xl mt-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </form>
     </div>
  </div>

  <div id="dessert-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
     <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
        <h3 id="dessert-modal-title" class="text-lg font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
        <form id="dessert-form" class="space-y-4">
           <input type="hidden" id="dessert-id">
           <input id="dessert-name" class="w-full p-3 border rounded-xl" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" required>
           <input id="dessert-emoji" class="w-full p-3 border rounded-xl" placeholder="Emoji (‡πÄ‡∏ä‡πà‡∏ô üç∞)">
           <textarea id="dessert-desc" class="w-full p-3 border rounded-xl" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"></textarea>
           <label class="flex items-center gap-2"><input type="checkbox" id="dessert-active" checked> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</label>
           <div class="flex gap-3 justify-end">
              <button type="button" onclick="closeDessertModal()" class="px-4 py-2 rounded-lg text-slate-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
           </div>
        </form>
     </div>
  </div>

  <div id="brownie-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
       <h3 id="brownie-modal-title" class="text-lg font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</h3>
       <form id="brownie-form" class="space-y-3">
          <input type="hidden" id="brownie-id"><input type="hidden" id="brownie-type">
          <input id="brownie-name" class="w-full p-3 border rounded-xl" placeholder="‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏≤‡∏£‡πå‡∏Ñ‡∏ä‡πá‡∏≠‡∏Å)" required>
          <input id="brownie-desc" class="w-full p-3 border rounded-xl" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
          <div class="grid grid-cols-2 gap-3">
             <input id="brownie-price" type="number" step="0.01" class="w-full p-3 border rounded-xl" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required>
             <input id="brownie-points" type="number" class="w-full p-3 border rounded-xl" placeholder="‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ" required>
          </div>
          <label class="flex items-center gap-2"><input id="brownie-active" type="checkbox" checked> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</label>
          <div class="flex gap-3 justify-end mt-2">
             <button type="button" onclick="closeBrownieModal()" class="px-4 py-2 rounded-lg text-slate-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
             <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
       </form>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="success-message" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-[100] hidden flex items-center gap-3 animate-bounce">
    <i class="fa-solid fa-circle-check text-green-400"></i>
    <span id="success-text" class="font-medium">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
  </div>

  <script>
    // Configuration
    const LIFF_ID = "2008357926-Ly07A5w2";
    const SUPABASE_URL = "https://dyorwbjagjlkqpbrdjwk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5b3J3YmphZ2psa3FwYnJkandrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjk2NjgsImV4cCI6MjA3Njk0NTY2OH0.bZJRcaM3u9NUBrux5AbPXOXVtcSnJHDdK15gCQ-9Zc4";
    // Default Admins (Hardcoded + Persistent)
    const ADMIN_IDS = ["Ud21a04a5d66c9de0b4c6f1aaf8f050e2","U5301bd5962323787574d82f86f3d954e"];
    let adminList = []; // Will be populated on init

    // State Variables
    let supabase;
    let userProfile = null;
    let currentUser = null;
    let selectedBase = null;
    let selectedTopping = null;
    let quantity = 1;
    let cart = [];
    let userPoints = 0;
    let selectedCoupon = null;
    let availableRewards = [];
    let userCoupons = [];
    let allDesserts = [];
    let selectedDessert = null;
    let currentAdminDessertId = null;
    let shopIsOpen = true;
    let blockedDates = []; // Store blocked dates
    let allOrders = [];
    let allUsers = []; // Store all users for admin
    let dbColumnExists = true; // Flag to check if DB column exists

    // --- Core UI Functions ---

    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        const backdrop = document.getElementById('modal-backdrop');
        const content = modal.children[0];
        
        if (show) {
            modal.classList.remove('hidden');
            backdrop.classList.remove('hidden');
            requestAnimationFrame(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('translate-y-full');
            });
        } else {
            backdrop.classList.add('opacity-0');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
                backdrop.classList.add('hidden');
            }, 300);
        }
    }

    // Wrappers for specific modals
    function showRewards() { 
        renderRewards();
        toggleModal('rewards-modal', true); 
    }
    function closeRewards() { toggleModal('rewards-modal', false); }
    
    function showMyCoupons() { 
        renderMyCoupons();
        closeRewards(); // Close previous if open
        toggleModal('my-coupons-modal', true); 
    }
    function closeMyCoupons() { toggleModal('my-coupons-modal', false); }
    
    function showCart() { 
        renderCart();
        toggleModal('cart-modal', true); 
    }
    function closeCart() { toggleModal('cart-modal', false); }
    
    function showMyCouponsForCart() {
        closeCart();
        showMyCoupons();
    }

    // Admin UI Toggles
    function showAdmin() {
        const modal = document.getElementById('admin-modal');
        modal.classList.remove('hidden');
        showAdminTab('shop-status'); // Default to shop status
    }
    function closeAdmin() {
        document.getElementById('admin-modal').classList.add('hidden');
    }
    function showAdminTab(tabId) {
        // Desktop Nav (Actually now used for mobile too since topbar is gone)
        document.querySelectorAll('.admin-nav-btn').forEach(btn => {
            if (btn.dataset.tab === tabId) {
                btn.classList.add('bg-indigo-50', 'text-indigo-600', 'shadow-sm');
                btn.classList.remove('text-slate-600');
            } else {
                btn.classList.remove('bg-indigo-50', 'text-indigo-600', 'shadow-sm');
                btn.classList.add('text-slate-600');
            }
        });

        document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('admin-' + tabId + '-tab').classList.remove('hidden');

        // Load data on switch
        if (tabId === 'shop-status') updateShopStatusUI();
        if (tabId === 'orders') loadAdminOrders();
        if (tabId === 'rewards') loadAdminRewards();
        if (tabId === 'coupons') loadAdminCoupons();
        if (tabId === 'stats') loadAdminStats();
        if (tabId === 'desserts') loadAdminDesserts();
        if (tabId === 'brownie' && currentAdminDessertId) loadBrownieMenus(currentAdminDessertId);
        if (tabId === 'summary') loadSummaryDeliveryRounds(); 
        if (tabId === 'delivery') renderDeliveryRoundsManagement();
        if (tabId === 'users') loadAdminUsers();
    }

    // --- Logic Implementation ---

    async function init() {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Load Admins from LocalStorage & Merge
        const storedAdmins = JSON.parse(localStorage.getItem('suan_khanom_admins') || '[]');
        adminList = [...new Set([...ADMIN_IDS, ...storedAdmins])];

        // --- RESTORE LOGIN ---
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        userProfile = await liff.getProfile();

        // Auto-add current mock user to admin list for access (if needed)
        // if (!adminList.includes(userProfile.userId)) {
        //      adminList.push(userProfile.userId);
        // }

        // Init cart from local storage
        loadCartFromStorage();
        
        await saveUserToSupabase(userProfile);
        await loadUserData(userProfile.userId);
        
        await Promise.all([
           loadRewards(),
           loadUserCoupons(),
           loadDesserts(),
           loadShopStatus()
        ]);

        // Check against adminList instead of static array
        if (adminList.includes(userProfile.userId)) {
           document.getElementById("admin-container").classList.remove("hidden");
        }

        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("main-header").classList.remove("hidden");
        document.getElementById("main-app").classList.remove("hidden");
      } catch (error) {
        console.error("Init Error:", error);
        alert("Connection Error. Please refresh.");
      }
    }

    // Local Storage Cart Functions
    function saveCartToStorage() {
        localStorage.setItem("suan_khanom_cart", JSON.stringify(cart));
    }

    function loadCartFromStorage() {
        const stored = localStorage.getItem("suan_khanom_cart");
        if (stored) {
            try {
                cart = JSON.parse(stored);
                updateCartBadge();
            } catch (e) {
                console.error("Error parsing cart from storage", e);
                cart = [];
            }
        }
    }

    async function saveUserToSupabase(profile) {
      const { data } = await supabase.from("users").select("id").eq("line_id", profile.userId).maybeSingle();
      if (!data) {
        await supabase.from("users").insert([{
          line_id: profile.userId,
          display_name: profile.displayName,
          picture_url: profile.pictureUrl,
          points: 0
        }]);
      }
    }

    async function loadUserData(lineId) {
      const { data } = await supabase.from("users").select("*").eq("line_id", lineId).single();
      if (data) {
        currentUser = data;
        userPoints = data.points;
        document.getElementById("userPoints").innerText = userPoints;
        document.getElementById("modal-user-points").innerText = userPoints;
        document.getElementById("userPic").src = data.picture_url;
      }
    }

    // --- Desserts & Menu Logic ---

    async function loadDesserts() {
       const { data } = await supabase.from("desserts").select("*").eq("is_active", true).order("id");
       allDesserts = data || [];
       const container = document.getElementById("dessert-list");
       if(container) {
          container.innerHTML = allDesserts.map(d => `
             <div class="menu-card" onclick='selectDessert(${JSON.stringify(d).replace(/'/g, "&#39;")}, this)'>
                <div class="check-icon"><i class="fa-solid fa-check"></i></div>
                <div class="text-4xl mb-3 transform transition hover:scale-110">${d.emoji || 'üç™'}</div>
                <div class="font-bold text-slate-800 text-sm sm:text-base">${d.name}</div>
                <div class="text-xs text-slate-400 mt-1">${d.description || ''}</div>
             </div>
          `).join('');
       }
    }

    function selectDessert(dessert, el) {
       selectedDessert = dessert;
       document.querySelectorAll('#dessert-list .menu-card').forEach(c => c.classList.remove('selected'));
       el.classList.add('selected');
       document.getElementById("menu-selection").classList.remove("hidden");
       document.getElementById("action-bar").classList.remove("hidden");
       setTimeout(() => document.getElementById("action-bar").classList.remove("translate-y-full"), 100);
       document.getElementById("menu-selection").scrollIntoView({behavior: "smooth", block: "start"});
       loadBrownieItems(dessert.id);
    }

    async function loadBrownieItems(dessertId) {
       const { data } = await supabase.from("brownie_items").select("*").eq("dessert_id", dessertId).eq("is_active", true).order("price");
       const bases = data.filter(i => i.type === 'base');
       const toppings = data.filter(i => i.type === 'topping');
       renderItems('base', bases);
       renderItems('topping', toppings);
       selectedBase = null; 
       selectedTopping = null;
       updateTotal();
    }

    function renderItems(type, items) {
       const container = document.getElementById(type + '-list');
       if (items.length === 0) {
           container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-4 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
           return;
       }
       container.innerHTML = items.map(item => `
          <div class="menu-card item-card-${type}" onclick="selectItem('${type}', ${item.id}, '${item.name}', ${item.price}, this)">
             <div class="check-icon"><i class="fa-solid fa-check"></i></div>
             <div class="font-bold text-slate-700 text-sm">${item.name}</div>
             <div class="text-xs text-indigo-500 font-semibold mt-1">+${item.price}‡∏ø</div>
          </div>
       `).join('');
    }

    function selectItem(type, id, name, price, el) {
       document.querySelectorAll(`.item-card-${type}`).forEach(c => c.classList.remove('selected'));
       el.classList.add('selected');
       if (type === 'base') selectedBase = { id, name, price };
       else selectedTopping = { id, name, price };
       updateTotal();
    }

    function changeQuantity(delta) {
        if (quantity + delta >= 1) {
            quantity += delta;
            document.getElementById("quantity").innerText = quantity;
            updateTotal();
        }
    }

    function updateTotal() {
        const baseP = selectedBase ? selectedBase.price : 0;
        const topP = selectedTopping ? selectedTopping.price : 0;
        const total = (baseP + topP) * quantity;
        document.getElementById("total-price").innerText = total.toLocaleString();
        document.getElementById("mobile-total-price").innerText = total.toLocaleString();
        const btn = document.getElementById("add-to-cart");
        btn.disabled = !(selectedBase && selectedTopping);
    }

    function addToCart() {
       if (!selectedBase || !selectedTopping) return;
       const unitPrice = selectedBase.price + selectedTopping.price;
       cart.push({
          dessertId: selectedDessert.id, dessertName: selectedDessert.name,
          baseName: selectedBase.name, toppingName: selectedTopping.name,
          quantity: quantity, unitPrice: unitPrice, totalPrice: unitPrice * quantity
       });
       
       saveCartToStorage(); // Save cart

       quantity = 1; 
       document.getElementById("quantity").innerText = 1;
       selectedBase = null; selectedTopping = null;
       document.querySelectorAll('.menu-card.selected').forEach(c => c.classList.remove('selected'));
       updateCartBadge();
       showSuccessToast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
       window.scrollTo({ top: 0, behavior: 'smooth' });
       document.getElementById("menu-selection").classList.add("hidden");
       document.getElementById("action-bar").classList.add("translate-y-full");
    }

    function updateCartBadge() {
       const badge = document.getElementById("cart-badge");
       const count = cart.reduce((a,b) => a + b.quantity, 0);
       badge.innerText = count;
       if (count > 0) {
           badge.classList.remove('hidden');
           badge.classList.add('flex', 'animate-bounce'); 
           setTimeout(() => badge.classList.remove('animate-bounce'), 1000);
       } else {
           badge.classList.add('hidden');
       }
    }

    function renderCart() {
       const container = document.getElementById("cart-content");
       if (cart.length === 0) {
           container.innerHTML = `
             <div class="text-center py-10 opacity-50">
               <i class="fa-solid fa-basket-shopping text-6xl mb-4 text-slate-300"></i>
               <p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
             </div>
           `;
       } else {
           container.innerHTML = cart.map((item, idx) => `
             <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                <div>
                   <div class="font-bold text-slate-800 text-sm">${item.dessertName}</div>
                   <div class="text-xs text-slate-500">${item.baseName} + ${item.toppingName}</div>
                   <div class="text-xs font-semibold text-indigo-600 mt-1">${item.unitPrice} ‡∏ø/‡∏ä‡∏¥‡πâ‡∏ô</div>
                </div>
                <div class="flex flex-col items-end gap-2">
                   <div class="flex items-center gap-2 bg-white rounded-lg border border-slate-200 px-1 py-0.5">
                      <button onclick="updateCartItem(${idx}, -1)" class="w-6 h-6 flex items-center justify-center text-slate-400 hover:text-red-500"><i class="fa-solid fa-minus text-xs"></i></button>
                      <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                      <button onclick="updateCartItem(${idx}, 1)" class="w-6 h-6 flex items-center justify-center text-slate-400 hover:text-green-500"><i class="fa-solid fa-plus text-xs"></i></button>
                   </div>
                   <div class="text-sm font-bold">${item.totalPrice} ‡∏ø</div>
                </div>
             </div>
           `).join('');
       }
       updateCartTotal();
       loadDeliveryDates();
    }

    function updateCartItem(idx, delta) {
        if (cart[idx].quantity + delta < 1) {
            if (confirm("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?")) cart.splice(idx, 1);
        } else {
            cart[idx].quantity += delta;
            cart[idx].totalPrice = cart[idx].unitPrice * cart[idx].quantity;
        }
        saveCartToStorage(); // Save updates
        renderCart();
        updateCartBadge();
    }

    async function loadDeliveryDates() {
        const sel = document.getElementById("delivery-date");
        sel.innerHTML = '';
        const days = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏û‡∏∏‡∏ò", "‡∏û‡∏§‡∏´‡∏±‡∏™", "‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÄ‡∏™‡∏≤‡∏£‡πå"];
        const deliveryDays = [1, 3, 5]; // Mon, Wed, Fri
        let d = new Date();
        let count = 0;
        
        // Loop to find next 5 available delivery dates
        while(count < 8) {
            d.setDate(d.getDate() + 1);
            if (deliveryDays.includes(d.getDay())) {
                 const dateStr = d.toISOString().split('T')[0];
                 // Check if this date is blocked
                 if (!blockedDates.includes(dateStr)) {
                     const opt = document.createElement("option");
                     const label = `${days[d.getDay()]} ${d.getDate()}/${d.getMonth()+1}`;
                     opt.value = dateStr;
                     opt.text = label;
                     sel.appendChild(opt);
                     count++;
                 }
            }
        }
        if(sel.options.length === 0) {
            const opt = document.createElement("option");
            opt.text = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ";
            sel.appendChild(opt);
        }
    }

    function updateCartTotal() {
        const subtotal = cart.reduce((a,b) => a + b.totalPrice, 0);
        let discount = 0;
        if (selectedCoupon) {
            if (selectedCoupon.discount_type === 'percent') discount = Math.floor(subtotal * selectedCoupon.discount_value / 100);
            else discount = selectedCoupon.discount_value;
            discount = Math.min(discount, subtotal);
        }
        document.getElementById("cart-subtotal").innerText = subtotal.toLocaleString() + " ‡∏ø";
        document.getElementById("discount-amount").innerText = "-" + discount.toLocaleString() + " ‡∏ø";
        document.getElementById("cart-total").innerText = (subtotal - discount).toLocaleString() + " ‡∏ø";
        if (discount > 0) document.getElementById("discount-row").classList.remove("hidden");
        else document.getElementById("discount-row").classList.add("hidden");
    }

    // --- Rewards & Coupons ---

    async function loadRewards() {
        const { data } = await supabase.from("rewards").select("*").eq("is_active", true);
        availableRewards = data || [];
    }
    
    async function loadUserCoupons() {
        const { data } = await supabase.from("user_coupons").select("*, rewards(*)").eq("user_id", currentUser?.id).eq("is_used", false);
        userCoupons = data || [];
    }

    function renderRewards() {
        const container = document.getElementById("rewards-content");
        if (availableRewards.length === 0) container.innerHTML = `<div class="text-center p-4 text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>`;
        else {
           container.innerHTML = availableRewards.map(r => {
              const can = userPoints >= r.points_required;
              return `
              <div class="flex items-center justify-between bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                 <div>
                    <div class="font-bold text-slate-800">${r.name}</div>
                    <div class="text-xs text-slate-500">${r.description}</div>
                    <div class="text-xs font-semibold text-orange-500 mt-1"><i class="fa-solid fa-coins"></i> ${r.points_required} ‡πÅ‡∏ï‡πâ‡∏°</div>
                 </div>
                 <button onclick="redeemReward(${r.id})" ${!can ? 'disabled' : ''} class="px-4 py-2 rounded-lg text-sm font-bold transition ${can ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}">
                   ‡πÅ‡∏•‡∏Å
                 </button>
              </div>`;
           }).join('');
        }
    }
    
    async function redeemReward(id) {
       const r = availableRewards.find(x => x.id === id);
       if (!confirm(`‡πÅ‡∏•‡∏Å "${r.name}" ‡∏î‡πâ‡∏ß‡∏¢ ${r.points_required} ‡πÅ‡∏ï‡πâ‡∏°?`)) return;
       const { error } = await supabase.from("users").update({points: userPoints - r.points_required}).eq("id", currentUser.id);
       if (!error) {
          const code = "REW-" + Math.random().toString(36).substr(2,6).toUpperCase();
          await supabase.from("user_coupons").insert([{
              user_id: currentUser.id, reward_id: id, coupon_code: code
          }]);
          userPoints -= r.points_required;
          document.getElementById("userPoints").innerText = userPoints;
          document.getElementById("modal-user-points").innerText = userPoints;
          showSuccessToast("‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          loadUserCoupons();
          closeRewards();
       }
    }

    function renderMyCoupons() {
        const container = document.getElementById("my-coupons-content");
        if (userCoupons.length === 0) {
            container.innerHTML = `<div class="text-center p-8 text-slate-400">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</div>`;
            return;
        }
        container.innerHTML = userCoupons.map(c => `
           <div onclick="selectCoupon('${c.coupon_code}')" class="bg-white p-4 rounded-xl border-2 border-dashed border-indigo-200 hover:border-indigo-400 cursor-pointer transition relative overflow-hidden group">
              <div class="absolute right-0 top-0 bg-indigo-100 text-indigo-600 px-3 py-1 rounded-bl-xl text-xs font-bold">Code: ${c.coupon_code}</div>
              <div class="font-bold text-slate-800 pr-16">${c.rewards.name}</div>
              <div class="text-xs text-slate-500 mt-1">${c.rewards.description}</div>
              <div class="mt-2 text-indigo-600 text-sm font-semibold opacity-0 group-hover:opacity-100 transition-opacity">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ</div>
           </div>
        `).join('');
    }

    async function applyCouponCode() {
        const code = document.getElementById("coupon-input").value.trim().toUpperCase();
        let coupon = userCoupons.find(c => c.coupon_code === code);
        if (coupon) {
            selectedCoupon = {
                id: coupon.id, code: coupon.coupon_code, name: coupon.rewards.name,
                description: coupon.rewards.description, discount_type: coupon.rewards.discount_type,
                discount_value: coupon.rewards.discount_value, coupon_type: 'reward'
            };
        } else {
             const { data } = await supabase.from("coupons").select("*").eq("code", code).eq("is_active", true).maybeSingle();
             if (data) {
                 selectedCoupon = {
                     id: data.id, code: data.code, name: data.name, description: data.description,
                     discount_type: data.type, discount_value: data.value, coupon_type: 'normal'
                 };
             } else {
                 document.getElementById("coupon-message").innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á";
                 document.getElementById("coupon-message").className = "text-xs text-red-500 mt-2";
                 document.getElementById("coupon-message").classList.remove("hidden");
                 return;
             }
        }
        document.getElementById("selected-coupon").classList.remove("hidden");
        document.getElementById("coupon-name").innerText = selectedCoupon.name;
        document.getElementById("coupon-desc").innerText = selectedCoupon.description;
        document.getElementById("coupon-input").value = "";
        updateCartTotal();
        if (!document.getElementById("my-coupons-modal").classList.contains("hidden")) {
            closeMyCoupons();
            showCart();
        }
    }
    
    function removeCoupon() {
        selectedCoupon = null;
        document.getElementById("selected-coupon").classList.add("hidden");
        updateCartTotal();
    }
    
    function selectCoupon(code) {
        document.getElementById("coupon-input").value = code;
        applyCouponCode();
    }

    // --- Checkout & Status ---

    async function loadShopStatus() {
        const { data } = await supabase.from("shop_settings").select("is_open, blocked_dates").eq("id", 1).maybeSingle();
        shopIsOpen = data ? data.is_open : true;
        // Parse blocked dates from DB
        if (data && data.blocked_dates) {
            try {
                blockedDates = typeof data.blocked_dates === 'string' ? JSON.parse(data.blocked_dates) : data.blocked_dates;
            } catch(e) { blockedDates = []; }
        } else {
            blockedDates = [];
        }
        updateShopStatusUI();
    }
    
    function updateShopStatusUI() {
        if (!shopIsOpen) document.getElementById("shop-closed-overlay").classList.remove("hidden");
        const icon = document.getElementById("shop-status-icon");
        const txt = document.getElementById("shop-status-text");
        const btn = document.getElementById("toggle-shop-btn");
        if (icon) {
            icon.innerText = shopIsOpen ? "üè†" : "üîí";
            txt.innerText = shopIsOpen ? "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà" : "‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß";
            btn.innerText = shopIsOpen ? "‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô" : "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
            btn.className = shopIsOpen ? "w-full py-3 rounded-xl font-bold text-lg shadow-lg bg-red-500 text-white hover:bg-red-600" : "w-full py-3 rounded-xl font-bold text-lg shadow-lg bg-green-500 text-white hover:bg-green-600";
        }
    }
    
    async function toggleShopStatus() {
        shopIsOpen = !shopIsOpen;
        await supabase.from("shop_settings").upsert({id:1, is_open: shopIsOpen});
        updateShopStatusUI();
    }

    function closeShopClosedOverlay() {
        document.getElementById("shop-closed-overlay").classList.add("hidden");
    }

    async function checkout() {
        if (cart.length === 0) return;
        if (!shopIsOpen) return alert("‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
        const date = document.getElementById("delivery-date").value;
        if (!date) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
        const subtotal = cart.reduce((a,b) => a+b.totalPrice, 0);
        let discount = 0;
        if (selectedCoupon) {
            if (selectedCoupon.discount_type === 'percent') discount = Math.floor(subtotal * selectedCoupon.discount_value / 100);
            else discount = selectedCoupon.discount_value;
            discount = Math.min(discount, subtotal);
        }
        const total = subtotal - discount;
        const { data, error } = await supabase.from("orders").insert([{
            user_id: currentUser.id, line_id: currentUser.line_id, items: cart,
            subtotal, discount, total_price: total, earned_points: Math.floor(total / 10),
            delivery_date: date, status: "pending", coupon_code: selectedCoupon ? selectedCoupon.code : null // Save coupon code
        }]);

        if (!error) {
            if (selectedCoupon && selectedCoupon.coupon_type === 'reward') {
                 await supabase.from("user_coupons").update({is_used: true}).eq("id", selectedCoupon.id);
            }
            cart = []; 
            saveCartToStorage(); // Clear storage cart
            selectedCoupon = null;
            updateCartBadge();
            closeCart();
            showSuccessToast("‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            loadUserCoupons();
        } else {
            alert("Order Failed: " + error.message);
        }
    }

    // --- Admin Delivery Management ---
    async function renderDeliveryRoundsManagement() {
        const container = document.getElementById("delivery-rounds-list");
        container.innerHTML = '';
        
        // Generate next 14 possible delivery dates
        const days = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏û‡∏∏‡∏ò", "‡∏û‡∏§‡∏´‡∏±‡∏™", "‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÄ‡∏™‡∏≤‡∏£‡πå"];
        const deliveryDays = [1, 3, 5]; 
        let d = new Date();
        let count = 0;
        
        while (count < 14) {
            d.setDate(d.getDate() + 1);
            if (deliveryDays.includes(d.getDay())) {
                const dateStr = d.toISOString().split('T')[0];
                const dateLabel = `${days[d.getDay()]} ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
                const isBlocked = blockedDates.includes(dateStr);
                
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-4 bg-slate-50 rounded-xl border " + (isBlocked ? "border-red-200 bg-red-50" : "border-slate-200");
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${isBlocked ? 'bg-red-100 text-red-500' : 'bg-green-100 text-green-500'}">
                            <i class="fa-solid ${isBlocked ? 'fa-ban' : 'fa-check'}"></i>
                        </div>
                        <div>
                            <div class="font-bold text-slate-800">${dateLabel}</div>
                            <div class="text-xs ${isBlocked ? 'text-red-500' : 'text-green-600'}">${isBlocked ? '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå'}</div>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer" onchange="toggleDeliveryDate('${dateStr}')" ${!isBlocked ? 'checked' : ''}>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                `;
                container.appendChild(item);
                count++;
            }
        }
    }

    async function toggleDeliveryDate(dateStr) {
        if (blockedDates.includes(dateStr)) {
            // Remove (Open)
            blockedDates = blockedDates.filter(d => d !== dateStr);
        } else {
            // Add (Close)
            blockedDates.push(dateStr);
        }
        
        // Save directly to DB
        const { error } = await supabase.from("shop_settings").update({ blocked_dates: blockedDates }).eq("id", 1);
        
        if (error) {
            console.error("Error updating blocked dates:", error);
            showSuccessToast("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } else {
            renderDeliveryRoundsManagement();
        }
    }
    
    // --- Admin Summary with Auto-Generated Rounds ---
    async function loadSummaryDeliveryRounds() {
        const sel = document.getElementById("summary-delivery-round");
        sel.innerHTML = '';
        const days = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏û‡∏∏‡∏ò", "‡∏û‡∏§‡∏´‡∏±‡∏™", "‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÄ‡∏™‡∏≤‡∏£‡πå"];
        const deliveryDays = [1, 3, 5]; 
        let d = new Date();
        let count = 0;
        
        while (count < 8) {
            d.setDate(d.getDate() + 1);
            if (deliveryDays.includes(d.getDay())) {
                 const dateStr = d.toISOString().split('T')[0];
                 // We show ALL future rounds here, even blocked ones, maybe admins want to see pre-orders?
                 // Or filter blocked. Let's filter blocked to be safe, or show marked.
                 // For summary, usually we want active rounds.
                 if (!blockedDates.includes(dateStr)) {
                     const opt = document.createElement("option");
                     const label = `${days[d.getDay()]} ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
                     opt.value = dateStr;
                     opt.text = label;
                     sel.appendChild(opt);
                     count++;
                 }
            }
        }
        
        if(sel.options.length > 0) {
            sel.selectedIndex = 0; // Select first available
            loadOrderSummary(); // Load data for it
        } else {
             const opt = document.createElement("option");
             opt.text = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ";
             sel.appendChild(opt);
        }
    }

    // --- Admin Functions (Restored Logic) ---

    // New unified function to render admin order list
function renderAdminOrderList(orders) {
  const container = document.getElementById("admin-orders-content");
  if (orders.length === 0) {
    container.innerHTML = "<p class='text-center text-slate-400'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>";
    return;
  }
  
  container.innerHTML = orders.map(o => {
    let items = [];
    try { items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; } catch(e) {}
    const totalQty = Array.isArray(items) ? items.reduce((s, i) => s + (parseInt(i.quantity)||1), 0) : 0;
    
    // Format Date
    const createdDate = new Date(o.created_at).toLocaleString('th-TH');
    const deliveryDate = o.delivery_date ? new Date(o.delivery_date).toLocaleDateString('th-TH', {weekday:'short', day:'numeric', month:'short'}) : '-';

    // User Pic
    const userPic = o.users?.picture_url || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';

    // Items HTML
    const itemsHtml = items.map(i => `
        <div class="text-xs text-slate-600 ml-4 border-l-2 border-slate-200 pl-2 mt-1">
            ${i.baseName} + ${i.toppingName} <span class="font-bold">x${i.quantity}</span>
        </div>
    `).join('');

    return `
       <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all">
          <div class="flex justify-between items-start mb-3">
             <div class="flex items-center gap-2">
                <img src="${userPic}" class="w-8 h-8 rounded-full object-cover border border-slate-200" onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'">
                <div>
                    <span class="font-bold text-slate-800">#${o.id}</span>
                    <div class="text-xs text-slate-500">${o.users?.display_name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</div>
                </div>
             </div>
             <select onchange="updateOrderStatus(${o.id}, this.value)" 
                class="text-xs border rounded px-2 py-1 outline-none ${
                    o.status==='pending'?'bg-yellow-50 text-yellow-700 border-yellow-200':
                    o.status==='preparing'?'bg-blue-50 text-blue-700 border-blue-200':
                    o.status==='ready'?'bg-green-50 text-green-700 border-green-200':
                    o.status==='completed'?'bg-purple-50 text-purple-700 border-purple-200':
                    'bg-red-50 text-red-700 border-red-200'
                }">
                <option value="pending" ${o.status==='pending'?'selected':''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                <option value="preparing" ${o.status==='preparing'?'selected':''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                <option value="ready" ${o.status==='ready'?'selected':''}>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
                <option value="completed" ${o.status==='completed'?'selected':''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                <option value="cancelled" ${o.status==='cancelled'?'selected':''}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
             </select>
          </div>
          
          <div class="grid grid-cols-2 gap-2 text-xs text-slate-500 mb-3">
             <div class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> ‡∏™‡∏±‡πà‡∏á: ${createdDate}</div>
             <div class="flex items-center gap-1"><i class="fa-solid fa-truck-fast"></i> ‡∏™‡πà‡∏á: ${deliveryDate}</div>
          </div>

          <div class="bg-slate-50 rounded-lg p-2 mb-3">
             <div class="flex justify-between text-xs font-semibold text-slate-600 mb-1">
                <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (${totalQty} ‡∏ä‡∏¥‡πâ‡∏ô)</span>
             </div>
             ${itemsHtml}
          </div>

          <div class="flex justify-between items-end border-t border-slate-100 pt-2">
             <div class="text-xs text-slate-400">LINE ID: ${o.line_id || '-'}</div>
             <div class="text-right">
                <div class="text-xs text-slate-400">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
                <div class="font-bold text-lg text-indigo-600">${o.total_price.toLocaleString()} ‡∏ø</div>
             </div>
          </div>
       </div>
    `;
  }).join('');
}

async function loadAdminOrders() {
    // Note: Added picture_url to query
    const { data } = await supabase.from("orders").select("*, users(display_name, picture_url)").order("created_at", {ascending: false});
    allOrders = data;
    renderAdminOrderList(allOrders);
}

function filterAdminOrders() {
    const txt = document.getElementById("admin-order-search").value.toLowerCase();
    const filtered = allOrders.filter(o => o.id.toString().includes(txt) || (o.users?.display_name||"").toLowerCase().includes(txt));
    renderAdminOrderList(filtered);
}
    
    async function updateOrderStatus(id, status) {
        await supabase.from("orders").update({status}).eq("id", id);
        showSuccessToast("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß");
    }

    async function createReward(event) {
        event.preventDefault();
        const id = document.getElementById("reward-id").value;
        const name = document.getElementById("reward-name").value;
        const description = document.getElementById("reward-description").value;
        const points = parseInt(document.getElementById("reward-points").value);
        const type = document.getElementById("reward-type").value;
        const value = parseInt(document.getElementById("reward-value").value);
        const min = parseInt(document.getElementById("reward-min").value);
        const isActive = document.getElementById("reward-active").checked;

        const payload = {
            name, description, points_required: points, discount_type: type, discount_value: value, min_purchase: min, is_active: isActive
        };

        let error;
        if(id) {
            const res = await supabase.from("rewards").update(payload).eq("id", id);
            error = res.error;
        } else {
            const res = await supabase.from("rewards").insert([payload]);
            error = res.error;
        }

        if(!error) {
            showSuccessToast(id ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            closeCreateReward();
            loadAdminRewards();
        } else {
            alert(error.message);
        }
    }

    async function loadAdminRewards() {
        const { data } = await supabase.from("rewards").select("*").order("points_required");
        const container = document.getElementById("admin-rewards-content");
        container.innerHTML = data.map(r => `
          <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
             <div class="flex-1 mr-4">
                <div class="font-bold text-slate-800">${r.name}</div>
                <div class="text-xs text-slate-500">${r.points_required} ‡πÅ‡∏ï‡πâ‡∏° | ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ${r.discount_type === 'percent' ? r.discount_value + '%' : r.discount_value + ' ‡∏ø'}</div>
                <div class="text-xs ${r.is_active ? 'text-green-500' : 'text-red-500'} mt-1">${r.is_active ? 'üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'üî¥ ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}</div>
             </div>
             <div class="flex gap-2">
                <button onclick='openEditRewardModal(${JSON.stringify(r).replace(/'/g, "&#39;")})' class="w-8 h-8 flex items-center justify-center bg-yellow-50 text-yellow-600 rounded-lg hover:bg-yellow-100 transition"><i class="fa-solid fa-pen text-xs"></i></button>
                <button onclick="deleteReward(${r.id})" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition"><i class="fa-solid fa-trash text-xs"></i></button>
             </div>
          </div>
        `).join('');
    }

    async function deleteReward(id) {
        if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ?")) {
            await supabase.from("rewards").delete().eq("id", id);
            loadAdminRewards();
        }
    }

    async function createCoupon(event) {
        event.preventDefault();
        const id = document.getElementById("coupon-id").value;
        const code = document.getElementById("coupon-code").value.toUpperCase();
        const name = document.getElementById("coupon-title").value;
        const desc = document.getElementById("coupon-description").value;
        const type = document.getElementById("coupon-type").value;
        const value = parseInt(document.getElementById("coupon-value").value);
        const min = parseInt(document.getElementById("coupon-min").value);
        const limit = parseInt(document.getElementById("coupon-usage").value);
        const isActive = document.getElementById("coupon-active").checked;

        const payload = {
            code, name, description: desc, type, value, min_purchase: min, usage_limit: limit, usage_count: 0, is_active: isActive, show_in_list: true
        };

        let error;
        if(id) {
             // Exclude usage_count on update usually, but here we just update basic fields
             delete payload.usage_count; 
             const res = await supabase.from("coupons").update(payload).eq("id", id);
             error = res.error;
        } else {
             const res = await supabase.from("coupons").insert([payload]);
             error = res.error;
        }
        
        if(!error) {
            showSuccessToast(id ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            closeCreateCoupon();
            loadAdminCoupons();
        } else { alert(error.message); }
    }

    async function loadAdminCoupons() {
        const { data } = await supabase.from("coupons").select("*").order("created_at");
        const container = document.getElementById("admin-coupons-content");
        container.innerHTML = data.map(c => `
          <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
             <div class="flex-1 mr-4">
                <div class="font-bold text-slate-800">${c.code}</div>
                <div class="text-xs text-slate-500">${c.name} | ‡∏•‡∏î ${c.type === 'percent' ? c.value + '%' : c.value + ' ‡∏ø'}</div>
                <div class="text-xs ${c.is_active ? 'text-green-500' : 'text-red-500'} mt-1">${c.is_active ? 'üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'üî¥ ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}</div>
             </div>
             <div class="flex gap-2">
                <button onclick="openCouponHistoryModal('${c.code}', '${c.name}')" class="w-8 h-8 flex items-center justify-center bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition"><i class="fa-solid fa-clock-rotate-left text-xs"></i></button>
                <button onclick='openEditCouponModal(${JSON.stringify(c).replace(/'/g, "&#39;")})' class="w-8 h-8 flex items-center justify-center bg-yellow-50 text-yellow-600 rounded-lg hover:bg-yellow-100 transition"><i class="fa-solid fa-pen text-xs"></i></button>
                <button onclick="deleteCoupon(${c.id})" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition"><i class="fa-solid fa-trash text-xs"></i></button>
             </div>
          </div>
        `).join('');
    }
    
    // New: Open Coupon History Modal
    async function openCouponHistoryModal(code, name) {
        const modal = document.getElementById("coupon-history-modal");
        const listContainer = document.getElementById("coupon-history-list");
        const titleEl = document.getElementById("history-coupon-code");
        
        titleEl.textContent = `${code} (${name})`;
        listContainer.innerHTML = "<p class='text-center text-slate-400 py-4'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>";
        
        toggleModal("coupon-history-modal", true);
        
        try {
             // Find orders with this coupon code
             const { data: orders, error } = await supabase
                 .from("orders")
                 .select("created_at, total_price, users(display_name, picture_url)")
                 .eq("coupon_code", code)
                 .order("created_at", {ascending: false});
                 
             if (error) throw error;
             
             if (!orders || orders.length === 0) {
                 listContainer.innerHTML = "<p class='text-center text-slate-400 py-4'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>";
             } else {
                 listContainer.innerHTML = orders.map(o => `
                    <div class="flex items-center justify-between p-2 border-b border-slate-100 last:border-0">
                       <div class="flex items-center gap-2">
                          <img src="${o.users?.picture_url || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="w-8 h-8 rounded-full object-cover">
                          <div>
                             <div class="text-sm font-bold text-slate-700">${o.users?.display_name || 'Unknown'}</div>
                             <div class="text-xs text-slate-400">${new Date(o.created_at).toLocaleDateString('th-TH')}</div>
                          </div>
                       </div>
                       <div class="text-sm font-bold text-green-600">
                          ${o.total_price} ‡∏ø
                       </div>
                    </div>
                 `).join('');
             }
             
        } catch (e) {
            console.error("Error loading history", e);
            listContainer.innerHTML = "<p class='text-center text-red-400 py-4'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>";
        }
    }

    async function deleteCoupon(id) {
        if(confirm("‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")) {
            await supabase.from("coupons").delete().eq("id", id);
            loadAdminCoupons();
        }
    }
    
    // -- Admin Desserts & Brownie Logic --
    async function loadAdminDesserts() {
      const { data } = await supabase.from("desserts").select("*").order("id");
      const container = document.getElementById("admin-dessert-list");
      container.innerHTML = data.map(d => `
        <div class="bg-white p-3 rounded-xl border shadow-sm flex justify-between items-center">
          <div class="flex items-center gap-3">
             <span class="text-2xl">${d.emoji||'?'}</span>
             <span class="font-bold text-sm">${d.name}</span>
          </div>
          <div class="flex gap-2">
             <button onclick="manageDessertItems(${d.id}, '${d.name}')" class="text-xs bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-100 hover:bg-indigo-100 transition">‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</button>
             <button onclick='openDessertModal("edit", ${JSON.stringify(d).replace(/'/g, "&#39;")})' class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
             <button onclick="deleteDessert(${d.id})" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">‡∏•‡∏ö</button>
          </div>
        </div>
      `).join('');
    }

    function manageDessertItems(id, name) {
        currentAdminDessertId = id;
        loadBrownieMenus(id);
        showAdminTab('brownie');
    }

    async function deleteDessert(id) {
        if(confirm("‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ? (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô)")) {
            await supabase.from("desserts").delete().eq("id", id);
            loadAdminDesserts();
        }
    }

    async function loadBrownieMenus(dessertId) {
       const { data } = await supabase.from("brownie_items").select("*").eq("dessert_id", dessertId).order("type");
       const container = document.getElementById("admin-brownie-list");
       if(data.length===0) container.innerHTML = "<div class='text-center text-slate-400'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>";
       else {
         container.innerHTML = renderBrownieList(data);
       }
    }
    
    function renderBrownieList(items) {
      if (!items || items.length === 0)
        return `<p class="text-gray-500 italic text-xs sm:text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;

      return items.map(i => `
        <div class="flex justify-between items-center border border-slate-200 p-3 rounded-xl mb-2 bg-white shadow-sm hover:shadow-md transition-all group">
          <div class="flex-1 min-w-0 mr-3">
            <div class="font-semibold text-slate-800 text-sm">${i.name}</div>
             <div class="text-xs text-slate-500 mt-0.5 flex items-center gap-2">
              <span class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-600">${i.price} ‡∏ø</span>
              ${i.is_active ? "<span class='text-green-600 flex items-center gap-1'><i class='fa-solid fa-circle text-[6px]'></i> ‡∏Ç‡∏≤‡∏¢</span>" : "<span class='text-red-400 flex items-center gap-1'><i class='fa-solid fa-circle text-[6px]'></i> ‡∏õ‡∏¥‡∏î</span>"}
            </div>
          </div>
          <div class="flex gap-1">
            <button class="w-8 h-8 flex items-center justify-center bg-yellow-50 text-yellow-600 rounded-lg hover:bg-yellow-100 transition" onclick="openBrownieModal('${i.type}', ${i.id})">
                <i class="fa-solid fa-pen text-xs"></i>
            </button>
            <button class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition" onclick="deleteBrownieItem(${i.id})">
                <i class="fa-solid fa-trash text-xs"></i>
            </button>
          </div>
        </div>
      `).join("");
    }
    
    async function deleteBrownieItem(id) {
        if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) {
            await supabase.from("brownie_items").delete().eq("id", id);
            loadBrownieMenus(currentAdminDessertId);
        }
    }

    // --- Admin User Management Logic ---
    async function loadAdminUsers() {
        const { data } = await supabase.from('users').select('*').order('created_at', { ascending: false });
        allUsers = data || [];
        renderAdminUsers(allUsers);
    }

    function renderAdminUsers(users) {
        const container = document.getElementById("admin-users-list");
        if (users.length === 0) {
            container.innerHTML = "<p class='text-center text-slate-400 col-span-full'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>";
            return;
        }
        
        container.innerHTML = users.map(u => {
            const isAdmin = adminList.includes(u.line_id);
            const adminBadge = isAdmin ? '<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded-full ml-1 border border-yellow-200">üëë Admin</span>' : '';
            
            return `
           <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-3 relative hover:shadow-md transition-all">
               <div class="flex items-center gap-3">
                   <img src="${u.picture_url || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="w-10 h-10 rounded-full object-cover border border-slate-100 shadow-sm">
                   <div class="flex-1 min-w-0">
                       <div class="font-bold text-slate-800 flex items-center text-sm truncate">
                            ${u.display_name || 'Guest'} ${adminBadge}
                       </div>
                       <div class="text-xs text-slate-500 truncate cursor-pointer hover:text-blue-600 flex items-center gap-1" onclick="copyToClipboard('${u.line_id}')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID">
                          ID: ${u.line_id.substring(0, 8)}... <i class="fa-regular fa-copy text-[10px]"></i>
                       </div>
                   </div>
                   <div class="text-right">
                      <div class="text-[10px] text-slate-400">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
                      <div class="text-lg font-bold text-orange-500 leading-none">${u.points || 0}</div>
                   </div>
               </div>
               
               <div class="grid grid-cols-2 gap-2">
                   <button onclick="openAddPointsModal('${u.id}', '${u.display_name || 'Guest'}')" class="bg-blue-50 text-blue-600 text-xs py-1.5 rounded-lg hover:bg-blue-100 font-medium transition flex items-center justify-center gap-1 border border-blue-100">
                      <i class="fa-solid fa-plus-circle"></i> ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°
                   </button>
                   <button onclick="openGiveCouponModal('${u.id}', '${u.display_name || 'Guest'}')" class="bg-purple-50 text-purple-600 text-xs py-1.5 rounded-lg hover:bg-purple-100 font-medium transition flex items-center justify-center gap-1 border border-purple-100">
                      <i class="fa-solid fa-ticket"></i> ‡πÅ‡∏à‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                   </button>
                   <button onclick='openUserDetailsModal(${JSON.stringify(u).replace(/'/g, "&#39;")})' class="bg-slate-50 text-slate-600 text-xs py-1.5 rounded-lg hover:bg-slate-100 font-medium transition flex items-center justify-center gap-1 border border-slate-200">
                       <i class="fa-solid fa-address-card"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                   </button>
                   ${isAdmin ? 
                       `<button onclick="toggleAdmin('${u.line_id}', '${u.display_name}')" class="bg-red-50 text-red-600 text-xs py-1.5 rounded-lg hover:bg-red-100 font-medium transition flex items-center justify-center gap-1 border border-red-100"><i class="fa-solid fa-user-minus"></i> ‡∏õ‡∏•‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>` : 
                       `<button onclick="toggleAdmin('${u.line_id}', '${u.display_name}')" class="bg-yellow-50 text-yellow-700 text-xs py-1.5 rounded-lg hover:bg-yellow-100 font-medium transition flex items-center justify-center gap-1 border border-yellow-200"><i class="fa-solid fa-user-plus"></i> ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>`
                   }
               </div>
           </div>
        `;
        }).join('');
    }
    
    function copyToClipboard(text) {
        const tempInput = document.createElement("input");
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        showSuccessToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    }
    
    function toggleAdmin(lineId, name) {
        if (adminList.includes(lineId)) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                adminList = adminList.filter(id => id !== lineId);
                localStorage.setItem('suan_khanom_admins', JSON.stringify(adminList));
                showSuccessToast(`‡∏õ‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß`);
            }
        } else {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á "${name}" ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                adminList.push(lineId);
                localStorage.setItem('suan_khanom_admins', JSON.stringify(adminList));
                showSuccessToast(`‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
            }
        }
        loadAdminUsers(); // Refresh UI
    }

    function filterAdminUsers() {
        const txt = document.getElementById("admin-user-search").value.toLowerCase();
        const filtered = allUsers.filter(u => 
            (u.display_name || "").toLowerCase().includes(txt) || 
            (u.line_id || "").toLowerCase().includes(txt)
        );
        renderAdminUsers(filtered);
    }
    
    // User Details Logic
    async function openUserDetailsModal(user) {
        const modal = document.getElementById("user-details-modal");
        
        // Fill basic info
        document.getElementById("ud-pic").src = user.picture_url || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
        document.getElementById("ud-name").innerText = user.display_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
        document.getElementById("ud-line-id").innerText = 'Line ID: ' + user.line_id;
        document.getElementById("ud-points").innerText = user.points || 0;
        
        // Fetch stats
        const { count } = await supabase.from("orders").select('*', { count: 'exact', head: true }).eq('user_id', user.id);
        document.getElementById("ud-total-orders").innerText = count || 0;
        
        // Fetch recent history
        const { data: orders } = await supabase.from("orders").select('*').eq('user_id', user.id).order('created_at', {ascending: false}).limit(5);
        const historyContainer = document.getElementById("ud-order-history");
        
        if (!orders || orders.length === 0) {
            historyContainer.innerHTML = '<p class="text-center text-slate-400 text-xs py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>';
        } else {
            historyContainer.innerHTML = orders.map(o => `
                <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg border border-slate-100">
                    <div>
                        <div class="text-xs font-bold text-slate-700">#${o.id}</div>
                        <div class="text-[10px] text-slate-400">${new Date(o.created_at).toLocaleDateString('th-TH')}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-indigo-600">${o.total_price} ‡∏ø</div>
                        <div class="text-[10px] ${o.status === 'completed' ? 'text-green-500' : 'text-yellow-500'}">${o.status}</div>
                    </div>
                </div>
            `).join('');
        }
        
        toggleModal("user-details-modal", true);
    }

    // --- Points Logic ---
    function openAddPointsModal(userId, userName) {
        document.getElementById("add-points-user-id").value = userId;
        document.getElementById("add-points-user-name").innerText = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: " + userName;
        document.getElementById("points-amount").value = "";
        toggleModal("add-points-modal", true);
    }

    async function submitAddPoints() {
        const userId = document.getElementById("add-points-user-id").value;
        const amount = parseInt(document.getElementById("points-amount").value);
        
        if (!userId || isNaN(amount) || amount === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°");

        // Fetch current points
        const { data: user } = await supabase.from('users').select('points').eq('id', userId).single();
        const currentPoints = user ? user.points : 0;
        const newPoints = Math.max(0, currentPoints + amount);

        const { error } = await supabase.from('users').update({ points: newPoints }).eq('id', userId);
        
        if (!error) {
            showSuccessToast(amount > 0 ? `‡πÄ‡∏û‡∏¥‡πà‡∏° ${amount} ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à` : `‡∏•‡∏î ${Math.abs(amount)} ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            toggleModal("add-points-modal", false);
            loadAdminUsers(); // Refresh list
        } else {
            alert("Error: " + error.message);
        }
    }

    // --- Give Coupon Logic ---
    async function openGiveCouponModal(userId, userName) {
        document.getElementById("give-coupon-user-id").value = userId;
        document.getElementById("give-coupon-user-name").innerText = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: " + userName;
        
        // Load rewards for selection
        const rewardSelect = document.getElementById("reward-select");
        rewardSelect.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
        
        const { data: rewards } = await supabase.from('rewards').select('*').eq('is_active', true);
        
        if (!rewards || rewards.length === 0) {
            rewardSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</option>';
        } else {
            rewardSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• --</option>' + 
                rewards.map(r => `<option value="${r.id}">${r.name} (${r.points_required} ‡πÅ‡∏ï‡πâ‡∏°)</option>`).join('');
        }
        
        toggleModal("give-coupon-modal", true);
    }

    async function submitGiveCoupon() {
        const userId = document.getElementById("give-coupon-user-id").value;
        const rewardId = document.getElementById("reward-select").value;
        
        if (!userId || !rewardId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•");

        const code = "GIFT-" + Math.random().toString(36).substr(2, 6).toUpperCase();
        
        const { error } = await supabase.from("user_coupons").insert([{
            user_id: userId,
            reward_id: rewardId,
            coupon_code: code,
            is_used: false
        }]);
        
        if (!error) {
            showSuccessToast("‡∏°‡∏≠‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            toggleModal("give-coupon-modal", false);
        } else {
            alert("Error: " + error.message);
        }
    }

    // Forms Handlers
    document.getElementById("dessert-form").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("dessert-id").value;
        const name = document.getElementById("dessert-name").value;
        const emoji = document.getElementById("dessert-emoji").value;
        const desc = document.getElementById("dessert-desc").value;
        const active = document.getElementById("dessert-active").checked;
        const payload = { name, emoji, description: desc, is_active: active };
        
        let error;
        if(id) {
            const res = await supabase.from("desserts").update(payload).eq("id", id);
            error = res.error;
        } else {
            const res = await supabase.from("desserts").insert([payload]);
            error = res.error;
        }
        
        if(!error) {
            showSuccessToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            closeDessertModal();
            loadAdminDesserts();
        }
    };

    document.getElementById("brownie-form").onsubmit = async (e) => {
        e.preventDefault();
        if(!currentAdminDessertId) return alert("Error: No Dessert Selected");
        
        const type = document.getElementById("brownie-type").value;
        const name = document.getElementById("brownie-name").value;
        const desc = document.getElementById("brownie-desc").value;
        const price = document.getElementById("brownie-price").value;
        const points = document.getElementById("brownie-points").value;
        const active = document.getElementById("brownie-active").checked;
        
        const payload = { 
            dessert_id: currentAdminDessertId,
            type, name, description: desc, price, points, is_active: active 
        };
        
        const { error } = await supabase.from("brownie_items").insert([payload]);
        if(!error) {
            showSuccessToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            closeBrownieModal();
            loadBrownieMenus(currentAdminDessertId);
        }
    };
    
    // Admin Stats & Summary
    async function loadAdminStats() {
       const { data: orders } = await supabase.from("orders").select("total_price, status");
       const { count } = await supabase.from("users").select("*", {count:'exact', head:true});
       
       const totalRev = orders.reduce((s,o) => s + o.total_price, 0);
       const content = document.getElementById("admin-stats-content");
       content.innerHTML = `
         <div class="bg-indigo-600 text-white p-4 rounded-xl shadow-lg">
            <div class="text-sm opacity-80">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
            <div class="text-2xl font-bold">${totalRev.toLocaleString()} ‡∏ø</div>
         </div>
         <div class="bg-white p-4 rounded-xl border shadow-sm">
            <div class="text-sm text-slate-500">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-2xl font-bold text-slate-800">${orders.length}</div>
         </div>
         <div class="bg-white p-4 rounded-xl border shadow-sm">
            <div class="text-sm text-slate-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
            <div class="text-2xl font-bold text-slate-800">${count}</div>
         </div>
       `;
    }
    
    async function loadOrderSummary() {
        const date = document.getElementById("summary-delivery-round").value; // Changed ID here
        const status = document.getElementById("summary-status").value;
        let q = supabase.from("orders").select("*");
        
        if(date) {
             // IMPORTANT: Filter by delivery_date, not created_at
             q = q.eq("delivery_date", date);
        } else {
             // If no date selected, don't load anything or show all?
             // Better to require date for clarity, or default to "upcoming"
        }
        
        if(status) q = q.eq("status", status);
        else q = q.neq("status", "cancelled"); // Default exclude cancelled
        
        const { data } = await q;
        const content = document.getElementById("summary-content");
        if(!data || data.length === 0) { content.innerHTML = "<p class='text-center text-slate-400 mt-4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</p>"; return; }
        
        // Count items
        const counts = {};
        data.forEach(o => {
            let items = [];
            try { items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; } catch(e) {}
            
            items.forEach(i => {
                const key = i.baseName + " + " + i.toppingName;
                counts[key] = (counts[key]||0) + (parseInt(i.quantity)||1);
            });
        });
        
        content.innerHTML = `
           <div class="mb-4 text-center">
              <div class="text-2xl font-bold text-indigo-600">${data.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
              <div class="text-sm text-slate-500">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ${data.reduce((s,o)=>s+o.total_price,0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
           </div>
           <div class="space-y-2">
              ${Object.entries(counts).map(([k,v]) => `
                 <div class="flex justify-between border-b pb-1 border-dashed border-slate-200">
                    <span class="text-slate-700 text-sm">${k}</span> 
                    <span class="font-bold text-indigo-600">${v} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                 </div>
              `).join('')}
           </div>
        `;
    }
    
    async function updateAllFilteredOrders() {
        const newStatus = document.getElementById("update-status-select").value;
        if(!newStatus) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ?")) return;
        
        const date = document.getElementById("summary-delivery-round").value; // Changed ID here
        const status = document.getElementById("summary-status").value;
        let q = supabase.from("orders").update({status: newStatus});
        
        if(date) {
             q = q.eq("delivery_date", date); // Filter by delivery_date
        }
        if(status) q = q.eq("status", status);
        else q = q.neq("status", "cancelled");
        
        const { error } = await q;
        if(!error) {
            showSuccessToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            loadOrderSummary();
        } else {
            alert("Update failed: " + error.message);
        }
    }

    // --- History View ---
    async function openOrderHistory() {
        document.getElementById("main-app").classList.add("hidden");
        document.getElementById("order-history").classList.remove("hidden");
        
        const { data } = await supabase.from("orders").select("*").eq("user_id", currentUser.id).order("created_at", {ascending: false});
        const list = document.getElementById("order-list");
        if (data.length === 0) list.innerHTML = "<p class='text-center text-slate-400 mt-10'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>";
        else {
            list.innerHTML = data.map(o => {
                // Parse items safely
                let items = [];
                try { 
                    items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; 
                } catch(e) { items = []; }
                
                // Calculate total quantity (sum of all item quantities)
                const totalQty = Array.isArray(items) ? items.reduce((sum, i) => sum + (parseInt(i.quantity) || 1), 0) : 0;
                
                // Format Delivery Date
                const dateOptions = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                const deliveryDateDisplay = o.delivery_date 
                    ? new Date(o.delivery_date).toLocaleDateString('th-TH', dateOptions) 
                    : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á';

                // Status Badge Color
                let statusClass = 'bg-gray-100 text-gray-600';
                let statusText = o.status;
                if(o.status === 'pending') { statusClass = 'bg-yellow-100 text-yellow-700'; statusText = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'; }
                else if(o.status === 'preparing') { statusClass = 'bg-blue-100 text-blue-700'; statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥'; }
                else if(o.status === 'ready') { statusClass = 'bg-green-100 text-green-700'; statusText = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á'; }
                else if(o.status === 'completed') { statusClass = 'bg-green-100 text-green-700'; statusText = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }
                else if(o.status === 'cancelled') { statusClass = 'bg-red-100 text-red-700'; statusText = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'; }

                return `
              <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                 <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-slate-800 text-lg">Order #${o.id}</span>
                    <span class="text-xs px-3 py-1 rounded-full font-medium ${statusClass}">${statusText}</span>
                 </div>
                 
                 <div class="space-y-2 mb-4 text-sm text-slate-600">
                    <div class="flex items-center gap-2">
                        <div class="w-6 text-center"><i class="fa-solid fa-truck-fast text-indigo-500"></i></div>
                        <div>‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á: <span class="font-semibold text-slate-800">${deliveryDateDisplay}</span></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 text-center"><i class="fa-solid fa-cubes-stacked text-orange-500"></i></div>
                        <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: <span class="font-semibold text-slate-800">${totalQty} ‡∏ä‡∏¥‡πâ‡∏ô</span> <span class="text-xs text-slate-400">(${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span></div>
                    </div>
                 </div>

                 <div class="border-t border-slate-100 pt-3 flex justify-between items-end">
                    <div class="text-xs text-slate-400">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(o.created_at).toLocaleDateString('th-TH')}</div>
                    <div class="text-right">
                        <div class="text-xs text-slate-400">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                        <div class="font-bold text-xl text-indigo-600">${o.total_price.toLocaleString()} ‡∏ø</div>
                    </div>
                 </div>
              </div>
            `;
            }).join('');
        }
    }
    
    function backToMain() {
        document.getElementById("order-history").classList.add("hidden");
        document.getElementById("main-app").classList.remove("hidden");
    }

    function showSuccessToast(msg) {
        const t = document.getElementById("success-message");
        document.getElementById("success-text").innerText = msg;
        t.classList.remove("hidden");
        setTimeout(() => t.classList.add("hidden"), 3000);
    }
    
    function filterAdminOrders() {
        const txt = document.getElementById("admin-order-search").value.toLowerCase();
        const filtered = allOrders.filter(o => o.id.toString().includes(txt) || (o.users?.display_name||"").toLowerCase().includes(txt));
        renderAdminOrderList(filtered);
    }
    
    function clearOrderFilters() {
        document.getElementById("admin-order-search").value = "";
        loadAdminOrders();
    }

    // Initial Load
    window.addEventListener("load", init);

    // Helpers for modal closing
    window.closeCreateReward = () => toggleModal('create-reward-modal', false);
    window.showCreateRewardForm = () => {
        // Reset form for Create
        document.getElementById('reward-id').value = '';
        document.getElementById('reward-name').value = '';
        document.getElementById('reward-description').value = '';
        document.getElementById('reward-points').value = '';
        document.getElementById('reward-value').value = '';
        document.getElementById('reward-min').value = 0;
        document.getElementById('reward-modal-title').innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•';
        toggleModal('create-reward-modal', true);
    };
    
    window.closeCreateCoupon = () => toggleModal('create-coupon-modal', false);
    window.showCreateCouponForm = () => {
        // Reset form for Create
        document.getElementById('coupon-id').value = '';
        document.getElementById('coupon-code').value = '';
        document.getElementById('coupon-title').value = '';
        document.getElementById('coupon-description').value = '';
        document.getElementById('coupon-value').value = '';
        document.getElementById('coupon-min').value = 0;
        document.getElementById('coupon-usage').value = 100;
        document.getElementById('coupon-modal-title').innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á';
        toggleModal('create-coupon-modal', true);
    };
    
    window.openEditRewardModal = (data) => {
        document.getElementById('reward-id').value = data.id;
        document.getElementById('reward-name').value = data.name;
        document.getElementById('reward-description').value = data.description;
        document.getElementById('reward-points').value = data.points_required;
        document.getElementById('reward-type').value = data.discount_type;
        document.getElementById('reward-value').value = data.discount_value;
        document.getElementById('reward-min').value = data.min_purchase;
        document.getElementById('reward-modal-title').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•';
        toggleModal('create-reward-modal', true);
    };

    window.openEditCouponModal = (data) => {
        document.getElementById('coupon-id').value = data.id;
        document.getElementById('coupon-code').value = data.code;
        document.getElementById('coupon-title').value = data.name;
        document.getElementById('coupon-description').value = data.description;
        document.getElementById('coupon-type').value = data.type;
        document.getElementById('coupon-value').value = data.value;
        document.getElementById('coupon-min').value = data.min_purchase;
        document.getElementById('coupon-usage').value = data.usage_limit;
        document.getElementById('coupon-active').checked = data.is_active;
        document.getElementById('coupon-modal-title').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á';
        toggleModal('create-coupon-modal', true);
    };
    
    window.openDessertModal = (type, data) => {
        const form = document.getElementById("dessert-form");
        form.reset();
        document.getElementById("dessert-id").value = "";
        document.getElementById("dessert-modal-title").innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π";
        if(type==='edit' && data) {
            document.getElementById("dessert-modal-title").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π";
            document.getElementById("dessert-id").value = data.id;
            document.getElementById("dessert-name").value = data.name;
            document.getElementById("dessert-emoji").value = data.emoji;
            document.getElementById("dessert-desc").value = data.description;
            document.getElementById("dessert-active").checked = data.is_active;
        }
        toggleModal('dessert-modal', true);
    };
    window.closeDessertModal = () => toggleModal('dessert-modal', false);
    
    window.openBrownieModal = (type, data) => {
        const form = document.getElementById("brownie-form");
        form.reset();
        document.getElementById("brownie-modal-title").innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (" + type + ")";
        document.getElementById("brownie-type").value = type;
        document.getElementById("brownie-active").checked = true;
        
        // If editing, preload data (need separate logic or pass data)
        // Here simplified for new only, edit handled inside renderBrownieList call
        if (typeof data === 'object') { // If full object passed
             document.getElementById("brownie-id").value = data.id;
             document.getElementById("brownie-modal-title").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö";
             document.getElementById("brownie-name").value = data.name;
             document.getElementById("brownie-desc").value = data.description || '';
             document.getElementById("brownie-price").value = data.price;
             document.getElementById("brownie-points").value = data.points;
             document.getElementById("brownie-active").checked = data.is_active;
        }
        
        toggleModal('brownie-modal', true);
    };
    window.closeBrownieModal = () => toggleModal('brownie-modal', false);

  </script>
</body>
</html>
