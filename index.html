<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SUAN KHANOM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
 <style>
  body {
    font-family: "Inter", sans-serif;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
    min-height: 100vh;
  }

  * { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

  .glass {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    border: none;
    font-weight: 500;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.8);
    color: #374151;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .card {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 1.25rem;
  }

  @media (min-width: 640px) {
    .card { padding: 1.5rem; }
  }

  .selected {
    border: 4px solid #1d4ed8 !important;
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(29, 78, 216, 0.5);
  }

  .quantity-btn {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
  }

  @media (min-width: 640px) {
    .quantity-btn {
      width: 2.75rem;
      height: 2.75rem;
      font-size: 1.25rem;
    }
  }

  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }
  .float { animation: float 3s ease-in-out infinite; }

  .loading-screen {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .menu-card {
    background: white;
    border-radius: 1rem;
    border: 2px solid #e5e7eb;
    padding: 1rem;
    text-align: center;
    transition: all 0.25s ease;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  }

  .menu-card:hover {
    border-color: #6366f1;
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(99, 102, 241, 0.2);
  }

  .menu-card.selected {
    border: 3px solid #3b82f6;
    box-shadow: 0 0 12px rgba(59, 130, 246, 0.3);
    transform: scale(1.03);
  }

  .menu-card .title {
    font-weight: 600;
    color: #1e293b;
    margin-top: 0.375rem;
    font-size: 0.875rem;
  }

  @media (min-width: 640px) {
    .menu-card .title { font-size: 0.9375rem; }
  }

  .menu-card .price {
    font-size: 0.8125rem;
    color: #2563eb;
    margin-top: 0.125rem;
  }

  @media (min-width: 640px) {
    .menu-card .price { font-size: 0.875rem; }
  }

  .logo-image {
    width: 7rem;
    height: 7rem;
    border-radius: 50%;
    object-fit: cover;
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  @media (min-width: 640px) {
    .logo-image {
      width: 8rem;
      height: 8rem;
    }
  }

  .shop-closed-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 60;
    padding: 1rem;
  }

  h1 {
    font-size: 1.75rem;
  }

  @media (min-width: 640px) {
    h1 { font-size: 2rem; }
  }
  #dessert-list, #base-list, #topping-list {
  display: grid !important;
  grid-template-columns: 1fr !important;
  gap: 1rem !important;
}

@media (min-width: 640px) {
  #dessert-list, #base-list, #topping-list {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}

@media (min-width: 780px) {
  #dessert-list, #base-list, #topping-list {
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 1.5rem !important;
  }
}

@media (min-width: 1200px) {
  #dessert-list, #base-list, #topping-list {
    grid-template-columns: repeat(4, 1fr) !important;
  }
}

</style>


</head>
<body class="min-h-full">
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="text-center">
      <div class="spinner mb-4 mx-auto"></div>
      <p class="text-white text-lg sm:text-xl font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>
  </div>

  <!-- Shop Closed Overlay -->
  <div id="shop-closed-overlay" class="shop-closed-overlay hidden">
    <div class="bg-white rounded-2xl p-6 sm:p-8 max-w-md text-center shadow-2xl">
      <div class="text-5xl sm:text-6xl mb-4">üò¥</div>
      <h3 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3">‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
      <p class="text-sm sm:text-base text-gray-600 mb-6">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
      <button onclick="closeShopClosedOverlay()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-medium text-sm sm:text-base">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
      </button>
    </div>
  </div>

<header id="main-header" class="glass shadow-sm border-b border-white/20 sticky top-0 z-40 hidden">
  <div class="max-w-6xl mx-auto px-3 sm:px-4 py-2 sm:py-3">
    <div class="flex items-center justify-between gap-2 sm:gap-3 flex-nowrap overflow-x-auto">

      <!-- üéØ ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢: ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° -->
      <div class="flex items-center space-x-2 sm:space-x-3 flex-shrink-0">
        <div class="text-base sm:text-xl">ü™ô</div>
        <div class="leading-tight">
          <div class="text-xs text-gray-500">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
          <div class="font-semibold text-gray-900 text-sm sm:text-base">
            <span id="userPoints" class="text-orange-600 font-semibold">0</span> ‡πÅ‡∏ï‡πâ‡∏°
          </div>
        </div>
      </div>

      <!-- ü∞†‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤: ‡πÄ‡∏°‡∏ô‡∏π + ‡∏£‡∏π‡∏õ + ‡∏ä‡∏∑‡πà‡∏≠ -->
      <div class="flex items-center justify-end gap-2 sm:gap-3 flex-shrink-0 ml-auto">
        
        <!-- ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
        <button onclick="showCart()" 
          class="bg-orange-500 hover:bg-orange-600 text-white rounded-xl flex items-center justify-center gap-1 px-3 py-2 text-xs sm:text-sm relative">
          <span>üõí</span>
          <span class="hidden sm:inline">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
          <span id="cart-badge" 
                class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
        </button>

        <!-- ‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á") -->
        <button onclick="showRewards()" 
          class="bg-purple-500 hover:bg-purple-600 text-white rounded-xl flex items-center justify-center gap-1 px-3 py-2 text-xs sm:text-sm">
          <span>üéÅ</span>
          <span class="hidden sm:inline">‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</span>
        </button>

        <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
        <button onclick="openOrderHistory()" 
          class="btn-secondary rounded-xl flex items-center justify-center gap-1 px-3 py-2 text-xs sm:text-sm">
          <span>üìã</span>
          <span class="hidden sm:inline">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
        </button>

        <!-- ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô -->
        <button id="admin-btn" onclick="showAdmin()" 
          class="bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl flex items-center justify-center gap-1 px-3 py-2 text-xs sm:text-sm hidden">
          <span>üë®‚Äçüíº</span>
          <span class="hidden sm:inline">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span>
        </button>

        <!-- ‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î -->
        <img id="userPic" src="" alt="Profile"
             class="w-8 h-8 sm:w-9 sm:h-9 rounded-full border border-gray-300 object-cover" />

        <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ -->
        <span id="userName" 
              class="hidden sm:inline text-xs sm:text-sm font-medium text-gray-800 whitespace-nowrap ml-1 sm:ml-2"></span>
      </div>
    </div>
  </div>
</header>


  <main id="main-app" class="max-w-none w-full mx-auto px-3 sm:px-4 py-4 sm:py-6 lg:py-8 hidden">
  <div class="text-center mb-6 sm:mb-8 lg:mb-12">
    <img src="https://i.postimg.cc/8PwWyXdd/s-thxng-thangkar-re-ybng-ay-w-np-ym-ha-rach-Instagram-phost-1.png" 
         alt="SUAN KHANOM Logo" 
         class="logo-image mx-auto mb-3 sm:mb-4 float" />
    <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-2" style="background: linear-gradient(135deg, #1f2937, #374151); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
      SUAN KHANOM
    </h1>
    <p class="text-gray-600 text-sm sm:text-base lg:text-lg mb-3 sm:mb-4">‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì</p>
  </div>

  <!-- ü∞†‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏° -->
  <section id="dessert-selection" class="mb-4 sm:mb-6">
    <h2 class="text-base sm:text-lg lg:text-xl font-bold text-slate-700 mb-3 sm:mb-4 text-center sm:text-left border-b-2 border-indigo-100 pb-1">
      ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°
    </h2>
    <div id="dessert-list" class="grid w-full"></div>
  </section>

  <!-- üßä ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö -->
  <section id="menu-selection" class="mb-4 sm:mb-6 hidden">
    <h2 class="text-base sm:text-lg lg:text-xl font-bold text-slate-700 mb-3 sm:mb-4 text-center sm:text-left border-b-2 border-indigo-100 pb-1">
      ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
    </h2>

    <div class="mb-4 sm:mb-6">
      <h3 class="text-sm sm:text-base lg:text-lg font-semibold text-slate-600 mb-3 text-center sm:text-left">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ (Base)
      </h3>
      <div id="base-list" class="grid w-full"></div>
    </div>

    <div>
      <h3 class="text-sm sm:text-base lg:text-lg font-semibold text-slate-600 mb-3 text-center sm:text-left">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (Topping)
      </h3>
      <div id="topping-list" class="grid w-full"></div>
    </div>
  </section>
    
    <section id="quantity-section" class="card mb-4 sm:mb-6 hover-lift">
      <h2 class="text-base sm:text-lg lg:text-xl font-semibold text-gray-900 mb-4 sm:mb-6 flex items-center justify-center sm:justify-start">
        <span class="mr-2 text-xl sm:text-2xl">üì¶</span> 
        <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</span>
      </h2>
      
      <div class="flex items-center justify-center space-x-4 sm:space-x-6">
        <button onclick="changeQuantity(-1)" class="quantity-btn bg-red-500 hover:bg-red-600 text-white active:scale-95">
          ‚àí
        </button>

        <div class="text-center">
          <div class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900" id="quantity">1</div>
          <div class="text-xs sm:text-sm text-gray-500 mt-1 sm:mt-2">‡∏ä‡∏¥‡πâ‡∏ô</div>
        </div>

        <button onclick="changeQuantity(1)" class="quantity-btn bg-green-500 hover:bg-green-600 text-white active:scale-95">
          +
        </button>
      </div>
    </section>

    <section class="card text-center hover-lift">
      <div class="mb-4 sm:mb-6">
        <div class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">
          üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <span id="total-price">0</span> ‡∏ö‡∏≤‡∏ó
        </div>
      </div>

      <button id="add-to-cart" onclick="addToCart()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold text-sm sm:text-base lg:text-lg disabled:bg-gray-400 disabled:cursor-not-allowed w-full sm:w-auto active:scale-95" disabled>
        üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      </button>
    </section>
  </main>

  <!-- Order History -->
  <section id="order-history" class="hidden px-3 sm:px-4 py-4 sm:py-6 max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-base sm:text-lg lg:text-xl font-semibold text-purple-800 flex items-center gap-2">
        <span class="text-xl sm:text-2xl">üì¶</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
      </h2>
      <button onclick="backToMain()" class="px-3 sm:px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md transition text-xs sm:text-sm lg:text-base">
        ‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </button>
    </div>
    <div id="order-list" class="space-y-3 sm:space-y-4"></div>
  </section>

  <!-- Rewards Modal (‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°) -->
  <div id="rewards-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-3 sm:p-4" onclick="closeModalOnBackdrop(event, 'rewards-modal')">
    <div class="card max-w-4xl w-full max-h-[85vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4 sm:mb-6">
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">üéÅ ‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
        <button onclick="closeRewards()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      
      <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ -->
      <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl p-4 mb-6">
        <div class="text-sm opacity-90">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
        <div class="text-3xl font-bold"><span id="modal-user-points">0</span> ‡πÅ‡∏ï‡πâ‡∏°</div>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô -->
      <div class="mb-6">
        <button onclick="showMyCoupons()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium text-sm sm:text-base">
          üé´ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
        </button>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÑ‡∏î‡πâ -->
      <h4 class="font-semibold text-gray-900 mb-4">üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</h4>
      <div id="rewards-content" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
    </div>
  </div>

  <!-- My Coupons Modal (‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô) -->
  <div id="my-coupons-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-3 sm:p-4" onclick="closeModalOnBackdrop(event, 'my-coupons-modal')">
    <div class="card max-w-4xl w-full max-h-[85vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4 sm:mb-6">
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">üé´ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        <button onclick="closeMyCoupons()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <div id="my-coupons-content" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-3 sm:p-4" onclick="closeModalOnBackdrop(event, 'cart-modal')">
    <div class="card max-w-2xl w-full max-h-[85vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4 sm:mb-6">
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <div id="cart-content" class="mb-4 sm:mb-6"></div>
      
      <div id="coupon-section" class="mb-4 sm:mb-6 p-3 sm:p-4 bg-purple-50 rounded-xl">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-gray-900 text-sm sm:text-base">üé´ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h4>
          <button onclick="showMyCouponsForCart()" class="text-purple-600 text-xs sm:text-sm hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        </div>
        <div id="selected-coupon" class="hidden mb-3 p-3 bg-white rounded-lg border-2 border-purple-300">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium text-purple-900 text-sm sm:text-base" id="coupon-name"></div>
              <div class="text-xs sm:text-sm text-purple-700" id="coupon-desc"></div>
            </div>
            <button onclick="removeCoupon()" class="text-red-500 hover:text-red-700 text-xs sm:text-sm font-medium">‡∏•‡∏ö</button>
          </div>
        </div>
        <div class="flex gap-2">
          <input type="text" id="coupon-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á" class="flex-1 px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" />
          <button onclick="applyCouponCode()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium text-xs sm:text-sm">‡πÉ‡∏ä‡πâ</button>
        </div>
        <div id="coupon-message" class="text-xs sm:text-sm mt-2 hidden"></div>
      </div>

      <div class="border-t pt-4">
        <div class="space-y-2 mb-4">
          <div class="flex justify-between text-gray-700 text-sm sm:text-base">
            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
            <span id="cart-subtotal">0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div id="discount-row" class="flex justify-between text-green-600 hidden text-sm sm:text-base">
            <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
            <span id="discount-amount">-0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div class="flex justify-between items-center text-base sm:text-lg lg:text-xl font-bold border-t pt-2">
            <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
            <span id="cart-total" class="text-blue-600">0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>
        <button onclick="checkout()" class="btn-primary w-full py-3 rounded-xl font-semibold text-sm sm:text-base lg:text-lg">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-3 sm:p-4" onclick="closeModalOnBackdrop(event, 'admin-modal')">
    <div class="card max-w-6xl w-full max-h-[90vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4 sm:mb-6">
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">üë®‚Äçüíº Admin Dashboard</h3>
        <button onclick="closeAdmin()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>

      <div class="flex space-x-2 sm:space-x-4 mb-4 sm:mb-6 border-b overflow-x-auto">
        <button onclick="showAdminTab('shop-status')" class="admin-tab px-3 sm:px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600 text-xs sm:text-sm whitespace-nowrap" data-tab="shop-status">
          ü™†‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô
        </button>
        <button onclick="showAdminTab('orders')" class="admin-tab px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-xs sm:text-sm whitespace-nowrap" data-tab="orders">
          üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        </button>
        <button onclick="showAdminTab('rewards')" class="admin-tab px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-xs sm:text-sm whitespace-nowrap" data-tab="rewards">
          üéÅ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
        </button>
        <button onclick="showAdminTab('coupons')" class="admin-tab px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-xs sm:text-sm whitespace-nowrap" data-tab="coupons">
          üé´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
        </button>
        <button onclick="showAdminTab('stats')" class="admin-tab px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-xs sm:text-sm whitespace-nowrap" data-tab="stats">
          üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        </button>
        <button onclick="showAdminTab('desserts')" class="admin-tab px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-xs sm:text-sm whitespace-nowrap" data-tab="desserts">
          ü∞†‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°
        </button>
        <button onclick="showAdminTab('brownie')" class="admin-tab px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-xs sm:text-sm whitespace-nowrap" data-tab="brownie">
          üìÇ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
        </button>
        <button onclick="showAdminTab('summary')" class="admin-tab px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-xs sm:text-sm whitespace-nowrap" data-tab="summary">
          üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        </button>
      </div>

      <!-- Shop Status Tab -->
      <section id="admin-shop-status-tab" class="admin-tab-content">
        <div class="max-w-2xl mx-auto text-center">
          <div class="text-5xl sm:text-6xl mb-4" id="shop-status-icon">ü™†</div>
          <h3 class="text-xl sm:text-2xl font-bold mb-4" id="shop-status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
          <p class="text-sm sm:text-base text-gray-600 mb-6">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ</p>
          <button id="toggle-shop-btn" onclick="toggleShopStatus()" class="px-6 py-3 rounded-xl font-semibold text-base sm:text-lg">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
          </button>
        </div>
      </section>

      <!-- Orders Tab -->
      <div id="admin-orders-tab" class="admin-tab-content hidden">
        <div class="mb-4 space-y-3">
          <div class="flex flex-wrap gap-3">
            <input type="date" id="admin-order-date" class="border rounded-lg px-3 py-2 text-xs sm:text-sm" />
            <input type="text" id="admin-order-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå..." class="flex-1 min-w-[200px] border rounded-lg px-3 py-2 text-xs sm:text-sm" />
            <button onclick="filterAdminOrders()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-xs sm:text-sm">
              üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
            <button onclick="clearOrderFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs sm:text-sm">
              ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
            </button>
          </div>
        </div>
        <div id="admin-orders-content"></div>
      </div>

      <!-- Rewards Tab (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•) -->
      <div id="admin-rewards-tab" class="admin-tab-content hidden">
        <div class="mb-4 sm:mb-6">
          <button onclick="showCreateRewardForm()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium text-xs sm:text-sm lg:text-base">
            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
        <div id="admin-rewards-content"></div>
      </div>

      <!-- Coupons Tab (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á) -->
      <div id="admin-coupons-tab" class="admin-tab-content hidden">
        <div class="mb-4 sm:mb-6">
          <button onclick="showCreateCouponForm()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium text-xs sm:text-sm lg:text-base">
            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
        <div id="admin-coupons-content"></div>
      </div>

      <!-- Summary Tab (‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞) -->
      <div id="admin-summary-tab" class="admin-tab-content hidden space-y-4">
        <div class="flex flex-wrap gap-3 items-center">
          <input type="date" id="summary-date" class="border rounded-lg px-3 py-2 shadow-sm text-xs sm:text-sm" placeholder="‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö">
          <select id="summary-status" class="border rounded-lg px-3 py-2 shadow-sm text-xs sm:text-sm">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="pending">üïì ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="preparing">üë®‚Äçüç≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
            <option value="ready">üöö ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
            <option value="completed">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
            <option value="cancelled">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
          </select>
          <button onclick="loadOrderSummary()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-xs sm:text-sm">
            ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ
          </button>
          <button onclick="updateAllFilteredOrders()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition text-xs sm:text-sm">
            ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </button>
        </div>
        <div id="summary-content" class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200 min-h-[150px]">
          <p class="text-gray-500 text-center text-xs sm:text-sm">üìÜ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
        </div>
      </div>

      <!-- Stats Tab -->
      <div id="admin-stats-tab" class="admin-tab-content hidden">
        <div id="admin-stats-content" class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4"></div>
      </div>

      <!-- Desserts Tab -->
      <section id="admin-desserts-tab" class="admin-tab-content hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-base sm:text-lg lg:text-xl font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏° (Desserts)</h3>
          <button class="btn-primary px-3 py-2 text-xs sm:text-sm lg:text-base" onclick="openDessertModal('new')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <div id="admin-dessert-list" class="space-y-2"></div>
      </section>

      <!-- Brownie Tab -->
      <section id="admin-brownie-tab" class="admin-tab-content hidden">
        <h3 class="text-base sm:text-lg lg:text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
        <div class="flex gap-2 sm:gap-4 mb-4 flex-wrap">
          <button class="btn-primary px-3 py-2 text-xs sm:text-sm" onclick="openBrownieModal('base', null)">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ (Base)
          </button>
          <button class="btn-primary px-3 py-2 text-xs sm:text-sm" onclick="openBrownieModal('topping', null)">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤ (Topping)
          </button>
        </div>
        <div id="admin-brownie-list" class="space-y-2"></div>
      </section>
    </div>
  </div>

  <!-- Create Reward Modal -->
  <div id="create-reward-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-3 sm:p-4" onclick="closeModalOnBackdrop(event, 'create-reward-modal')">
    <div class="card max-w-md w-full hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4 sm:mb-6">
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà</h3>
        <button onclick="closeCreateReward()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <form onsubmit="createReward(event)" class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
          <input type="text" id="reward-name" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏•‡∏î 10%" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
          <input type="text" id="reward-description" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏î 10% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ</label>
          <input type="number" id="reward-points" required min="1" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <select id="reward-type" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm">
            <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</option>
            <option value="fixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <input type="number" id="reward-value" required min="1" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="reward-min" value="0" min="0" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" />
        </div>
        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold text-xs sm:text-sm lg:text-base">
          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
        </button>
      </form>
    </div>
  </div>

  <!-- Create Coupon Modal (‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤) -->
  <div id="create-coupon-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-3 sm:p-4" onclick="closeModalOnBackdrop(event, 'create-coupon-modal')">
    <div class="card max-w-md w-full hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4 sm:mb-6">
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
        <button onclick="closeCreateCoupon()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <form onsubmit="createCoupon(event)" class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input type="text" id="coupon-code" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô WELCOME10" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input type="text" id="coupon-title" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏î 10%" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
          <input type="text" id="coupon-description" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏î 10% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <select id="coupon-type" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm">
            <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</option>
            <option value="fixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <input type="number" id="coupon-value" required min="1" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="coupon-min" value="0" min="0" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" />
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
          <input type="number" id="coupon-usage" value="1" min="1" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs sm:text-sm" />
        </div>
        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold text-xs sm:text-sm lg:text-base">
          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
        </button>
      </form>
    </div>
  </div>

  <!-- Dessert Modal -->
  <div id="dessert-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 sm:p-4 z-50">
    <div class="glass rounded-xl p-4 sm:p-6 w-full max-w-md shadow-2xl border-t border-white/30">
      <h3 id="dessert-modal-title" class="text-lg sm:text-xl lg:text-2xl font-bold mb-4">‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°</h3>
      <form id="dessert-form">
        <input type="hidden" id="dessert-id" />
        <div class="mb-3">
          <label class="block text-xs sm:text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π:</label>
          <input id="dessert-name" class="w-full p-2 border rounded text-xs sm:text-sm" required />
        </div>
        <div class="mb-3">
          <label class="block text-xs sm:text-sm font-medium mb-1">Emoji (ü´ê):</label>
          <input id="dessert-emoji" class="w-full p-2 border rounded text-xs sm:text-sm" />
        </div>
        <div class="mb-3">
          <label class="block text-xs sm:text-sm font-medium mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</label>
          <textarea id="dessert-desc" class="w-full p-2 border rounded text-xs sm:text-sm"></textarea>
        </div>
        <div class="flex items-center gap-2 mb-3">
          <input type="checkbox" id="dessert-active" checked />
          <label class="text-xs sm:text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</label>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" class="btn-secondary px-4 py-2 text-xs sm:text-sm" onclick="closeDessertModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="btn-primary px-4 py-2 text-xs sm:text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Brownie Modal -->
  <div id="brownie-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 p-3 sm:p-4">
    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 w-full max-w-md mx-4">
      <h3 id="brownie-modal-title" class="text-base sm:text-lg lg:text-xl font-semibold mb-4">ü∞†‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>
      <form id="brownie-form" class="space-y-3">
        <input type="hidden" id="brownie-id">
        <input type="hidden" id="brownie-type">
        <div>
          <label class="block text-xs sm:text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π (‡πÉ‡∏™‡πà‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÑ‡∏î‡πâ)</label>
          <input id="brownie-name" class="w-full border rounded px-3 py-2 text-xs sm:text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ü´ê ‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà‡πÇ‡∏Å‡πÇ‡∏Å‡πâ" required>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
          <textarea id="brownie-desc" class="w-full border rounded px-3 py-2 text-xs sm:text-sm" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏™‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô ‡∏´‡∏≠‡∏°‡πÇ‡∏Å‡πÇ‡∏Å‡πâ"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs sm:text-sm font-medium mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
            <input id="brownie-price" type="number" step="0.01" class="w-full border rounded px-3 py-2 text-xs sm:text-sm" required>
          </div>
          <div>
            <label class="block text-xs sm:text-sm font-medium mb-1">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ</label>
            <input id="brownie-points" type="number" class="w-full border rounded px-3 py-2 text-xs sm:text-sm" required>
          </div>
        </div>
        <label class="flex items-center gap-2 mt-2">
          <input id="brownie-active" type="checkbox" class="w-4 h-4">
          <span class="text-xs sm:text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ</span>
        </label>
        <div class="flex justify-end gap-2 pt-3 border-t mt-4">
          <button type="button" onclick="closeBrownieModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-xs sm:text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs sm:text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Message -->
  <div id="success-message" class="fixed top-20 right-4 card shadow-lg hidden z-50 max-w-sm">
    <div class="flex items-center space-x-3">
      <div class="text-xl sm:text-2xl">üéâ</div>
      <div id="success-text" class="font-medium text-gray-900 text-xs sm:text-sm"></div>
    </div>
  </div>

  <script>
    const LIFF_ID = "2008357926-Ly07A5w2";
    const SUPABASE_URL = "https://dyorwbjagjlkqpbrdjwk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5b3J3YmphZ2psa3FwYnJkandrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjk2NjgsImV4cCI6MjA3Njk0NTY2OH0.bZJRcaM3u9NUBrux5AbPXOXVtcSnJHDdK15gCQ-9Zc4";
    const ADMIN_IDS = ["Ud21a04a5d66c9de0b4c6f1aaf8f050e2","U5301bd5962323787574d82f86f3d954e"];

    let supabase;
    let userProfile = null;
    let currentUser = null;
    let selectedBase = null;
    let selectedTopping = null;
    let quantity = 1;
    let cart = [];
    let userPoints = 0;
    let selectedCoupon = null;
    let availableRewards = [];
    let availableCoupons = [];
    let userCoupons = [];
    let allDesserts = [];
    let selectedDessert = null;
    let currentAdminDessertId = null;
    let allItems = [];
    let shopIsOpen = true;
    let allOrders = [];
    
    async function init() {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("‚úÖ Supabase initialized");

        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        userProfile = await liff.getProfile();
        await saveUserToSupabase(userProfile);
        await loadUserData(userProfile.userId);
        await loadRewards();
        await loadUserCoupons();
        await loadCoupons();
        await loadDesserts();
        await loadShopStatus();

        if (ADMIN_IDS.includes(userProfile.userId)) {
          document.getElementById("admin-btn").classList.remove("hidden");
        }

        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("main-header").classList.remove("hidden");
        document.getElementById("main-app").classList.remove("hidden");
      } catch (error) {
        console.error("‚ùå Init error:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
      }
    }

    async function loadShopStatus() {
      try {
        const { data, error } = await supabase
          .from("shop_settings")
          .select("is_open")
          .eq("id", 1)
          .maybeSingle();

        if (error && error.code !== "PGRST116") throw error;

        if (data) {
          shopIsOpen = data.is_open;
        } else {
          await supabase.from("shop_settings").insert([{ id: 1, is_open: true }]);
          shopIsOpen = true;
        }

        console.log("ü™†Shop status:", shopIsOpen ? "Open" : "Closed");
      } catch (error) {
        console.error("‚ùå Error loading shop status:", error);
        shopIsOpen = true;
      }
    }

    async function toggleShopStatus() {
      try {
        shopIsOpen = !shopIsOpen;

        const { error } = await supabase
          .from("shop_settings")
          .upsert({ id: 1, is_open: shopIsOpen });

        if (error) throw error;

        updateShopStatusUI();
        showMessage(shopIsOpen ? "‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß" : "üîí ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß");
      } catch (error) {
        console.error("‚ùå Error toggling shop status:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô");
        shopIsOpen = !shopIsOpen;
      }
    }

    function updateShopStatusUI() {
      const icon = document.getElementById("shop-status-icon");
      const text = document.getElementById("shop-status-text");
      const btn = document.getElementById("toggle-shop-btn");

      if (shopIsOpen) {
        icon.textContent = "ü™†";
        text.textContent = "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå";
        btn.textContent = "üîí ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
        btn.className = "px-6 py-3 rounded-xl font-semibold text-base sm:text-lg bg-red-500 hover:bg-red-600 text-white";
      } else {
        icon.textContent = "üò¥";
        text.textContent = "‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå";
        btn.textContent = "ü™†‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
        btn.className = "px-6 py-3 rounded-xl font-semibold text-base sm:text-lg bg-green-500 hover:bg-green-600 text-white";
      }
    }

    function closeShopClosedOverlay() {
      document.getElementById("shop-closed-overlay").classList.add("hidden");
    }

    async function saveUserToSupabase(profile) {
      try {
        const { data: existingUser, error: findError } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", profile.userId)
          .maybeSingle();

        if (findError && findError.code !== "PGRST116") throw findError;

        if (!existingUser) {
          const { error: insertError } = await supabase
            .from("users")
            .insert([{
              line_id: profile.userId,
              display_name: profile.displayName,
              picture_url: profile.pictureUrl,
              points: 0
            }]);

          if (insertError) throw insertError;
          console.log("‚úÖ New user created");
        } else {
          console.log("üü¢ User exists");
        }
      } catch (error) {
        console.error("‚ùå Error saving user:", error);
        throw error;
      }
    }

    async function loadUserData(userId) {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", userId)
          .single();

        if (error) throw error;

        currentUser = data;
        userPoints = data.points || 0;

        document.getElementById("userPic").src = data.picture_url;
        document.getElementById("userPoints").textContent = userPoints;
        document.getElementById("userName").textContent = data.display_name || "";

        console.log("‚úÖ User data loaded:", data);
      } catch (error) {
        console.error("‚ùå Error loading user data:", error);
        throw error;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
    async function loadRewards() {
      try {
        const { data, error } = await supabase
          .from("rewards")
          .select("*")
          .eq("is_active", true)
          .order("points_required", { ascending: true });

        if (error) throw error;

        availableRewards = data || [];
        console.log("‚úÖ Rewards loaded:", availableRewards.length);
      } catch (error) {
        console.error("‚ùå Error loading rewards:", error);
      }
    }

    async function loadUserCoupons() {
      try {
        const { data, error } = await supabase
          .from("user_coupons")
          .select("*, rewards(*)")
          .eq("user_id", currentUser.id)
          .eq("is_used", false)
          .order("created_at", { ascending: false });

        if (error) throw error;

        userCoupons = data || [];
        console.log("‚úÖ User coupons loaded:", userCoupons.length);
      } catch (error) {
        console.error("‚ùå Error loading user coupons:", error);
      }
    }

    async function loadCoupons() {
      try {
        const { data, error } = await supabase
          .from("coupons")
          .select("*")
          .eq("is_active", true)
          .eq("show_in_list", true)
          .order("created_at", { ascending: false });

        if (error) throw error;

        availableCoupons = data || [];
        console.log("‚úÖ Coupons loaded:", availableCoupons.length);
      } catch (error) {
        console.error("‚ùå Error loading coupons:", error);
      }
    }

    function showRewards() {
      const modal = document.getElementById("rewards-modal");
      const content = document.getElementById("rewards-content");
      document.getElementById("modal-user-points").textContent = userPoints;

      if (availableRewards.length === 0) {
        content.innerHTML = `
          <div class="col-span-2 text-center py-12">
            <div class="text-5xl sm:text-6xl mb-4">üéÅ</div>
            <p class="text-gray-600 text-sm sm:text-base">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÑ‡∏î‡πâ</p>
          </div>
        `;
      } else {
        let html = '';
        availableRewards.forEach(reward => {
          const canRedeem = userPoints >= reward.points_required;
          html += `
            <div class="card border-2 ${canRedeem ? 'border-purple-200 hover:border-purple-400' : 'border-gray-200 opacity-50'} p-3 sm:p-4">
              <div class="flex items-start justify-between mb-3">
                <div class="text-2xl sm:text-3xl">üéÅ</div>
                <div class="text-xs ${canRedeem ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} px-2 py-1 rounded-full">
                  ${reward.points_required} ‡πÅ‡∏ï‡πâ‡∏°
                </div>
              </div>
              <div class="font-bold text-sm sm:text-base lg:text-lg text-purple-900 mb-1">${reward.name}</div>
              <div class="text-xs sm:text-sm text-gray-600 mb-2">${reward.description}</div>
              <div class="text-xs text-gray-500 mb-3">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${reward.discount_type === 'percent' ? reward.discount_value + '%' : reward.discount_value + ' ‡∏ö‡∏≤‡∏ó'}</div>
              ${canRedeem ? `
                <button onclick="redeemReward(${reward.id})" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium text-xs sm:text-sm">
                  üéÅ ‡πÅ‡∏•‡∏Å‡πÄ‡∏•‡∏¢
                </button>
              ` : `
                <button disabled class="w-full bg-gray-300 text-gray-500 px-4 py-2 rounded-lg font-medium text-xs sm:text-sm cursor-not-allowed">
                  ‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠
                </button>
              `}
            </div>
          `;
        });
        content.innerHTML = html;
      }

      modal.classList.remove("hidden");
    }

    function closeRewards() {
      document.getElementById("rewards-modal").classList.add("hidden");
    }

    async function redeemReward(rewardId) {
      try {
        const reward = availableRewards.find(r => r.id === rewardId);
        if (!reward) {
          showMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ");
          return;
        }

        if (userPoints < reward.points_required) {
          showMessage("‚ùå ‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");
          return;
        }

        if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏° ${reward.points_required} ‡πÅ‡∏ï‡πâ‡∏° ‡πÄ‡∏õ‡πá‡∏ô "${reward.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
          return;
        }

        // ‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°
        const newPoints = userPoints - reward.points_required;
        const { error: updateError } = await supabase
          .from("users")
          .update({ points: newPoints })
          .eq("id", currentUser.id);

        if (updateError) throw updateError;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const couponCode = `REWARD${Date.now()}`;
        const { error: couponError } = await supabase
          .from("user_coupons")
          .insert([{
            user_id: currentUser.id,
            reward_id: rewardId,
            coupon_code: couponCode,
            is_used: false
          }]);

        if (couponError) throw couponError;

        userPoints = newPoints;
        document.getElementById("userPoints").textContent = userPoints;
        document.getElementById("modal-user-points").textContent = userPoints;

        showMessage(`üéâ ‡πÅ‡∏•‡∏Å "${reward.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á: ${couponCode}`);
        
        await loadUserCoupons();
        closeRewards();

      } catch (error) {
        console.error("‚ùå Error redeeming reward:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•");
      }
    }

    function showMyCoupons() {
      const modal = document.getElementById("my-coupons-modal");
      const content = document.getElementById("my-coupons-content");

      if (userCoupons.length === 0) {
        content.innerHTML = `
          <div class="col-span-2 text-center py-12">
            <div class="text-5xl sm:text-6xl mb-4">üé´</div>
            <p class="text-gray-600 text-sm sm:text-base">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
          </div>
        `;
      } else {
        let html = '';
        userCoupons.forEach(coupon => {
          html += `
            <div class="card border-2 ${coupon.is_used ? 'border-gray-200 opacity-50' : 'border-purple-200 hover:border-purple-400 cursor-pointer'} p-3 sm:p-4" ${!coupon.is_used ? `onclick="selectCouponFromMyCoupons('${coupon.coupon_code}')"` : ''}>
              <div class="flex items-start justify-between mb-3">
                <div class="text-2xl sm:text-3xl">üé´</div>
                <div class="text-xs ${coupon.is_used ? 'bg-gray-100 text-gray-800' : 'bg-green-100 text-green-800'} px-2 py-1 rounded-full">
                  ${coupon.is_used ? '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'}
                </div>
              </div>
              <div class="font-bold text-sm sm:text-base lg:text-lg text-purple-900 mb-1">${coupon.rewards.name}</div>
              <div class="text-xs sm:text-sm text-gray-600 mb-2">${coupon.rewards.description}</div>
              <div class="text-xs text-gray-500 mb-2">‡∏£‡∏´‡∏±‡∏™: <span class="font-mono font-bold">${coupon.coupon_code}</span></div>
              <div class="text-xs text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${coupon.rewards.discount_type === 'percent' ? coupon.rewards.discount_value + '%' : coupon.rewards.discount_value + ' ‡∏ö‡∏≤‡∏ó'}</div>
              <div class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ${coupon.rewards.min_purchase} ‡∏ö‡∏≤‡∏ó</div>
              ${!coupon.is_used ? '<div class="mt-3 text-xs text-purple-600 font-medium text-center">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</div>' : ''}
            </div>
          `;
        });
        content.innerHTML = html;
      }

      closeRewards();
      modal.classList.remove("hidden");
    }

    function selectCouponFromMyCoupons(couponCode) {
      closeMyCoupons();
      // ‡∏£‡∏≠‡πÉ‡∏´‡πâ modal ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
      setTimeout(() => {
        if (!document.getElementById("cart-modal").classList.contains("hidden")) {
          document.getElementById("coupon-input").value = couponCode;
          applyCouponCode();
        } else {
          // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô
          showCart();
          setTimeout(() => {
            document.getElementById("coupon-input").value = couponCode;
            applyCouponCode();
          }, 300);
        }
      }, 300);
    }

    function closeMyCoupons() {
      document.getElementById("my-coupons-modal").classList.add("hidden");
    }

    function showMyCouponsForCart() {
      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      document.getElementById("my-coupons-modal").classList.remove("hidden");
    }

    async function loadMenus(dessertId) { 
      document.getElementById("base-list").innerHTML = "<p class='text-gray-500 text-xs sm:text-sm col-span-full text-center py-4'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>";
      document.getElementById("topping-list").innerHTML = "<p class='text-gray-500 text-xs sm:text-sm col-span-full text-center py-4'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>";

      try {
        const { data, error } = await supabase
          .from("brownie_items")
          .select("*")
          .eq("is_active", true)
          .eq("dessert_id", dessertId)
          .order("type")
          .order("price");

        if (error) throw error;
        
        allItems = data;
        const baseList = allItems.filter((item) => item.type === "base");
        const toppingList = allItems.filter((item) => item.type === "topping");

        renderMenu("base", baseList);
        renderMenu("topping", toppingList);

        selectedBase = null;
        selectedTopping = null;
        updateTotal();

      } catch (err) {
        console.error("Error loading items:", err);
        showMessage("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ");
      }
    }

    function renderMenu(type, items) {
      const container = document.getElementById(`${type}-list`);
      if (!container) return;

      if (items.length === 0) {
        container.innerHTML = `<p class='col-span-full text-center text-gray-500 py-4 text-xs sm:text-sm'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ${type === 'base' ? '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' : '‡∏´‡∏ô‡πâ‡∏≤'}‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>`;
        return;
      }

      container.innerHTML = items.map(item => `
        <div class="menu-card hover-lift cursor-pointer ${type === 'base' ? 'brownie-base' : 'topping-item'} active:scale-95"
             onclick="select${type.charAt(0).toUpperCase() + type.slice(1)}(${item.id}, '${item.name.replace(/'/g, "\\'")}', ${item.price}, this)">
          <div class="title">${item.name}</div>
          <div class="text-xs text-gray-500 mt-1">${item.description || ''}</div>
          <div class="price font-bold mt-2">${item.price} ‡∏ö‡∏≤‡∏ó</div>
        </div>
      `).join("");
    }

    function selectBase(id, name, price, el) {
      document.querySelectorAll('.brownie-base').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      selectedBase = { id, name, price };
      updateTotal();
    }

    function selectTopping(id, name, price, el) {
      document.querySelectorAll('.topping-item').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      selectedTopping = { id, name, price };
      updateTotal();
    }

    function changeQuantity(v) {
      quantity = Math.max(1, quantity + v);
      document.getElementById("quantity").textContent = quantity;
      updateTotal();
    }

    function updateTotal() {
      const basePrice = selectedBase?.price || 0;
      const toppingPrice = selectedTopping?.price || 0;
      const total = (basePrice + toppingPrice) * quantity;
      document.getElementById("total-price").textContent = total.toLocaleString();
      document.getElementById("add-to-cart").disabled = !(selectedBase && selectedTopping);
    }

    function addToCart() {
      if (!selectedDessert) {
        showMessage("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }

      if (!selectedBase || !selectedTopping) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏ô‡∏°");
        return;
      }

      const total = (selectedBase.price + selectedTopping.price) * quantity;

      cart.push({
        dessertId: selectedDessert.id,
        dessertName: selectedDessert.name,
        baseName: selectedBase.name,
        toppingName: selectedTopping.name,
        quantity,
        unitPrice: selectedBase.price + selectedTopping.price,
        totalPrice: total
      });

      updateCartBadge();
      showMessage("üß∫ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!");

      quantity = 1;
      document.getElementById("quantity").textContent = "1";
      updateTotal();
      document.querySelectorAll('.brownie-base').forEach(e => e.classList.remove('selected'));
      document.querySelectorAll('.topping-item').forEach(e => e.classList.remove('selected'));
      selectedBase = null;
      selectedTopping = null;

      document.getElementById("menu-selection").classList.add("hidden");
      document.getElementById("dessert-selection").classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function updateCartBadge() {
      const badge = document.getElementById("cart-badge");
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      
      if (totalItems > 0) {
        badge.textContent = totalItems;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }

    function showCart() {
      const modal = document.getElementById("cart-modal");
      const content = document.getElementById("cart-content");

      if (cart.length === 0) {
        content.innerHTML = `
          <div class="text-center py-12">
            <div class="text-5xl sm:text-6xl mb-4">üõí</div>
            <p class="text-gray-600 text-sm sm:text-base">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
          </div>
        `;
      } else {
        let html = '<div class="space-y-3">';
        cart.forEach((item, index) => {
          html += `
            <div class="card border border-gray-200 p-3">
              <div class="flex justify-between items-start gap-3">
                <div class="flex-1 min-w-0">
                  <div class="font-bold text-blue-600 text-xs sm:text-sm truncate">${item.dessertName || '‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°'}</div>
                  <div class="text-xs text-gray-800 font-medium mt-1">${item.baseName} + ${item.toppingName}</div>
                  <div class="text-xs text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                </div>

                <div class="text-right flex-shrink-0">
                  <div class="font-bold text-blue-600 text-xs sm:text-sm">${item.totalPrice} ‡∏ö‡∏≤‡∏ó</div>

                  <div class="flex items-center gap-1 mt-2 justify-end">
                    <button onclick="updateCartQuantity(${index}, -1)" 
                            class="quantity-btn bg-red-500 hover:bg-red-600 text-white text-xs w-6 h-6 sm:w-7 sm:h-7">‚àí</button>
                    <span class="text-xs font-medium w-6 text-center">${item.quantity}</span>
                    <button onclick="updateCartQuantity(${index}, 1)" 
                            class="quantity-btn bg-green-500 hover:bg-green-600 text-white text-xs w-6 h-6 sm:w-7 sm:h-7">+</button>
                  </div>

                  <button onclick="removeFromCart(${index})" 
                          class="text-red-500 text-xs mt-2 hover:underline">‡∏•‡∏ö</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;
      }

      updateCartTotal();
      modal.classList.remove("hidden");
    }

    function updateCartQuantity(index, change) {
      if (cart[index]) {
        cart[index].quantity = Math.max(1, cart[index].quantity + change);
        cart[index].totalPrice = cart[index].unitPrice * cart[index].quantity;
        updateCartBadge();
        showCart();
      }
    }

    function updateCartTotal() {
      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      let discount = 0;

      if (selectedCoupon) {
        if (selectedCoupon.discount_type === 'percent') {
          discount = Math.floor(subtotal * selectedCoupon.discount_value / 100);
        } else {
          discount = Math.min(selectedCoupon.discount_value, subtotal);
        }
      }

      const total = Math.max(0, subtotal - discount);

      document.getElementById("cart-subtotal").textContent = subtotal + " ‡∏ö‡∏≤‡∏ó";
      document.getElementById("cart-total").textContent = total + " ‡∏ö‡∏≤‡∏ó";

      if (discount > 0) {
        document.getElementById("discount-row").classList.remove("hidden");
        document.getElementById("discount-amount").textContent = "-" + discount + " ‡∏ö‡∏≤‡∏ó";
      } else {
        document.getElementById("discount-row").classList.add("hidden");
      }
    }

    function closeCart() {
      document.getElementById("cart-modal").classList.add("hidden");
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartBadge();
      showCart();
      showMessage("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
    }

    async function applyCouponCode() {
      const code = document.getElementById("coupon-input").value.trim().toUpperCase();

      if (!code) {
        showCouponMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á", "error");
        return;
      }

      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);

      try {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å user_coupons (‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡∏°‡∏≤)
        const { data: userCoupon, error: userCouponError } = await supabase
          .from("user_coupons")
          .select("*, rewards(*)")
          .eq("coupon_code", code)
          .eq("user_id", currentUser.id)
          .eq("is_used", false)
          .maybeSingle();

        console.log("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô user_coupons:", userCoupon);

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô user_coupons ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô coupons (‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤)
        if (!userCoupon) {
          console.log("üîç ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô user_coupons, ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô coupons...");
          
          const { data: normalCoupon, error: normalCouponError } = await supabase
            .from("coupons")
            .select("*")
            .eq("code", code)
            .eq("is_active", true)
            .maybeSingle();

          console.log("üîç ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å coupons:", normalCoupon);
          console.log("‚ùå Error:", normalCouponError);

          if (!normalCoupon) {
            showCouponMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß", "error");
            return;
          }

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          if (normalCoupon.usage_count >= normalCoupon.usage_limit) {
            showCouponMessage("‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß", "error");
            return;
          }

          if (subtotal < normalCoupon.min_purchase) {
            showCouponMessage(`‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${normalCoupon.min_purchase} ‡∏ö‡∏≤‡∏ó`, "error");
            return;
          }

          selectedCoupon = {
            id: normalCoupon.id,
            code: normalCoupon.code,
            name: normalCoupon.name,
            description: normalCoupon.description,
            discount_type: normalCoupon.type,
            discount_value: normalCoupon.value,
            min_purchase: normalCoupon.min_purchase,
            coupon_type: 'normal' // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤
          };

          console.log("‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", selectedCoupon);

        } else {
          // ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
          if (subtotal < userCoupon.rewards.min_purchase) {
            showCouponMessage(`‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${userCoupon.rewards.min_purchase} ‡∏ö‡∏≤‡∏ó`, "error");
            return;
          }

          selectedCoupon = {
            id: userCoupon.id,
            code: userCoupon.coupon_code,
            name: userCoupon.rewards.name,
            description: userCoupon.rewards.description,
            discount_type: userCoupon.rewards.discount_type,
            discount_value: userCoupon.rewards.discount_value,
            min_purchase: userCoupon.rewards.min_purchase,
            coupon_type: 'reward' // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
          };

          console.log("‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", selectedCoupon);
        }

        document.getElementById("selected-coupon").classList.remove("hidden");
        document.getElementById("coupon-name").textContent = selectedCoupon.name;
        document.getElementById("coupon-desc").textContent = selectedCoupon.description;
        document.getElementById("coupon-input").value = "";

        updateCartTotal();
        showCouponMessage("‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ", "success");

      } catch (error) {
        console.error("‚ùå Error applying coupon:", error);
        showCouponMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message, "error");
      }
    }

    function removeCoupon() {
      selectedCoupon = null;
      document.getElementById("selected-coupon").classList.add("hidden");
      updateCartTotal();
      showMessage("‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
    }

    function showCouponMessage(message, type) {
      const messageEl = document.getElementById("coupon-message");
      messageEl.textContent = message;
      messageEl.className = `text-xs sm:text-sm mt-2 ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
      messageEl.classList.remove("hidden");
      setTimeout(() => messageEl.classList.add("hidden"), 3000);
    }

    async function checkout() {
      if (cart.length === 0) {
        showMessage("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
        return;
      }

      if (!shopIsOpen) {
        document.getElementById("shop-closed-overlay").classList.remove("hidden");
        return;
      }

      try {
        const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
        let discount = 0;

        if (selectedCoupon) {
          if (selectedCoupon.discount_type === "percent") {
            discount = Math.floor(subtotal * selectedCoupon.discount_value / 100);
          } else {
            discount = Math.min(selectedCoupon.discount_value, subtotal);
          }

          // ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
          if (selectedCoupon.coupon_type === 'reward') {
            // ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
            await supabase
              .from("user_coupons")
              .update({ is_used: true, used_at: new Date().toISOString() })
              .eq("id", selectedCoupon.id);
          } else if (selectedCoupon.coupon_type === 'normal') {
            // ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ
            const { data: currentCoupon } = await supabase
              .from("coupons")
              .select("usage_count")
              .eq("id", selectedCoupon.id)
              .single();

            await supabase
              .from("coupons")
              .update({ usage_count: (currentCoupon.usage_count || 0) + 1 })
              .eq("id", selectedCoupon.id);
          }
        }

        const total = Math.max(0, subtotal - discount);
        const earnedPoints = total;

        const { data: orderData, error: orderError } = await supabase
          .from("orders")
          .insert([{
            user_id: currentUser.id,
            line_id: currentUser.line_id,
            items: cart,
            subtotal: subtotal,
            discount: discount,
            total_price: total,
            earned_points: earnedPoints,
            coupon_code: selectedCoupon ? selectedCoupon.code : null,
            status: "pending",
          }])
          .select()
          .single();

        if (orderError) throw orderError;

        await supabase.functions.invoke("send-line-notification", {
          body: {
            lineId: currentUser.line_id,
            orderId: orderData.id,
            status: "pending",
            orderData: {
              items: cart,
              total_price: total,
              subtotal: subtotal,
              discount: discount,
            },
          },
        });

        cart = [];
        selectedCoupon = null;
        updateCartBadge();
        closeCart();
        await loadUserCoupons();
        await loadCoupons();

        showMessage(`‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏° +${earnedPoints} ‡πÅ‡∏ï‡πâ‡∏° ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ üéâ`);
      } catch (error) {
        console.error("‚ùå Checkout error:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
      }
    }

    function openOrderHistory() {
      if (!userProfile || !userProfile.userId) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
        return;
      }

      document.getElementById("main-app").classList.add("hidden");
      document.getElementById("order-history").classList.remove("hidden");
      loadOrderHistory();
    }

    function backToMain() {
      document.getElementById("order-history").classList.add("hidden");
      document.getElementById("main-app").classList.remove("hidden");
    }

    async function loadOrderHistory() {
      const orderList = document.getElementById("order-list");
      orderList.innerHTML = '<p class="text-gray-500 text-center py-8 text-xs sm:text-sm">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .eq("line_id", userProfile.userId)
          .order("created_at", { ascending: false });

        if (error) throw error;

        if (!orders || orders.length === 0) {
          orderList.innerHTML = `
            <div class="text-center py-12">
              <div class="text-5xl sm:text-6xl mb-2">üî≠</div>
              <p class="text-gray-600 text-xs sm:text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
            </div>`;
          return;
        }

        let html = "";
        orders.forEach(order => {
          let itemsArray = [];
          try {
            itemsArray = typeof order.items === "string" ? JSON.parse(order.items) : order.items;
          } catch {
            itemsArray = [];
          }

          const items = Array.isArray(itemsArray)
            ? itemsArray.map(i => `
              <li class="text-xs sm:text-sm">ü´ê <span class="font-medium text-purple-700">${i.baseName}</span> 
              <span class="text-gray-600">+ ${i.toppingName}</span> (${i.quantity || 1})</li>
            `).join("")
            : "<li class='text-xs sm:text-sm'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</li>";

          const canCancel = order.status === "pending";
          const statusBadge = getStatusBadge(order.status);

          html += `
            <div class="p-3 sm:p-4 bg-white rounded-2xl shadow-md border border-gray-200 hover:shadow-lg transition">
              <div class="flex justify-between items-start flex-wrap gap-2">
                <div>
                  <p class="font-semibold text-purple-900 text-xs sm:text-sm lg:text-base">Order #${order.id}</p>
                  <p class="text-xs text-gray-500">${new Date(order.created_at).toLocaleString("th-TH")}</p>
                </div>
                <span class="text-xs font-medium ${statusBadge.class} px-2 sm:px-3 py-1 rounded-full">${statusBadge.label}</span>
              </div>
              <ul class="mt-3 text-gray-700 list-disc list-inside space-y-1">${items}</ul>
              <div class="flex justify-between items-center mt-4 flex-wrap gap-2">
                <p class="font-medium text-purple-700 text-xs sm:text-sm lg:text-base">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total_price} ‡∏ö‡∏≤‡∏ó</p>
                ${canCancel ? `<button onclick="cancelOrder(${order.id})"
                  class="text-red-600 hover:text-red-800 font-medium text-xs px-2 sm:px-3 py-1 border border-red-300 rounded-xl hover:bg-red-50 transition">
                  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                </button>` : ""}
              </div>
            </div>`;
        });

        orderList.innerHTML = html;
      } catch (error) {
        console.error("‚ùå Error loading orders:", error);
        orderList.innerHTML = `<p class="text-center text-red-600 text-xs sm:text-sm">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
      }
    }

    function getStatusBadge(status) {
      switch (status) {
        case "pending":
          return { label: "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", class: "bg-yellow-100 text-yellow-700" };
        case "preparing":
          return { label: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°", class: "bg-blue-100 text-blue-700" };
        case "ready":
          return { label: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á", class: "bg-green-100 text-green-700" };
        case "completed":
          return { label: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", class: "bg-purple-100 text-purple-700" };
        case "cancelled":
          return { label: "‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", class: "bg-red-100 text-red-700" };
        default:
          return { label: status, class: "bg-gray-100 text-gray-700" };
      }
    }

    async function cancelOrder(orderId) {
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

      try {
        const { error } = await supabase
          .from("orders")
          .update({ status: "cancelled" })
          .eq("id", orderId);

        if (error) throw error;

        showMessage("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß üõë");
        loadOrderHistory();
      } catch (error) {
        console.error("‚ùå Error cancelling order:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
      }
    }

    function showAdmin() {
      document.getElementById("admin-modal").classList.remove("hidden");
      showAdminTab('shop-status');
    }

    function closeAdmin() {
      document.getElementById("admin-modal").classList.add("hidden");
    }

    function showAdminTab(tab) {
      document.querySelectorAll(".admin-tab").forEach(el => {
        el.classList.remove("border-blue-600", "text-blue-600");
        el.classList.add("border-transparent", "text-gray-600");
      });

      document.querySelectorAll(".admin-tab-content").forEach(el => {
        el.classList.add("hidden");
      });

      const activeTab = document.querySelector(`[data-tab="${tab}"]`);
      if (activeTab) {
        activeTab.classList.remove("border-transparent", "text-gray-600");
        activeTab.classList.add("border-blue-600", "text-blue-600");
      }

      document.getElementById(`admin-${tab}-tab`).classList.remove("hidden");

      if (tab === 'shop-status') updateShopStatusUI();
      if (tab === 'orders') loadAdminOrders();
      if (tab === 'rewards') loadAdminRewards();
      if (tab === 'coupons') loadAdminCoupons();
      if (tab === 'stats') loadAdminStats();
      if (tab === 'desserts') loadAdminDesserts();
      if (tab === 'brownie') loadBrownieMenus(currentAdminDessertId);
      if (tab === 'summary') loadOrderSummary();
    }

    async function loadAdminOrders() {
      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select(`
            *,
            users (display_name, picture_url)
          `)
          .order("created_at", { ascending: false })
          .limit(100);

        if (error) throw error;

        allOrders = orders;
        renderAdminOrders(orders);
      } catch (error) {
        console.error("‚ùå Error loading admin orders:", error);
      }
    }

    function renderAdminOrders(orders) {
      const content = document.getElementById("admin-orders-content");
      
      if (orders.length === 0) {
        content.innerHTML = '<p class="text-center text-gray-500 py-12 text-xs sm:text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>';
        return;
      }

      let html = '<div class="space-y-3 sm:space-y-4">';
      orders.forEach(order => {
        const statusClass = getStatusBadgeClass(order.status);
        const isCancelled = order.status === 'cancelled';
        
        let itemsArray = [];
        try {
          itemsArray = typeof order.items === "string" ? JSON.parse(order.items) : order.items;
        } catch {
          itemsArray = [];
        }
        
        html += `
          <div class="card border border-gray-200 p-3 sm:p-4 ${isCancelled ? 'opacity-60' : ''}">
            <div class="flex items-start justify-between mb-3 gap-3 flex-wrap">
              <div class="flex items-center space-x-3">
                <img src="${order.users?.picture_url || ''}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full" />
                <div>
                  <div class="font-semibold text-xs sm:text-sm">${order.users?.display_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                  <div class="text-xs text-gray-500">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id}</div>
                </div>
              </div>
              <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-medium ${statusClass}">${getStatusText(order.status)}</span>
            </div>
            
            <div class="space-y-1 mb-3">
              ${Array.isArray(itemsArray) ? itemsArray.map(item => `
                <div class="text-xs sm:text-sm text-gray-600">‚Ä¢ ${item.baseName} + ${item.toppingName} √ó ${item.quantity}</div>
              `).join('') : '<div class="text-xs sm:text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>'}
            </div>
            
            <div class="flex items-center justify-between pt-3 border-t gap-3 flex-wrap">
              <div>
                <div class="text-xs sm:text-sm text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <span class="font-bold text-gray-900">${order.total_price} ‡∏ö‡∏≤‡∏ó</span></div>
                <div class="text-xs text-gray-400">${new Date(order.created_at).toLocaleString('th-TH')}</div>
              </div>
              <div class="flex gap-2">
                ${isCancelled ? `
                  <div class="text-xs sm:text-sm text-red-600 font-medium px-3 py-2">
                    üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                  </div>
                ` : `
                  <select onchange="updateOrderStatus(${order.id}, this.value)" class="text-xs sm:text-sm border border-gray-300 rounded px-2 py-1">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</option>
                    <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</option>
                    <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                  </select>
                `}
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      content.innerHTML = html;
    }

    function filterAdminOrders() {
      const dateFilter = document.getElementById("admin-order-date").value;
      const searchQuery = document.getElementById("admin-order-search").value.toLowerCase();

      let filtered = allOrders;

      if (dateFilter) {
        const filterDate = new Date(dateFilter).toDateString();
        filtered = filtered.filter(order => {
          const orderDate = new Date(order.created_at).toDateString();
          return orderDate === filterDate;
        });
      }

      if (searchQuery) {
        filtered = filtered.filter(order => {
          const orderIdMatch = order.id.toString().includes(searchQuery);
          const nameMatch = order.users?.display_name?.toLowerCase().includes(searchQuery);
          return orderIdMatch || nameMatch;
        });
      }

      renderAdminOrders(filtered);
    }

    function clearOrderFilters() {
      document.getElementById("admin-order-date").value = "";
      document.getElementById("admin-order-search").value = "";
      renderAdminOrders(allOrders);
    }

    function getStatusText(status) {
      switch (status) {
        case "pending": return "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£";
        case "preparing": return "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°";
        case "ready": return "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö";
        case "completed": return "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        case "cancelled": return "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
        default: return "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
      }
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case "pending": return "bg-yellow-100 text-yellow-700";
        case "preparing": return "bg-blue-100 text-blue-700";
        case "ready": return "bg-green-100 text-green-700";
        case "completed": return "bg-purple-100 text-purple-700";
        case "cancelled": return "bg-red-100 text-red-700";
        default: return "bg-gray-100 text-gray-700";
      }
    }

    async function updateOrderStatus(orderId, newStatus) {
      try {
        const { data: orderData, error: fetchError } = await supabase
          .from('orders')
          .select('status, user_id, earned_points, line_id, items, total_price, subtotal, discount, id')
          .eq('id', orderId)
          .single();

        if (fetchError) throw fetchError;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (orderData.status === 'cancelled') {
          showMessage("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ");
          loadAdminOrders(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï dropdown
          return;
        }

        const { error: updateError } = await supabase
          .from('orders')
          .update({ status: newStatus })
          .eq('id', orderId);

        if (updateError) throw updateError;

        await sendOrderStatusNotification(orderData, newStatus);

        if (newStatus === 'completed' && orderData.status !== 'completed') {
          const { data: user, error: userError } = await supabase
            .from('users')
            .select('points')
            .eq('id', orderData.user_id)
            .single();

          if (userError) throw userError;

          const newPoints = (user.points || 0) + (orderData.earned_points || 0);
          await supabase.from('users').update({ points: newPoints }).eq('id', orderData.user_id);

          showMessage(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πâ‡∏° ${orderData.earned_points} ‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        } else {
          showMessage(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${orderId} ‡πÄ‡∏õ‡πá‡∏ô ${getStatusText(newStatus)}`);
        }

        loadAdminOrders();
      } catch (error) {
        console.error("‚ùå Error updating order status:", error);
        showMessage(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
        loadAdminOrders(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï dropdown
      }
    }

    async function sendOrderStatusNotification(order, newStatus) {
      try {
        await supabase.functions.invoke('send-line-notification', {
          body: {
            lineId: order.line_id,
            orderId: order.id,
            status: newStatus,
            orderData: {
              items: order.items,
              total_price: order.total_price,
              subtotal: order.subtotal,
              discount: order.discount
            }
          }
        });
        console.log("‚úÖ Notification sent successfully");
      } catch (error) {
        console.error("‚ùå Error sending notification:", error);
      }
    }

    // Admin Rewards Functions
    async function loadAdminRewards() {
      try {
        const { data: rewards, error } = await supabase
          .from("rewards")
          .select("*")
          .order("points_required", { ascending: true });

        if (error) throw error;

        const content = document.getElementById("admin-rewards-content");
        
        if (rewards.length === 0) {
          content.innerHTML = '<p class="text-center text-gray-500 py-12 text-xs sm:text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>';
          return;
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">';
        rewards.forEach(reward => {
          html += `
            <div class="card border-2 border-purple-200 p-3 sm:p-4">
              <div class="flex items-start justify-between mb-3 gap-3 flex-wrap">
                <div>
                  <div class="font-bold text-sm sm:text-base lg:text-lg text-purple-900">${reward.name}</div>
                  <div class="text-xs sm:text-sm text-gray-600">${reward.description}</div>
                </div>
                <label class="flex items-center justify-end text-xs sm:text-sm">
                  <input type="checkbox" ${reward.is_active ? 'checked' : ''} 
                         onchange="toggleReward(${reward.id}, this.checked)" class="mr-2" />
                  <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ</span>
                </label>
              </div>
              
              <div class="space-y-1 text-xs sm:text-sm text-gray-600">
                <div>‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ: <span class="font-bold">${reward.points_required} ‡πÅ‡∏ï‡πâ‡∏°</span></div>
                <div>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${reward.discount_type === 'percent' ? reward.discount_value + '%' : reward.discount_value + ' ‡∏ö‡∏≤‡∏ó'}</div>
                <div>‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ${reward.min_purchase} ‡∏ö‡∏≤‡∏ó</div>
              </div>
              
              <button onclick="deleteReward(${reward.id})" class="mt-3 text-red-500 hover:text-red-700 text-xs sm:text-sm font-medium">
                üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
              </button>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;

      } catch (error) {
        console.error("‚ùå Error loading rewards:", error);
      }
    }

    function showCreateRewardForm() {
      document.getElementById("create-reward-modal").classList.remove("hidden");
    }

    function closeCreateReward() {
      document.getElementById("create-reward-modal").classList.add("hidden");
    }

    async function createReward(event) {
      event.preventDefault();

      try {
        const name = document.getElementById("reward-name").value;
        const description = document.getElementById("reward-description").value;
        const pointsRequired = parseInt(document.getElementById("reward-points").value);
        const discountType = document.getElementById("reward-type").value;
        const discountValue = parseInt(document.getElementById("reward-value").value);
        const minPurchase = parseInt(document.getElementById("reward-min").value);

        const { error } = await supabase
          .from("rewards")
          .insert([{
            name,
            description,
            points_required: pointsRequired,
            discount_type: discountType,
            discount_value: discountValue,
            min_purchase: minPurchase,
            is_active: true
          }]);

        if (error) throw error;

        showMessage("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ");
        closeCreateReward();
        loadAdminRewards();
        loadRewards();
        event.target.reset();

      } catch (error) {
        console.error("‚ùå Error creating reward:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }

    async function toggleReward(rewardId, isActive) {
      try {
        const { error } = await supabase
          .from("rewards")
          .update({ is_active: isActive })
          .eq("id", rewardId);

        if (error) throw error;

        showMessage(isActive ? "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏•‡πâ‡∏ß" : "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏•‡πâ‡∏ß");
        loadRewards();

      } catch (error) {
        console.error("‚ùå Error toggling reward:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }

    async function deleteReward(rewardId) {
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

      try {
        const { error } = await supabase
          .from("rewards")
          .delete()
          .eq("id", rewardId);

        if (error) throw error;

        showMessage("‡∏•‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        loadAdminRewards();
        loadRewards();

      } catch (error) {
        console.error("‚ùå Error deleting reward:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }

    // Admin Coupons Functions (‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤)
    async function loadAdminCoupons() {
      try {
        const { data: coupons, error } = await supabase
          .from("coupons")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) throw error;

        const content = document.getElementById("admin-coupons-content");
        
        if (coupons.length === 0) {
          content.innerHTML = '<p class="text-center text-gray-500 py-12 text-xs sm:text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>';
          return;
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">';
        coupons.forEach(coupon => {
          html += `
            <div class="card border-2 border-purple-200 p-3 sm:p-4">
              <div class="flex items-start justify-between mb-3 gap-3 flex-wrap">
                <div>
                  <div class="font-bold text-sm sm:text-base lg:text-lg text-purple-900">${coupon.name}</div>
                  <div class="text-xs sm:text-sm text-gray-600">${coupon.description}</div>
                </div>
                <div class="space-y-1 text-right">
                  <label class="flex items-center justify-end text-xs sm:text-sm">
                    <input type="checkbox" ${coupon.is_active ? 'checked' : ''} 
                           onchange="toggleCoupon(${coupon.id}, this.checked)" class="mr-2" />
                    <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ</span>
                  </label>
                  <label class="flex items-center justify-end text-xs sm:text-sm">
                    <input type="checkbox" ${coupon.show_in_list ? 'checked' : ''} 
                           onchange="toggleCouponVisibility(${coupon.id}, this.checked)" class="mr-2" />
                    <span>‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                  </label>
                </div>
              </div>
              
              <div class="space-y-1 text-xs sm:text-sm text-gray-600">
                <div>‡∏£‡∏´‡∏±‡∏™: <span class="font-mono font-bold">${coupon.code}</span></div>
                <div>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${coupon.type === 'percent' ? coupon.value + '%' : coupon.value + ' ‡∏ö‡∏≤‡∏ó'}</div>
                <div>‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ${coupon.min_purchase} ‡∏ö‡∏≤‡∏ó</div>
                <div>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ: ${coupon.usage_count} / ${coupon.usage_limit} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
              </div>
              
              <button onclick="deleteCoupon(${coupon.id})" class="mt-3 text-red-500 hover:text-red-700 text-xs sm:text-sm font-medium">
                üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
              </button>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;

      } catch (error) {
        console.error("‚ùå Error loading coupons:", error);
      }
    }

    function showCreateCouponForm() {
      document.getElementById("create-coupon-modal").classList.remove("hidden");
    }

    function closeCreateCoupon() {
      document.getElementById("create-coupon-modal").classList.add("hidden");
    }

    async function createCoupon(event) {
      event.preventDefault();

      try {
        const code = document.getElementById("coupon-code").value.toUpperCase();
        const name = document.getElementById("coupon-title").value;
        const description = document.getElementById("coupon-description").value;
        const type = document.getElementById("coupon-type").value;
        const value = parseInt(document.getElementById("coupon-value").value);
        const minPurchase = parseInt(document.getElementById("coupon-min").value);
        const usageLimit = parseInt(document.getElementById("coupon-usage").value);

        const { error } = await supabase
          .from("coupons")
          .insert([{
            code,
            name,
            description,
            type,
            value,
            min_purchase: minPurchase,
            usage_limit: usageLimit,
            usage_count: 0,
            is_active: true,
            show_in_list: true
          }]);

        if (error) throw error;

        showMessage("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ");
        closeCreateCoupon();
        loadAdminCoupons();
        loadCoupons();
        event.target.reset();

      } catch (error) {
        console.error("‚ùå Error creating coupon:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }

    async function toggleCoupon(couponId, isActive) {
      try {
        const { error } = await supabase
          .from("coupons")
          .update({ is_active: isActive })
          .eq("id", couponId);

        if (error) throw error;

        showMessage(isActive ? "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß" : "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
        loadCoupons();

      } catch (error) {
        console.error("‚ùå Error toggling coupon:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }

    async function toggleCouponVisibility(couponId, showInList) {
      try {
        const { error } = await supabase
          .from("coupons")
          .update({ show_in_list: showInList })
          .eq("id", couponId);

        if (error) throw error;

        showMessage(showInList
          ? "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô' ‚úÖ"
          : "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üîí"
        );

        loadAdminCoupons();
        loadCoupons();
      } catch (error) {
        console.error("‚ùå Error toggling coupon visibility:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á");
      }
    }

    async function deleteCoupon(couponId) {
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

      try {
        const { error } = await supabase
          .from("coupons")
          .delete()
          .eq("id", couponId);

        if (error) throw error;

        showMessage("‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        loadAdminCoupons();
        loadCoupons();

      } catch (error) {
        console.error("‚ùå Error deleting coupon:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }

    async function loadAdminStats() {
      try {
        const { data: orders, error: ordersError } = await supabase
          .from("orders")
          .select("total_price, status");

        if (ordersError) throw ordersError;

        const { count: usersCount, error: usersError } = await supabase
          .from("users")
          .select("*", { count: 'exact', head: true });

        if (usersError) throw usersError;

        const totalOrders = orders.length;
        const totalRevenue = orders.reduce((sum, order) => sum + order.total_price, 0);
        const pendingOrders = orders.filter(o => o.status === 'pending').length;
        const completedOrders = orders.filter(o => o.status === 'completed').length;

        const content = document.getElementById("admin-stats-content");
        content.innerHTML = `
          <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 sm:p-6">
            <div class="text-2xl sm:text-3xl mb-2">üìä</div>
            <div class="text-xs sm:text-sm opacity-90 mb-1">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
            <div class="text-xl sm:text-2xl lg:text-3xl font-bold">${totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
          </div>

          <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white p-4 sm:p-6">
            <div class="text-2xl sm:text-3xl mb-2">üì¶</div>
            <div class="text-xs sm:text-sm opacity-90 mb-1">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-xl sm:text-2xl lg:text-3xl font-bold">${totalOrders}</div>
            <div class="text-xs opacity-75 mt-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${completedOrders} | ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ${pendingOrders}</div>
          </div>

          <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 sm:p-6">
            <div class="text-2xl sm:text-3xl mb-2">üë•</div>
            <div class="text-xs sm:text-sm opacity-90 mb-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-xl sm:text-2xl lg:text-3xl font-bold">${usersCount}</div>
          </div>

          <div class="card col-span-full p-4 sm:p-6">
            <h4 class="font-semibold text-sm sm:text-base lg:text-lg mb-4">üìà ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h4>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
              <div class="text-center">
                <div class="text-lg sm:text-xl lg:text-2xl font-bold text-yellow-600">${orders.filter(o => o.status === 'pending').length}</div>
                <div class="text-xs sm:text-sm text-gray-600">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
              </div>
              <div class="text-center">
                <div class="text-lg sm:text-xl lg:text-2xl font-bold text-blue-600">${orders.filter(o => o.status === 'preparing').length}</div>
                <div class="text-xs sm:text-sm text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</div>
              </div>
              <div class="text-center">
                <div class="text-lg sm:text-xl lg:text-2xl font-bold text-green-600">${orders.filter(o => o.status === 'ready').length}</div>
                <div class="text-xs sm:text-sm text-gray-600">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</div>
              </div>
              <div class="text-center">
                <div class="text-lg sm:text-xl lg:text-2xl font-bold text-indigo-600">${orders.filter(o => o.status === 'completed').length}</div>
                <div class="text-xs sm:text-sm text-gray-600">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
              </div>
              <div class="text-center">
                <div class="text-lg sm:text-xl lg:text-2xl font-bold text-red-600">${orders.filter(o => o.status === 'cancelled').length}</div>
                <div class="text-xs sm:text-sm text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
              </div>
            </div>
          </div>
        `;

      } catch (error) {
        console.error("‚ùå Error loading stats:", error);
      }
    }

    async function loadOrderSummary() {
      const selectedDate = document.getElementById("summary-date").value;
      const selectedStatus = document.getElementById("summary-status").value;
      const content = document.getElementById("summary-content");

      try {
        let query = supabase.from("orders").select("*");

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        if (selectedDate) {
          const start = new Date(selectedDate);
          const end = new Date(selectedDate);
          end.setDate(end.getDate() + 1);
          query = query.gte("created_at", start.toISOString()).lt("created_at", end.toISOString());
        }

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (selectedStatus) {
          query = query.eq("status", selectedStatus);
        }

        const { data: orders, error } = await query.order("created_at", { ascending: false });

        if (error) throw error;

        if (orders.length === 0) {
          content.innerHTML = `<p class="text-gray-500 text-center text-xs sm:text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>`;
          return;
        }

        const totalRevenue = orders.reduce((sum, o) => sum + o.total_price, 0);
        const totalOrders = orders.length;

        const comboCounts = {};
        orders.forEach(o => {
          let itemsArray = [];
          try {
            itemsArray = typeof o.items === "string" ? JSON.parse(o.items) : o.items;
          } catch {
            itemsArray = [];
          }
          
          itemsArray.forEach(i => {
            const combo = `${i.baseName} + ${i.toppingName}`;
            comboCounts[combo] = (comboCounts[combo] || 0) + i.quantity;
          });
        });

        let filterText = '';
        if (selectedDate && selectedStatus) {
          filterText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${getStatusText(selectedStatus)}`;
        } else if (selectedDate) {
          filterText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate}`;
        } else if (selectedStatus) {
          filterText = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${getStatusText(selectedStatus)}`;
        } else {
          filterText = '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        }

        let html = `
          <h3 class="text-sm sm:text-base lg:text-lg font-semibold mb-3">üìÖ ‡∏™‡∏£‡∏∏‡∏õ ${filterText}</h3>
          <div class="mb-4">
            <p class="text-xs sm:text-sm">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${totalOrders}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            <p class="text-xs sm:text-sm">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <b>${totalRevenue.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</p>
          </div>

          <div class="border-t pt-4">
            <h4 class="font-semibold text-purple-700 mb-2 text-xs sm:text-sm">ü∞†‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ + ‡∏´‡∏ô‡πâ‡∏≤)</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              ${Object.entries(comboCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([combo, qty]) => `<p class="text-xs sm:text-sm">‚Ä¢ ${combo} ‚Äî <b>${qty}</b> ‡∏ä‡∏¥‡πâ‡∏ô</p>`)
                .join('')}
            </div>
          </div>

          <div class="mt-6 flex flex-col items-center gap-3">
            <select id="update-status-select" class="border rounded px-3 py-2 text-xs sm:text-sm w-full max-w-xs">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
              <option value="pending">üïì ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option value="preparing">üë®‚Äçüç≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
              <option value="ready">üöö ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
              <option value="completed">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
            </select>
            <p class="text-xs text-gray-500">* ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
            <button onclick="updateAllFilteredOrders()" 
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs sm:text-sm shadow">
              üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>
        `;

        content.innerHTML = html;
      } catch (err) {
        console.error(err);
        content.innerHTML = `<p class="text-red-500 text-center text-xs sm:text-sm">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
      }
    }

    async function updateAllFilteredOrders() {
      const selectedDate = document.getElementById("summary-date").value;
      const selectedStatus = document.getElementById("summary-status").value;
      const newStatus = document.getElementById("update-status-select").value;

      if (!newStatus) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");

      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÄ‡∏õ‡πá‡∏ô "${getStatusText(newStatus)}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n* ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞`)) {
        return;
      }

      try {
        let query = supabase.from("orders").select("*, users(line_id, display_name)");

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        if (selectedDate) {
          const start = new Date(selectedDate);
          const end = new Date(selectedDate);
          end.setDate(end.getDate() + 1);
          query = query.gte("created_at", start.toISOString()).lt("created_at", end.toISOString());
        }

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (selectedStatus) {
          query = query.eq("status", selectedStatus);
        }

        // ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß
        query = query.neq("status", "cancelled");

        const { data: orders, error: fetchError } = await query;

        if (fetchError) throw fetchError;
        if (!orders || orders.length === 0) {
          showMessage("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
          return;
        }

        let successCount = 0;
        let errorCount = 0;

        for (const order of orders) {
          try {
            const { error: updateError } = await supabase
              .from("orders")
              .update({ status: newStatus })
              .eq("id", order.id);

            if (updateError) {
              console.error(`‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${order.id} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, updateError);
              errorCount++;
              continue;
            }

            // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE
            try {
              await supabase.functions.invoke("send-line-notification", {
                body: {
                  lineId: order.users.line_id,
                  orderId: order.id,
                  status: newStatus,
                  orderData: {
                    items: order.items,
                    total_price: order.total_price,
                    subtotal: order.subtotal,
                    discount: order.discount,
                  },
                },
              });
            } catch (notifyError) {
              console.error(`‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${order.id} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, notifyError);
            }

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ completed ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πâ‡∏°
            if (newStatus === 'completed' && order.status !== 'completed') {
              const { data: user, error: userError } = await supabase
                .from('users')
                .select('points')
                .eq('id', order.user_id)
                .single();

              if (!userError && user) {
                const newPoints = (user.points || 0) + (order.earned_points || 0);
                await supabase.from('users').update({ points: newPoints }).eq('id', order.user_id);
              }
            }

            successCount++;
          } catch (orderError) {
            console.error(`‚ùå Error processing order ${order.id}:`, orderError);
            errorCount++;
          }
        }

        showMessage(
          `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÄ‡∏õ‡πá‡∏ô "${getStatusText(newStatus)}"${errorCount > 0 ? ` (‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${errorCount} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå)` : ''}`
        );
        loadOrderSummary();
      } catch (err) {
        console.error("‚ùå Error in updateAllFilteredOrders:", err);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
      }
    }

    async function loadDesserts() {
      try {
        const { data, error } = await supabase
          .from("desserts")
          .select("*")
          .eq("is_active", true)
          .order("id");

        if (error) throw error;
        allDesserts = data;
        renderDesserts();
      } catch (err) {
        console.error("Error loading desserts:", err);
        showMessage("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏°‡πÑ‡∏î‡πâ");
      }
    }

    function renderDesserts() {
      const container = document.getElementById("dessert-list");
      container.innerHTML = "";
      
      if (allDesserts.length === 0) {
        container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8 text-xs sm:text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
        return;
      }
      
      allDesserts.forEach((dessert) => {
        const card = document.createElement("div");
        card.className = "menu-card hover-lift cursor-pointer active:scale-95";
        card.innerHTML = `
          <div class="text-2xl sm:text-3xl lg:text-4xl mb-2">${dessert.emoji || "‚ùì"}</div>
          <h4 class="title">${dessert.name}</h4>
          <p class="text-xs text-slate-500 mt-1">${dessert.description || ""}</p>
        `;
        card.onclick = () => selectDessert(dessert);
        container.appendChild(card);
      });
    }

    function selectDessert(dessert) {
      selectedDessert = dessert;

      document.querySelectorAll("#dessert-list .menu-card").forEach(card => {
        card.classList.remove('ring-4', 'ring-blue-500');
      });

      const cards = [...document.querySelectorAll("#dessert-list .menu-card")];
      const index = allDesserts.findIndex(d => d.id === dessert.id);
      if (index >= 0) cards[index].classList.add('ring-4', 'ring-blue-500');

      document.getElementById("menu-selection").classList.remove("hidden");
      document.getElementById("menu-selection").scrollIntoView({ behavior: 'smooth', block: 'start' });
      loadMenus(dessert.id);
    }

    async function loadAdminDesserts() {
      try {
        const { data, error } = await supabase
          .from("desserts")
          .select("*")
          .order("id");
        if (error) throw error;
        renderAdminDesserts(data);
      } catch (err) {
        console.error("Error loading admin desserts:", err);
        showMessage("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°‡πÑ‡∏î‡πâ");
      }
    }

    function renderAdminDesserts(desserts) {
      const container = document.getElementById("admin-dessert-list");
      container.innerHTML = "";
      if (desserts.length === 0) {
        container.innerHTML = "<p class='text-gray-500 text-xs sm:text-sm'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°</p>";
        return;
      }

      desserts.forEach((dessert) => {
        const item = document.createElement("div");
        item.className = "p-3 bg-white/60 rounded-lg flex justify-between items-center gap-3 flex-wrap";
        item.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="text-xl sm:text-2xl">${dessert.emoji || "‚ùì"}</span>
            <div>
              <span class="font-bold text-xs sm:text-sm lg:text-base">${dessert.name}</span>
              <span class="text-xs text-gray-600 ml-2">${dessert.is_active ? "(‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢)" : "(‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢)"}</span>
            </div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button class="btn-secondary text-xs sm:text-sm px-2 sm:px-3 py-1 sm:py-2" onclick="manageDessertItems(${dessert.id}, '${dessert.name.replace(/'/g, "\\'")}')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</button>
            <button class="btn-secondary text-xs sm:text-sm px-2 sm:px-3 py-1 sm:py-2" onclick='openDessertModal("edit", ${JSON.stringify(dessert).replace(/'/g, "&#39;")})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="bg-red-500 text-white text-xs sm:text-sm px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-red-600" onclick="deleteDessert(${dessert.id})">‡∏•‡∏ö</button>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function openDessertModal(type, dessert = null) {
      const form = document.getElementById("dessert-form");
      form.reset();

      if (type === 'edit') {
        document.getElementById("dessert-modal-title").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°";
        document.getElementById("dessert-id").value = dessert.id;
        document.getElementById("dessert-name").value = dessert.name;
        document.getElementById("dessert-emoji").value = dessert.emoji;
        document.getElementById("dessert-desc").value = dessert.description;
        document.getElementById("dessert-active").checked = dessert.is_active;
      } else {
        document.getElementById("dessert-modal-title").innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°‡πÉ‡∏´‡∏°‡πà";
        document.getElementById("dessert-id").value = "";
      }
      document.getElementById("dessert-modal").classList.remove("hidden");
    }

    function closeDessertModal() {
      document.getElementById("dessert-modal").classList.add("hidden");
    }

    function manageDessertItems(dessertId, dessertName) {
      currentAdminDessertId = dessertId;
      document.querySelector("#admin-brownie-tab h3").innerText = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏Ç‡∏≠‡∏á: ${dessertName})`;
      loadBrownieMenus(dessertId);
      showAdminTab('brownie');
    }

    async function deleteDessert(id) {
      if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?\n(‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö '‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö' ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô)")) {
        return;
      }
      try {
        const { error } = await supabase.from("desserts").delete().eq("id", id);
        if (error) throw error;
        showMessage("‚úÖ ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        loadAdminDesserts();
      } catch (err) {
        console.error(err);
        showMessage("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà)");
      }
    }

    async function loadBrownieMenus(dessertId) {
      const container = document.getElementById("admin-brownie-list");
      
      if (!dessertId) {
        container.innerHTML = "<p class='text-gray-500 text-xs sm:text-sm'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°</p>";
        return;
      }

      try {
        const { data, error } = await supabase
          .from("brownie_items")
          .select("*")
          .eq("dessert_id", dessertId)
          .order("type")
          .order("price");
          
        if (error) throw error;
        container.innerHTML = renderBrownieList(data);
      } catch (err) {
        console.error("Error loading brownie menus:", err);
        showMessage("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÑ‡∏î‡πâ");
        container.innerHTML = "<p class='text-red-500 text-xs sm:text-sm'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>";
      }
    }

    function renderBrownieList(items) {
      if (!items || items.length === 0)
        return `<p class="text-gray-500 italic text-xs sm:text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;

      return items.map(i => `
        <div class="flex justify-between items-start border p-3 rounded-lg mb-2 bg-white shadow-sm hover:shadow-md transition gap-3 flex-wrap">
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-xs sm:text-sm lg:text-base">${i.name}</div>
            <div class="text-xs sm:text-sm text-gray-600">${i.description || ''}</div>
            <div class="text-xs sm:text-sm mt-1">
              üí∞ ${i.price} ‡∏ö‡∏≤‡∏ó | üéØ ${i.points} ‡πÅ‡∏ï‡πâ‡∏° | 
              ${i.is_active ? "‚úÖ <span class='text-green-600'>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</span>" : "‚ùå <span class='text-red-500'>‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</span>"}
            </div>
          </div>
          <div class="flex gap-2 flex-shrink-0">
            <button class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs sm:text-sm" onclick="openBrownieModal('${i.type}', ${i.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs sm:text-sm" onclick="deleteBrownieItem(${i.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </div>
        </div>
      `).join("");
    }

    function openBrownieModal(type, id) {
      if (!currentAdminDessertId) {
        showMessage("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°' ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö' ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô");
        showAdminTab('desserts');
        return;
      }
      
      const modal = document.getElementById("brownie-modal");
      const title = document.getElementById("brownie-modal-title");

      modal.classList.remove("hidden");

      document.getElementById("brownie-id").value = id || "";
      document.getElementById("brownie-type").value = type;
      document.getElementById("brownie-name").value = "";
      document.getElementById("brownie-desc").value = "";
      document.getElementById("brownie-price").value = "";
      document.getElementById("brownie-points").value = "";
      document.getElementById("brownie-active").checked = true;

      title.textContent = id ? "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà" : "ü∞†‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà";

      if (id) loadBrownieForEdit(id);
    }

    function closeBrownieModal() {
      document.getElementById("brownie-modal").classList.add("hidden");
    }

    async function loadBrownieForEdit(id) {
      const { data, error } = await supabase.from("brownie_items").select("*").eq("id", id).single();
      if (error) return console.error(error);

      document.getElementById("brownie-id").value = data.id;
      document.getElementById("brownie-type").value = data.type;
      document.getElementById("brownie-name").value = data.name;
      document.getElementById("brownie-desc").value = data.description || "";
      document.getElementById("brownie-price").value = data.price;
      document.getElementById("brownie-points").value = data.points;
      document.getElementById("brownie-active").checked = data.is_active;
    }

    async function deleteBrownieItem(id) {
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

      const { error } = await supabase.from("brownie_items").delete().eq("id", id);
      if (error) {
        console.error(error);
        return showMessage("‚ùå ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
      }

      showMessage("üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      loadBrownieMenus(currentAdminDessertId);
      
      if (selectedDessert && selectedDessert.id === currentAdminDessertId) {
        loadMenus(currentAdminDessertId);
      }
    }

    function showMessage(message) {
      const successMessage = document.getElementById("success-message");
      const successText = document.getElementById("success-text");
      successText.textContent = message;
      successMessage.classList.remove("hidden");

      setTimeout(() => {
        successMessage.classList.add("hidden");
      }, 3000);
    }

    function closeModalOnBackdrop(event, modalId) {
      if (event.target.id === modalId) {
        document.getElementById(modalId).classList.add("hidden");
      }
    }

    document.getElementById("brownie-form").onsubmit = async (e) => {
      e.preventDefault();

      if (!currentAdminDessertId) {
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏î");
        return;
      }

      const id = document.getElementById("brownie-id").value;
      const type = document.getElementById("brownie-type").value;
      const name = document.getElementById("brownie-name").value;
      const description = document.getElementById("brownie-desc").value;
      const price = parseFloat(document.getElementById("brownie-price").value);
      const points = parseInt(document.getElementById("brownie-points").value);
      const isActive = document.getElementById("brownie-active").checked;

      const data = { 
        type, 
        name, 
        description, 
        price, 
        points, 
        is_active: isActive,
        dessert_id: currentAdminDessertId
      };

      try {
        if (id) {
          const { error } = await supabase.from("brownie_items").update(data).eq("id", id);
          if (error) throw error;
          showMessage("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } else {
          const { error } = await supabase.from("brownie_items").insert([data]);
          if (error) throw error;
          showMessage("üéâ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        closeBrownieModal();
        loadBrownieMenus(currentAdminDessertId);
        
        if (selectedDessert && selectedDessert.id === currentAdminDessertId) {
          loadMenus(currentAdminDessertId);
        }
      } catch (err) {
        console.error(err);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      }
    };

    document.getElementById("dessert-form").onsubmit = async (e) => {
      e.preventDefault();

      const id = document.getElementById("dessert-id").value;
      const name = document.getElementById("dessert-name").value;
      const emoji = document.getElementById("dessert-emoji").value;
      const description = document.getElementById("dessert-desc").value;
      const isActive = document.getElementById("dessert-active").checked;

      const data = { name, emoji, description, is_active: isActive };

      try {
        if (id) {
          const { error } = await supabase.from("desserts").update(data).eq("id", id);
          if (error) throw error;
          showMessage("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } else {
          const { error } = await supabase.from("desserts").insert([data]);
          if (error) throw error;
          showMessage("üéâ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ô‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        closeDessertModal();
        loadAdminDesserts();
        loadDesserts();
      } catch (err) {
        console.error(err);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      }
    };

    window.addEventListener("load", init);
  </script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    init();
  });
  </script>

</body>
</html>
