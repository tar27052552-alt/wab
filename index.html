<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brownie Studio - Order Online</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
      min-height: 100vh;
    }
    * { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      font-weight: 500;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
    }
    .selected {
      border: 4px solid #1d4ed8 !important;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(29, 78, 216, 0.5);
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .float { animation: float 3s ease-in-out infinite; }
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-full">
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="text-center">
      <div class="spinner mb-4 mx-auto"></div>
      <p class="text-white text-xl font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>
  </div>

  <!-- Header -->
  <header id="main-header" class="glass shadow-sm border-b border-white/20 sticky top-0 z-40 hidden">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <!-- Points Section -->
        <div class="flex items-center space-x-3">
          <div class="text-2xl float">ü™ô</div>
          <div>
            <div class="text-sm text-gray-500">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
            <div class="font-semibold text-gray-900">
              <span id="userPoints" class="text-orange-600 font-semibold">0</span> ‡πÅ‡∏ï‡πâ‡∏°
            </div>
          </div>
        </div>

        <!-- User Section -->
        <div class="flex items-center space-x-2 sm:space-x-3">
          <div class="flex items-center space-x-2">
            <img id="userPic" src="" alt="Profile" class="w-8 h-8 rounded-full border border-gray-300" />
            <span id="userName" class="text-sm text-gray-600 hidden sm:block">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
          </div>
          <button onclick="showCart()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-xl text-sm hover-lift relative">
            <span class="hidden sm:inline">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
            <span class="sm:hidden">üõí</span>
            <span id="cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
          </button>
          <button onclick="showOrderHistory()" class="btn-secondary px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
            <span class="sm:hidden">üìã</span>
          </button>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            <span class="sm:hidden">üö™</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main App -->
  <main id="main-app" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <!-- Hero Section -->
    <div class="text-center mb-12">
      <div class="text-6xl mb-4 float">ü´ê</div>
      <h1 class="text-4xl font-bold mb-2" style="background: linear-gradient(135deg, #1f2937, #374151); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Brownie Studio</h1>
      <p class="text-gray-600 text-lg mb-4">‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <!-- Base Selection -->
    <section class="card mb-8 hover-lift">
      <h2 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
        <span class="mr-3">ü´ê</span>
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="brownie-base card border-2 border-gray-200 cursor-pointer hover-lift" onclick="selectBase('cocoa', this)">
          <div class="text-center">
            <div class="text-6xl mb-3">ü´ê</div>
            <h3 class="font-semibold text-gray-900 mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÇ‡∏Å‡πÇ‡∏Å‡πâ</h3>
            <p class="text-sm text-gray-500 mb-3">‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡πÇ‡∏Å‡πÇ‡∏Å‡πâ‡πÅ‡∏ó‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô</p>
            <div class="text-lg font-bold text-blue-600">25 ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </div>

        <div class="brownie-base card border-2 border-gray-200 cursor-pointer hover-lift" onclick="selectBase('greentea', this)">
          <div class="text-center">
            <div class="text-6xl mb-3">üçÉ</div>
            <h3 class="font-semibold text-gray-900 mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</h3>
            <p class="text-sm text-gray-500 mb-3">‡∏´‡∏≠‡∏°‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÅ‡∏ó‡πâ</p>
            <div class="text-lg font-bold text-blue-600">25 ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </div>

        <div class="brownie-base card border-2 border-gray-200 cursor-pointer hover-lift" onclick="selectBase('thaitea', this)">
          <div class="text-center">
            <div class="text-6xl mb-3">üß°</div>
            <h3 class="font-semibold text-gray-900 mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢</h3>
            <p class="text-sm text-gray-500 mb-3">‡∏´‡∏ß‡∏≤‡∏ô‡∏´‡∏≠‡∏°‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏ó‡πâ</p>
            <div class="text-lg font-bold text-blue-600">25 ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Toppings Section -->
    <section id="toppings-section" class="card mb-8 hidden hover-lift">
      <h2 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
        <span class="mr-3">üç™</span>
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="topping-item card border-2 border-gray-200 cursor-pointer hover-lift" onclick="selectTopping('chocolate', this)">
          <div class="text-center">
            <div class="text-4xl mb-3">üç´</div>
            <h3 class="font-medium text-gray-900 mb-1">‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï‡∏ä‡∏¥‡∏û</h3>
            <p class="text-sm text-gray-500 mb-3">‡∏´‡∏≠‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô</p>
            <div class="text-lg font-bold text-blue-600">15 ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </div>

        <div class="topping-item card border-2 border-gray-200 cursor-pointer hover-lift" onclick="selectTopping('almond', this)">
          <div class="text-center">
            <div class="text-4xl mb-3">üå∞</div>
            <h3 class="font-medium text-gray-900 mb-1">‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå‡πÅ‡∏ú‡πà‡∏ô</h3>
            <p class="text-sm text-gray-500 mb-3">‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏≠‡∏°‡∏ô‡∏±‡∏ó</p>
            <div class="text-lg font-bold text-blue-600">15 ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </div>

        <div class="topping-item card border-2 border-gray-200 cursor-pointer hover-lift" onclick="selectTopping('oreo', this)">
          <div class="text-center">
            <div class="text-4xl mb-3">üç™</div>
            <h3 class="font-medium text-gray-900 mb-1">‡πÇ‡∏≠‡∏£‡∏¥‡πÇ‡∏≠‡πâ‡∏ö‡∏î</h3>
            <p class="text-sm text-gray-500 mb-3">‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô</p>
            <div class="text-lg font-bold text-blue-600">15 ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Add to Cart -->
    <section class="card text-center hover-lift">
      <div class="mb-6">
        <div class="text-3xl font-bold" style="background: linear-gradient(135deg, #1f2937, #374151); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
          ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <span id="total-price">0</span> ‡∏ö‡∏≤‡∏ó
        </div>
      </div>
      <button id="add-to-cart-btn" onclick="addToCart()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
        üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      </button>
    </section>
  </main>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="card max-w-2xl w-full max-h-[80vh] overflow-y-auto hover-lift">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <div id="cart-content" class="mb-6"></div>
      <div class="border-t pt-4">
        <div class="flex justify-between items-center mb-4">
          <span class="text-xl font-bold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
          <span id="cart-total" class="text-2xl font-bold text-blue-600">0 ‡∏ö‡∏≤‡∏ó</span>
        </div>
        <button onclick="checkout()" class="btn-primary w-full py-3 rounded-xl font-semibold text-lg">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div id="success-message" class="fixed top-20 right-4 card shadow-lg hidden z-50">
    <div class="flex items-center space-x-3">
      <div class="text-2xl">üéâ</div>
      <div id="success-text" class="font-medium text-gray-900"></div>
    </div>
  </div>

  <script>
    // ===============================================================
    // 1. CONFIGURATION
    // ===============================================================
    const LIFF_ID = "2008357926-Ly07A5w2";
    const SUPABASE_URL = "https://kpxgskwtxwkqoztkkrwu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtwdmdza3d0eHdrcW96dGtrcnd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDQyNDQ4MDcsImV4cCI6MjAxOTgyMDgwN30.i9w7_YgW3-V8T2N_05P_6qHw6k3qWb0P_3o_rO0t6gU";

    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===============================================================
    // 2. STATE VARIABLES
    // ===============================================================
    let currentUser = null;
    let selectedBase = null;
    let selectedTopping = null;
    let cart = [];
    let userPoints = 0;

    const baseNames = {
      cocoa: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÇ‡∏Å‡πÇ‡∏Å‡πâ",
      greentea: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß",
      thaitea: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢"
    };

    const toppingNames = {
      chocolate: "‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï‡∏ä‡∏¥‡∏û",
      almond: "‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå‡πÅ‡∏ú‡πà‡∏ô",
      oreo: "‡πÇ‡∏≠‡∏£‡∏¥‡πÇ‡∏≠‡πâ‡∏ö‡∏î"
    };

    // ===============================================================
    // 3. INITIALIZATION
    // ===============================================================
    async function init() {
      try {
        // Initialize LIFF
        await liff.init({ liffId: LIFF_ID });
        console.log("‚úÖ LIFF Initialized");

        // Check if logged in
        if (!liff.isLoggedIn()) {
          console.log("‚ùå Not logged in, redirecting to LINE Login...");
          liff.login();
          return;
        }

        // Get LINE profile
        const profile = await liff.getProfile();
        console.log("üë§ Profile loaded:", profile);

        // Save/update user in Supabase
        await saveUserToSupabase(profile);

        // Load user data
        await loadUserData(profile.userId);

        // Show main app
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("main-header").classList.remove("hidden");
        document.getElementById("main-app").classList.remove("hidden");

      } catch (error) {
        console.error("‚ùå Init error:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
        setTimeout(() => {
          liff.login();
        }, 2000);
      }
    }

    // ===============================================================
    // 4. USER MANAGEMENT
    // ===============================================================
    async function saveUserToSupabase(profile) {
      try {
        const { data: existingUser, error: findError } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", profile.userId)
          .maybeSingle();

        if (findError && findError.code !== "PGRST116") {
          throw findError;
        }

        if (!existingUser) {
          // Insert new user
          const { error: insertError } = await supabase
            .from("users")
            .insert([{
              line_id: profile.userId,
              display_name: profile.displayName,
              picture_url: profile.pictureUrl,
              points: 0
            }]);

          if (insertError) throw insertError;
          console.log("‚úÖ New user created in Supabase");
        } else {
          console.log("üü¢ User already exists in Supabase");
        }
      } catch (error) {
        console.error("‚ùå Error saving user:", error);
        throw error;
      }
    }

    async function loadUserData(userId) {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", userId)
          .single();

        if (error) throw error;

        currentUser = data;
        userPoints = data.points || 0;

        // Update UI
        document.getElementById("userName").textContent = data.display_name;
        document.getElementById("userPic").src = data.picture_url;
        document.getElementById("userPoints").textContent = userPoints;

        console.log("‚úÖ User data loaded:", data);
      } catch (error) {
        console.error("‚ùå Error loading user data:", error);
        throw error;
      }
    }

    async function logout() {
      if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        liff.logout();
        window.location.reload();
      }
    }

    // ===============================================================
    // 5. ORDER MANAGEMENT
    // ===============================================================
    function selectBase(base, element) {
      // Remove previous selection
      document.querySelectorAll(".brownie-base").forEach(el => {
        el.classList.remove("selected");
      });

      // Select new base
      element.classList.add("selected");
      selectedBase = base;

      // Show toppings section
      document.getElementById("toppings-section").classList.remove("hidden");

      updateTotal();
    }

    function selectTopping(topping, element) {
      // Remove previous selection
      document.querySelectorAll(".topping-item").forEach(el => {
        el.classList.remove("selected");
      });

      // Select new topping
      element.classList.add("selected");
      selectedTopping = topping;

      updateTotal();
    }

    function updateTotal() {
      const basePrice = selectedBase ? 25 : 0;
      const toppingPrice = selectedTopping ? 15 : 0;
      const total = basePrice + toppingPrice;

      document.getElementById("total-price").textContent = total;

      const addButton = document.getElementById("add-to-cart-btn");
      addButton.disabled = !selectedBase || !selectedTopping;
    }

    function addToCart() {
      if (!selectedBase || !selectedTopping) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà");
        return;
      }

      const item = {
        id: Date.now(),
        base: selectedBase,
        topping: selectedTopping,
        price: 40,
        baseName: baseNames[selectedBase],
        toppingName: toppingNames[selectedTopping]
      };

      cart.push(item);
      updateCartBadge();
      
      // Reset selections
      document.querySelectorAll(".brownie-base, .topping-item").forEach(el => {
        el.classList.remove("selected");
      });
      selectedBase = null;
      selectedTopping = null;
      updateTotal();

      showMessage("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üõí");
    }

    function updateCartBadge() {
      const badge = document.getElementById("cart-badge");
      if (cart.length > 0) {
        badge.textContent = cart.length;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }

    function showCart() {
      const modal = document.getElementById("cart-modal");
      const content = document.getElementById("cart-content");

      if (cart.length === 0) {
        content.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">üõí</div>
            <p class="text-gray-600 text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
          </div>
        `;
      } else {
        let html = '<div class="space-y-3">';
        cart.forEach((item, index) => {
          html += `
            <div class="card border border-gray-200 p-4">
              <div class="flex justify-between items-start">
                <div>
                  <div class="font-semibold">${item.baseName}</div>
                  <div class="text-sm text-gray-600">‡∏´‡∏ô‡πâ‡∏≤: ${item.toppingName}</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-blue-600">${item.price} ‡∏ö‡∏≤‡∏ó</div>
                  <button onclick="removeFromCart(${index})" class="text-red-500 text-sm mt-1">‡∏•‡∏ö</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;
      }

      const total = cart.reduce((sum, item) => sum + item.price, 0);
      document.getElementById("cart-total").textContent = total + " ‡∏ö‡∏≤‡∏ó";

      modal.classList.remove("hidden");
    }

    function closeCart() {
      document.getElementById("cart-modal").classList.add("hidden");
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartBadge();
      showCart();
    }

    async function checkout() {
      if (cart.length === 0) {
        showMessage("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
        return;
      }

      try {
        const total = cart.reduce((sum, item) => sum + item.price, 0);
        const earnedPoints = total;

        // Create order in Supabase
        const { data: orderData, error: orderError } = await supabase
          .from("orders")
          .insert([{
            user_id: currentUser.id,
            line_id: currentUser.line_id,
            items: cart,
            total_price: total,
            earned_points: earnedPoints,
            status: "pending"
          }])
          .select()
          .single();

        if (orderError) throw orderError;

        // Update user points
        const { error: updateError } = await supabase
          .from("users")
          .update({ points: userPoints + earnedPoints })
          .eq("id", currentUser.id);

        if (updateError) throw updateError;

        // Update local state
        userPoints += earnedPoints;
        document.getElementById("userPoints").textContent = userPoints;
        cart = [];
        updateCartBadge();
        closeCart();

        showMessage(`‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏° +${earnedPoints} ‡πÅ‡∏ï‡πâ‡∏° üéâ`);

      } catch (error) {
        console.error("‚ùå Checkout error:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
      }
    }

    async function showOrderHistory() {
      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .eq("line_id", currentUser.line_id)
          .order("created_at", { ascending: false });

        if (error) throw error;

        if (orders.length === 0) {
          showMessage("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
          return;
        }

        let message = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:\n\n";
        orders.forEach((order, i) => {
          message += `${i + 1}. ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total_price} ‡∏ö‡∏≤‡∏ó\n`;
          message += `   ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${order.status}\n`;
          message += `   ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(order.created_at).toLocaleDateString('th-TH')}\n\n`;
        });

        alert(message);

      } catch (error) {
        console.error("‚ùå Error loading orders:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥");
      }
    }

    // ===============================================================
    // 6. UTILITY FUNCTIONS
    // ===============================================================
    function showMessage(message) {
      const successMessage = document.getElementById("success-message");
      const successText = document.getElementById("success-text");
      successText.textContent = message;
      successMessage.classList.remove("hidden");

      setTimeout(() => {
        successMessage.classList.add("hidden");
      }, 3000);
    }

    // ===============================================================
    // 7. START APPLICATION
    // ===============================================================
    window.addEventListener("load", init);
  </script>
</body>
</html>
