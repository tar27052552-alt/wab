<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SUAN KHANOM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
      min-height: 100vh;
    }
    * { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      font-weight: 500;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.8);
      color: #374151;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
    }
    .selected {
      border: 4px solid #1d4ed8 !important;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(29, 78, 216, 0.5);
    }
    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .float { animation: float 3s ease-in-out infinite; }
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-preparing { background: #dbeafe; color: #1e40af; }
    .badge-ready { background: #d1fae5; color: #065f46; }
    .badge-completed { background: #e0e7ff; color: #3730a3; }
    .badge-cancelled { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="min-h-full">
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="text-center">
      <div class="spinner mb-4 mx-auto"></div>
      <p class="text-white text-xl font-semibold">กำลังโหลด...</p>
    </div>
  </div>

  <!-- Header -->
  <header id="main-header" class="glass shadow-sm border-b border-white/20 sticky top-0 z-40 hidden">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-2xl float">🪙</div>
          <div>
            <div class="text-sm text-gray-500">แต้มสะสม</div>
            <div class="font-semibold text-gray-900">
              <span id="userPoints" class="text-orange-600 font-semibold">0</span> แต้ม
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-3">
          <div class="flex items-center space-x-2">
            <img id="userPic" src="" alt="Profile" class="w-8 h-8 rounded-full border border-gray-300" />
            <span id="userName" class="text-sm text-gray-600 hidden sm:block">กำลังโหลด...</span>
          </div>
          <button onclick="showCart()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-xl text-sm hover-lift relative">
            <span class="hidden sm:inline">🛒 ตะกร้า</span>
            <span class="sm:hidden">🛒</span>
            <span id="cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
          </button>
          <button onclick="showCoupons()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">🎫 คูปอง</span>
            <span class="sm:hidden">🎫</span>
          </button>
          <button onclick="openOrderHistory()" 
            class="btn-secondary px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">📋 ประวัติ</span>
            <span class="sm:hidden">📋</span>
          </button>
          <button id="admin-btn" onclick="showAdmin()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-xl text-sm hover-lift hidden">
            <span class="hidden sm:inline">👨‍💼 Admin</span>
            <span class="sm:hidden">👨‍💼</span>
          </button>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">ออกจากระบบ</span>
            <span class="sm:hidden">🚪</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main App -->
  <main id="main-app" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <div class="text-center mb-12">
      <div class="text-6xl mb-4 float">🍫</div>
      <h1 class="text-4xl font-bold mb-2" style="background: linear-gradient(135deg, #1f2937, #374151); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SUAN KHANOM</h1>
      <p class="text-gray-600 text-lg mb-4">สั่งทำพิเศษเพื่อคุณ</p>
    </div>

    <section id="product-type-section" class="bg-white p-6 rounded-xl shadow-md mb-6">
  <h3 class="text-xl font-semibold mb-4">🍰 เลือกประเภทขนม</h3>
  <div id="product-type-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>

<section id="base-section" class="bg-white p-6 rounded-xl shadow-md mb-6 hidden">
  <h3 id="base-title" class="text-xl font-semibold mb-4">🍫 เลือกเนื้อ...</h3>
  <div id="base-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>

<section id="topping-section" class="bg-white p-6 rounded-xl shadow-md mb-6 hidden">
  <h3 id="topping-title" class="text-xl font-semibold mb-4">🫀 เลือกหน้า...</h3>
  <div id="topping-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>


    <!-- จำนวนและราคารวม -->
    <section id="quantity-section" class="card mb-8 hover-lift">
      <h2 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
        <span class="mr-3">📦</span> จำนวนและราคารวม
      </h2>
      
      <div class="flex items-center justify-center space-x-6">
        <button onclick="changeQuantity(-1)" 
                class="quantity-btn bg-red-500 hover:bg-red-600 text-white">
          −
        </button>

        <div class="text-center">
          <div class="text-5xl font-bold text-gray-900" id="quantity">1</div>
          <div class="text-sm text-gray-500 mt-2">ชิ้น</div>
        </div>

        <button onclick="changeQuantity(1)" 
                class="quantity-btn bg-green-500 hover:bg-green-600 text-white">
          +
        </button>
      </div>
    </section>

    <!-- ปุ่มเพิ่มลงตะกร้า -->
    <section class="card text-center hover-lift">
      <div class="mb-6">
        <div class="text-3xl font-bold text-gray-900">
          💰 ราคารวม: <span id="total-price">0</span> บาท
        </div>
      </div>

      <button id="add-to-cart" 
              onclick="addToCart()" 
              class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed"
              disabled>
        🛒 เพิ่มลงตะกร้า
      </button>
    </section>
  </main>

  <!-- Order History -->
  <section id="order-history" class="hidden px-4 py-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-purple-800 flex items-center gap-2">
        <span class="text-2xl">📦</span> ประวัติคำสั่งซื้อของฉัน
      </h2>
      <button 
        onclick="backToMain()" 
        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md transition">
        ⬅️ กลับหน้าหลัก
      </button>
    </div>
    <div id="order-list" class="space-y-4"></div>
  </section>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'cart-modal')">
    <div class="card max-w-2xl w-full max-h-[80vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">🛒 ตะกร้าสินค้า</h3>
        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>
      <div id="cart-content" class="mb-6"></div>
      
      <!-- Coupon Section -->
      <div id="coupon-section" class="mb-6 p-4 bg-purple-50 rounded-xl">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-gray-900">🎫 ใช้คูปอง</h4>
          <button onclick="showCoupons()" class="text-purple-600 text-sm hover:underline">ดูคูปองทั้งหมด</button>
        </div>
        <div id="selected-coupon" class="hidden mb-3 p-3 bg-white rounded-lg border-2 border-purple-300">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium text-purple-900" id="coupon-name"></div>
              <div class="text-sm text-purple-700" id="coupon-desc"></div>
            </div>
            <button onclick="removeCoupon()" class="text-red-500 hover:text-red-700 text-sm font-medium">ลบ</button>
          </div>
        </div>
        <div class="flex gap-2">
          <input type="text" id="coupon-input" placeholder="กรอกโค้ดคูปอง" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
          <button onclick="applyCouponCode()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">ใช้</button>
        </div>
        <div id="coupon-message" class="text-sm mt-2 hidden"></div>
      </div>

      <div class="border-t pt-4">
        <div class="space-y-2 mb-4">
          <div class="flex justify-between text-gray-700">
            <span>ยอดรวม:</span>
            <span id="cart-subtotal">0 บาท</span>
          </div>
          <div id="discount-row" class="flex justify-between text-green-600 hidden">
            <span>ส่วนลด:</span>
            <span id="discount-amount">-0 บาท</span>
          </div>
          <div class="flex justify-between items-center text-xl font-bold border-t pt-2">
            <span>รวมทั้งหมด:</span>
            <span id="cart-total" class="text-blue-600">0 บาท</span>
          </div>
        </div>
        <button onclick="checkout()" class="btn-primary w-full py-3 rounded-xl font-semibold text-lg">✅ ยืนยันการสั่ง</button>
      </div>
    </div>
  </div>

  <!-- Coupons Modal -->
  <div id="coupons-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'coupons-modal')">
    <div class="card max-w-4xl w-full max-h-[80vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">🎫 คูปองของฉัน</h3>
        <button onclick="closeCoupons()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>
      <div id="coupons-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'admin-modal')">
    <div class="card max-w-6xl w-full max-h-[90vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">👨‍💼 Admin Dashboard</h3>
        <button onclick="closeAdmin()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>

      <!-- Admin Tabs -->
      <div class="flex space-x-4 mb-6 border-b">
        <button onclick="showAdminTab('orders')" class="admin-tab px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600" data-tab="orders">
          📦 จัดการออเดอร์
        </button>
        <button onclick="showAdminTab('coupons')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="coupons">
          🎫 จัดการคูปอง
        </button>
        <button onclick="showAdminTab('stats')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="stats">
          📊 สถิติ
        </button>
        <button onclick="showAdminTab('menu')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="brownie">
          📋 จัดการเมนู
        </button>
        <button onclick="showAdminTab('summary')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="summary">
          📅 สรุปออเดอร์รายวัน
        </button>
      </div>

      <!-- Brownie Tab -->
      <section id="admin-menu-tab" class="admin-tab-content hidden">
        <div id="admin-brownie-content" class="p-4"></div>
      </section>

      <!-- 🧁 หน้าจัดการเมนู (เพิ่มใหม่ตรงนี้) -->
    <div id="admin-menu-content" class="hidden p-4">
      <h2 class="text-2xl font-bold mb-4">📋 จัดการเมนูขนม</h2>
      <div id="admin-brownie-content"></div>
    </div>

      <!-- Orders Tab -->
      <div id="admin-orders-tab" class="admin-tab-content">
        <div id="admin-orders-content"></div>
      </div>

      <!-- Coupons Tab -->
      <div id="admin-coupons-tab" class="admin-tab-content hidden">
        <div class="mb-6">
          <button onclick="showCreateCouponForm()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">
            ➕ สร้างคูปองใหม่
          </button>
        </div>
        <div id="admin-coupons-content"></div>
      </div>

      <!-- Summary Tab -->
      <div id="admin-summary-tab" class="admin-tab-content hidden space-y-4">
        <div class="flex flex-wrap gap-3 items-center">
          <input type="date" id="summary-date" class="border rounded-lg px-3 py-2 shadow-sm">
          <button onclick="loadDailySummary()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
            ดูสรุป
          </button>
          <button onclick="updateAllOrdersOfDay()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
            อัปเดตสถานะทั้งหมดของวัน
          </button>
        </div>
        <div id="summary-content" class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200 min-h-[150px]">
          <p class="text-gray-500 text-center">📆 กรุณาเลือกวันที่เพื่อดูสรุปออเดอร์</p>
        </div>
      </div>

      <!-- Stats Tab -->
      <div id="admin-stats-tab" class="admin-tab-content hidden">
        <div id="admin-stats-content" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </div>
    </div>
  </div>

  <!-- Create Coupon Modal -->
  <div id="create-coupon-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'create-coupon-modal')">
    <div class="card max-w-md w-full hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">➕ สร้างคูปองใหม่</h3>
        <button onclick="closeCreateCoupon()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>
      <form onsubmit="createCoupon(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">รหัสคูปอง</label>
          <input type="text" id="coupon-code" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น WELCOME10" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อคูปอง</label>
          <input type="text" id="coupon-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น ลด 10%" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบาย</label>
          <input type="text" id="coupon-description" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น ลด 10% สำหรับสมาชิกใหม่" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทส่วนลด</label>
          <select id="coupon-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="percent">เปอร์เซ็นต์ (%)</option>
            <option value="fixed">จำนวนเงิน (บาท)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">มูลค่าส่วนลด</label>
          <input type="number" id="coupon-value" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น 10" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ยอดขั้นต่ำ (บาท)</label>
          <input type="number" id="coupon-min" value="0" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนการใช้งาน</label>
          <input type="number" id="coupon-usage" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>
        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold">
          สร้างคูปอง
        </button>
      </form>
    </div>
  </div>

  <!-- Brownie Modal -->
 <div id="brownie-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-xl p-6 w-96 relative">
    <h3 id="brownie-modal-title" class="text-xl font-bold mb-4">🍫 เพิ่มเมนู</h3>

    <form id="brownie-form" class="space-y-3">
      <input type="hidden" id="brownie-id">
      <input type="hidden" id="brownie-type">

      <div>
        <label class="block text-sm font-medium">ชื่อเมนู</label>
        <input id="brownie-name" class="w-full border p-2 rounded" required>
      </div>

      <div>
        <label class="block text-sm font-medium">คำอธิบาย</label>
        <textarea id="brownie-desc" class="w-full border p-2 rounded"></textarea>
      </div>

      <div class="flex gap-2">
        <div class="flex-1">
          <label class="block text-sm font-medium">ราคา (บาท)</label>
          <input id="brownie-price" type="number" class="w-full border p-2 rounded" required>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium">แต้ม</label>
          <input id="brownie-points" type="number" class="w-full border p-2 rounded">
        </div>
      </div>

      <label class="flex items-center gap-2">
        <input id="brownie-active" type="checkbox" checked> เปิดขาย
      </label>

      <div class="flex justify-end gap-2 mt-4">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">บันทึก</button>
        <button type="button" onclick="closeBrownieModal()" class="bg-gray-300 px-4 py-2 rounded">ยกเลิก</button>
      </div>
    </form>
  </div>
</div>

  <!-- Success Message -->
  <div id="success-message" class="fixed top-20 right-4 card shadow-lg hidden z-50">
    <div class="flex items-center space-x-3">
      <div class="text-2xl">🎉</div>
      <div id="success-text" class="font-medium text-gray-900"></div>
    </div>
  </div>

  <script>
    // ===============================================================
    // 1. CONFIGURATION
    // ===============================================================
    const LIFF_ID = "2008357926-Ly07A5w2";
    const SUPABASE_URL = "https://dyorwbjagjlkqpbrdjwk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5b3J3YmphZ2psa3FwYnJkandrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjk2NjgsImV4cCI6MjA3Njk0NTY2OH0.bZJRcaM3u9NUBrux5AbPXOXVtcSnJHDdK15gCQ-9Zc4";
    const ADMIN_IDS = ["Ud21a04a5d66c9de0b4c6f1aaf8f050e2","U5301bd5962323787574d82f86f3d954e"];

    // ===============================================================
// 🧠 ตัวแปร Global (ใช้เก็บสถานะของระบบทั้งหมด)
// ===============================================================
let supabase;
let userProfile = null;
let currentUser = null;
let selectedBase = null;
let selectedTopping = null;
let quantity = 1;
let cart = [];
let userPoints = 0;
let selectedCoupon = null;
let availableCoupons = [];

// ===============================================================
// 🍫 เพิ่มใหม่สำหรับระบบหลายประเภทขนม
// ===============================================================
let selectedProductType = null; // 🧁 เก็บประเภทขนมที่ผู้ใช้เลือก เช่น "บราวนี่", "คุกกี้"
let allMenus = [];              // 🍪 เก็บเมนูทั้งหมด (base + topping) จาก Supabase

    // ===============================================================
    // 2. INITIALIZATION
    // ===============================================================
    async function init() {
      try {
        // Initialize Supabase
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("✅ Supabase initialized");

        // Initialize LIFF
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        userProfile = await liff.getProfile();
        await saveUserToSupabase(userProfile);
        await loadUserData(userProfile.userId);
        await loadCoupons();
        await loadProductTypes();

        // Check admin
        if (ADMIN_IDS.includes(userProfile.userId)) {
          document.getElementById("admin-btn").classList.remove("hidden");
        }

        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("main-header").classList.remove("hidden");
        document.getElementById("main-app").classList.remove("hidden");
      } catch (error) {
        console.error("❌ Init error:", error);
        showMessage("เกิดข้อผิดพลาดในการเข้าสู่ระบบ");
      }
    }

    // ===============================================================
    // 3. USER MANAGEMENT
    // ===============================================================
    async function saveUserToSupabase(profile) {
      try {
        const { data: existingUser, error: findError } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", profile.userId)
          .maybeSingle();

        if (findError && findError.code !== "PGRST116") throw findError;

        if (!existingUser) {
          const { error: insertError } = await supabase
            .from("users")
            .insert([{
              line_id: profile.userId,
              display_name: profile.displayName,
              picture_url: profile.pictureUrl,
              points: 0
            }]);

          if (insertError) throw insertError;
          console.log("✅ New user created");
        } else {
          console.log("🟢 User exists");
        }
      } catch (error) {
        console.error("❌ Error saving user:", error);
        throw error;
      }
    }

    async function loadUserData(userId) {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", userId)
          .single();

        if (error) throw error;

        currentUser = data;
        userPoints = data.points || 0;

        document.getElementById("userName").textContent = data.display_name;
        document.getElementById("userPic").src = data.picture_url;
        document.getElementById("userPoints").textContent = userPoints;

        console.log("✅ User data loaded:", data);
      } catch (error) {
        console.error("❌ Error loading user data:", error);
        throw error;
      }
    }

    function logout() {
      if (confirm("ต้องการออกจากระบบหรือไม่?")) {
        liff.logout();
        window.location.reload();
      }
    }

    // ===============================================================
    // 4. MENU MANAGEMENT
    // ===============================================================

    function extractEmoji(text) {
      const emojiRegex = /[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu;
      const match = text.match(emojiRegex);
      return match ? match[0] : '🍫';
    }

    function removeEmoji(text) {
      const emojiRegex = /[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu;
      return text.replace(emojiRegex, '').trim();
    }

   function selectBase(event, id, name, price, points) {
      // 1. เก็บข้อมูล (รวมแต้ม)
      selectedBase = { id, name, price, points: points || 0 };
      
      // 2. อัปเดต UI
      document.querySelectorAll('.brownie-base').forEach(e => e.classList.remove('selected'));
      if (event) { // (FIX) ตรวจสอบว่า event มีค่าก่อนใช้
          event.currentTarget.classList.add('selected');
      }
      
      updateTotal();
    }

    function selectTopping(event, id, name, price, points) {
      // 1. เก็บข้อมูล (รวมแต้ม)
      selectedTopping = { id, name, price, points: points || 0 };
      
      // 2. อัปเดต UI
      document.querySelectorAll('.topping-item').forEach(e => e.classList.remove('selected'));
      if (event) { // (FIX) ตรวจสอบว่า event มีค่าก่อนใช้
          event.currentTarget.classList.add('selected');
      }

      updateTotal();
    }

    // ===============================================================
    // 5. CART MANAGEMENT
    // ===============================================================
    function changeQuantity(v) {
      quantity = Math.max(1, quantity + v);
      document.getElementById("quantity").textContent = quantity;
      updateTotal();
    }

    function updateTotal() {
      const basePrice = selectedBase?.price || 0;
      const toppingPrice = selectedTopping?.price || 0;
      const total = (basePrice + toppingPrice) * quantity;
      document.getElementById("total-price").textContent = total.toLocaleString();
      document.getElementById("add-to-cart").disabled = !(selectedBase && selectedTopping);
    }

    function addToCart() {
      if (!selectedBase || !selectedTopping) {
        showMessage("กรุณาเลือกเนื้อและหน้าบราวนี่");
        return;
      }

      const total = (selectedBase.price + selectedTopping.price) * quantity;
      cart.push({
        baseName: selectedBase.name,
        toppingName: selectedTopping.name,
        quantity,
        unitPrice: selectedBase.price + selectedTopping.price,
        totalPrice: total
      });

      updateCartBadge();
      showMessage("🧺 เพิ่มลงตะกร้าแล้ว!");
      quantity = 1;
      document.getElementById("quantity").textContent = "1";
      updateTotal();
      
      // Reset selections
      document.querySelectorAll('.brownie-base').forEach(e => e.classList.remove('selected'));
      document.querySelectorAll('.topping-item').forEach(e => e.classList.remove('selected'));
      selectedBase = null;
      selectedTopping = null;
    }

    function updateCartBadge() {
      const badge = document.getElementById("cart-badge");
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      
      if (totalItems > 0) {
        badge.textContent = totalItems;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }

    function showCart() {
      const modal = document.getElementById("cart-modal");
      const content = document.getElementById("cart-content");

      if (cart.length === 0) {
        content.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">🛒</div>
            <p class="text-gray-600 text-lg">ตะกร้าว่างเปล่า</p>
          </div>
        `;
      } else {
        let html = '<div class="space-y-3">';
        cart.forEach((item, index) => {
          html += `
            <div class="card border border-gray-200 p-4">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="font-semibold">${item.baseName}</div>
                  <div class="text-sm text-gray-600">หน้า: ${item.toppingName}</div>
                  <div class="text-sm text-gray-500 mt-1">จำนวน: ${item.quantity} ชิ้น</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-blue-600">${item.totalPrice} บาท</div>
                  <div class="flex items-center gap-2 mt-2">
                    <button onclick="updateCartQuantity(${index}, -1)" class="quantity-btn bg-red-500 hover:bg-red-600 text-white text-sm w-6 h-6">−</button>
                    <span class="text-sm font-medium">${item.quantity}</span>
                    <button onclick="updateCartQuantity(${index}, 1)" class="quantity-btn bg-green-500 hover:bg-green-600 text-white text-sm w-6 h-6">+</button>
                  </div>
                  <button onclick="removeFromCart(${index})" class="text-red-500 text-sm mt-2 hover:underline">ลบ</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;
      }

      updateCartTotal();
      modal.classList.remove("hidden");
    }

    function updateCartQuantity(index, change) {
      if (cart[index]) {
        cart[index].quantity = Math.max(1, cart[index].quantity + change);
        cart[index].totalPrice = cart[index].unitPrice * cart[index].quantity;
        updateCartBadge();
        showCart();
      }
    }

    function updateCartTotal() {
      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      let discount = 0;

      if (selectedCoupon) {
        if (selectedCoupon.type === 'percent') {
          discount = Math.floor(subtotal * selectedCoupon.value / 100);
        } else {
          discount = Math.min(selectedCoupon.value, subtotal);
        }
      }

      const total = Math.max(0, subtotal - discount);

      document.getElementById("cart-subtotal").textContent = subtotal + " บาท";
      document.getElementById("cart-total").textContent = total + " บาท";

      if (discount > 0) {
        document.getElementById("discount-row").classList.remove("hidden");
        document.getElementById("discount-amount").textContent = "-" + discount + " บาท";
      } else {
        document.getElementById("discount-row").classList.add("hidden");
      }
    }

    function closeCart() {
      document.getElementById("cart-modal").classList.add("hidden");
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartBadge();
      showCart();
      showMessage("ลบสินค้าออกจากตะกร้าแล้ว");
    }

    // ===============================================================
    // 6. COUPON SYSTEM
    // ===============================================================
    async function loadCoupons() {
      try {
        const { data, error } = await supabase
          .from("coupons")
          .select("*")
          .eq("is_active", true)
          .eq("show_in_list", true)
          .order("created_at", { ascending: false });

        if (error) throw error;

        availableCoupons = data || [];
        console.log("✅ Coupons loaded:", availableCoupons.length);
      } catch (error) {
        console.error("❌ Error loading coupons:", error);
      }
    }

    function showCoupons() {
      const modal = document.getElementById("coupons-modal");
      const content = document.getElementById("coupons-content");

      if (availableCoupons.length === 0) {
        content.innerHTML = `
          <div class="col-span-2 text-center py-12">
            <div class="text-6xl mb-4">🎫</div>
            <p class="text-gray-600 text-lg">ยังไม่มีคูปองที่ใช้ได้</p>
          </div>
        `;
      } else {
        let html = '';
        availableCoupons.forEach(coupon => {
          const canUse = coupon.usage_limit > coupon.usage_count;
          html += `
            <div class="card border-2 ${canUse ? 'border-purple-200 hover:border-purple-400 cursor-pointer' : 'border-gray-200 opacity-50'} p-4" ${canUse ? `onclick="selectCouponFromList('${coupon.code}')"` : ''}>
              <div class="flex items-start justify-between mb-3">
                <div class="text-3xl">🎫</div>
                <div class="text-xs ${canUse ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} px-2 py-1 rounded-full">
                  ${canUse ? 'ใช้ได้' : 'หมดแล้ว'}
                </div>
              </div>
              <div class="font-bold text-lg text-purple-900 mb-1">${coupon.name}</div>
              <div class="text-sm text-gray-600 mb-2">${coupon.description}</div>
              <div class="text-xs text-gray-500">รหัส: ${coupon.code}</div>
              <div class="text-xs text-gray-500">ยอดขั้นต่ำ: ${coupon.min_purchase} บาท</div>
              <div class="text-xs text-gray-500">เหลือ: ${coupon.usage_limit - coupon.usage_count} ครั้ง</div>
            </div>
          `;
        });
        content.innerHTML = html;
      }

      modal.classList.remove("hidden");
    }

    function closeCoupons() {
      document.getElementById("coupons-modal").classList.add("hidden");
    }

    function selectCouponFromList(code) {
      document.getElementById("coupon-input").value = code;
      closeCoupons();
      applyCouponCode();
    }

    async function applyCouponCode() {
      const code = document.getElementById("coupon-input").value.trim().toUpperCase();

      if (!code) {
        showCouponMessage("กรุณากรอกโค้ดคูปอง", "error");
        return;
      }

      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);

      try {
        const { data: coupon, error } = await supabase
          .from("coupons")
          .select("*")
          .eq("code", code)
          .eq("is_active", true)
          .single();

        if (error || !coupon) {
          showCouponMessage("ไม่พบคูปองนี้หรือหมดอายุแล้ว", "error");
          return;
        }

        if (coupon.usage_count >= coupon.usage_limit) {
          showCouponMessage("คูปองนี้ถูกใช้หมดแล้ว", "error");
          return;
        }

        if (subtotal < coupon.min_purchase) {
          showCouponMessage(`ยอดขั้นต่ำ ${coupon.min_purchase} บาท`, "error");
          return;
        }

        selectedCoupon = coupon;
        document.getElementById("selected-coupon").classList.remove("hidden");
        document.getElementById("coupon-name").textContent = coupon.name;
        document.getElementById("coupon-desc").textContent = coupon.description;
        document.getElementById("coupon-input").value = "";

        updateCartTotal();
        showCouponMessage("ใช้คูปองสำเร็จ! 🎉", "success");

      } catch (error) {
        console.error("❌ Error applying coupon:", error);
        showCouponMessage("เกิดข้อผิดพลาด", "error");
      }
    }

    function removeCoupon() {
      selectedCoupon = null;
      document.getElementById("selected-coupon").classList.add("hidden");
      updateCartTotal();
      showMessage("ลบคูปองแล้ว");
    }

    function showCouponMessage(message, type) {
      const messageEl = document.getElementById("coupon-message");
      messageEl.textContent = message;
      messageEl.className = `text-sm mt-2 ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
      messageEl.classList.remove("hidden");
      setTimeout(() => messageEl.classList.add("hidden"), 3000);
    }

    // ===============================================================
    // 7. CHECKOUT
    // ===============================================================
    async function checkout() {
      if (cart.length === 0) {
        showMessage("ตะกร้าว่างเปล่า");
        return;
      }

      try {
        const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
        let discount = 0;

        if (selectedCoupon) {
          if (selectedCoupon.type === 'percent') {
            discount = Math.floor(subtotal * selectedCoupon.value / 100);
          } else {
            discount = Math.min(selectedCoupon.value, subtotal);
          }
        }

        const total = Math.max(0, subtotal - discount);
        const earnedPoints = total;

        const { data: orderData, error: orderError } = await supabase
          .from("orders")
          .insert([{
            user_id: currentUser.id,
            line_id: currentUser.line_id,
            items: cart,
            subtotal: subtotal,
            discount: discount,
            total_price: total,
            earned_points: earnedPoints,
            coupon_code: selectedCoupon ? selectedCoupon.code : null,
            status: "pending"
          }])
          .select()
          .single();

        if (orderError) throw orderError;

        if (selectedCoupon) {
          await supabase
            .from("coupons")
            .update({ usage_count: selectedCoupon.usage_count + 1 })
            .eq("id", selectedCoupon.id);
        }

        //await supabase
          //.from("users")
          //.update({ points: userPoints + earnedPoints })
          //.eq("id", currentUser.id);

        //userPoints += earnedPoints;
        //document.getElementById("userPoints").textContent = userPoints;
        cart = [];
        selectedCoupon = null;
        updateCartBadge();
        closeCart();
        await loadCoupons();

        showMessage(`สั่งซื้อสำเร็จ! คุณจะได้รับ +${earnedPoints} แต้ม เมื่อออเดอร์สำเร็จ 🎉`);

      } catch (error) {
        console.error("❌ Checkout error:", error);
        showMessage("เกิดข้อผิดพลาดในการสั่งซื้อ");
      }
    }

    // ===============================================================
    // 8. ORDER HISTORY
    // ===============================================================
    function openOrderHistory() {
      if (!userProfile || !userProfile.userId) {
        showMessage("กรุณาเข้าสู่ระบบก่อนดูประวัติคำสั่งซื้อ");
        return;
      }

      document.getElementById("main-app").classList.add("hidden");
      document.getElementById("order-history").classList.remove("hidden");
      loadOrderHistory();
    }

    function backToMain() {
      document.getElementById("order-history").classList.add("hidden");
      document.getElementById("main-app").classList.remove("hidden");
    }

    async function loadOrderHistory() {
      const orderList = document.getElementById("order-list");
      orderList.innerHTML = '<p class="text-gray-500 text-center py-8">⏳ กำลังโหลด...</p>';

      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .eq("line_id", userProfile.userId)
          .order("created_at", { ascending: false });

        if (error) throw error;

        if (!orders || orders.length === 0) {
          orderList.innerHTML = `
            <div class="text-center py-12">
              <div class="text-6xl mb-2">🔭</div>
              <p class="text-gray-600">ยังไม่มีคำสั่งซื้อ</p>
            </div>`;
          return;
        }

        let html = "";
        orders.forEach(order => {
          let itemsArray = [];
          try {
            itemsArray = typeof order.items === "string" ? JSON.parse(order.items) : order.items;
          } catch {
            itemsArray = [];
          }

          const items = Array.isArray(itemsArray)
            ? itemsArray.map(i => `
              <li>🍫 <span class="font-medium text-purple-700">${i.baseName}</span> 
              <span class="text-gray-600">+ ${i.toppingName}</span> (${i.quantity || 1})</li>
            `).join("")
            : "<li>ไม่พบข้อมูลสินค้า</li>";

          const canCancel = order.status === "pending";
          const statusBadge = getStatusBadge(order.status);

          html += `
            <div class="p-4 bg-white rounded-2xl shadow-md border border-gray-200 hover:shadow-lg transition">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold text-purple-900">Order #${order.id}</p>
                  <p class="text-sm text-gray-500">${new Date(order.created_at).toLocaleString("th-TH")}</p>
                </div>
                <span class="text-sm font-medium ${statusBadge.class} px-3 py-1 rounded-full">${statusBadge.label}</span>
              </div>
              <ul class="mt-3 text-sm text-gray-700 list-disc list-inside">${items}</ul>
              <div class="flex justify-between items-center mt-4">
                <p class="font-medium text-purple-700">ยอดรวม: ${order.total_price} บาท</p>
                ${canCancel ? `<button onclick="cancelOrder(${order.id})"
                  class="text-red-600 hover:text-red-800 font-medium text-sm px-3 py-1 border border-red-300 rounded-xl hover:bg-red-50 transition">
                  ยกเลิกคำสั่งซื้อ
                </button>` : ""}
              </div>
            </div>`;
        });

        orderList.innerHTML = html;
      } catch (error) {
        console.error("❌ Error loading orders:", error);
        orderList.innerHTML = `<p class="text-center text-red-600">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>`;
      }
    }

    function getStatusBadge(status) {
      switch (status) {
        case "pending":
          return { label: "รอดำเนินการ", class: "bg-yellow-100 text-yellow-700" };
        case "preparing":
          return { label: "กำลังเตรียม", class: "bg-blue-100 text-blue-700" };
        case "ready":
          return { label: "พร้อมส่ง", class: "bg-green-100 text-green-700" };
        case "completed":
          return { label: "สำเร็จ", class: "bg-purple-100 text-purple-700" };
        case "cancelled":
          return { label: "ถูกยกเลิก", class: "bg-red-100 text-red-700" };
        default:
          return { label: status, class: "bg-gray-100 text-gray-700" };
      }
    }

    async function cancelOrder(orderId) {
      if (!confirm("ต้องการยกเลิกคำสั่งซื้อนี้หรือไม่?")) return;

      try {
        const { error } = await supabase
          .from("orders")
          .update({ status: "cancelled" })
          .eq("id", orderId);

        if (error) throw error;

        showMessage("ยกเลิกคำสั่งซื้อเรียบร้อยแล้ว 🛑");
        loadOrderHistory();
      } catch (error) {
        console.error("❌ Error cancelling order:", error);
        showMessage("เกิดข้อผิดพลาดในการยกเลิกออเดอร์");
      }
    }

    // ===============================================================
    // 9. ADMIN DASHBOARD
    // ===============================================================
    function showAdmin() {
      document.getElementById("admin-modal").classList.remove("hidden");
      showAdminTab('orders');
    }

    function closeAdmin() {
      document.getElementById("admin-modal").classList.add("hidden");
    }

    function showAdminTab(tab) {
      document.querySelectorAll(".admin-tab").forEach(el => {
        el.classList.remove("border-blue-600", "text-blue-600");
        el.classList.add("border-transparent", "text-gray-600");
      });

      document.querySelectorAll(".admin-tab-content").forEach(el => {
        el.classList.add("hidden");
      });

      const activeTab = document.querySelector(`[data-tab="${tab}"]`);
      if (activeTab) {
        activeTab.classList.remove("border-transparent", "text-gray-600");
        activeTab.classList.add("border-blue-600", "text-blue-600");
      }

      document.getElementById(`admin-${tab}-tab`).classList.remove("hidden");

      if (tab === 'orders') loadAdminOrders();
      if (tab === 'coupons') loadAdminCoupons();
      if (tab === 'stats') loadAdminStats();
      if (tab === 'menu') loadBrownieMenus();
      if (tab === 'summary') loadDailySummary();
    }

    function getStatusText(status) {
      switch (status) {
        case "pending": return "รอดำเนินการ";
        case "preparing": return "กำลังเตรียม";
        case "ready": return "พร้อมรับ";
        case "completed": return "สำเร็จ";
        case "cancelled": return "ยกเลิก";
        default: return "ไม่ทราบสถานะ";
      }
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case "pending": return "bg-yellow-100 text-yellow-700";
        case "preparing": return "bg-blue-100 text-blue-700";
        case "ready": return "bg-green-100 text-green-700";
        case "completed": return "bg-purple-100 text-purple-700";
        case "cancelled": return "bg-red-100 text-red-700";
        default: return "bg-gray-100 text-gray-700";
      }
    }

    async function loadAdminOrders() {
      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select(`
            *,
            users (display_name, picture_url)
          `)
          .order("created_at", { ascending: false })
          .limit(50);

        if (error) throw error;

        const content = document.getElementById("admin-orders-content");
        
        if (orders.length === 0) {
          content.innerHTML = '<p class="text-center text-gray-500 py-12">ยังไม่มีออเดอร์</p>';
          return;
        }

        let html = '<div class="space-y-4">';
        orders.forEach(order => {
          const statusClass = getStatusBadgeClass(order.status);
          
          let itemsArray = [];
          try {
            itemsArray = typeof order.items === "string" ? JSON.parse(order.items) : order.items;
          } catch {
            itemsArray = [];
          }
          
          html += `
            <div class="card border border-gray-200 p-4">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center space-x-3">
                  <img src="${order.users?.picture_url || ''}" class="w-10 h-10 rounded-full" />
                  <div>
                    <div class="font-semibold">${order.users?.display_name || 'ไม่ระบุ'}</div>
                    <div class="text-sm text-gray-500">ออเดอร์ #${order.id}</div>
                  </div>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">${getStatusText(order.status)}</span>
              </div>
              
              <div class="space-y-1 mb-3">
                ${Array.isArray(itemsArray) ? itemsArray.map(item => `
                  <div class="text-sm text-gray-600">• ${item.baseName} + ${item.toppingName} × ${item.quantity}</div>
                `).join('') : '<div class="text-sm text-gray-500">ไม่พบข้อมูลสินค้า</div>'}
              </div>
              
              <div class="flex items-center justify-between pt-3 border-t">
                <div>
                  <div class="text-sm text-gray-500">ราคารวม: <span class="font-bold text-gray-900">${order.total_price} บาท</span></div>
                  <div class="text-xs text-gray-400">${new Date(order.created_at).toLocaleString('th-TH')}</div>
                </div>
                <div class="flex gap-2">
                  <select onchange="updateOrderStatus(${order.id}, this.value)" class="text-sm border border-gray-300 rounded px-2 py-1">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>รอดำเนินการ</option>
                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>กำลังเตรียม</option>
                    <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>พร้อมรับ</option>
                    <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>สำเร็จ</option>
                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ยกเลิก</option>
                  </select>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;

      } catch (error) {
        console.error("❌ Error loading admin orders:", error);
      }
    }

    async function updateOrderStatus(orderId, newStatus) {
  try {
    // 1️⃣ ดึงข้อมูลออเดอร์ พร้อมข้อมูลผู้ใช้
    const { data: order, error: fetchError } = await supabase
      .from("orders")
      .select("id, user_id, earned_points, status, users(line_id, display_name)")
      .eq("id", orderId)
      .single();
    if (fetchError) throw fetchError;

    let givePoints = false;

    // 2️⃣ ตรวจสอบว่าสถานะเปลี่ยนเป็น completed และยังไม่เคย completed มาก่อน
    if (newStatus === "completed" && order.status !== "completed") {
      givePoints = true;
    }

    // 3️⃣ อัปเดตสถานะในฐานข้อมูล
    const { error: updateError } = await supabase
      .from("orders")
      .update({ status: newStatus })
      .eq("id", orderId);
    if (updateError) throw updateError;

    // 4️⃣ ถ้าเป็น completed → อัปเดตแต้มสะสมให้ผู้ใช้
    if (givePoints) {
      const { data: user, error: userError } = await supabase
        .from("users")
        .select("points")
        .eq("id", order.user_id)
        .single();
      if (userError) throw userError;

      const newPoints = (user.points || 0) + (order.earned_points || 0);

      const { error: updatePointsError } = await supabase
        .from("users")
        .update({ points: newPoints })
        .eq("id", order.user_id);
      if (updatePointsError) throw updatePointsError;

      console.log(`✅ ให้แต้มสะสม ${order.earned_points} แก่ user ${order.user_id}`);
    }

    // 5️⃣ ส่งแจ้งเตือน LINE OA
    await sendOrderStatusNotification(order, newStatus);

    // 6️⃣ แสดงข้อความสำเร็จ
    if (givePoints) {
      showMessage("✅ อัปเดตสถานะและให้แต้มสะสม + ส่งแจ้งเตือนเรียบร้อยแล้ว");
    } else {
      showMessage("✅ อัปเดตสถานะและส่งแจ้งเตือนเรียบร้อยแล้ว");
    }

    // 7️⃣ โหลดรายการใหม่
    loadAdminOrders();

  } catch (error) {
    console.error("❌ Error updating status or points:", error);
    showMessage("❌ เกิดข้อผิดพลาด: " + error.message);
  }
}

    async function sendOrderStatusNotification(order, newStatus) {
      try {
        const { data, error } = await supabase.functions.invoke('send-line-notification', {
          body: {
            lineId: order.users.line_id,
            orderId: order.id,
            status: newStatus,
            orderData: {
              items: order.items,
              total_price: order.total_price,
              subtotal: order.subtotal,
              discount: order.discount
            }
          }
        });

        if (error) {
          console.error("❌ Error calling edge function:", error);
        } else {
          console.log("✅ Notification sent successfully");
        }

      } catch (error) {
        console.error("❌ Error sending notification:", error);
      }
    }

    async function loadAdminCoupons() {
      try {
        const { data: coupons, error } = await supabase
          .from("coupons")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) throw error;

        const content = document.getElementById("admin-coupons-content");
        
        if (coupons.length === 0) {
          content.innerHTML = '<p class="text-center text-gray-500 py-12">ยังไม่มีคูปอง</p>';
          return;
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
        coupons.forEach(coupon => {
          html += `
            <div class="card border-2 border-purple-200 p-4">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <div class="font-bold text-lg text-purple-900">${coupon.name}</div>
                  <div class="text-sm text-gray-600">${coupon.description}</div>
                </div>
                <div class="space-y-1 text-right">
                  <label class="flex items-center justify-end">
                    <input type="checkbox" ${coupon.is_active ? 'checked' : ''} 
                           onchange="toggleCoupon(${coupon.id}, this.checked)" class="mr-2" />
                    <span class="text-sm">เปิดใช้</span>
                  </label>
                  <label class="flex items-center justify-end">
                    <input type="checkbox" ${coupon.show_in_list ? 'checked' : ''} 
                           onchange="toggleCouponVisibility(${coupon.id}, this.checked)" class="mr-2" />
                    <span class="text-sm">แสดงในคูปองของฉัน</span>
                  </label>
                </div>
              </div>
              
              <div class="space-y-1 text-sm text-gray-600">
                <div>รหัส: <span class="font-mono font-bold">${coupon.code}</span></div>
                <div>ส่วนลด: ${coupon.type === 'percent' ? coupon.value + '%' : coupon.value + ' บาท'}</div>
                <div>ยอดขั้นต่ำ: ${coupon.min_purchase} บาท</div>
                <div>ใช้ไป: ${coupon.usage_count} / ${coupon.usage_limit} ครั้ง</div>
              </div>
              
              <button onclick="deleteCoupon(${coupon.id})" class="mt-3 text-red-500 hover:text-red-700 text-sm font-medium">
                🗑️ ลบคูปอง
              </button>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;

      } catch (error) {
        console.error("❌ Error loading coupons:", error);
      }
    }

    function showCreateCouponForm() {
      document.getElementById("create-coupon-modal").classList.remove("hidden");
    }

    function closeCreateCoupon() {
      document.getElementById("create-coupon-modal").classList.add("hidden");
    }

    async function createCoupon(event) {
      event.preventDefault();

      try {
        const code = document.getElementById("coupon-code").value.toUpperCase();
        const name = document.getElementById("coupon-title").value;
        const description = document.getElementById("coupon-description").value;
        const type = document.getElementById("coupon-type").value;
        const value = parseInt(document.getElementById("coupon-value").value);
        const minPurchase = parseInt(document.getElementById("coupon-min").value);
        const usageLimit = parseInt(document.getElementById("coupon-usage").value);

        const { error } = await supabase
          .from("coupons")
          .insert([{
            code,
            name,
            description,
            type,
            value,
            min_purchase: minPurchase,
            usage_limit: usageLimit,
            usage_count: 0,
            is_active: true,
            show_in_list: true
          }]);

        if (error) throw error;

        showMessage("สร้างคูปองสำเร็จ! 🎉");
        closeCreateCoupon();
        loadAdminCoupons();
        loadCoupons();
        event.target.reset();

      } catch (error) {
        console.error("❌ Error creating coupon:", error);
        showMessage("เกิดข้อผิดพลาด: " + error.message);
      }
    }

    async function toggleCoupon(couponId, isActive) {
      try {
        const { error } = await supabase
          .from("coupons")
          .update({ is_active: isActive })
          .eq("id", couponId);

        if (error) throw error;

        showMessage(isActive ? "เปิดใช้คูปองแล้ว" : "ปิดใช้คูปองแล้ว");
        loadCoupons();

      } catch (error) {
        console.error("❌ Error toggling coupon:", error);
        showMessage("เกิดข้อผิดพลาด");
      }
    }

    async function toggleCouponVisibility(couponId, showInList) {
      try {
        const { error } = await supabase
          .from("coupons")
          .update({ show_in_list: showInList })
          .eq("id", couponId);

        if (error) throw error;

        showMessage(showInList
          ? "คูปองนี้จะแสดงในหน้า 'คูปองของฉัน' ✅"
          : "คูปองนี้ถูกซ่อนไว้ ต้องกรอกรหัสก่อนเท่านั้น 🔒"
        );

        loadAdminCoupons();
        loadCoupons();
      } catch (error) {
        console.error("❌ Error toggling coupon visibility:", error);
        showMessage("เกิดข้อผิดพลาดในการเปลี่ยนการแสดงคูปอง");
      }
    }

    async function deleteCoupon(couponId) {
      if (!confirm("ต้องการลบคูปองนี้หรือไม่?")) return;

      try {
        const { error } = await supabase
          .from("coupons")
          .delete()
          .eq("id", couponId);

        if (error) throw error;

        showMessage("ลบคูปองสำเร็จ");
        loadAdminCoupons();
        loadCoupons();

      } catch (error) {
        console.error("❌ Error deleting coupon:", error);
        showMessage("เกิดข้อผิดพลาด");
      }
    }

    async function loadAdminStats() {
      try {
        const { data: orders, error: ordersError } = await supabase
          .from("orders")
          .select("total_price, status");

        if (ordersError) throw ordersError;

        const { count: usersCount, error: usersError } = await supabase
          .from("users")
          .select("*", { count: 'exact', head: true });

        if (usersError) throw usersError;

        const totalOrders = orders.length;
        const totalRevenue = orders.reduce((sum, order) => sum + order.total_price, 0);
        const pendingOrders = orders.filter(o => o.status === 'pending').length;
        const completedOrders = orders.filter(o => o.status === 'completed').length;

        const content = document.getElementById("admin-stats-content");
        content.innerHTML = `
          <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6">
            <div class="text-3xl mb-2">📊</div>
            <div class="text-sm opacity-90 mb-1">ยอดขายรวม</div>
            <div class="text-3xl font-bold">${totalRevenue.toLocaleString()} บาท</div>
          </div>

          <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white p-6">
            <div class="text-3xl mb-2">📦</div>
            <div class="text-sm opacity-90 mb-1">ออเดอร์ทั้งหมด</div>
            <div class="text-3xl font-bold">${totalOrders}</div>
            <div class="text-xs opacity-75 mt-2">สำเร็จ: ${completedOrders} | รอดำเนินการ: ${pendingOrders}</div>
          </div>

          <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6">
            <div class="text-3xl mb-2">👥</div>
            <div class="text-sm opacity-90 mb-1">ผู้ใช้ทั้งหมด</div>
            <div class="text-3xl font-bold">${usersCount}</div>
          </div>

          <div class="card bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6">
            <div class="text-3xl mb-2">💰</div>
            <div class="text-sm opacity-90 mb-1">ยอดเฉลี่ยต่อออเดอร์</div>
            <div class="text-3xl font-bold">${totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0} บาท</div>
          </div>

          <div class="card col-span-full p-6">
            <h4 class="font-semibold text-lg mb-4">📈 สถานะออเดอร์</h4>
            <div class="grid grid-cols-5 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold text-yellow-600">${orders.filter(o => o.status === 'pending').length}</div>
                <div class="text-sm text-gray-600">รอดำเนินการ</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">${orders.filter(o => o.status === 'preparing').length}</div>
                <div class="text-sm text-gray-600">กำลังเตรียม</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600">${orders.filter(o => o.status === 'ready').length}</div>
                <div class="text-sm text-gray-600">พร้อมรับ</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-indigo-600">${orders.filter(o => o.status === 'completed').length}</div>
                <div class="text-sm text-gray-600">สำเร็จ</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-red-600">${orders.filter(o => o.status === 'cancelled').length}</div>
                <div class="text-sm text-gray-600">ยกเลิก</div>
              </div>
            </div>
          </div>
        `;

      } catch (error) {
        console.error("❌ Error loading stats:", error);
      }
    }

    async function loadDailySummary() {
      const selectedDate = document.getElementById("summary-date").value;
      const content = document.getElementById("summary-content");

      if (!selectedDate) {
        content.innerHTML = `<p class="text-gray-500 text-center">⚠️ กรุณาเลือกวันที่ก่อน</p>`;
        return;
      }

      try {
        const start = new Date(selectedDate);
        const end = new Date(selectedDate);
        end.setDate(end.getDate() + 1);

        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .gte("created_at", start.toISOString())
          .lt("created_at", end.toISOString());

        if (error) throw error;

        if (orders.length === 0) {
          content.innerHTML = `<p class="text-gray-500 text-center">ไม่มีออเดอร์ในวันที่ ${selectedDate}</p>`;
          return;
        }

        const totalRevenue = orders.reduce((sum, o) => sum + o.total_price, 0);
        const totalOrders = orders.length;

        const comboCounts = {};
        orders.forEach(o => {
          let itemsArray = [];
          try {
            itemsArray = typeof o.items === "string" ? JSON.parse(o.items) : o.items;
          } catch {
            itemsArray = [];
          }
          
          itemsArray.forEach(i => {
            const combo = `${i.baseName} + ${i.toppingName}`;
            comboCounts[combo] = (comboCounts[combo] || 0) + i.quantity;
          });
        });

        let html = `
          <h3 class="text-lg font-semibold mb-3">📅 สรุปวันที่ ${selectedDate}</h3>
          <div class="mb-4">
            <p>ออเดอร์ทั้งหมด: <b>${totalOrders}</b> รายการ</p>
            <p>ยอดขายรวม: <b>${totalRevenue}</b> บาท</p>
          </div>

          <div class="border-t pt-4">
            <h4 class="font-semibold text-purple-700 mb-2">� รายการรวม (เนื้อ + หน้า)</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              ${Object.entries(comboCounts)
                .map(([combo, qty]) => `<p>• ${combo} — <b>${qty}</b> ชิ้น</p>`)
                .join('')}
            </div>
          </div>

          <div class="mt-6 flex flex-col items-center gap-3">
            <select id="update-status-select" class="border rounded px-3 py-2 text-sm">
              <option value="">-- เลือกสถานะที่จะอัปเดตทั้งหมด --</option>
              <option value="pending">🕐 รอดำเนินการ</option>
              <option value="preparing">� กำลังเตรียม</option>
              <option value="ready">📦 พร้อมรับ</option>
              <option value="completed">✅ สำเร็จ</option>
              <option value="cancelled">❌ ยกเลิก</option>
            </select>
            <button onclick="updateAllOrdersOfDay()" 
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm shadow">
              🔄 อัปเดตสถานะทั้งหมดของวัน
            </button>
          </div>
        `;

        content.innerHTML = html;
      } catch (err) {
        console.error(err);
        content.innerHTML = `<p class="text-red-500 text-center">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>`;
      }
    }

    async function updateAllOrdersOfDay() {
      const selectedDate = document.getElementById("summary-date").value;
      const newStatus = document.getElementById("update-status-select").value;

      if (!selectedDate) return alert("⚠️ กรุณาเลือกวันที่ก่อน");
      if (!newStatus) return alert("⚠️ กรุณาเลือกสถานะที่จะอัปเดต");

      try {
        const start = new Date(selectedDate);
        const end = new Date(selectedDate);
        end.setDate(end.getDate() + 1);

        const { data: orders, error: fetchError } = await supabase
          .from("orders")
          .select("*, users(line_id, display_name)")
          .gte("created_at", start.toISOString())
          .lt("created_at", end.toISOString());

        if (fetchError) throw fetchError;
        if (!orders || orders.length === 0) {
          showMessage("❌ ไม่มีออเดอร์ในวันนั้น");
          return;
        }

        for (const order of orders) {
          const { error: updateError } = await supabase
            .from("orders")
            .update({ status: newStatus })
            .eq("id", order.id);

          if (updateError) console.error(`❌ อัปเดตออเดอร์ ${order.id} ล้มเหลว:`, updateError);

          try {
            await supabase.functions.invoke("send-line-notification", {
              body: {
                lineId: order.users.line_id,
                orderId: order.id,
                status: newStatus,
                orderData: {
                  items: order.items,
                  total_price: order.total_price,
                  subtotal: order.subtotal,
                  discount: order.discount,
                },
              },
            });
          } catch (notifyError) {
            console.error(`⚠️ แจ้งเตือน LINE ของออเดอร์ ${order.id} ไม่สำเร็จ`, notifyError);
          }
        }

        showMessage(
          `✅ อัปเดตสถานะทั้งหมด ${orders.length} ออเดอร์ในวันที่ ${selectedDate} เป็น "${getStatusText(newStatus)}" สำเร็จ`
        );
        loadDailySummary();
      } catch (err) {
        console.error("❌ Error in updateAllOrdersOfDay:", err);
        showMessage("❌ เกิดข้อผิดพลาดในการอัปเดตสถานะ");
      }
    }

    async function loadBrownieMenus() {
  const content = document.getElementById("admin-brownie-content");
  content.innerHTML = `<div class="text-center text-gray-500">กำลังโหลด...</div>`;

  try {
    // โหลดประเภทขนมทั้งหมด
    const { data: types, error: typesError } = await supabase
      .from("product_types")
      .select("*")
      .order("id");
    if (typesError) throw typesError;

    // โหลดเมนูทั้งหมด (base + topping)
    const { data: items, error: itemsError } = await supabase
      .from("brownie_items")
      .select("*")
      .order("product_type_id");
    if (itemsError) throw itemsError;

    let html = `
      <button onclick="openProductTypeModal()" 
        class="bg-green-600 text-white px-4 py-2 rounded-lg mb-4 hover:bg-green-700">
        ➕ เพิ่มประเภทขนมใหม่
      </button>
    `;

    // วนลูปแต่ละประเภท
    types.forEach(type => {
      const typeItems = items.filter(i => i.product_type_id === type.id);
      const bases = typeItems.filter(i => i.type === 'base');
      const toppings = typeItems.filter(i => i.type === 'topping');

      html += `
        <div class="border rounded-xl p-4 mb-6 bg-white shadow-md">
          <div class="flex justify-between items-center mb-3">
            <h4 class="text-xl font-bold">${type.emoji || '🍰'} ${type.name}</h4>
            <div>
              <button onclick="openProductTypeModal(${JSON.stringify(type).replace(/"/g, "'")})" 
                      class="text-sm px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">✏️ แก้ไข</button>
              <button onclick="deleteProductType(${type.id})" 
                      class="text-sm px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">🗑️ ลบ</button>
            </div>
          </div>

          <h5 class="font-semibold text-gray-700 mt-4">🍫 เนื้อ/ไส้</h5>
          ${renderBrownieList(bases)}
          <button onclick="openBrownieModal('base', ${type.id})" 
                  class="text-sm px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 mt-2">
            ➕ เพิ่มเนื้อ
          </button>

          <h5 class="font-semibold text-gray-700 mt-4">🫀 หน้า/ท็อปปิ้ง</h5>
          ${renderBrownieList(toppings)}
          <button onclick="openBrownieModal('topping', ${type.id})" 
                  class="text-sm px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 mt-2">
            ➕ เพิ่มหน้า
          </button>
        </div>
      `;
    });

    content.innerHTML = html;
  } catch (err) {
    console.error("❌ Error loading admin menus:", err);
  }
}

    async function loadProductTypes() {
  try {
    // 1️⃣ โหลดประเภทขนมจาก Supabase
    const { data: types, error: typesError } = await supabase
      .from("product_types")
      .select("*")
      .eq("is_active", true)
      .order("id");
    if (typesError) throw typesError;

    // 2️⃣ โหลดเมนูทั้งหมด (ฐาน + หน้า)
    const { data: items, error: itemsError } = await supabase
      .from("brownie_items")
      .select("*")
      .eq("is_active", true)
      .order("id");
    if (itemsError) throw itemsError;

    // เก็บเมนูทั้งหมดไว้ใน global variable
    allMenus = items;

    // 3️⃣ แสดงประเภทขนมเป็น card ให้ผู้ใช้เลือก
    const typeList = document.getElementById("product-type-list");
    typeList.innerHTML = types.map(type => `
      <div class="product-type-item card cursor-pointer text-center hover-lift"
           onclick="selectProductType(event, ${type.id}, '${type.name.replace(/\\/g, "\\\\").replace(/'/g, "\\'")}', '${type.emoji || '🍰'}')">
        <div class="text-5xl mb-3">${type.emoji || '🍰'}</div>
        <div class="font-semibold text-lg">${type.name}</div>
      </div>
    `).join('');

  } catch (error) {
    console.error("❌ Error loading product types:", error);
  }
}
function selectProductType(event, typeId, typeName, emoji) {
      selectedProductType = typeId;

      // 1. Reset การเลือกเก่า
      selectedBase = null;
      selectedTopping = null;
      // 1a. อัปเดต UI การเลือกประเภท
      document.querySelectorAll('.product-type-item').forEach(e => e.classList.remove('selected'));
      if (event) { // (FIX) ตรวจสอบว่า event มีค่าก่อนใช้
          event.currentTarget.classList.add('selected');
      }

      // 2. กรอง Bases และ Toppings ที่ตรงกับ typeId
      const bases = allMenus.filter(i => i.type === 'base' && i.product_type_id === typeId);
      const toppings = allMenus.filter(i => i.type === 'topping' && i.product_type_id === typeId);

      // (FIX) ฟังก์ชันสำหรับ escape ชื่อ (กัน Error)
      const escapeName = (name) => {
        if (!name) return '';
        return name.replace(/\\/g, "\\\\").replace(/'/g, "\\'");
      }

      // 3. แสดงผล Bases (หน้าเนื้อ)
      const baseList = document.getElementById("base-list");
      document.getElementById("base-title").innerHTML = `${emoji} เลือกเนื้อ${typeName}`;
      baseList.innerHTML = bases.map(b => `
        <div class="brownie-base card cursor-pointer text-center hover-lift" 
             onclick="selectBase(event, ${b.id}, '${escapeName(b.name)}', ${b.price}, ${b.points})">
          <div class="text-4xl mb-3">${b.name.split(' ')[0]}</div>
          <div class="font-semibold">${b.name}</div>
          <div class="text-sm text-gray-500">${b.description}</div>
          <div class="mt-2 font-bold text-blue-600">${b.price} บาท</div>
        </div>
      `).join('');
      
      // 4. แสดงผล Toppings (หน้าเดิม)
      const toppingList = document.getElementById("topping-list");
      document.getElementById("topping-title").innerHTML = `🫀 เลือกหน้า${typeName}`;
      toppingList.innerHTML = toppings.map(t => `
        <div class="topping-item card cursor-pointer text-center hover-lift" 
             onclick="selectTopping(event, ${t.id}, '${escapeName(t.name)}', ${t.price}, ${t.points})">
          <div class="text-4xl mb-3">${t.name.split(' ')[0]}</div>
          <div class="font-semibold">${t.name}</div>
          <div class="text-sm text-gray-500">${t.description}</div>
          <div class="mt-2 font-bold text-blue-600">+${t.price} บาท</div>
        </div>
      `).join('');

      // 5. แสดง section ที่ซ่อนไว้
      document.getElementById("base-section").classList.remove("hidden");
      document.getElementById("topping-section").classList.remove("hidden");

      updateTotal();
    }

    function renderBrownieList(items) {
  if (!items || items.length === 0)
    return `<p class="text-gray-500 italic">ยังไม่มีข้อมูล</p>`;

  return items.map(i => `
    <div class="flex justify-between items-start border p-3 rounded-lg mb-2 bg-white shadow-sm hover:shadow-md transition">
      <div>
        <div class="font-semibold text-lg">${i.name}</div>
        <div class="text-sm text-gray-600">${i.description || ''}</div>
        <div class="text-sm mt-1">
          💰 ${i.price} บาท | 🎯 ${i.points} แต้ม | 
          ${i.is_active 
            ? "✅ <span class='text-green-600'>เปิดขาย</span>" 
            : "❌ <span class='text-red-500'>ปิดขาย</span>"}
        </div>
      </div>
      <div class="flex gap-2 mt-1">
        <button class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600" 
          onclick="openBrownieModal('${i.type}', ${i.product_type_id}, ${JSON.stringify(i).replace(/"/g, '&quot;')})"
          ✏️ แก้ไข
        </button>
        <button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" 
          onclick="deleteBrownieItem(${i.id})">
          🗑️ ลบ
        </button>
      </div>
    </div>
  `).join("");
}

   function openBrownieModal(type, productTypeId, itemJson) {
      const modal = document.getElementById("brownie-modal");
      const title = document.getElementById("brownie-modal-title");
      const form = document.getElementById("brownie-form");
      
      // 1. รีเซ็ต form (เผื่อมีค่าเก่า)
      form.reset();
      
      // 2. ตั้งค่าพื้นฐาน
      document.getElementById("brownie-type").value = type;
      form.dataset.productTypeId = productTypeId; // เก็บ ID ประเภทขนมไว้ใน form

      // 3. ตรวจสอบว่าเป็น "แก้ไข" (มี itemJson) หรือ "เพิ่มใหม่"
      if (itemJson) {
        // --- กรณีแก้ไข ---
        title.textContent = `✏️ แก้ไขเมนู${type === "base" ? "เนื้อ" : "หน้า"}`;
        document.getElementById("brownie-id").value = itemJson.id;
        document.getElementById("brownie-name").value = itemJson.name;
        document.getElementById("brownie-desc").value = itemJson.description || "";
        document.getElementById("brownie-price").value = itemJson.price;
        document.getElementById("brownie-points").value = itemJson.points;
        document.getElementById("brownie-active").checked = itemJson.is_active;
      } else {
        // --- กรณีเพิ่มใหม่ ---
        title.textContent = `🍰 เพิ่มเมนู${type === "base" ? "เนื้อ" : "หน้า"}`;
        document.getElementById("brownie-id").value = "";
        document.getElementById("brownie-active").checked = true;
      }
      
      // 4. แสดง modal
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

const modal = document.getElementById("brownie-modal");

  // ตั้งค่าพื้นฐาน
  const isEdit = !!item;
  document.getElementById("brownie-id").value = item ? item.id : "";
  document.getElementById("brownie-type").value = type;
  document.getElementById("brownie-name").value = item ? item.name : "";
  document.getElementById("brownie-desc").value = item ? item.description || "" : "";
  document.getElementById("brownie-price").value = item ? item.price : "";
  document.getElementById("brownie-points").value = item ? item.points : "";
  document.getElementById("brownie-active").checked = item ? item.is_active : true;

  // เก็บค่า product_type_id ไว้ใน form (dataset)
  const form = document.getElementById("brownie-form");
  form.dataset.productTypeId = productTypeId;

  // เปลี่ยนชื่อหัว modal
  title.textContent = isEdit
    ? `✏️ แก้ไขเมนู${type === "base" ? "เนื้อ" : "หน้า"}`
    : `🍰 เพิ่มเมนู${type === "base" ? "เนื้อ" : "หน้า"}`;

    function closeBrownieModal() {
      document.getElementById("brownie-modal").classList.add("hidden");
    }

    async function loadBrownieForEdit(id) {
      const { data, error } = await supabase.from("brownie_items").select("*").eq("id", id).single();
      if (error) return console.error(error);

      document.getElementById("brownie-id").value = data.id;
      document.getElementById("brownie-type").value = data.type;
      document.getElementById("brownie-name").value = data.name;
      document.getElementById("brownie-desc").value = data.description || "";
      document.getElementById("brownie-price").value = data.price;
      document.getElementById("brownie-points").value = data.points;
      document.getElementById("brownie-active").checked = data.is_active;
    }

    async function deleteBrownieItem(id) {
      if (!confirm("ต้องการลบเมนูนี้หรือไม่?")) return;

      const { error } = await supabase.from("brownie_items").delete().eq("id", id);
      if (error) {
        console.error(error);
        return showMessage("❌ ลบเมนูล้มเหลว");
      }

      showMessage("🗑️ ลบเมนูสำเร็จ");
      loadBrownieMenus();
      loadMenus();
    }

    document.getElementById("brownie-form").onsubmit = async (e) => {
  e.preventDefault();

  const id = document.getElementById("brownie-id").value;
  const type = document.getElementById("brownie-type").value;
  const name = document.getElementById("brownie-name").value.trim();
  const description = document.getElementById("brownie-desc").value.trim();
  const price = parseFloat(document.getElementById("brownie-price").value);
  const points = parseInt(document.getElementById("brownie-points").value) || 0;
  const isActive = document.getElementById("brownie-active").checked;
  const productTypeId = parseInt(e.target.dataset.productTypeId); // 👈 เพิ่มตรงนี้สำหรับระบบใหม่

  if (!name || isNaN(price)) {
    showMessage("⚠️ กรุณากรอกชื่อเมนูและราคาด้วย");
    return;
  }

  const data = {
    name,
    description,
    price,
    points,
    type,
    is_active: isActive,
    product_type_id: productTypeId, // 👈 บอกว่าเมนูนี้อยู่ในประเภทขนมไหน
  };

  try {
    let error;
    if (id) {
      // แก้ไขเมนูเดิม
      ({ error } = await supabase.from("brownie_items").update(data).eq("id", id));
    } else {
      // เพิ่มเมนูใหม่
      ({ error } = await supabase.from("brownie_items").insert([data]));
    }

    if (error) throw error;

    showMessage("✅ บันทึกเมนูเรียบร้อยแล้ว");
    closeBrownieModal();
    loadBrownieMenus();
  } catch (err) {
    console.error("❌ Error saving menu:", err);
    showMessage("เกิดข้อผิดพลาด: " + err.message);
  }
};

    // ===============================================================
    // 10. UTILITY FUNCTIONS
    // ===============================================================
    function showMessage(message) {
      const successMessage = document.getElementById("success-message");
      const successText = document.getElementById("success-text");
      successText.textContent = message;
      successMessage.classList.remove("hidden");

      setTimeout(() => {
        successMessage.classList.add("hidden");
      }, 3000);
    }

    function closeModalOnBackdrop(event, modalId) {
      if (event.target.id === modalId) {
        document.getElementById(modalId).classList.add("hidden");
      }
    }

    // ===============================================================
    // 11. FORM HANDLERS
    // ===============================================================
   document.getElementById("brownie-form").onsubmit = async (e) => {
      e.preventDefault();

      const id = document.getElementById("brownie-id").value;
      const type = document.getElementById("brownie-type").value;
      const name = document.getElementById("brownie-name").value;
      const description = document.getElementById("brownie-desc").value;
      const price = parseFloat(document.getElementById("brownie-price").value);
      const points = parseInt(document.getElementById("brownie-points").value) || 0;
      const isActive = document.getElementById("brownie-active").checked;
      
      // (เพิ่มใหม่) ดึง ID ประเภทขนมจาก dataset ที่เราเก็บไว้
      const productTypeId = parseInt(e.target.dataset.productTypeId);

      // (เพิ่มใหม่) เพิ่ม product_type_id เข้าไปใน object ที่จะส่ง
      const data = { 
        type, 
        name, 
        description, 
        price, 
        points, 
        is_active: isActive,
        product_type_id: productTypeId // <-- บรรทัดนี้สำคัญ
      };

      try {
        if (id) {
          // กรณีอัปเดต (แก้ไข)
          const { error } = await supabase.from("brownie_items").update(data).eq("id", id);
          if (error) throw error;
          showMessage("✅ อัปเดตเมนูสำเร็จ");
        } else {
          // กรณีเพิ่มใหม่
          const { error } = await supabase.from("brownie_items").insert([data]);
          if (error) throw error;
          showMessage("🎉 เพิ่มเมนูใหม่สำเร็จ");
        }

        closeBrownieModal();
        loadBrownieMenus();    // รีเฟรชหน้า Admin
        loadProductTypes();  // (แก้ไข) รีเฟรชเมนูหน้าหลักเป็นฟังก์ชันตัวใหม่
      } catch (err) {
        console.error("❌ Error saving brownie item:", err);
        showMessage("❌ เกิดข้อผิดพลาดในการบันทึกข้อมูล: " + err.message);
      }
    };
    // ===============================================================
    // 12. INITIALIZE APP
    // ===============================================================
    window.addEventListener("load", init);
  </script>
</body>
</html>
