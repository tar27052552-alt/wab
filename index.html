<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaskFlow — SkyTravel Theme</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Prompt',-apple-system,BlinkMacSystemFont,'Inter',sans-serif;letter-spacing:-.01em}
    .glass{background:rgba(255,255,255,0.9);backdrop-filter:blur(18px);border:1px solid rgba(2,132,199,.06)}
    .soft-card{background:white;border:1px solid rgba(2,132,199,.06);box-shadow:0 10px 30px rgba(15,23,42,.06)}
    .day-dot-red{width:.5rem;height:.5rem;background:#fb7185;border-radius:9999px}
    .day-dot-green{width:.5rem;height:.5rem;background:#34d399;border-radius:9999px}
  </style>
</head>
<body class="h-full bg-gradient-to-br from-sky-50 via-white to-sky-100">
  <!-- Navbar -->
  <nav class="glass sticky top-0 z-20 border-b border-sky-100">
    <div class="max-w-7xl mx-auto px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-sky-600/90 grid place-items-center text-white font-bold">TF</div>
          <span class="font-extrabold tracking-tight text-slate-800">TaskFlow</span>
        </div>
        <div class="hidden sm:flex items-center gap-2">
          <button onclick="showAddActivity()" class="px-5 py-2 rounded-full bg-white text-slate-900 border border-slate-200">เพิ่มกิจกรรม</button>
          <button onclick="showAddHomework()" class="px-5 py-2 rounded-full bg-slate-900 text-white">เพิ่มงาน</button>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-6 lg:px-8 py-8 space-y-10">
    <!-- Calendar + Upcoming -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 soft-card rounded-3xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-extrabold tracking-tight text-slate-800" id="calendar-title">January 2024</h2>
          <div class="flex gap-2">
            <button onclick="previousMonth()" class="h-10 w-10 grid place-items-center rounded-full bg-white border border-sky-100">◀</button>
            <button onclick="nextMonth()" class="h-10 w-10 grid place-items-center rounded-full bg-white border border-sky-100">▶</button>
          </div>
        </div>
        <div class="grid grid-cols-7 gap-2 mb-3 text-sm font-semibold text-slate-500">
          <div class="text-center py-2">Sun</div><div class="text-center py-2">Mon</div><div class="text-center py-2">Tue</div><div class="text-center py-2">Wed</div><div class="text-center py-2">Thu</div><div class="text-center py-2">Fri</div><div class="text-center py-2">Sat</div>
        </div>
        <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
      </div>
      <div class="soft-card rounded-3xl p-6">
        <h3 class="text-xl font-extrabold text-slate-800 mb-4">งานที่ใกล้ถึงกำหนด</h3>
        <div id="upcoming-tasks" class="space-y-3"></div>
      </div>
    </section>

    <!-- Homework & Activities sections -->
    <section class="soft-card rounded-3xl p-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-extrabold text-slate-800">การบ้าน</h2>
        <div class="flex gap-3">
          <button onclick="showSubjectSettings()" class="px-4 py-2 rounded-full bg-white border border-sky-100">วิชา</button>
          <button onclick="showAddHomework()" class="px-5 py-2 rounded-full bg-slate-900 text-white">เพิ่มการบ้าน</button>
        </div>
      </div>
      <div class="flex gap-2 mb-6 bg-slate-100 p-1 rounded-full w-full max-w-xl">
        <button onclick="filterHomework('all')" id="filter-all" class="filter-btn bg-white text-slate-700 px-4 py-2 rounded-full font-medium shadow-sm">ทั้งหมด (<span id="count-all">0</span>)</button>
        <button onclick="filterHomework('pending')" id="filter-pending" class="filter-btn text-slate-600 px-4 py-2 rounded-full font-medium">ค้างส่ง (<span id="count-pending">0</span>)</button>
        <button onclick="filterHomework('overdue')" id="filter-overdue" class="filter-btn text-slate-600 px-4 py-2 rounded-full font-medium">เลยกำหนด (<span id="count-overdue">0</span>)</button>
        <button onclick="filterHomework('completed')" id="filter-completed" class="filter-btn text-slate-600 px-4 py-2 rounded-full font-medium">เสร็จแล้ว (<span id="count-completed">0</span>)</button>
      </div>
      <div id="homework-list" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <section class="soft-card rounded-3xl p-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-extrabold text-slate-800">กิจกรรม</h2>
        <button onclick="showAddActivity()" class="px-5 py-2 rounded-full bg-slate-900 text-white">เพิ่มกิจกรรม</button>
      </div>
      <div id="activities-list" class="grid md:grid-cols-2 gap-4"></div>
    </section>
  </main>

  <!-- Homework Modal -->
  <div id="add-homework-modal" class="hidden fixed inset-0 bg-black/50 p-4 z-50">
    <div class="max-w-md mx-auto bg-white rounded-3xl p-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold">เพิ่มการบ้าน</h3>
        <button onclick="closeAddHomework()" class="px-3 py-1 rounded-full bg-slate-100">✕</button>
      </div>
      <form id="homework-form" onsubmit="saveHomework(event)" class="space-y-3">
        <div>
          <label class="text-sm">วิชา</label>
          <select id="homework-subject" required class="w-full px-3 py-2 rounded-xl border border-slate-200"></select>
        </div>
        <div>
          <label class="text-sm">รายละเอียด</label>
          <input id="homework-title" required class="w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="เช่น แบบฝึกหัดบทที่ 5"/>
        </div>
        <div>
          <label class="text-sm">กำหนดส่ง</label>
          <input id="homework-date" type="date" required class="w-full px-3 py-2 rounded-xl border border-slate-200"/>
        </div>
        <div>
          <label class="text-sm">สถานะ</label>
          <select id="homework-status" class="w-full px-3 py-2 rounded-xl border border-slate-200">
            <option value="pending">ยังไม่เสร็จ</option>
            <option value="completed">เสร็จแล้ว</option>
          </select>
        </div>
        <div class="flex gap-2 pt-2">
          <button type="button" onclick="closeAddHomework()" class="flex-1 px-4 py-2 rounded-xl bg-slate-100">ยกเลิก</button>
          <button type="submit" class="flex-1 px-4 py-2 rounded-xl bg-sky-600 text-white">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Activity Modal -->
  <div id="add-activity-modal" class="hidden fixed inset-0 bg-black/50 p-4 z-50">
    <div class="max-w-md mx-auto bg-white rounded-3xl p-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold">เพิ่มกิจกรรม</h3>
        <button onclick="closeAddActivity()" class="px-3 py-1 rounded-full bg-slate-100">✕</button>
      </div>
      <form id="activity-form" onsubmit="saveActivity(event)" class="space-y-3">
        <div>
          <label class="text-sm">ชื่อกิจกรรม</label>
          <input id="activity-title" required class="w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="เช่น งานวิทยาศาสตร์"/>
        </div>
        <div>
          <label class="text-sm">รายละเอียด</label>
          <textarea id="activity-description" rows="3" class="w-full px-3 py-2 rounded-xl border border-slate-200"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">เริ่ม</label>
            <input id="activity-start-date" type="date" required class="w-full px-3 py-2 rounded-xl border border-slate-200"/>
          </div>
          <div>
            <label class="text-sm">สิ้นสุด</label>
            <input id="activity-end-date" type="date" required class="w-full px-3 py-2 rounded-xl border border-slate-200"/>
          </div>
        </div>
        <div class="flex gap-2 pt-2">
          <button type="button" onclick="closeAddActivity()" class="flex-1 px-4 py-2 rounded-xl bg-slate-100">ยกเลิก</button>
          <button type="submit" class="flex-1 px-4 py-2 rounded-xl bg-sky-600 text-white">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Subject Settings Modal -->
  <div id="subject-settings-modal" class="hidden fixed inset-0 bg-black/50 p-4 z-50">
    <div class="max-w-md mx-auto bg-white rounded-3xl p-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold">ตั้งค่าวิชา</h3>
        <button onclick="closeSubjectSettings()" class="px-3 py-1 rounded-full bg-slate-100">✕</button>
      </div>
      <div class="flex gap-2 mb-3">
        <input id="new-subject" class="flex-1 px-3 py-2 rounded-xl border border-slate-200" placeholder="ชื่อวิชา"/>
        <button onclick="addSubject()" class="px-4 py-2 rounded-xl bg-sky-600 text-white">เพิ่ม</button>
      </div>
      <div id="subjects-list" class="space-y-2 max-h-60 overflow-auto"></div>
    </div>
  </div>

  <!-- Detail Modal (for calendar day & upcoming items) -->
  <div id="detail-modal" class="hidden fixed inset-0 bg-black/50 p-4 z-40">
    <div class="max-w-md mx-auto bg-white rounded-3xl p-6">
      <div class="flex justify-between items-start mb-3">
        <h3 id="detail-title" class="text-lg font-bold">รายละเอียด</h3>
        <button onclick="closeDetail()" class="px-3 py-1 rounded-full bg-slate-100">✕</button>
      </div>
      <div id="detail-body" class="space-y-3 text-slate-700"></div>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div id="delete-modal" class="hidden fixed inset-0 bg-black/60 p-4 z-[80]">
    <div class="max-w-sm mx-auto bg-white rounded-3xl p-6">
      <div class="text-center">
        <div class="text-4xl mb-2">⚠️</div>
        <h3 class="text-lg font-bold mb-2">ยืนยันการลบ</h3>
        <p class="text-slate-600 mb-5">คุณต้องการลบการบ้านนี้หรือไม่?</p>
        <div class="flex gap-2">
          <button onclick="closeDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-slate-100">ยกเลิก</button>
          <button onclick="confirmDelete()" class="flex-1 px-4 py-2 rounded-xl bg-rose-600 text-white">ลบ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Google Sheets (Apps Script) integration ===== */
    const SHEET_API = "https://script.google.com/macros/s/AKfycbwMQCT0So7bJUIvG3kWMz5psytQrzMBhixs9Y4snYWtfYilgy9gf7vzaYt2ifBe8mvzsQ/exec";
    const SHEET_ENABLED = !!SHEET_API;

    async function sheetGet(sheetName){
      try{
        const url = `${SHEET_API}?sheet=${encodeURIComponent(sheetName)}`;
        const res = await fetch(url, { method: 'GET' });
        const json = await res.json().catch(()=>([]));
        return Array.isArray(json) ? { ok:true, data:json } : (json||{ ok:false, data:[] });
      }catch(err){
        console.warn('[Sheet] GET fallback', err);
        return { ok:false, data:[] };
      }
    }
    async function sheetPost(body){
      try{
        const res = await fetch(SHEET_API, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        let json; try { json = await res.json(); }
        catch { const t = await res.text(); try{ json = JSON.parse(t); } catch { json = { ok: res.ok, raw:t }; } }
        return (json && typeof json.ok!=="undefined") ? json : { ok: res.ok, data: json };
      }catch(err){
        console.warn('[Sheet] POST fallback', err);
        return { ok:false, error:String(err) };
      }
    }
    async function loadDataFromSheet(){
      const [hw, act] = await Promise.all([sheetGet('homework'), sheetGet('activities')]);
      if(hw.ok){ homework = (hw.data||[]).map(x=>({ id:String(x.id), subject:x.subject||'', title:x.title||'', dueDate:x.dueDate||'', status:x.status||'pending' })); }
      if(act.ok){ activities = (act.data||[]).map(x=>({ id:String(x.id), title:x.title||'', description:x.description||'', startDate:x.startDate||'', endDate:x.endDate||'' })); }
      updateCalendar(); updateUpcoming(); displayHomework(); updateActivities();
    }
    async function createHomeworkSheet(item){ return sheetPost({ action:'create', sheet:'homework', payload:item }); }
    async function updateHomeworkSheet(id, patch){ return sheetPost({ action:'update', sheet:'homework', id, payload:patch }); }
    async function deleteHomeworkSheet(id){ return sheetPost({ action:'delete', sheet:'homework', id }); }
    async function createActivitySheet(item){ return sheetPost({ action:'create', sheet:'activities', payload:item }); }
    async function updateActivitySheet(id, patch){ return sheetPost({ action:'update', sheet:'activities', id, payload:patch }); }
    async function deleteActivitySheet(id){ return sheetPost({ action:'delete', sheet:'activities', id }); }

    // --------- Data ---------
    let currentDate = new Date();
    let subjects = ['คณิตศาสตร์','ภาษาไทย','ภาษาอังกฤษ','วิทยาศาสตร์','สังคมศึกษา'];
    let homework = [
      { id:1, subject:'คณิตศาสตร์', title:'แบบฝึกหัดบทที่ 5', dueDate:'2024-01-25', status:'pending' },
      { id:2, subject:'ภาษาอังกฤษ', title:'เขียนเรียงความ My Family', dueDate:'2024-01-20', status:'pending' }
    ];
    let activities = [
      { id:1, title:'งานวิทยาศาสตร์', description:'โครงงานพลังงานทดแทน', startDate:'2024-01-22', endDate:'2024-01-30' }
    ];
    let editingId = null;       // id การบ้านที่กำลังแก้ไข
    let pendingDeleteId = null; // id การบ้านที่รอลบ

    // --------- Modal helpers ---------
    function showModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
    function hideModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.add('hidden'); const anyOpen=['add-homework-modal','add-activity-modal','subject-settings-modal','detail-modal','delete-modal'].some(mid=>!document.getElementById(mid).classList.contains('hidden')); if(!anyOpen){ document.body.classList.remove('overflow-hidden'); } }

    // --------- Helpers ---------
    function pad2(n){return String(n).padStart(2,'0')}
    function fmt(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`}
    function parseDate(s){const [y,m,d]=s.split('-').map(Number);return new Date(y,(m||1)-1,d||1)}
    function startOfDay(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate())}
    function daysUntil(s){const t=startOfDay(new Date());const g=startOfDay(parseDate(s));return Math.round((g-t)/86400000)}
    function thaiDate(s){const d=parseDate(s);const m=['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'][d.getMonth()];return `${d.getDate()} ${m} ${d.getFullYear()+543}`}

    // --------- Calendar ---------
    function updateCalendar(){
      const title=document.getElementById('calendar-title');
      const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
      title.textContent=`${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
      const first=new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const start=new Date(first); start.setDate(first.getDate()-first.getDay());
      const grid=document.getElementById('calendar-grid'); grid.innerHTML='';
      const today=startOfDay(new Date());
      for(let i=0;i<42;i++){
        const d=new Date(start); d.setDate(start.getDate()+i);
        const isCur=d.getMonth()===currentDate.getMonth();
        const isToday=startOfDay(d).getTime()===today.getTime();
        const ds=fmt(d);
        const hasHW=homework.some(h=>h.dueDate===ds);
        const hasAct=activities.some(a=>ds>=a.startDate && ds<=a.endDate);
        const el=document.createElement('div');
        el.className='p-3 text-center rounded-2xl cursor-pointer transition-all ' + (!isCur?'text-gray-300': isToday?'bg-sky-600 text-white font-bold':'text-slate-700 hover:bg-slate-100');
        el.innerHTML=`<div class='font-semibold'>${d.getDate()}</div>${(hasHW||hasAct)?`<div class='flex justify-center gap-1 mt-1'>${hasHW?"<div class='day-dot-red'></div>":''}${hasAct?"<div class='day-dot-green'></div>":''}</div>`:''}`;
        el.addEventListener('click',()=>showDayDetail(ds));
        grid.appendChild(el);
      }
    }
    function previousMonth(){currentDate.setMonth(currentDate.getMonth()-1);updateCalendar()}
    function nextMonth(){currentDate.setMonth(currentDate.getMonth()+1);updateCalendar()}

    function showDayDetail(dateStr){
      const dayHW=homework.filter(h=>h.dueDate===dateStr);
      const dayAct=activities.filter(a=>dateStr>=a.startDate && dateStr<=a.endDate);
      document.getElementById('detail-title').textContent = `รายการวันที่ ${thaiDate(dateStr)}`;
      let html='';
      if(dayHW.length){
        html += `<div class='font-semibold text-sky-700'>📝 การบ้าน</div>`;
        dayHW.forEach(h=>{html += `<div class='p-3 rounded-xl border border-slate-200 flex items-start justify-between gap-3'>
          <div>
            <div class='font-semibold'>${h.title}</div>
            <div class='text-sm text-slate-600'>วิชา: ${h.subject}</div>
            <div class='text-xs text-slate-500'>กำหนดส่ง: ${thaiDate(h.dueDate)}</div>
          </div>
          ${h.status!=='completed'?`<button class='px-3 py-1 rounded-full bg-emerald-600 text-white text-sm whitespace-nowrap' onclick='markHomeworkDone(${h.id})'>ทำเสร็จแล้ว</button>`:"<span class='px-3 py-1 rounded-full bg-emerald-100 text-emerald-800 text-xs'>เสร็จแล้ว</span>"}
        </div>`});
      }
      if(dayAct.length){
        html += `<div class='font-semibold text-emerald-700 mt-2'>🎯 กิจกรรม</div>`;
        dayAct.forEach(a=>{html += `<div class='p-3 rounded-xl border border-slate-200'>
          <div class='font-semibold'>${a.title}</div>
          <div class='text-sm text-slate-600'>${a.description||''}</div>
          <div class='text-xs text-slate-500'>${thaiDate(a.startDate)} - ${thaiDate(a.endDate)}</div>
        </div>`});
      }
      if(!html) html = `<div class='text-slate-500'>ไม่มีงานหรือกิจกรรมในวันนี้</div>`;
      document.getElementById('detail-body').innerHTML = html;
      showModal('detail-modal');
    }

    // --------- Upcoming ---------
    function updateUpcoming(){
      const list=[]; const today=startOfDay(new Date());
      homework.filter(h=>h.status!=='completed').forEach(h=>list.push({type:'homework',id:h.id,title:h.title, sub:h.subject, date:h.dueDate, days:daysUntil(h.dueDate)}));
      activities.forEach(a=>{const s=startOfDay(parseDate(a.startDate)); if(s>=today) list.push({type:'activity',id:a.id,title:a.title, sub:a.description, date:a.startDate, days:daysUntil(a.startDate)})});
      list.sort((a,b)=>a.days-b.days);
      const c=document.getElementById('upcoming-tasks');
      c.innerHTML = list.slice(0,5).map(item=>`<button class='w-full text-left flex items-center justify-between p-4 bg-slate-50 rounded-2xl hover:bg-slate-100' onclick="openUpcoming('${item.type}', ${item.id})">
        <div class='flex items-center gap-3'>
          <div class='text-2xl'>${item.type==='homework'?'📝':'🎯'}</div>
          <div><div class='font-semibold text-slate-900'>${item.title}</div><div class='text-sm text-slate-600'>${item.sub||''}</div></div>
        </div>
        <div class='text-right'>
          <div class='text-sm font-semibold ${item.days<0?'text-rose-600':item.days<=3?'text-amber-600':'text-emerald-600'}'>${item.days<0?'เลยกำหนดแล้ว':item.days===0?'วันนี้':`เหลืออีก ${item.days} วัน`}</div>
          <div class='text-xs text-slate-500'>${thaiDate(item.date)}</div>
        </div>
      </button>`).join('');
    }
    function openUpcoming(type,id){ if(type==='homework'){showHomeworkDetail(id)} else {showActivityDetail(id)} }

    function showHomeworkDetail(id){
      const h = homework.find(x=>x.id===id); if(!h) return;
      document.getElementById('detail-title').textContent = 'รายละเอียดการบ้าน';
      document.getElementById('detail-body').innerHTML = `
        <div class='space-y-3'>
          <div class='text-lg font-bold'>${h.title}</div>
          <div class='text-slate-600'>วิชา: ${h.subject}</div>
          <div class='text-sm text-slate-500'>กำหนดส่ง: ${thaiDate(h.dueDate)}</div>
          <div class='flex flex-wrap items-center gap-2'>
            <span class='px-2 py-1 rounded-full text-xs ${h.status==='completed'?'bg-emerald-100 text-emerald-800':'bg-amber-100 text-amber-800'}'>${h.status==='completed'?'เสร็จแล้ว':'ยังไม่เสร็จ'}</span>
            ${h.status!=='completed'?`<button class='px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm' onclick='markHomeworkDone(${h.id})'>ทำเสร็จแล้ว</button>`:''}
            <button class='px-4 py-2 rounded-xl bg-sky-600 text-white text-sm' onclick='editHomework(${h.id})'>แก้ไข</button>
            <button class='px-4 py-2 rounded-xl bg-rose-600 text-white text-sm' onclick='openDeleteConfirm(${h.id})'>ลบ</button>
          </div>
        </div>`;
      showModal('detail-modal');
    }

    function showActivityDetail(id){
      const a = activities.find(x=>x.id===id); if(!a) return;
      document.getElementById('detail-title').textContent = 'รายละเอียดกิจกรรม';
      document.getElementById('detail-body').innerHTML = `
        <div class='space-y-2'>
          <div class='text-lg font-bold'>${a.title}</div>
          <div class='text-slate-600'>${a.description||''}</div>
          <div class='text-sm text-slate-500'>${thaiDate(a.startDate)} - ${thaiDate(a.endDate)}</div>
        </div>`;
      showModal('detail-modal');
    }

    // --------- Homework list & filter ---------
    let activeFilter='all';
    function filterHomework(filter){
      activeFilter=filter;
      document.querySelectorAll('.filter-btn').forEach(b=>{b.classList.remove('bg-white','shadow-sm','text-slate-700');b.classList.add('text-slate-600')});
      const btn=document.getElementById(`filter-${filter}`); if(btn){btn.classList.add('bg-white','shadow-sm','text-slate-700')}
      displayHomework();
    }
    function updateHomeworkCounts(){
      const today=startOfDay(new Date());
      homework.forEach(h=>{if(h.status==='pending' && startOfDay(parseDate(h.dueDate))<today){h.status='overdue'}});
      const counts={all:homework.length,pending:homework.filter(h=>h.status==='pending').length,overdue:homework.filter(h=>h.status==='overdue').length,completed:homework.filter(h=>h.status==='completed').length};
      for(const k in counts){const el=document.getElementById(`count-${k}`); if(el) el.textContent=counts[k];}
    }
    function displayHomework(){
      updateHomeworkCounts();
      let data=homework; if(activeFilter!=='all') data=homework.filter(h=>h.status===activeFilter);
      const c=document.getElementById('homework-list');
      if(!data.length){c.innerHTML='<div class="text-center text-slate-500 py-8">ไม่มีการบ้าน</div>'; return;}
      c.innerHTML=data.map(h=>{
        const d=daysUntil(h.dueDate);
        let badge='';
        if(h.status==='completed') badge='<span class="bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded-full">เสร็จแล้ว</span>';
        else if(h.status==='overdue') badge='<span class="bg-rose-100 text-rose-800 text-xs px-2 py-1 rounded-full">เลยกำหนด</span>';
        else if(d<=3) badge=`<span class='bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded-full'>เหลืออีก ${d} วัน</span>`;
        else badge=`<span class='bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full'>เหลืออีก ${d} วัน</span>`;
        return `<div class='soft-card rounded-2xl p-4'>
          <div class='flex items-start justify-between'>
            <div>
              <div class='flex gap-2 mb-1'><span class='bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full'>${h.subject}</span>${badge}</div>
              <button class='font-semibold hover:underline' onclick='showHomeworkDetail(${h.id})'>${h.title}</button>
              <div class='text-sm text-slate-600'>กำหนด: ${thaiDate(h.dueDate)}</div>
            </div>
          </div>
        </div>`
      }).join('');
    }

    // --------- Activities ---------
    function updateActivities(){
      const c=document.getElementById('activities-list');
      if(!activities.length){c.innerHTML='<div class="text-center text-slate-500 py-8">ยังไม่มีกิจกรรม</div>'; return;}
      const today=startOfDay(new Date());
      const sorted=[...activities].sort((a,b)=>parseDate(a.startDate)-parseDate(b.startDate));
      c.innerHTML=sorted.map(a=>{
        const s=parseDate(a.startDate), e=parseDate(a.endDate);
        const ongoing = startOfDay(s)<=today && today<=startOfDay(e);
        const upcoming = startOfDay(s)>today;
        const badge = ongoing?'<span class="bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded-full">กำลังดำเนินการ</span>': upcoming?`<span class='bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full'>เริ่มในอีก ${daysUntil(a.startDate)} วัน</span>`:'<span class="bg-slate-100 text-slate-700 text-xs px-2 py-1 rounded-full">สิ้นสุดแล้ว</span>';
        return `<div class='soft-card rounded-2xl p-4'>
          <div class='mb-1'>${badge}</div>
          <button class='font-semibold hover:underline' onclick='showActivityDetail(${a.id})'>${a.title}</button>
          <div class='text-sm text-slate-600 mb-1'>${a.description||''}</div>
          <div class='text-xs text-slate-500'>${thaiDate(a.startDate)} - ${thaiDate(a.endDate)}</div>
        </div>`
      }).join('');
    }

    // --------- ADD / EDIT (Homework) ---------
    function populateSubjectDropdown(){ const dd=document.getElementById('homework-subject'); if(!dd) return; dd.innerHTML = subjects.map(s=>`<option value='${s}'>${s}</option>`).join(''); }
    function showAddHomework(){ hideModal('detail-modal'); populateSubjectDropdown(); const form=document.getElementById('homework-form'); if(form) form.reset(); showModal('add-homework-modal'); }
    function closeAddHomework(){ hideModal('add-homework-modal'); }
    async function saveHomework(e){
      e.preventDefault();
      const subject=document.getElementById('homework-subject').value;
      const title=document.getElementById('homework-title').value.trim();
      const dueDate=document.getElementById('homework-date').value;
      const status=document.getElementById('homework-status').value;
      if(!subject||!title||!dueDate) return;

      if(editingId){
        const idx = homework.findIndex(h=>String(h.id)===String(editingId));
        if(idx>-1){
          const patch = { subject, title, dueDate, status };
          if(SHEET_ENABLED){ const resp = await updateHomeworkSheet(homework[idx].id, patch); if(!resp.ok) console.warn('[Sheet] update failed', resp); }
          homework[idx] = { ...homework[idx], ...patch };
        }
        editingId = null;
      } else {
        const newItem = { id: String(Date.now()), subject, title, dueDate, status };
        if(SHEET_ENABLED){ const resp = await createHomeworkSheet(newItem); if(!resp.ok) console.warn('[Sheet] create failed', resp); }
        homework.push(newItem);
      }
      closeAddHomework();
      displayHomework(); updateUpcoming(); updateCalendar();
    }

    function editHomework(id){
      const h = homework.find(x=>x.id===id); if(!h) return;
      editingId = id; hideModal('detail-modal'); populateSubjectDropdown();
      document.getElementById('homework-subject').value = h.subject;
      document.getElementById('homework-title').value = h.title;
      document.getElementById('homework-date').value = h.dueDate;
      document.getElementById('homework-status').value = h.status;
      showModal('add-homework-modal');
    }

    function openDeleteConfirm(id){ ['add-homework-modal','add-activity-modal','subject-settings-modal','detail-modal'].forEach(hideModal); pendingDeleteId = id; showModal('delete-modal'); }
    function closeDeleteConfirm(){ pendingDeleteId = null; hideModal('delete-modal'); }
    async function confirmDelete(){
      if(pendingDeleteId==null) return;
      const idx = homework.findIndex(h => String(h.id) === String(pendingDeleteId));
      const delId = pendingDeleteId; pendingDeleteId = null;
      if(idx > -1){
        if(SHEET_ENABLED){ const resp = await deleteHomeworkSheet(homework[idx].id); if(!resp.ok) console.warn('[Sheet] delete failed', resp); }
        homework.splice(idx, 1);
      }
      hideModal('delete-modal'); displayHomework(); updateUpcoming(); updateCalendar();
    }

    // --------- ADD (Activity) ---------
    function showAddActivity(){ const form=document.getElementById('activity-form'); if(form) form.reset(); showModal('add-activity-modal'); }
    function closeAddActivity(){ hideModal('add-activity-modal'); }
    async function saveActivity(e){
      e.preventDefault();
      const title=document.getElementById('activity-title').value.trim();
      const description=document.getElementById('activity-description').value.trim();
      const startDate=document.getElementById('activity-start-date').value;
      const endDate=document.getElementById('activity-end-date').value;
      if(!title||!startDate||!endDate) return;
      const newItem = { id: String(Date.now()), title, description, startDate, endDate };
      if(SHEET_ENABLED){ const resp = await createActivitySheet(newItem); if(!resp.ok) console.warn('[Sheet] create activity failed', resp); }
      activities.push(newItem);
      closeAddActivity(); updateActivities(); updateUpcoming(); updateCalendar();
    }

    // --------- Subjects modal ---------
    function showSubjectSettings(){ updateSubjectsList(); showModal('subject-settings-modal'); }
    function closeSubjectSettings(){ hideModal('subject-settings-modal'); }
    function updateSubjectsList(){
      const list = document.getElementById('subjects-list');
      list.innerHTML = subjects.map(s => `
        <div class='flex items-center justify-between p-2 bg-slate-50 rounded-xl'>
          <span class='text-sm'>${s}</span>
          <button class='text-rose-600 hover:text-rose-700 text-sm' onclick="removeSubject('${s.replace(/'/g,"\\'")}')">ลบ</button>
        </div>`).join('');
    }
    function addSubject(){ const input=document.getElementById('new-subject'); const name=(input.value||'').trim(); if(!name) return; if(subjects.includes(name)){ input.value=''; return; } subjects.push(name); input.value=''; updateSubjectsList(); populateSubjectDropdown(); }
    function removeSubject(name){ subjects = subjects.filter(s => s !== name); updateSubjectsList(); populateSubjectDropdown(); }

    // --------- Close by ESC / click backdrop ---------
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeDeleteConfirm(); closeDetail(); } });
    document.getElementById('delete-modal').addEventListener('click', (e)=>{ if(e.target.id==='delete-modal'){ closeDeleteConfirm(); } });
    document.getElementById('detail-modal').addEventListener('click', (e)=>{ if(e.target.id==='detail-modal'){ closeDetail(); } });
    function closeDetail(){ hideModal('detail-modal'); }

    // --------- Self-tests ---------
    function selfTests(){
      try{
        updateCalendar();
        console.assert(document.getElementById('calendar-grid').children.length===42,'[Calendar] should have 42 cells');
        updateUpcoming();
        // Add/Edit/Delete test (local only)
        const len0 = homework.length;
        const tempId = 987654321;
        homework.push({id:tempId, subject:'ทดสอบ', title:'งานทดสอบ', dueDate:'2025-12-31', status:'pending'});
        console.assert(homework.length===len0+1,'[Add] +1 item');
        const idx = homework.findIndex(h=>h.id===tempId); homework[idx] = { ...homework[idx], title:'งานทดสอบ(แก้ไข)' }; console.assert(homework[idx].title.includes('แก้ไข'),'[Edit] title updated');
        openDeleteConfirm(tempId); confirmDelete();
        console.assert(homework.length===len0,'[Delete] back to original length');
        console.assert(!homework.some(h=>h.id===tempId),'[Delete] removed item');
      }catch(e){ console.error('[SelfTest] Failed', e); }
    }

    // --------- init ---------
    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        if(SHEET_ENABLED){ await loadDataFromSheet(); }
        else { updateCalendar(); updateUpcoming(); displayHomework(); updateActivities(); }
      }catch(err){ console.warn('[Sheet] load failed, fallback to local mock', err); updateCalendar(); updateUpcoming(); displayHomework(); updateActivities(); }
      populateSubjectDropdown(); selfTests();
    });
  </script>
</body>
</html>
