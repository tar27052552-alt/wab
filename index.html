<!DOCTYPE html>
<script>
const liffId = "2008357926-Ly07A5w2";
const supabaseUrl = "https://dyorwbjagjlkqpbrdjwk.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);


async function initLiff() {
try {
await liff.init({ liffId });
console.log("‚úÖ LIFF Loaded");


if (!liff.isLoggedIn()) {
liff.login();
return;
}


const profile = await liff.getProfile();
console.log("üë§ Profile:", profile);


await saveUserToSupabase(profile);
localStorage.setItem("userName", profile.displayName);
localStorage.setItem("userPic", profile.pictureUrl);
localStorage.setItem("userId", profile.userId);


window.location.href = "home.html";
} catch (err) {
console.error("‚ùå Error initializing LIFF:", err);
}
}


async function saveUserToSupabase(profile) {
try {
const { data: existingUser, error: findError } = await supabase
.from("users")
.select("*")
.eq("line_id", profile.userId)
.single();


if (findError && findError.code !== "PGRST116") throw findError;


if (!existingUser) {
const { error } = await supabase.from("users").insert([
{
display_name: profile.displayName,
picture_url: profile.pictureUrl,
line_id: profile.userId,
points: 0,
},
]);
if (error) throw error;
console.log("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô Supabase ‡πÅ‡∏•‡πâ‡∏ß");
} else {
console.log("üü¢ ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Supabase ‡πÅ‡∏•‡πâ‡∏ß");
}
} catch (err) {
console.error("saveUserToSupabase error:", err);
}
}
</script>
</body>
</html>
