<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SUAN KHANOM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
      min-height: 100vh;
    }
    * { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      font-weight: 500;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.8);
      color: #374151;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
    }
    .selected {
      border: 4px solid #1d4ed8 !important;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(29, 78, 216, 0.5);
    }
    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .float { animation: float 3s ease-in-out infinite; }
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-preparing { background: #dbeafe; color: #1e40af; }
    .badge-ready { background: #d1fae5; color: #065f46; }
    .badge-completed { background: #e0e7ff; color: #3730a3; }
    .badge-cancelled { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="min-h-full">
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="text-center">
      <div class="spinner mb-4 mx-auto"></div>
      <p class="text-white text-xl font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>
  </div>

  <!-- Header -->
  <header id="main-header" class="glass shadow-sm border-b border-white/20 sticky top-0 z-40 hidden">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-2xl float">ü™ô</div>
          <div>
            <div class="text-sm text-gray-500">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
            <div class="font-semibold text-gray-900">
              <span id="userPoints" class="text-orange-600 font-semibold">0</span> ‡πÅ‡∏ï‡πâ‡∏°
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-3">
          <div class="flex items-center space-x-2">
            <img id="userPic" src="" alt="Profile" class="w-8 h-8 rounded-full border border-gray-300" />
            <span id="userName" class="text-sm text-gray-600 hidden sm:block">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
          </div>
          <button onclick="showCart()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-xl text-sm hover-lift relative">
            <span class="hidden sm:inline">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
            <span class="sm:hidden">üõí</span>
            <span id="cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
          </button>
          <button onclick="showCoupons()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">üé´ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</span>
            <span class="sm:hidden">üé´</span>
          </button>
          <button onclick="openOrderHistory()" 
            class="btn-secondary px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
            <span class="sm:hidden">üìã</span>
          </button>
          <button id="admin-btn" onclick="showAdmin()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-xl text-sm hover-lift hidden">
            <span class="hidden sm:inline">üë®‚Äçüíº Admin</span>
            <span class="sm:hidden">üë®‚Äçüíº</span>
          </button>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            <span class="sm:hidden">üö™</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main App -->
  <main id="main-app" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <div class="text-center mb-12">
      <div class="text-6xl mb-4 float">ü´ê</div>
      <h1 class="text-4xl font-bold mb-2" style="background: linear-gradient(135deg, #1f2937, #374151); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SUAN KHANOM</h1>
      <p class="text-gray-600 text-lg mb-4">‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <!-- üç∞ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà -->
<section class="bg-white p-6 rounded-xl shadow-md mb-6">
  <h3 class="text-xl font-semibold mb-4">ü´ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>
  <div id="base-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>

<!-- üç´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà -->
<section class="bg-white p-6 rounded-xl shadow-md mb-6">
  <h3 class="text-xl font-semibold mb-4">üç´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>
  <div id="topping-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>

<!-- üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ -->
<section class="bg-white p-6 rounded-xl shadow-md text-center mb-6">
  <h3 class="text-lg font-semibold mb-3">üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</h3>
  <div class="flex justify-center items-center gap-4 mb-4">
    <button id="decreaseQty" class="bg-gray-200 px-4 py-2 rounded text-lg font-bold">‚àí</button>
    <span id="quantity" class="text-2xl font-semibold">1</span>
    <button id="increaseQty" class="bg-gray-200 px-4 py-2 rounded text-lg font-bold">Ôºã</button>
  </div>
  <p class="text-lg">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <span id="total-price" class="font-bold text-blue-600">0</span> ‡∏ö‡∏≤‡∏ó</p>
</section>

<!-- üõí ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
<div class="text-center">
  <button id="add-to-cart" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-purple-700 transition">
    üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
  </button>
</div>
  </main>

<section id="order-history" class="hidden px-4 py-6">
  <!-- ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏õ‡∏∏‡πà‡∏° -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-semibold text-purple-800 flex items-center gap-2">
      <span class="text-2xl">üì¶</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
    </h2>
    <button 
      onclick="backToMain()" 
      class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md transition">
      ‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    </button>
  </div>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ -->
  <div id="order-list" class="space-y-4"></div>
</section>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'cart-modal')">
    <div class="card max-w-2xl w-full max-h-[80vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <div id="cart-content" class="mb-6"></div>
      
      <!-- Coupon Section -->
      <div id="coupon-section" class="mb-6 p-4 bg-purple-50 rounded-xl">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-gray-900">üé´ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h4>
          <button onclick="showCoupons()" class="text-purple-600 text-sm hover:underline">‡∏î‡∏π‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div id="selected-coupon" class="hidden mb-3 p-3 bg-white rounded-lg border-2 border-purple-300">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium text-purple-900" id="coupon-name"></div>
              <div class="text-sm text-purple-700" id="coupon-desc"></div>
            </div>
            <button onclick="removeCoupon()" class="text-red-500 hover:text-red-700 text-sm font-medium">‡∏•‡∏ö</button>
          </div>
        </div>
        <div class="flex gap-2">
          <input type="text" id="coupon-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
          <button onclick="applyCouponCode()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">‡πÉ‡∏ä‡πâ</button>
        </div>
        <div id="coupon-message" class="text-sm mt-2 hidden"></div>
      </div>

      <div class="border-t pt-4">
        <div class="space-y-2 mb-4">
          <div class="flex justify-between text-gray-700">
            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
            <span id="cart-subtotal">0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div id="discount-row" class="flex justify-between text-green-600 hidden">
            <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
            <span id="discount-amount">-0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div class="flex justify-between items-center text-xl font-bold border-t pt-2">
            <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
            <span id="cart-total" class="text-blue-600">0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>
        <button onclick="checkout()" class="btn-primary w-full py-3 rounded-xl font-semibold text-lg">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Coupons Modal -->
  <div id="coupons-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'coupons-modal')">
    <div class="card max-w-4xl w-full max-h-[80vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">üé´ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        <button onclick="closeCoupons()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <div id="coupons-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'admin-modal')">
    <div class="card max-w-6xl w-full max-h-[90vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">üë®‚Äçüíº Admin Dashboard</h3>
        <button onclick="closeAdmin()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>

      <!-- Admin Tabs -->
     <div class="flex space-x-4 mb-6 border-b">
  <button onclick="showAdminTab('orders')" class="admin-tab px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600" data-tab="orders">
    üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
  </button>
  <button onclick="showAdminTab('coupons')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="coupons">
    üé´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
  </button>
  <button onclick="showAdminTab('stats')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="stats">
    üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
  </button>
  <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà -->
  <button onclick="showAdminTab('brownie')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="brownie">
    üç∞ ‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà
  </button>
  <button class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="summary" onclick="showAdminTab('summary')">
    üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
  </button>
</div>

<!-- ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà -->
<section id="admin-brownie-tab" class="admin-tab-content hidden">
  <div id="admin-brownie-content" class="p-4"></div>
</section>
<!-- Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà -->
<div id="brownie-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h3 id="brownie-modal-title" class="text-xl font-semibold mb-4">üç∞ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>

    <form id="brownie-form" class="space-y-3">
      <input type="hidden" id="brownie-id">
      <input type="hidden" id="brownie-type">

      <div>
        <label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π (‡πÉ‡∏™‡πà‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÑ‡∏î‡πâ)</label>
        <input id="brownie-name" class="w-full border rounded px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô üç´ ‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà‡πÇ‡∏Å‡πÇ‡∏Å‡πâ" required>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
        <textarea id="brownie-desc" class="w-full border rounded px-3 py-2" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏™‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô ‡∏´‡∏≠‡∏°‡πÇ‡∏Å‡πÇ‡∏Å‡πâ"></textarea>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
          <input id="brownie-price" type="number" step="0.01" class="w-full border rounded px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ</label>
          <input id="brownie-points" type="number" class="w-full border rounded px-3 py-2" required>
        </div>
      </div>

      <label class="flex items-center gap-2 mt-2">
        <input id="brownie-active" type="checkbox" class="w-4 h-4"> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ
      </label>

      <div class="flex justify-end gap-2 pt-3 border-t mt-4">
        <button type="button" onclick="closeBrownieModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </form>
  </div>
</div>

      <!-- Orders Tab -->
      <div id="admin-orders-tab" class="admin-tab-content">
        <div id="admin-orders-content"></div>
      </div>

      <!-- Coupons Tab -->
      <div id="admin-coupons-tab" class="admin-tab-content hidden">
        <div class="mb-6">
          <button onclick="showCreateCouponForm()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">
            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
        <div id="admin-coupons-content"></div>
      </div>
<!-- üìÖ ‡πÅ‡∏ó‡πá‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô -->
<div id="admin-summary-tab" class="admin-tab-content hidden space-y-4">
  <div class="flex flex-wrap gap-3 items-center">
    <input type="date" 
           id="summary-date" 
           class="border rounded-lg px-3 py-2 shadow-sm">
    <button onclick="loadDailySummary()" 
            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
      ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ
    </button>
    <button onclick="updateAllOrdersOfDay()" 
            class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
      ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô
    </button>
  </div>

  <div id="summary-content" 
       class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200 min-h-[150px]">
    <p class="text-gray-500 text-center">
      üìÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
    </p>
  </div>
</div>

      <!-- Stats Tab -->
      <div id="admin-stats-tab" class="admin-tab-content hidden">
        <div id="admin-stats-content" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </div>
    </div>
  </div>
  <!-- Create Coupon Modal -->
  <div id="create-coupon-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'create-coupon-modal')">
    <div class="card max-w-md w-full hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
        <button onclick="closeCreateCoupon()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <form onsubmit="createCoupon(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input type="text" id="coupon-code" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô WELCOME10" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input type="text" id="coupon-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏î 10%" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
          <input type="text" id="coupon-description" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏î 10% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <select id="coupon-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</option>
            <option value="fixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <input type="number" id="coupon-value" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="coupon-min" value="0" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
          <input type="number" id="coupon-usage" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>
        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold">
          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
        </button>
      </form>
    </div>
  </div>

  <!-- Success Message -->
  <div id="success-message" class="fixed top-20 right-4 card shadow-lg hidden z-50">
    <div class="flex items-center space-x-3">
      <div class="text-2xl">üéâ</div>
      <div id="success-text" class="font-medium text-gray-900"></div>
    </div>
  </div>

  <script>
    // ===============================================================
    // 1. CONFIGURATION
    // ===============================================================
    const LIFF_ID = "2008357926-Ly07A5w2";
    const SUPABASE_URL = "https://dyorwbjagjlkqpbrdjwk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5b3J3YmphZ2psa3FwYnJkandrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjk2NjgsImV4cCI6MjA3Njk0NTY2OH0.bZJRcaM3u9NUBrux5AbPXOXVtcSnJHDdK15gCQ-9Zc4";
    // Admin User IDs (‡πÄ‡∏û‡∏¥‡πà‡∏° LINE User ID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Admin)
    const ADMIN_IDS = ["Ud21a04a5d66c9de0b4c6f1aaf8f050e2","U5301bd5962323787574d82f86f3d954e"]; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô User ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log("‚úÖ Supabase initialized");
    } catch (error) {
      console.error("‚ùå Supabase initialization failed:", error);
    }

    // ===============================================================
    // 2. STATE VARIABLES
    // ===============================================================
    let userProfile = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE (global ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô)
    let currentUser = null;
    let selectedBase = null;
    let selectedTopping = null;
    let currentQuantity = 1;
    let cart = [];
    let userPoints = 0;
    let selectedCoupon = null;
    let availableCoupons = [];

    const baseNames = {
      cocoa: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÇ‡∏Å‡πÇ‡∏Å‡πâ",
      greentea: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß",
      thaitea: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢"
    };

    const toppingNames = {
      chocolate: "‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï‡∏ä‡∏¥‡∏û",
      almond: "‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå‡πÅ‡∏ú‡πà‡∏ô",
      oreo: "‡πÇ‡∏≠‡∏£‡∏¥‡πÇ‡∏≠‡πâ‡∏ö‡∏î"
    };

    // ===============================================================
    // 3. INITIALIZATION
    // ===============================================================
    async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    console.log("‚úÖ LIFF Initialized");

    if (!liff.isLoggedIn()) {
      console.log("‚ùå Not logged in, redirecting to LINE Login...");
      liff.login();
      return;
    }

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å LINE ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
    userProfile = await liff.getProfile();
    console.log("üë§ Profile loaded:", userProfile);

    // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• userProfile ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Supabase ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    await saveUserToSupabase(userProfile);
    await loadUserData(userProfile.userId);
    await loadCoupons();

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    if (ADMIN_IDS.includes(userProfile.userId)) {
      document.getElementById("admin-btn").classList.remove("hidden");
    }

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    document.getElementById("loading-screen").classList.add("hidden");
    document.getElementById("main-header").classList.remove("hidden");
    document.getElementById("main-app").classList.remove("hidden");

  } catch (error) {
    console.error("‚ùå Init error:", error);
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
    setTimeout(() => liff.login(), 2000);
  }
}
    // üìå ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
window.addEventListener("DOMContentLoaded", loadMenus);

    // ===============================================================
    // 4. USER MANAGEMENT
    // ===============================================================
    async function saveUserToSupabase(profile) {
      try {
        const { data: existingUser, error: findError } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", profile.userId)
          .maybeSingle();

        if (findError && findError.code !== "PGRST116") throw findError;

        if (!existingUser) {
          const { error: insertError } = await supabase
            .from("users")
            .insert([{
              line_id: profile.userId,
              display_name: profile.displayName,
              picture_url: profile.pictureUrl,
              points: 0
            }]);

          if (insertError) throw insertError;
          console.log("‚úÖ New user created");
        } else {
          console.log("üü¢ User exists");
        }
      } catch (error) {
        console.error("‚ùå Error saving user:", error);
        throw error;
      }
    }

    async function loadUserData(userId) {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", userId)
          .single();

        if (error) throw error;

        currentUser = data;
        userPoints = data.points || 0;

        document.getElementById("userName").textContent = data.display_name;
        document.getElementById("userPic").src = data.picture_url;
        document.getElementById("userPoints").textContent = userPoints;

        console.log("‚úÖ User data loaded:", data);
      } catch (error) {
        console.error("‚ùå Error loading user data:", error);
        throw error;
      }
    }

    async function logout() {
      if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        liff.logout();
        window.location.reload();
      }
    }

    // ===============================================================
    // 5. ORDER MANAGEMENT WITH QUANTITY
    // ===============================================================
   let selectedBase = null;
let selectedTopping = null;
let currentQuantity = 1;

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å Supabase (‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á)
async function loadMenus() {
  const { data: bases } = await supabase.from('brownie_bases').select('*').eq('is_active', true);
  const { data: toppings } = await supabase.from('brownie_toppings').select('*').eq('is_active', true);

  const baseList = document.getElementById("base-list");
  const toppingList = document.getElementById("topping-list");

  baseList.innerHTML = bases.map(b => `
    <div class="brownie-base card cursor-pointer text-center hover-lift" onclick="selectBase(${b.id}, '${b.name}', ${b.price}, this)">
      <div class="text-3xl mb-1">${b.name}</div>
      <p class="text-gray-600 text-sm">${b.description || ''}</p>
      <p class="text-blue-600 font-semibold mt-2">üí∞ ${b.price} ‡∏ö‡∏≤‡∏ó</p>
    </div>
  `).join('');

  toppingList.innerHTML = toppings.map(t => `
    <div class="topping-item card cursor-pointer text-center hover-lift" onclick="selectTopping(${t.id}, '${t.name}', ${t.price}, this)">
      <div class="text-3xl mb-1">${t.name}</div>
      <p class="text-gray-600 text-sm">${t.description || ''}</p>
      <p class="text-purple-600 font-semibold mt-2">üç´ ${t.price} ‡∏ö‡∏≤‡∏ó</p>
    </div>
  `).join('');
}

// ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠
function selectBase(id, name, price, el) {
  document.querySelectorAll('.brownie-base').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedBase = { id, name, price };
  updateTotal();
}

// ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤
function selectTopping(id, name, price, el) {
  document.querySelectorAll('.topping-item').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedTopping = { id, name, price };
  updateTotal();
}

// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
function changeQuantity(v) {
  currentQuantity = Math.max(1, currentQuantity + v);
  document.getElementById("quantity").textContent = currentQuantity;
  updateTotal();
}

// ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°
function updateTotal() {
  const basePrice = selectedBase?.price || 0;
  const toppingPrice = selectedTopping?.price || 0;
  const total = (basePrice + toppingPrice) * currentQuantity;

  document.getElementById("total-price").textContent = total.toLocaleString();

  document.getElementById("add-to-cart").disabled = !(selectedBase && selectedTopping);
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
function addToCart() {
  if (!selectedBase || !selectedTopping) return showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");

  const total = (selectedBase.price + selectedTopping.price) * currentQuantity;
  cart.push({
    id: Date.now(),
    baseName: selectedBase.name,
    toppingName: selectedTopping.name,
    quantity: currentQuantity,
    unitPrice: selectedBase.price + selectedTopping.price,
    totalPrice: total
  });

  updateCartBadge();
  showMessage("üß∫ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!");
  currentQuantity = 1;
  document.getElementById("quantity").textContent = "1";
  updateTotal();
}
    // ===============================================================
    // 6. CART & COUPON MANAGEMENT
    // ===============================================================
    function showCart() {
      const modal = document.getElementById("cart-modal");
      const content = document.getElementById("cart-content");

      if (cart.length === 0) {
        content.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">üõí</div>
            <p class="text-gray-600 text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
          </div>
        `;
      } else {
        let html = '<div class="space-y-3">';
        cart.forEach((item, index) => {
          html += `
            <div class="card border border-gray-200 p-4">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="font-semibold">${item.baseName}</div>
                  <div class="text-sm text-gray-600">‡∏´‡∏ô‡πâ‡∏≤: ${item.toppingName}</div>
                  <div class="text-sm text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-blue-600">${item.totalPrice} ‡∏ö‡∏≤‡∏ó</div>
                  <div class="flex items-center gap-2 mt-2">
                    <button onclick="updateCartQuantity(${index}, -1)" class="quantity-btn bg-red-500 hover:bg-red-600 text-white text-sm w-6 h-6">‚àí</button>
                    <span class="text-sm font-medium">${item.quantity}</span>
                    <button onclick="updateCartQuantity(${index}, 1)" class="quantity-btn bg-green-500 hover:bg-green-600 text-white text-sm w-6 h-6">+</button>
                  </div>
                  <button onclick="removeFromCart(${index})" class="text-red-500 text-sm mt-2 hover:underline">‡∏•‡∏ö</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;
      }

      updateCartTotal();
      modal.classList.remove("hidden");
    }

    function updateCartQuantity(index, change) {
      if (cart[index]) {
        cart[index].quantity = Math.max(1, cart[index].quantity + change);
        cart[index].totalPrice = cart[index].unitPrice * cart[index].quantity;
        updateCartBadge();
        showCart();
      }
    }

    function updateCartTotal() {
      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      let discount = 0;

      if (selectedCoupon) {
        if (selectedCoupon.type === 'percent') {
          discount = Math.floor(subtotal * selectedCoupon.value / 100);
        } else {
          discount = Math.min(selectedCoupon.value, subtotal);
        }
      }

      const total = Math.max(0, subtotal - discount);

      document.getElementById("cart-subtotal").textContent = subtotal + " ‡∏ö‡∏≤‡∏ó";
      document.getElementById("cart-total").textContent = total + " ‡∏ö‡∏≤‡∏ó";

      if (discount > 0) {
        document.getElementById("discount-row").classList.remove("hidden");
        document.getElementById("discount-amount").textContent = "-" + discount + " ‡∏ö‡∏≤‡∏ó";
      } else {
        document.getElementById("discount-row").classList.add("hidden");
      }
    }

    function closeCart() {
      document.getElementById("cart-modal").classList.add("hidden");
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartBadge();
      showCart();
      showMessage("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
    }

    // ===============================================================
    // 7. COUPON SYSTEM
    // ===============================================================
    async function loadCoupons() {
  try {
    const { data, error } = await supabase
      .from("coupons")
      .select("*")
      .eq("is_active", true)
      .eq("show_in_list", true) // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå
      .order("created_at", { ascending: false });

    if (error) throw error;

    availableCoupons = data || [];
    console.log("‚úÖ Coupons loaded:", availableCoupons.length);
  } catch (error) {
    console.error("‚ùå Error loading coupons:", error);
  }
}

function showCoupons() {
  const modal = document.getElementById("coupons-modal");
  const content = document.getElementById("coupons-content");

  if (availableCoupons.length === 0) {
    content.innerHTML = `
      <div class="col-span-2 text-center py-12">
        <div class="text-6xl mb-4">üé´</div>
        <p class="text-gray-600 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</p>
      </div>
    `;
  } else {
    let html = '';
    availableCoupons.forEach(coupon => {
      const canUse = coupon.usage_limit > coupon.usage_count;
      html += `
        <div class="card border-2 ${canUse ? 'border-purple-200 hover:border-purple-400 cursor-pointer' : 'border-gray-200 opacity-50'} p-4" ${canUse ? `onclick="selectCouponFromList('${coupon.code}')"` : ''}>
          <div class="flex items-start justify-between mb-3">
            <div class="text-3xl">üé´</div>
            <div class="text-xs ${canUse ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} px-2 py-1 rounded-full">
              ${canUse ? '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ' : '‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß'}
            </div>
          </div>
          <div class="font-bold text-lg text-purple-900 mb-1">${coupon.name}</div>
          <div class="text-sm text-gray-600 mb-2">${coupon.description}</div>
          <div class="text-xs text-gray-500">‡∏£‡∏´‡∏±‡∏™: ${coupon.code}</div>
          <div class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ${coupon.min_purchase} ‡∏ö‡∏≤‡∏ó</div>
          <div class="text-xs text-gray-500">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${coupon.usage_limit - coupon.usage_count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        </div>
      `;
    });
    content.innerHTML = html;
  }

  modal.classList.remove("hidden");
}

function closeCoupons() {
  document.getElementById("coupons-modal").classList.add("hidden");
}

function selectCouponFromList(code) {
  document.getElementById("coupon-input").value = code;
  closeCoupons();
  applyCouponCode();
}

async function applyCouponCode() {
  const code = document.getElementById("coupon-input").value.trim().toUpperCase();

  if (!code) {
    showCouponMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á", "error");
    return;
  }

  const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);

  try {
    const { data: coupon, error } = await supabase
      .from("coupons")
      .select("*")
      .eq("code", code)
      .eq("is_active", true)
      .single();

    if (error || !coupon) {
      showCouponMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß", "error");
      return;
    }

    if (coupon.usage_count >= coupon.usage_limit) {
      showCouponMessage("‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß", "error");
      return;
    }

    if (subtotal < coupon.min_purchase) {
      showCouponMessage(`‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${coupon.min_purchase} ‡∏ö‡∏≤‡∏ó`, "error");
      return;
    }

    selectedCoupon = coupon;
    document.getElementById("selected-coupon").classList.remove("hidden");
    document.getElementById("coupon-name").textContent = coupon.name;
    document.getElementById("coupon-desc").textContent = coupon.description;
    document.getElementById("coupon-input").value = "";

    updateCartTotal();
    showCouponMessage("‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ", "success");

  } catch (error) {
    console.error("‚ùå Error applying coupon:", error);
    showCouponMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error");
  }
}

function removeCoupon() {
  selectedCoupon = null;
  document.getElementById("selected-coupon").classList.add("hidden");
  updateCartTotal();
  showMessage("‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
}

function showCouponMessage(message, type) {
  const messageEl = document.getElementById("coupon-message");
  messageEl.textContent = message;
  messageEl.className = `text-sm mt-2 ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
  messageEl.classList.remove("hidden");
  setTimeout(() => messageEl.classList.add("hidden"), 3000);
}

    // ===============================================================
    // 8. CHECKOUT
    // ===============================================================
    async function checkout() {
      if (cart.length === 0) {
        showMessage("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
        return;
      }

      try {
        const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
        let discount = 0;

        if (selectedCoupon) {
          if (selectedCoupon.type === 'percent') {
            discount = Math.floor(subtotal * selectedCoupon.value / 100);
          } else {
            discount = Math.min(selectedCoupon.value, subtotal);
          }
        }

        const total = Math.max(0, subtotal - discount);
        const earnedPoints = total;

        // Create order
        const { data: orderData, error: orderError } = await supabase
          .from("orders")
          .insert([{
            user_id: currentUser.id,
            line_id: currentUser.line_id,
            items: cart,
            subtotal: subtotal,
            discount: discount,
            total_price: total,
            earned_points: earnedPoints,
            coupon_code: selectedCoupon ? selectedCoupon.code : null,
            status: "pending"
          }])
          .select()
          .single();

        if (orderError) throw orderError;

        // Update coupon usage
        if (selectedCoupon) {
          await supabase
            .from("coupons")
            .update({ usage_count: selectedCoupon.usage_count + 1 })
            .eq("id", selectedCoupon.id);
        }

        // Update user points
        await supabase
          .from("users")
          .update({ points: userPoints + earnedPoints })
          .eq("id", currentUser.id);

        userPoints += earnedPoints;
        document.getElementById("userPoints").textContent = userPoints;
        cart = [];
        selectedCoupon = null;
        updateCartBadge();
        closeCart();
        await loadCoupons();

        showMessage(`‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏° +${earnedPoints} ‡πÅ‡∏ï‡πâ‡∏° üéâ`);

      } catch (error) {
        console.error("‚ùå Checkout error:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
      }
    }

    // ===============================================================
    // 9. ORDER HISTORY
    // ===============================================================
    async function loadOrderHistory() {
  console.log("üì¶ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á userProfile:", userProfile);

  const orderList = document.getElementById("order-list");
  orderList.innerHTML = '<p class="text-gray-500 text-center py-8">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

  try {
    const { data: orders, error } = await supabase
      .from("orders")
      .select("*")
      .eq("line_id", userProfile.userId) // ‚úÖ ‡πÉ‡∏ä‡πâ line_id ‡∏Ç‡∏≠‡∏á LINE user
      .order("created_at", { ascending: false });

    console.log("üì¶ ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á userId:", userProfile.userId);
    console.log("üì¶ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å Supabase:", orders);

    if (error) throw error;

    if (!orders || orders.length === 0) {
      orderList.innerHTML = `
        <div class="text-center py-12">
          <div class="text-6xl mb-2">üì≠</div>
          <p class="text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
        </div>`;
      return;
    }

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
    let html = "";
    orders.forEach(order => {
      console.log("üßæ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå:", order.id, "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:", order.items);

      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á JSON ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      let itemsArray = [];
      try {
        itemsArray = typeof order.items === "string" ? JSON.parse(order.items) : order.items;
      } catch {
        itemsArray = [];
      }

      const items = Array.isArray(itemsArray)
      ? itemsArray.map(i => `
      <li>üç´ <span class="font-medium text-purple-700">${i.baseName}</span> 
      <span class="text-gray-600">+ ${i.toppingName}</span> (${i.quantity || 1})</li>
      `).join("")
      : "<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</li>";


      // ‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
      const canCancel = order.status === "pending";

      const statusBadge = getStatusBadge(order.status);

      html += `
        <div class="p-4 bg-white rounded-2xl shadow-md border border-gray-200 hover:shadow-lg transition">
          <div class="flex justify-between items-start">
            <div>
              <p class="font-semibold text-purple-900">Order #${order.id}</p>
              <p class="text-sm text-gray-500">${new Date(order.created_at).toLocaleString("th-TH")}</p>
            </div>
            <span class="text-sm font-medium ${statusBadge.class} px-3 py-1 rounded-full">${statusBadge.label}</span>
          </div>

          <ul class="mt-3 text-sm text-gray-700 list-disc list-inside">${items}</ul>

          <div class="flex justify-between items-center mt-4">
            <p class="font-medium text-purple-700">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total_price} ‡∏ö‡∏≤‡∏ó</p>
            ${
              canCancel
                ? `<button onclick="cancelOrder(${order.id})"
                    class="text-red-600 hover:text-red-800 font-medium text-sm px-3 py-1 border border-red-300 rounded-xl hover:bg-red-50 transition">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                  </button>`
                : ""
            }
          </div>
        </div>`;
    });

    orderList.innerHTML = html;
  } catch (error) {
    console.error("‚ùå Error loading orders:", error);
    orderList.innerHTML = `<p class="text-center text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
  }
}

// ===============================================================
// ‡πÅ‡∏™‡∏î‡∏á Badge ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
// ===============================================================
function getStatusBadge(status) {
  switch (status) {
    case "pending":
      return { label: "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", class: "bg-yellow-100 text-yellow-700" };
    case "preparing":
      return { label: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°", class: "bg-blue-100 text-blue-700" };
    case "ready":
      return { label: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á", class: "bg-green-100 text-green-700" };
    case "completed":
      return { label: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", class: "bg-purple-100 text-purple-700" };
    case "cancelled":
      return { label: "‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", class: "bg-red-100 text-red-700" };
    default:
      return { label: status, class: "bg-gray-100 text-gray-700" };
  }
}

// ===============================================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
// ===============================================================
async function cancelOrder(orderId) {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  try {
    const { error } = await supabase
      .from("orders")
      .update({ status: "cancelled" })
      .eq("id", orderId);

    if (error) throw error;

    showMessage("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß üõë");
    loadOrderHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  } catch (error) {
    console.error("‚ùå Error cancelling order:", error);
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
  }
}

// ===============================================================
// ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‚Äù
// ===============================================================
function openOrderHistory() {
  if (!userProfile || !userProfile.userId) {
    showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ü™™");
    return;
  }

  // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
  document.getElementById("main-app").classList.add("hidden");
  document.getElementById("order-history").classList.remove("hidden");

  loadOrderHistory();
}

// ===============================================================
// ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
// ===============================================================
function backToMain() {
  document.getElementById("order-history").classList.add("hidden");
  document.getElementById("main-app").classList.remove("hidden");
}
    // ===============================================================
    // 10. ADMIN DASHBOARD
    // ===============================================================
    function showAdmin() {
      document.getElementById("admin-modal").classList.remove("hidden");
      showAdminTab('orders');
    }

    function closeAdmin() {
      document.getElementById("admin-modal").classList.add("hidden");
    }

    function showAdminTab(tab) { 
      document.querySelectorAll(".admin-tab").forEach(el => {
        el.classList.remove("border-blue-600", "text-blue-600");
        el.classList.add("border-transparent", "text-gray-600");
      });

      document.querySelectorAll(".admin-tab-content").forEach(el => {
        el.classList.add("hidden");
      });

      const activeTab = document.querySelector(`[data-tab="${tab}"]`);
      if (activeTab) {
        activeTab.classList.remove("border-transparent", "text-gray-600");
        activeTab.classList.add("border-blue-600", "text-blue-600");
      }

      document.getElementById(`admin-${tab}-tab`).classList.remove("hidden");

      if (tab === 'orders') loadAdminOrders();
      if (tab === 'coupons') loadAdminCoupons();
      if (tab === 'stats') loadAdminStats();
      if (tab === 'brownie') loadBrownieMenus();
      if (tab === 'summary') loadDailySummary();
    }

    // ===============================================================
// üè∑Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
// ===============================================================
function getStatusText(status) {
  switch (status) {
    case "pending": return "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£";
    case "preparing": return "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°";
    case "ready": return "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö";
    case "completed": return "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    case "cancelled": return "‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
    default: return "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
  }
}

// ===============================================================
// üé® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ Badge ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
// ===============================================================
function getStatusBadgeClass(status) {
  switch (status) {
    case "pending": return "bg-yellow-100 text-yellow-700";
    case "preparing": return "bg-blue-100 text-blue-700";
    case "ready": return "bg-green-100 text-green-700";
    case "completed": return "bg-purple-100 text-purple-700";
    case "cancelled": return "bg-red-100 text-red-700";
    default: return "bg-gray-100 text-gray-700";
  }
}
    async function loadAdminOrders() {
      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select(`
            *,
            users (display_name, picture_url)
          `)
          .order("created_at", { ascending: false })
          .limit(50);

        if (error) throw error;

        const content = document.getElementById("admin-orders-content");
        
        if (orders.length === 0) {
          content.innerHTML = '<p class="text-center text-gray-500 py-12">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>';
          return;
        }

        let html = '<div class="space-y-4">';
        orders.forEach(order => {
          const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
          const statusClass = getStatusBadgeClass(order.status);
          
          html += `
            <div class="card border border-gray-200 p-4">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center space-x-3">
                  <img src="${order.users?.picture_url || ''}" class="w-10 h-10 rounded-full" />
                  <div>
                    <div class="font-semibold">${order.users?.display_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                    <div class="text-sm text-gray-500">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id}</div>
                  </div>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">   ${getStatusText(order.status)} </span>
              </div>
              
              <div class="space-y-1 mb-3">
                ${order.items.map(item => `
                  <div class="text-sm text-gray-600">‚Ä¢ ${item.baseName} + ${item.toppingName} √ó ${item.quantity}</div>
                `).join('')}
              </div>
              
              <div class="flex items-center justify-between pt-3 border-t">
                <div>
                  <div class="text-sm text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <span class="font-bold text-gray-900">${order.total_price} ‡∏ö‡∏≤‡∏ó</span></div>
                  <div class="text-xs text-gray-400">${new Date(order.created_at).toLocaleString('th-TH')}</div>
                </div>
                <div class="flex gap-2">
                  <select onchange="updateOrderStatus(${order.id}, this.value)" class="text-sm border border-gray-300 rounded px-2 py-1">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</option>
                    <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</option>
                    <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                  </select>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;

      } catch (error) {
        console.error("‚ùå Error loading admin orders:", error);
      }
    }

    async function updateOrderStatus(orderId, newStatus) {
      try {
        // Get order details first
        const { data: order, error: fetchError } = await supabase
          .from("orders")
          .select("*, users(line_id, display_name)")
          .eq("id", orderId)
          .single();

        if (fetchError) throw fetchError;

        // Update status
        const { error: updateError } = await supabase
          .from("orders")
          .update({ status: newStatus })
          .eq("id", orderId);

        if (updateError) throw updateError;

        // Send LINE notification
        await sendOrderStatusNotification(order, newStatus);

        showMessage("‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        loadAdminOrders();

      } catch (error) {
        console.error("‚ùå Error updating status:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }

    async function sendOrderStatusNotification(order, newStatus) {
      try {
        // Call Supabase Edge Function to send LINE notification
        const { data, error } = await supabase.functions.invoke('send-line-notification', {
          body: {
            lineId: order.users.line_id,
            orderId: order.id,
            status: newStatus,
            orderData: {
              items: order.items,
              total_price: order.total_price,
              subtotal: order.subtotal,
              discount: order.discount
            }
          }
        });

        if (error) {
          console.error("‚ùå Error calling edge function:", error);
          // Don't throw, just log
        } else {
          console.log("‚úÖ Notification sent successfully");
        }

      } catch (error) {
        console.error("‚ùå Error sending notification:", error);
        // Don't throw error, just log it
      }
    }

    async function loadAdminCoupons() {
  try {
    const { data: coupons, error } = await supabase
      .from("coupons")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) throw error;

    const content = document.getElementById("admin-coupons-content");
    
    if (coupons.length === 0) {
      content.innerHTML = '<p class="text-center text-gray-500 py-12">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>';
      return;
    }

    let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
    coupons.forEach(coupon => {
      html += `
        <div class="card border-2 border-purple-200 p-4">
          <div class="flex items-start justify-between mb-3">
            <div>
              <div class="font-bold text-lg text-purple-900">${coupon.name}</div>
              <div class="text-sm text-gray-600">${coupon.description}</div>
            </div>
            <div class="space-y-1 text-right">
              <label class="flex items-center justify-end">
                <input type="checkbox" ${coupon.is_active ? 'checked' : ''} 
                       onchange="toggleCoupon(${coupon.id}, this.checked)" class="mr-2" />
                <span class="text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ</span>
              </label>
              <label class="flex items-center justify-end">
                <input type="checkbox" ${coupon.show_in_list ? 'checked' : ''} 
                       onchange="toggleCouponVisibility(${coupon.id}, this.checked)" class="mr-2" />
                <span class="text-sm">‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
              </label>
            </div>
          </div>
          
          <div class="space-y-1 text-sm text-gray-600">
            <div>‡∏£‡∏´‡∏±‡∏™: <span class="font-mono font-bold">${coupon.code}</span></div>
            <div>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${coupon.type === 'percent' ? coupon.value + '%' : coupon.value + ' ‡∏ö‡∏≤‡∏ó'}</div>
            <div>‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ${coupon.min_purchase} ‡∏ö‡∏≤‡∏ó</div>
            <div>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ: ${coupon.usage_count} / ${coupon.usage_limit} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
          </div>
          
          <button onclick="deleteCoupon(${coupon.id})" class="mt-3 text-red-500 hover:text-red-700 text-sm font-medium">
            üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
          </button>
        </div>
      `;
    });
    html += '</div>';
    content.innerHTML = html;

  } catch (error) {
    console.error("‚ùå Error loading coupons:", error);
  }
}

function showCreateCouponForm() {
  document.getElementById("create-coupon-modal").classList.remove("hidden");
}

function closeCreateCoupon() {
  document.getElementById("create-coupon-modal").classList.add("hidden");
}

async function createCoupon(event) {
  event.preventDefault();

  try {
    const code = document.getElementById("coupon-code").value.toUpperCase();
    const name = document.getElementById("coupon-title").value;
    const description = document.getElementById("coupon-description").value;
    const type = document.getElementById("coupon-type").value;
    const value = parseInt(document.getElementById("coupon-value").value);
    const minPurchase = parseInt(document.getElementById("coupon-min").value);
    const usageLimit = parseInt(document.getElementById("coupon-usage").value);

    const { error } = await supabase
      .from("coupons")
      .insert([{
        code,
        name,
        description,
        type,
        value,
        min_purchase: minPurchase,
        usage_limit: usageLimit,
        usage_count: 0,
        is_active: true,
        show_in_list: true // ‚úÖ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á
      }]);

    if (error) throw error;

    showMessage("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ");
    closeCreateCoupon();
    loadAdminCoupons();
    loadCoupons();
    event.target.reset();

  } catch (error) {
    console.error("‚ùå Error creating coupon:", error);
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
  }
}

async function toggleCoupon(couponId, isActive) {
  try {
    const { error } = await supabase
      .from("coupons")
      .update({ is_active: isActive })
      .eq("id", couponId);

    if (error) throw error;

    showMessage(isActive ? "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß" : "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
    loadCoupons();

  } catch (error) {
    console.error("‚ùå Error toggling coupon:", error);
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ user
async function toggleCouponVisibility(couponId, showInList) {
  try {
    const { error } = await supabase
      .from("coupons")
      .update({ show_in_list: showInList })
      .eq("id", couponId);

    if (error) throw error;

    showMessage(showInList
      ? "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô' ‚úÖ"
      : "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üîí"
    );

    loadAdminCoupons();
    loadCoupons();
  } catch (error) {
    console.error("‚ùå Error toggling coupon visibility:", error);
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á");
  }
}

async function deleteCoupon(couponId) {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  try {
    const { error } = await supabase
      .from("coupons")
      .delete()
      .eq("id", couponId);

    if (error) throw error;

    showMessage("‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    loadAdminCoupons();
    loadCoupons();

  } catch (error) {
    console.error("‚ùå Error deleting coupon:", error);
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  }
}

        async function loadAdminStats() {
      try {
        // Get total orders
        const { data: orders, error: ordersError } = await supabase
          .from("orders")
          .select("total_price, status");

        if (ordersError) throw ordersError;

        // Get total users
        const { count: usersCount, error: usersError } = await supabase
          .from("users")
          .select("*", { count: 'exact', head: true });

        if (usersError) throw usersError;

        // Calculate stats
        const totalOrders = orders.length;
        const totalRevenue = orders.reduce((sum, order) => sum + order.total_price, 0);
        const pendingOrders = orders.filter(o => o.status === 'pending').length;
        const completedOrders = orders.filter(o => o.status === 'completed').length;

        const content = document.getElementById("admin-stats-content");
        content.innerHTML = `
          <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6">
            <div class="text-3xl mb-2">üìä</div>
            <div class="text-sm opacity-90 mb-1">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
            <div class="text-3xl font-bold">${totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
          </div>

          <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white p-6">
            <div class="text-3xl mb-2">üì¶</div>
            <div class="text-sm opacity-90 mb-1">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-3xl font-bold">${totalOrders}</div>
            <div class="text-xs opacity-75 mt-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${completedOrders} | ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ${pendingOrders}</div>
          </div>

          <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6">
            <div class="text-3xl mb-2">üë•</div>
            <div class="text-sm opacity-90 mb-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-3xl font-bold">${usersCount}</div>
          </div>

          <div class="card bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6">
            <div class="text-3xl mb-2">üí∞</div>
            <div class="text-sm opacity-90 mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
            <div class="text-3xl font-bold">${totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0} ‡∏ö‡∏≤‡∏ó</div>
          </div>

          <div class="card col-span-full p-6">
            <h4 class="font-semibold text-lg mb-4">üìà ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h4>
            <div class="grid grid-cols-5 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold text-yellow-600">${orders.filter(o => o.status === 'pending').length}</div>
                <div class="text-sm text-gray-600">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">${orders.filter(o => o.status === 'preparing').length}</div>
                <div class="text-sm text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600">${orders.filter(o => o.status === 'ready').length}</div>
                <div class="text-sm text-gray-600">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-indigo-600">${orders.filter(o => o.status === 'completed').length}</div>
                <div class="text-sm text-gray-600">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-red-600">${orders.filter(o => o.status === 'cancelled').length}</div>
                <div class="text-sm text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
              </div>
            </div>
          </div>
        `;

      } catch (error) {
        console.error("‚ùå Error loading stats:", error);
      }
    } // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadAdminStats() ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢


// ===============================================================
// üìÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (ADMIN)
// ===============================================================
async function loadDailySummary() {
  const selectedDate = document.getElementById("summary-date").value;
  const content = document.getElementById("summary-content");

  if (!selectedDate) {
    content.innerHTML = `<p class="text-gray-500 text-center">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô</p>`;
    return;
  }

  try {
    const start = new Date(selectedDate);
    const end = new Date(selectedDate);
    end.setDate(end.getDate() + 1);

    const { data: orders, error } = await supabase
      .from("orders")
      .select("*")
      .gte("created_at", start.toISOString())
      .lt("created_at", end.toISOString());

    if (error) throw error;

    if (orders.length === 0) {
      content.innerHTML = `<p class="text-gray-500 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate}</p>`;
      return;
    }

    const totalRevenue = orders.reduce((sum, o) => sum + o.total_price, 0);
    const totalOrders = orders.length;

    // ‚úÖ ‡∏£‡∏ß‡∏° "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ + ‡∏´‡∏ô‡πâ‡∏≤" ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà
    const comboCounts = {};
    orders.forEach(o => {
      o.items.forEach(i => {
        const combo = `${i.baseName} + ${i.toppingName}`;
        comboCounts[combo] = (comboCounts[combo] || 0) + i.quantity;
      });
    });

    let html = `
      <h3 class="text-lg font-semibold mb-3">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate}</h3>
      <div class="mb-4">
        <p>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${totalOrders}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
        <p>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <b>${totalRevenue}</b> ‡∏ö‡∏≤‡∏ó</p>
      </div>

      <div class="border-t pt-4">
        <h4 class="font-semibold text-purple-700 mb-2">üç∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ + ‡∏´‡∏ô‡πâ‡∏≤)</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          ${Object.entries(comboCounts)
            .map(([combo, qty]) => `<p>‚Ä¢ ${combo} ‚Äî <b>${qty}</b> ‡∏ä‡∏¥‡πâ‡∏ô</p>`)
            .join('')}
        </div>
      </div>
    `;

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô
    html += `
      <div class="mt-6 flex flex-col items-center gap-3">
        <select id="update-status-select" class="border rounded px-3 py-2 text-sm">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
          <option value="pending">üïì ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option value="preparing">üç≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</option>
          <option value="ready">üì¶ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</option>
          <option value="completed">‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
          <option value="cancelled">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
        </select>
        <button onclick="updateAllOrdersOfDay()" 
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm shadow">
          üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô
        </button>
      </div>
    `;

    content.innerHTML = html;
  } catch (err) {
    console.error(err);
    content.innerHTML = `<p class="text-red-500 text-center">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
  }
}


// ===============================================================
// üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô + ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE
// ===============================================================
async function updateAllOrdersOfDay() {
  const selectedDate = document.getElementById("summary-date").value;
  const newStatus = document.getElementById("update-status-select").value;

  if (!selectedDate) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
  if (!newStatus) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");

  try {
    const start = new Date(selectedDate);
    const end = new Date(selectedDate);
    end.setDate(end.getDate() + 1);

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
    const { data: orders, error: fetchError } = await supabase
      .from("orders")
      .select("*, users(line_id, display_name)")
      .gte("created_at", start.toISOString())
      .lt("created_at", end.toISOString());

    if (fetchError) throw fetchError;
    if (!orders || orders.length === 0) {
      showMessage("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô");
      return;
    }

    // ‚úÖ ‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + ‡∏™‡πà‡∏á LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    for (const order of orders) {
      const { error: updateError } = await supabase
        .from("orders")
        .update({ status: newStatus })
        .eq("id", order.id);

      if (updateError) console.error(`‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${order.id} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, updateError);

      // üîî ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô Edge Function
      try {
        await supabase.functions.invoke("send-line-notification", {
          body: {
            lineId: order.users.line_id,
            orderId: order.id,
            status: newStatus,
            orderData: {
              items: order.items,
              total_price: order.total_price,
              subtotal: order.subtotal,
              discount: order.discount,
            },
          },
        });
      } catch (notifyError) {
        console.error(`‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${order.id} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, notifyError);
      }
    }

    // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°
    showMessage(
      `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${orders.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} ‡πÄ‡∏õ‡πá‡∏ô "${getStatusText(newStatus)}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`
    );
    loadDailySummary();
  } catch (err) {
    console.error("‚ùå Error in updateAllOrdersOfDay:", err);
    showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
  }
}

    // ===============================================================
// üç´ ‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà (‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏•‡∏ö / ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥)
// ===============================================================
async function loadBrownieMenus() {
  const content = document.getElementById("admin-brownie-content");
  const { data, error } = await supabase.from("brownie_items").select("*").order("type, id");

  if (error) {
    console.error(error);
    content.innerHTML = `<p class="text-red-600 text-center">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>`;
    return;
  }

  let html = `
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">üç∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>
      <div class="space-x-2">
        <button onclick="addBrownieItem('base')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-lg text-sm">
          ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà
        </button>
        <button onclick="addBrownieItem('topping')" class="bg-pink-500 hover:bg-pink-600 text-white px-3 py-1 rounded-lg text-sm">
          üç´ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà
        </button>
      </div>
    </div>
    <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-2 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th class="p-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</th>
          <th class="p-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</th>
          <th class="p-2 text-right">‡πÅ‡∏ï‡πâ‡∏°</th>
          <th class="p-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="p-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody>
        ${data.map(i => `
          <tr class="border-t hover:bg-gray-50 transition">
            <td class="p-2">${i.type === 'base' ? 'üçû ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' : 'üç´ ‡∏´‡∏ô‡πâ‡∏≤'}</td>
            <td class="p-2 font-medium">${i.name}</td>
            <td class="p-2 text-right">${i.price}</td>
            <td class="p-2 text-right">${i.points}</td>
            <td class="p-2 text-center">${i.is_active ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢' : '‚ùå ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢'}</td>
            <td class="p-2 text-center space-x-2">
              <button onclick="editBrownieItem(${i.id})" class="text-blue-600 hover:underline">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button onclick="deleteBrownieItem(${i.id})" class="text-red-600 hover:underline">üóëÔ∏è ‡∏•‡∏ö</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  content.innerHTML = html;
}

// ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥)
async function addBrownieItem(type) {
  const name = prompt(`‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠${type === 'base' ? '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' : '‡∏´‡∏ô‡πâ‡∏≤'}‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà (‡πÉ‡∏™‡πà‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô üç´ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÇ‡∏Å‡πÇ‡∏Å‡πâ):`);
  if (!name) return;
  const price = parseInt(prompt("‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó):"), 10) || 0;
  const points = parseInt(prompt("‡πÉ‡∏™‡πà‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°:"), 10) || 0;

  const { error } = await supabase.from("brownie_items").insert([{ name, type, price, points, is_active: true }]);
  if (error) {
    alert("‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(error);
  } else {
    alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    loadBrownieMenus();
  }
}

// ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π
async function editBrownieItem(id) {
  const { data } = await supabase.from("brownie_items").select("*").eq("id", id).single();
  const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÑ‡∏î‡πâ):", data.name);
  const price = parseInt(prompt("‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏ö‡∏≤‡∏ó):", data.price), 10);
  const points = parseInt(prompt("‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà:", data.points), 10);
  const is_active = confirm("‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°? (OK = ‡πÄ‡∏õ‡∏¥‡∏î / Cancel = ‡∏õ‡∏¥‡∏î)");

  const { error } = await supabase
    .from("brownie_items")
    .update({ name, price, points, is_active })
    .eq("id", id);

  if (error) {
    alert("‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(error);
  } else {
    alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    loadBrownieMenus();
  }
}

// üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π
async function deleteBrownieItem(id) {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const { error } = await supabase.from("brownie_items").delete().eq("id", id);
  if (error) {
    alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(error);
  } else {
    alert("‚úÖ ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    loadBrownieMenus();
  }
}


    // ===============================================================
    // 11. UTILITY FUNCTIONS
    // ===============================================================
    function showMessage(message) {
      const successMessage = document.getElementById("success-message");
      const successText = document.getElementById("success-text");
      successText.textContent = message;
      successMessage.classList.remove("hidden");

      setTimeout(() => {
        successMessage.classList.add("hidden");
      }, 3000);
    }

    function closeModalOnBackdrop(event, modalId) {
      if (event.target.id === modalId) {
        document.getElementById(modalId).classList.add("hidden");
      }
    }

    // ===============================================================
// üîπ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
// ===============================================================
function openOrderHistory() {
  if (!userProfile || !userProfile.userId) {
    showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ü™™");
    return;
  }

  // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
  document.getElementById("main-app").classList.add("hidden");
  // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
  document.getElementById("order-history").classList.remove("hidden");

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  loadOrderHistory();
}

function backToMain() {
  document.getElementById("order-history").classList.add("hidden");
  document.getElementById("main-app").classList.remove("hidden");
}

// ‚úÖ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ <script type="module">
window.openOrderHistory = openOrderHistory;
window.backToMain = backToMain;


// ===============================================================
// 12. ADMIN: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ + ‡∏´‡∏ô‡πâ‡∏≤)
// ===============================================================
async function loadBrownieMenus() {
  try {
    const { data: items, error } = await supabase
      .from("brownie_items")
      .select("*")
      .order("id", { ascending: true });

    if (error) throw error;

    const bases = items.filter(i => i.type === "base");
    const toppings = items.filter(i => i.type === "topping");

    const content = document.getElementById("admin-brownie-content");
    content.innerHTML = `
      <h3 class="text-lg font-semibold mb-3">üç∞ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>
      <button onclick="openBrownieModal('base')" class="mb-3 px-3 py-1 bg-green-500 text-white rounded">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</button>
      ${renderBrownieList(bases)}

      <h3 class="text-lg font-semibold mt-6 mb-3">üç´ ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>
      <button onclick="openBrownieModal('topping')" class="mb-3 px-3 py-1 bg-green-500 text-white rounded">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</button>
      ${renderBrownieList(toppings)}
    `;
  } catch (err) {
    console.error("‚ùå Error loading brownie menus:", err);
  }
}

function renderBrownieList(items) {
  if (!items || items.length === 0)
    return `<p class="text-gray-500 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;

  return items.map(i => `
    <div class="flex justify-between items-start border p-3 rounded-lg mb-2 bg-white shadow-sm hover:shadow-md transition">
      <div>
        <div class="font-semibold text-lg">${i.name}</div>
        <div class="text-sm text-gray-600">${i.description || ''}</div>
        <div class="text-sm mt-1">
          üí∞ ${i.price} ‡∏ö‡∏≤‡∏ó | üéØ ${i.points} ‡πÅ‡∏ï‡πâ‡∏° | 
          ${i.is_active ? "‚úÖ <span class='text-green-600'>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</span>" : "‚ùå <span class='text-red-500'>‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</span>"}
        </div>
      </div>
      <div class="flex gap-2 mt-1">
        <button class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600" onclick="openBrownieModal('${i.type}', ${i.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" onclick="deleteBrownieItem(${i.id})">üóëÔ∏è ‡∏•‡∏ö</button>
      </div>
    </div>
  `).join("");
}

// ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
function openBrownieModal(type, id = null) {
  const modal = document.getElementById("brownie-modal");
  const title = document.getElementById("brownie-modal-title");
  const form = document.getElementById("brownie-form");

  modal.classList.remove("hidden");

  document.getElementById("brownie-id").value = id || "";
  document.getElementById("brownie-type").value = type;
  document.getElementById("brownie-name").value = "";
  document.getElementById("brownie-desc").value = "";
  document.getElementById("brownie-price").value = "";
  document.getElementById("brownie-points").value = "";
  document.getElementById("brownie-active").checked = true;

  title.textContent = id ? "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà" : "üç∞ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà";

  if (id) loadBrownieForEdit(id);
}

function closeBrownieModal() {
  document.getElementById("brownie-modal").classList.add("hidden");
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
async function loadBrownieForEdit(id) {
  const { data, error } = await supabase.from("brownie_items").select("*").eq("id", id).single();
  if (error) return console.error(error);

  document.getElementById("brownie-id").value = data.id;
  document.getElementById("brownie-type").value = data.type;
  document.getElementById("brownie-name").value = data.name;
  document.getElementById("brownie-desc").value = data.description || "";
  document.getElementById("brownie-price").value = data.price;
  document.getElementById("brownie-points").value = data.points;
  document.getElementById("brownie-active").checked = data.is_active;
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
document.getElementById("brownie-form").onsubmit = async (e) => {
  e.preventDefault();

  const id = document.getElementById("brownie-id").value;
  const type = document.getElementById("brownie-type").value;
  const name = document.getElementById("brownie-name").value;
  const description = document.getElementById("brownie-desc").value;
  const price = parseFloat(document.getElementById("brownie-price").value);
  const points = parseInt(document.getElementById("brownie-points").value);
  const isActive = document.getElementById("brownie-active").checked;

  const data = { type, name, description, price, points, is_active: isActive };

  try {
    if (id) {
      await supabase.from("brownie_items").update(data).eq("id", id);
      showMessage("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    } else {
      await supabase.from("brownie_items").insert([data]);
      showMessage("üéâ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    closeBrownieModal();
    loadBrownieMenus();
  } catch (err) {
    console.error(err);
    showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
  }
};

// ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π
async function deleteBrownieItem(id) {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  const { error } = await supabase.from("brownie_items").delete().eq("id", id);
  if (error) {
    console.error(error);
    return showMessage("‚ùå ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
  }

  showMessage("üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  loadBrownieMenus();
}

// ===============================================================
// üç∞ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà
// ===============================================================
async function loadBrownieChoices() {
  try {
    const { data: items, error } = await supabase
      .from("brownie_items")
      .select("*")
      .eq("is_active", true)
      .order("id", { ascending: true });

    if (error) throw error;

    const bases = items.filter(i => i.type === "base");
    const toppings = items.filter(i => i.type === "topping");

    renderBrownieCards(bases, "base-list", "base");
    renderBrownieCards(toppings, "topping-list", "topping");
  } catch (err) {
    console.error("‚ùå Error loading brownie items:", err);
  }
}

// ===============================================================
// üé® ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà
// ===============================================================
function renderBrownieCards(items, containerId, type) {
  const container = document.getElementById(containerId);
  container.innerHTML = items
    .map(
      (i) => `
      <div onclick="selectBrownieItem('${i.id}', '${type}', '${i.name}', ${i.price})"
        class="cursor-pointer text-center border rounded-2xl p-4 hover:shadow-lg transition bg-white" id="${type}-${i.id}">
        <div class="text-5xl mb-2">${extractEmoji(i.name)}</div>
        <div class="font-semibold text-lg">${removeEmoji(i.name)}</div>
        <div class="text-gray-500 text-sm mb-2">${i.description || ''}</div>
        <div class="text-blue-600 font-bold">${i.price} ‡∏ö‡∏≤‡∏ó</div>
      </div>
    `
    )
    .join("");
}

// ===============================================================
// üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤
// ===============================================================
function selectBrownieItem(id, type, name, price) {
  const allCards = document.querySelectorAll(`#${type}-list > div`);
  allCards.forEach(card => card.classList.remove("ring-4", "ring-purple-400", "bg-purple-50"));

  const selectedCard = document.getElementById(`${type}-${id}`);
  selectedCard.classList.add("ring-4", "ring-purple-400", "bg-purple-50");

  if (type === "base") {
    selectedBase = { id, name, price };
  } else {
    selectedTopping = { id, name, price };
  }

  updateTotalPrice();
}

// ===============================================================
// üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°
// ===============================================================
function updateTotalPrice() {
  const total =
    (selectedBase?.price || 0) +
    (selectedTopping?.price || 0);

  const totalWithQty = total * quantity;
  document.getElementById("total-price").innerText = totalWithQty.toLocaleString();
}

// ===============================================================
// üî¢ ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
// ===============================================================
document.getElementById("increaseQty").addEventListener("click", () => {
  quantity++;
  document.getElementById("quantity").innerText = quantity;
  updateTotalPrice();
});

document.getElementById("decreaseQty").addEventListener("click", () => {
  if (quantity > 1) {
    quantity--;
    document.getElementById("quantity").innerText = quantity;
    updateTotalPrice();
  }
});

// ===============================================================
// üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
// ===============================================================
document.getElementById("add-to-cart").addEventListener("click", () => {
  if (!selectedBase || !selectedTopping) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞");
    return;
  }

  const totalPrice =
    (selectedBase.price + selectedTopping.price) * quantity;
  cart.push({
  baseName: selectedBase.name,
  toppingName: selectedTopping.name,
  quantity: quantity,
  unitPrice: (selectedBase.price + selectedTopping.price),
  totalPrice: (selectedBase.price + selectedTopping.price) * quantity
});
updateCartBadge();
showMessage("üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
});

// ===============================================================
// üß© Helper Functions
// ===============================================================
function extractEmoji(text) {
  const match = text.match(/^[\p{Emoji_Presentation}\p{Emoji}\uFE0F\u200D]+/u);
  return match ? match[0] : "üç´";
}

function removeEmoji(text) {
  return text.replace(/^[\p{Emoji_Presentation}\p{Emoji}\uFE0F\u200D]+/u, "").trim();
}

// ===============================================================
// üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î
// ===============================================================
loadBrownieChoices();

    // ===============================================================
    // 13. START APPLICATION
    // ===============================================================
    window.addEventListener("load", init);

</script>
</body>
</html>
