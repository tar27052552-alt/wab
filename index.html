<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SUAN KHANOM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
      min-height: 100vh;
    }
    * { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      font-weight: 500;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.8);
      color: #374151;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
    }
    .selected {
      border: 4px solid #1d4ed8 !important;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(29, 78, 216, 0.5);
    }
    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .float { animation: float 3s ease-in-out infinite; }
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-preparing { background: #dbeafe; color: #1e40af; }
    .badge-ready { background: #d1fae5; color: #065f46; }
    .badge-completed { background: #e0e7ff; color: #3730a3; }
    .badge-cancelled { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="min-h-full">
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="text-center">
      <div class="spinner mb-4 mx-auto"></div>
      <p class="text-white text-xl font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>
  </div>

  <!-- Header -->
  <header id="main-header" class="glass shadow-sm border-b border-white/20 sticky top-0 z-40 hidden">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-2xl float">ü™ô</div>
          <div>
            <div class="text-sm text-gray-500">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
            <div class="font-semibold text-gray-900">
              <span id="userPoints" class="text-orange-600 font-semibold">0</span> ‡πÅ‡∏ï‡πâ‡∏°
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-3">
          <div class="flex items-center space-x-2">
            <img id="userPic" src="" alt="Profile" class="w-8 h-8 rounded-full border border-gray-300" />
            <span id="userName" class="text-sm text-gray-600 hidden sm:block">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
          </div>
          <button onclick="showCart()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-xl text-sm hover-lift relative">
            <span class="hidden sm:inline">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
            <span class="sm:hidden">üõí</span>
            <span id="cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
          </button>
          <button onclick="showCoupons()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">üé´ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</span>
            <span class="sm:hidden">üé´</span>
          </button>
          <button onclick="openOrderHistory()" 
            class="btn-secondary px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
            <span class="sm:hidden">üìã</span>
          </button>
          <button id="admin-btn" onclick="showAdmin()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-xl text-sm hover-lift hidden">
            <span class="hidden sm:inline">üë®‚Äçüíº Admin</span>
            <span class="sm:hidden">üë®‚Äçüíº</span>
          </button>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            <span class="sm:hidden">üö™</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main App -->
  <main id="main-app" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <div class="text-center mb-12">
      <div class="text-6xl mb-4 float">ü´ê</div>
      <h1 class="text-4xl font-bold mb-2" style="background: linear-gradient(135deg, #1f2937, #374151); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SUAN KHANOM</h1>
      <p class="text-gray-600 text-lg mb-4">‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <!-- üç∞ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà -->
<section class="bg-white p-6 rounded-xl shadow-md mb-6">
  <h3 class="text-xl font-semibold mb-4">ü´ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>
  <div id="base-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>

<!-- üç´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà -->
<section class="bg-white p-6 rounded-xl shadow-md mb-6">
  <h3 class="text-xl font-semibold mb-4">üç´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>
  <div id="topping-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>
<!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° -->
<section id="quantity-section" class="card mb-8 hover-lift">
  <h2 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
    <span class="mr-3">üì¶</span> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°
  </h2>
  
  <div class="flex items-center justify-center space-x-6">
    <button onclick="changeQuantity(-1)" 
            class="quantity-btn bg-red-500 hover:bg-red-600 text-white">
      ‚àí
    </button>

    <div class="text-center">
      <div class="text-5xl font-bold text-gray-900" id="quantity">1</div> <!-- üëà ‡∏ä‡∏∑‡πà‡∏≠ id ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô quantity -->
      <div class="text-sm text-gray-500 mt-2">‡∏ä‡∏¥‡πâ‡∏ô</div>
    </div>

    <button onclick="changeQuantity(1)" 
            class="quantity-btn bg-green-500 hover:bg-green-600 text-white">
      +
    </button>
  </div>
</section>

<!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
<section class="card text-center hover-lift">
  <div class="mb-6">
    <div class="text-3xl font-bold text-gray-900">
      üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <span id="total-price">0</span> ‡∏ö‡∏≤‡∏ó
    </div>
  </div>

  <button id="add-to-cart" 
          onclick="addToCart()" 
          class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed"
          disabled>
    üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
  </button>
</section>
  </main>

<section id="order-history" class="hidden px-4 py-6">
  <!-- ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏õ‡∏∏‡πà‡∏° -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-semibold text-purple-800 flex items-center gap-2">
      <span class="text-2xl">üì¶</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
    </h2>
    <button 
      onclick="backToMain()" 
      class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md transition">
      ‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    </button>
  </div>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ -->
  <div id="order-list" class="space-y-4"></div>
</section>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'cart-modal')">
    <div class="card max-w-2xl w-full max-h-[80vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <div id="cart-content" class="mb-6"></div>
      
      <!-- Coupon Section -->
      <div id="coupon-section" class="mb-6 p-4 bg-purple-50 rounded-xl">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-gray-900">üé´ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h4>
          <button onclick="showCoupons()" class="text-purple-600 text-sm hover:underline">‡∏î‡∏π‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div id="selected-coupon" class="hidden mb-3 p-3 bg-white rounded-lg border-2 border-purple-300">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium text-purple-900" id="coupon-name"></div>
              <div class="text-sm text-purple-700" id="coupon-desc"></div>
            </div>
            <button onclick="removeCoupon()" class="text-red-500 hover:text-red-700 text-sm font-medium">‡∏•‡∏ö</button>
          </div>
        </div>
        <div class="flex gap-2">
          <input type="text" id="coupon-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
          <button onclick="applyCouponCode()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">‡πÉ‡∏ä‡πâ</button>
        </div>
        <div id="coupon-message" class="text-sm mt-2 hidden"></div>
      </div>

      <div class="border-t pt-4">
        <div class="space-y-2 mb-4">
          <div class="flex justify-between text-gray-700">
            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
            <span id="cart-subtotal">0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div id="discount-row" class="flex justify-between text-green-600 hidden">
            <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
            <span id="discount-amount">-0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div class="flex justify-between items-center text-xl font-bold border-t pt-2">
            <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
            <span id="cart-total" class="text-blue-600">0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>
        <button onclick="checkout()" class="btn-primary w-full py-3 rounded-xl font-semibold text-lg">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Coupons Modal -->
  <div id="coupons-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'coupons-modal')">
    <div class="card max-w-4xl w-full max-h-[80vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">üé´ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        <button onclick="closeCoupons()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <div id="coupons-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'admin-modal')">
    <div class="card max-w-6xl w-full max-h-[90vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">üë®‚Äçüíº Admin Dashboard</h3>
        <button onclick="closeAdmin()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>

      <!-- Admin Tabs -->
     <div class="flex space-x-4 mb-6 border-b">
  <button onclick="showAdminTab('orders')" class="admin-tab px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600" data-tab="orders">
    üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
  </button>
  <button onclick="showAdminTab('coupons')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="coupons">
    üé´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
  </button>
  <button onclick="showAdminTab('stats')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="stats">
    üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
  </button>
  <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà -->
  <button onclick="showAdminTab('brownie')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="brownie">
    üç∞ ‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà
  </button>
  <button class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="summary" onclick="showAdminTab('summary')">
    üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
  </button>
</div>

<!-- ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà -->
<section id="admin-brownie-tab" class="admin-tab-content hidden">
  <div id="admin-brownie-content" class="p-4"></div>
</section>
<!-- Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà -->
<div id="brownie-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h3 id="brownie-modal-title" class="text-xl font-semibold mb-4">üç∞ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h3>

    <form id="brownie-form" class="space-y-3">
      <input type="hidden" id="brownie-id">
      <input type="hidden" id="brownie-type">

      <div>
        <label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π (‡πÉ‡∏™‡πà‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÑ‡∏î‡πâ)</label>
        <input id="brownie-name" class="w-full border rounded px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô üç´ ‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà‡πÇ‡∏Å‡πÇ‡∏Å‡πâ" required>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
        <textarea id="brownie-desc" class="w-full border rounded px-3 py-2" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏™‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô ‡∏´‡∏≠‡∏°‡πÇ‡∏Å‡πÇ‡∏Å‡πâ"></textarea>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
          <input id="brownie-price" type="number" step="0.01" class="w-full border rounded px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ</label>
          <input id="brownie-points" type="number" class="w-full border rounded px-3 py-2" required>
        </div>
      </div>

      <label class="flex items-center gap-2 mt-2">
        <input id="brownie-active" type="checkbox" class="w-4 h-4"> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ
      </label>

      <div class="flex justify-end gap-2 pt-3 border-t mt-4">
        <button type="button" onclick="closeBrownieModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </form>
  </div>
</div>

      <!-- Orders Tab -->
      <div id="admin-orders-tab" class="admin-tab-content">
        <div id="admin-orders-content"></div>
      </div>

      <!-- Coupons Tab -->
      <div id="admin-coupons-tab" class="admin-tab-content hidden">
        <div class="mb-6">
          <button onclick="showCreateCouponForm()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">
            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
        <div id="admin-coupons-content"></div>
      </div>
<!-- üìÖ ‡πÅ‡∏ó‡πá‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô -->
<div id="admin-summary-tab" class="admin-tab-content hidden space-y-4">
  <div class="flex flex-wrap gap-3 items-center">
    <input type="date" 
           id="summary-date" 
           class="border rounded-lg px-3 py-2 shadow-sm">
    <button onclick="loadDailySummary()" 
            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
      ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ
    </button>
    <button onclick="updateAllOrdersOfDay()" 
            class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
      ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô
    </button>
  </div>

  <div id="summary-content" 
       class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200 min-h-[150px]">
    <p class="text-gray-500 text-center">
      üìÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
    </p>
  </div>
</div>

      <!-- Stats Tab -->
      <div id="admin-stats-tab" class="admin-tab-content hidden">
        <div id="admin-stats-content" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </div>
    </div>
  </div>
  <!-- Create Coupon Modal -->
  <div id="create-coupon-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'create-coupon-modal')">
    <div class="card max-w-md w-full hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
        <button onclick="closeCreateCoupon()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      <form onsubmit="createCoupon(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input type="text" id="coupon-code" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô WELCOME10" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input type="text" id="coupon-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏î 10%" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
          <input type="text" id="coupon-description" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏î 10% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <select id="coupon-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</option>
            <option value="fixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <input type="number" id="coupon-value" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="coupon-min" value="0" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
          <input type="number" id="coupon-usage" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>
        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold">
          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
        </button>
      </form>
    </div>
  </div>

  <!-- Success Message -->
  <div id="success-message" class="fixed top-20 right-4 card shadow-lg hidden z-50">
    <div class="flex items-center space-x-3">
      <div class="text-2xl">üéâ</div>
      <div id="success-text" class="font-medium text-gray-900"></div>
    </div>
  </div>

 <script>
    // ===============================================================
    // 1. CONFIGURATION
    // ===============================================================
    const LIFF_ID = "2008357926-Ly07A5w2";
    const SUPABASE_URL = "https://dyorwbjagjlkqpbrdjwk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5b3J3YmphZ2psa3FwYnJkandrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjk2NjgsImV4cCI6MjA3Njk0NTY2OH0.bZJRcaM3u9NUBrux5AbPXOXVtcSnJHDdK15gCQ-9Zc4";
    // Admin User IDs (‡πÄ‡∏û‡∏¥‡πà‡∏° LINE User ID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Admin)
    const ADMIN_IDS = ["Ud21a04a5d66c9de0b4c6f1aaf8f050e2","U5301bd5962323787574d82f86f3d954e"]; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô User ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log("‚úÖ Supabase initialized");
    } catch (error) {
      console.error("‚ùå Supabase initialization failed:", error);
    }

    // ===============================================================
    // 2. STATE VARIABLES
    // ===============================================================
    let userProfile = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE (global ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô)
    let currentUser = null;
    let selectedBase = null;
    let selectedTopping = null;
    let quantity = 1;
    let cart = [];
    let userPoints = 0;
    let selectedCoupon = null;
    let availableCoupons = [];

    const baseNames = {
      cocoa: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÇ‡∏Å‡πÇ‡∏Å‡πâ",
      greentea: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß",
      thaitea: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢"
    };

    const toppingNames = {
      chocolate: "‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï‡∏ä‡∏¥‡∏û",
      almond: "‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå‡πÅ‡∏ú‡πà‡∏ô",
      oreo: "‡πÇ‡∏≠‡∏£‡∏¥‡πÇ‡∏≠‡πâ‡∏ö‡∏î"
    };

    // ===============================================================
    // 3. INITIALIZATION
    // ===============================================================
   async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    userProfile = await liff.getProfile();
    await saveUserToSupabase(userProfile);
    await loadUserData(userProfile.userId);
    await loadCoupons();

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Supabase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
    await loadMenus();

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô init ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ userProfile)
    if (ADMIN_IDS.includes(userProfile.userId)) {
      document.getElementById("admin-btn").classList.remove("hidden");
    }

    document.getElementById("loading-screen").classList.add("hidden");
    document.getElementById("main-header").classList.remove("hidden");
    document.getElementById("main-app").classList.remove("hidden");
  } catch (error) {
    console.error("‚ùå Init error:", error);
    // (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ) ‡∏´‡∏≤‡∏Å error ‡∏ï‡∏≠‡∏ô init ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° login ‡πÉ‡∏´‡∏°‡πà
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
    setTimeout(() => liff.login(), 2000);
  }
}

    // [‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà Error (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 614-636) ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß]

    // ===============================================================
    // 4. USER MANAGEMENT
    // ===============================================================
    async function saveUserToSupabase(profile) {
      try {
        const { data: existingUser, error: findError } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", profile.userId)
          .maybeSingle();

        if (findError && findError.code !== "PGRST116") throw findError;

        if (!existingUser) {
          const { error: insertError } = await supabase
            .from("users")
            .insert([{
              line_id: profile.userId,
              display_name: profile.displayName,
              picture_url: profile.pictureUrl,
              points: 0
            }]);

          if (insertError) throw insertError;
          console.log("‚úÖ New user created");
        } else {
          console.log("üü¢ User exists");
        }
      } catch (error) {
        console.error("‚ùå Error saving user:", error);
        throw error;
      }
    }

    async function loadUserData(userId) {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", userId)
          .single();

        if (error) throw error;

        currentUser = data;
        userPoints = data.points || 0;

        document.getElementById("userName").textContent = data.display_name;
        document.getElementById("userPic").src = data.picture_url;
        document.getElementById("userPoints").textContent = userPoints;

        console.log("‚úÖ User data loaded:", data);
      } catch (error) {
        console.error("‚ùå Error loading user data:", error);
        throw error;
      }
    }

    async function logout() {
      if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        liff.logout();
        window.location.reload();
      }
    }

    // ===============================================================
    // 5. ORDER MANAGEMENT WITH QUANTITY
    // ===============================================================
// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å Supabase
async function loadMenus() {
  try {
    const { data: items, error } = await supabase
      .from("brownie_items")
      .select("*")
      .eq("is_active", true)
      .order("id", { ascending: true });

    if (error) throw error;

    const bases = items.filter(i => i.type === "base");
    const toppings = items.filter(i => i.type === "topping");

    const baseList = document.getElementById("base-list");
    const toppingList = document.getElementById("topping-list");

    baseList.innerHTML = bases.map(b => `
      <div class="brownie-base card cursor-pointer text-center hover-lift" 
           onclick="selectBase(${b.id}, '${b.name}', ${b.price}, this)">
        <div class="text-5xl mb-1">${b.emoji || 'üç´'}</div>
        <div class="font-semibold text-lg">${b.name}</div>
        <p class="text-gray-600 text-sm">${b.description || ''}</p>
        <p class="text-blue-600 font-semibold mt-2">üí∞ ${b.price} ‡∏ö‡∏≤‡∏ó</p>
      </div>
    `).join('');

    toppingList.innerHTML = toppings.map(t => `
      <div class="topping-item card cursor-pointer text-center hover-lift" 
           onclick="selectTopping(${t.id}, '${t.name}', ${t.price}, this)">
        <div class="text-5xl mb-1">${t.emoji || 'üç™'}</div>
        <div class="font-semibold text-lg">${t.name}</div>
        <p class="text-gray-600 text-sm">${t.description || ''}</p>
        <p class="text-purple-600 font-semibold mt-2">üç´ ${t.price} ‡∏ö‡∏≤‡∏ó</p>
      </div>
    `).join('');

  } catch (err) {
    console.error("‚ùå Error loading menus:", err);
  }
}

// ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠
function selectBase(id, name, price, el) {
  document.querySelectorAll('.brownie-base').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedBase = { id, name, price };
  updateTotal();
}

// ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤
function selectTopping(id, name, price, el) {
  document.querySelectorAll('.topping-item').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedTopping = { id, name, price };
  updateTotal();
}

// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
function changeQuantity(v) {
  quantity = Math.max(1, quantity + v);
  document.getElementById("quantity").textContent = quantity;
  updateTotal();
}
// ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°
function updateTotal() {
  const basePrice = selectedBase?.price || 0;
  const toppingPrice = selectedTopping?.price || 0;
  const total = (basePrice + toppingPrice) * quantity;
  document.getElementById("total-price").textContent = total.toLocaleString();
  document.getElementById("add-to-cart").disabled = !(selectedBase && selectedTopping);
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
function addToCart() {
  // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  if (!selectedBase || !selectedTopping) {
    showMessage("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  
  const total = (selectedBase.price + selectedTopping.price) * quantity;
  cart.push({
    id: Date.now(), // (‡πÄ‡∏û‡∏¥‡πà‡∏°) id ‡πÉ‡∏´‡πâ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    baseName: selectedBase.name,
    toppingName: selectedTopping.name,
    quantity,
    unitPrice: selectedBase.price + selectedTopping.price,
    totalPrice: total
  });
  quantity = 1;
  document.getElementById("quantity").textContent = "1";
  updateTotal();

  // (‡∏¢‡πâ‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà Error ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
  updateCartBadge();
  showMessage("üß∫ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!");
}

    // [‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà Error (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 775-780) ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß]

    // ===============================================================
    // 6. CART & COUPON MANAGEMENT
    // ===============================================================
    function showCart() {
      const modal = document.getElementById("cart-modal");
      const content = document.getElementById("cart-content");

      if (cart.length === 0) {
        content.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">üõí</div>
            <p class="text-gray-600 text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
          </div>
        `;
      } else {
        let html = '<div class="space-y-3">';
        cart.forEach((item, index) => {
          html += `
            <div class="card border border-gray-200 p-4">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="font-semibold">${item.baseName}</div>
                  <div class="text-sm text-gray-600">‡∏´‡∏ô‡πâ‡∏≤: ${item.toppingName}</div>
                  <div class="text-sm text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-blue-600">${item.totalPrice} ‡∏ö‡∏≤‡∏ó</div>
                  <div class="flex items-center gap-2 mt-2">
                    <button onclick="updateCartQuantity(${index}, -1)" class="quantity-btn bg-red-500 hover:bg-red-600 text-white text-sm w-6 h-6">‚àí</button>
                    <span class="text-sm font-medium">${item.quantity}</span>
                    <button onclick="updateCartQuantity(${index}, 1)" class="quantity-btn bg-green-500 hover:bg-green-600 text-white text-sm w-6 h-6">+</button>
                  </div>
                  <button onclick="removeFromCart(${index})" class="text-red-500 text-sm mt-2 hover:underline">‡∏•‡∏ö</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;
      }
      updateCartTotal();
      modal.classList.remove("hidden");
    }

    function updateCartQuantity(index, change) {
      if (cart[index]) {
        cart[index].quantity = Math.max(1, cart[index].quantity + change);
        cart[index].totalPrice = cart[index].unitPrice * cart[index].quantity;
        updateCartBadge();
        showCart();
      }
    }

    function updateCartTotal() {
      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      let discount = 0;
      if (selectedCoupon) {
        // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
        if (subtotal < selectedCoupon.min_purchase) {
          removeCoupon(); // ‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å
          showMessage(`‚ö†Ô∏è ‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${selectedCoupon.min_purchase} ‡∏ö‡∏≤‡∏ó`);
        } else {
          if (selectedCoupon.type === 'percent') {
            discount = Math.floor(subtotal * selectedCoupon.value / 100);
          } else { // 'fixed'
            discount = Math.min(selectedCoupon.value, subtotal);
          }
        }
      }

      const total = Math.max(0, subtotal - discount);
      document.getElementById("cart-subtotal").textContent = subtotal.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
      document.getElementById("cart-total").textContent = total.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";

      if (discount > 0) {
        document.getElementById("discount-row").classList.remove("hidden");
        document.getElementById("discount-amount").textContent = "-" + discount.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
      } else {
        document.getElementById("discount-row").classList.add("hidden");
      }
    }

    function closeCart() {
      document.getElementById("cart-modal").classList.add("hidden");
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartBadge();
      showCart(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      showMessage("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
    }

    function updateCartBadge() {
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const badge = document.getElementById("cart-badge");
      if (totalItems > 0) {
        badge.textContent = totalItems;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }

    // ===============================================================
    // 7. COUPON SYSTEM
    // ===============================================================
    async function loadCoupons() {
      try {
        const { data, error } = await supabase
          .from("coupons")
          .select("*")
          .eq("is_active", true)
          //.eq("show_in_list", true) // (‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å) ‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î
          .order("created_at", { ascending: false });
        if (error) throw error;
        availableCoupons = data || [];
        console.log("‚úÖ Coupons loaded:", availableCoupons.length);
      } catch (error) {
        console.error("‚ùå Error loading coupons:", error);
      }
    }

    function showCoupons() {
      const modal = document.getElementById("coupons-modal");
      const content = document.getElementById("coupons-content");
      
      // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
      const displayableCoupons = availableCoupons.filter(c => 
        c.show_in_list && c.usage_limit > c.usage_count
      );

      if (displayableCoupons.length === 0) {
        content.innerHTML = `
          <div class="col-span-1 md:col-span-2 text-center py-12">
            <div class="text-6xl mb-4">üé´</div>
            <p class="text-gray-600 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
          </div>
        `;
      } else {
        let html = '';
        displayableCoupons.forEach(coupon => {
          const canUse = coupon.usage_limit > coupon.usage_count; // (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö)
          html += `
            <div class="card border-2 ${canUse ? 'border-purple-200 hover:border-purple-400 cursor-pointer' : 'border-gray-200 opacity-50'} p-4" 
                 ${canUse ? `onclick="selectCouponFromList('${coupon.code}')"` : ''}>
              <div class="flex items-start justify-between mb-3">
                <div class="text-3xl">üé´</div>
                <div class="text-xs ${canUse ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} px-2 py-1 rounded-full">
                  ${canUse ? '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ' : '‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß'}
                </div>
              </div>
              <div class="font-bold text-lg text-purple-900 mb-1">${coupon.name}</div>
              <div class="text-sm text-gray-600 mb-2">${coupon.description}</div>
              <div class="text-xs text-gray-500">
                ${coupon.min_purchase > 0 ? `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${coupon.min_purchase} ‡∏ö‡∏≤‡∏ó | ` : ''}
                ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ${coupon.usage_limit - coupon.usage_count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </div>
            </div>
          `;
        });
        content.innerHTML = html;
      }
      modal.classList.remove("hidden");
    }

    function closeCoupons() {
      document.getElementById("coupons-modal").classList.add("hidden");
    }

    function selectCouponFromList(code) {
      applyCoupon(code);
      closeCoupons();
      // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      const msgEl = document.getElementById("coupon-message");
      msgEl.textContent = "‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
      msgEl.className = "text-sm mt-2 text-green-600";
      msgEl.classList.remove("hidden");
    }

    function applyCouponCode() {
      const code = document.getElementById("coupon-input").value.trim().toUpperCase();
      applyCoupon(code);
    }

    async function applyCoupon(code) {
      const msgEl = document.getElementById("coupon-message");
      if (!code) {
        msgEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î";
        msgEl.className = "text-sm mt-2 text-red-600";
        msgEl.classList.remove("hidden");
        return;
      }

      // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      try {
        const { data: used, error: checkError } = await supabase
          .from("user_coupons")
          .select("id")
          .eq("user_id", currentUser.id)
          .eq("coupon_code", code)
          .maybeSingle();

        if (checkError) throw checkError;
        if (used) {
          msgEl.textContent = "‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
          msgEl.className = "text-sm mt-2 text-red-600";
          msgEl.classList.remove("hidden");
          return;
        }

        // ‡∏´‡∏≤‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å
        const coupon = availableCoupons.find(c => c.code.toUpperCase() === code);
        const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);

        if (!coupon) {
          msgEl.textContent = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ";
          msgEl.className = "text-sm mt-2 text-red-600";
        } else if (!coupon.is_active) {
          msgEl.textContent = "‚ö†Ô∏è ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
          msgEl.className = "text-sm mt-2 text-red-600";
        } else if (coupon.usage_count >= coupon.usage_limit) {
          msgEl.textContent = "‚ö†Ô∏è ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
          msgEl.className = "text-sm mt-2 text-red-600";
        } else if (subtotal < coupon.min_purchase) {
          msgEl.textContent = `‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${coupon.min_purchase} ‡∏ö‡∏≤‡∏ó`;
          msgEl.className = "text-sm mt-2 text-red-600";
        } else {
          // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏î‡πâ
          selectedCoupon = coupon;
          msgEl.textContent = "‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
          msgEl.className = "text-sm mt-2 text-green-600";
          document.getElementById("coupon-name").textContent = coupon.name;
          document.getElementById("coupon-desc").textContent = coupon.description;
          document.getElementById("selected-coupon").classList.remove("hidden");
        }
      } catch (error) {
        console.error("‚ùå Error applying coupon:", error);
        msgEl.textContent = "‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        msgEl.className = "text-sm mt-2 text-red-600";
      }

      msgEl.classList.remove("hidden");
      updateCartTotal();
    }
    
    function removeCoupon() {
      selectedCoupon = null;
      document.getElementById("selected-coupon").classList.add("hidden");
      document.getElementById("coupon-input").value = "";
      const msgEl = document.getElementById("coupon-message");
      msgEl.textContent = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß";
      msgEl.className = "text-sm mt-2 text-gray-600";
      msgEl.classList.remove("hidden");
      updateCartTotal();
    }


    // ===============================================================
    // 8. CHECKOUT
    // ===============================================================
    async function checkout() {
      if (cart.length === 0) {
        showMessage("üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
        return;
      }
      
      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      let discount = 0;
      let couponId = null;

      if (selectedCoupon) {
        // (‡πÄ‡∏û‡∏¥‡πà‡∏°) Re-validate coupon ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        if (subtotal < selectedCoupon.min_purchase) {
          removeCoupon();
          showMessage(`‚ö†Ô∏è ‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (${selectedCoupon.min_purchase} ‡∏ö‡∏≤‡∏ó)`);
          return;
        }
        
        if (selectedCoupon.type === 'percent') {
          discount = Math.floor(subtotal * selectedCoupon.value / 100);
        } else {
          discount = Math.min(selectedCoupon.value, subtotal);
        }
        couponId = selectedCoupon.id;
      }

      const total = Math.max(0, subtotal - discount);
      const totalPoints = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0); // (‡πÅ‡∏Å‡πâ) ‡∏Ñ‡∏¥‡∏î‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î
      const pointsEarned = Math.floor(totalPoints / 10); // (‡πÅ‡∏Å‡πâ) ‡∏™‡∏°‡∏°‡∏ï‡∏¥ 10 ‡∏ö‡∏≤‡∏ó 1 ‡πÅ‡∏ï‡πâ‡∏°

      const orderData = {
        user_id: currentUser.id,
        line_user_id: userProfile.userId,
        customer_name: userProfile.displayName,
        items: cart,
        subtotal: subtotal,
        discount: discount,
        total: total,
        status: "pending",
        points_earned: pointsEarned,
        coupon_id: couponId
      };

      try {
        // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Order
        const { data: newOrder, error: orderError } = await supabase
          .from("orders")
          .insert(orderData)
          .select()
          .single();
        
        if (orderError) throw orderError;

        // 2. (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
        if (couponId) {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          const { error: countError } = await supabase.rpc('increment_coupon_usage', { c_id: couponId });
          if (countError) throw countError;
          
          // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ user ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
          const { error: userCouponError } = await supabase
            .from("user_coupons")
            .insert({
              user_id: currentUser.id,
              coupon_id: couponId,
              coupon_code: selectedCoupon.code,
              order_id: newOrder.id
            });
          if (userCouponError) throw userCouponError;
        }

        // 3. (‡πÅ‡∏Å‡πâ) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏° (‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏≥‡∏ï‡∏≠‡∏ô admin ‡∏Å‡∏î complete)
        // (‡∏•‡∏ö) const { error: pointsError } = await supabase ...

        // 4. ‡∏™‡πà‡∏á Flex Message ‡πÑ‡∏õ‡∏´‡∏≤ Admin (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ backend)
        // ... (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô webhook/serverless function) ...
        // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô LIFF
        console.log("‚úÖ Order submitted! (Simulating Admin notification)");


        // 5. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        cart = [];
        removeCoupon();
        updateCartBadge();
        closeCart();

        // 6. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        showMessage("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        openOrderHistory(); // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥

      } catch (error) {
        console.error("‚ùå Checkout error:", error);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
      }
    }


    // ===============================================================
    // 9. ORDER HISTORY
    // ===============================================================
    function backToMain() {
      document.getElementById("order-history").classList.add("hidden");
      document.getElementById("main-app").classList.remove("hidden");
      document.getElementById("main-header").classList.remove("hidden");
    }

    async function openOrderHistory() {
      document.getElementById("main-app").classList.add("hidden");
      document.getElementById("main-header").classList.add("hidden"); // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏ã‡πà‡∏≠‡∏ô header ‡∏î‡πâ‡∏ß‡∏¢
      document.getElementById("order-history").classList.remove("hidden");

      const listEl = document.getElementById("order-list");
      listEl.innerHTML = '<div class="spinner mx-auto"></div><p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

      try {
        const { data, error } = await supabase
          .from("orders")
          .select("*")
          .eq("line_user_id", userProfile.userId)
          .order("created_at", { ascending: false })
          .limit(20);

        if (error) throw error;

        if (data.length === 0) {
          listEl.innerHTML = `<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>`;
          return;
        }

        listEl.innerHTML = data.map(order => {
          const itemsHtml = order.items.map(item => 
            `<div class="text-sm text-gray-600 ml-4">
              - ${item.baseName} (‡∏´‡∏ô‡πâ‡∏≤${item.toppingName}) x ${item.quantity}
             </div>`
          ).join('');

          return `
            <div class="card border border-gray-200">
              <div class="flex justify-between items-center mb-3">
                <div class="font-semibold text-gray-800">
                  ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id}
                </div>
                ${getStatusBadge(order.status)}
              </div>
              <div class="text-sm text-gray-500 mb-3">
                ${new Date(order.created_at).toLocaleString('th-TH')}
              </div>
              <div class="mb-3">${itemsHtml}</div>
              <div class="border-t pt-3 space-y-1">
                <div class="flex justify-between text-sm text-gray-600">
                  <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                  <span>${order.subtotal} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                ${order.discount > 0 ? `
                <div class="flex justify-between text-sm text-green-600">
                  <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                  <span>-${order.discount} ‡∏ö‡∏≤‡∏ó</span>
                </div>` : ''}
                <div class="flex justify-between font-bold text-blue-600">
                  <span>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                  <span>${order.total} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                ${order.status === 'completed' ? `
                <div class="flex justify-between text-sm text-orange-600 pt-1">
                  <span>‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:</span>
                  <span>+${order.points_earned} ‡πÅ‡∏ï‡πâ‡∏°</span>
                </div>` : ''}
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error("‚ùå Error loading history:", error);
        listEl.innerHTML = `<p class="text-center text-red-500 py-8">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</p>`;
      }
    }

    function getStatusBadge(status) {
      const statuses = {
        pending: '<span class="badge badge-pending">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>',
        preparing: '<span class="badge badge-preparing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</span>',
        ready: '<span class="badge badge-ready">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</span>',
        completed: '<span class="badge badge-completed">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>',
        cancelled: '<span class="badge badge-cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>'
      };
      return statuses[status] || status;
    }


    // ===============================================================
    // 10. ADMIN PANEL
    // ===============================================================
    function showAdmin() {
      document.getElementById("admin-modal").classList.remove("hidden");
      showAdminTab('orders'); // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö orders ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      loadAdminOrders(); // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏¢
    }

    function closeAdmin() {
      document.getElementById("admin-modal").classList.add("hidden");
    }

    function showAdminTab(tabName) {
      // ‡∏ã‡πà‡∏≠‡∏ô content ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ tab ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô default
      document.querySelectorAll('.admin-tab').forEach(el => {
        el.classList.remove('border-blue-600', 'text-blue-600');
        el.classList.add('border-transparent', 'text-gray-600', 'hover:text-gray-900');
      });

      // ‡πÅ‡∏™‡∏î‡∏á content ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      document.getElementById(`admin-${tabName}-tab`).classList.remove('hidden');
      // ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ tab ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const activeTab = document.querySelector(`.admin-tab[data-tab="${tabName}"]`);
      activeTab.classList.add('border-blue-600', 'text-blue-600');
      activeTab.classList.remove('border-transparent', 'text-gray-600', 'hover:text-gray-900');
      
      // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÅ‡∏ó‡πá‡∏ö
      if (tabName === 'orders') loadAdminOrders();
      if (tabName === 'coupons') loadAdminCoupons();
      if (tabName === 'stats') loadAdminStats();
      if (tabName === 'brownie') loadAdminBrownies();
      if (tabName === 'summary') {
        // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        document.getElementById('summary-date').valueAsDate = new Date();
        loadDailySummary();
      }
    }

    // --- Admin: Orders ---
    async function loadAdminOrders() {
      const content = document.getElementById("admin-orders-content");
      content.innerHTML = '<div class="spinner mx-auto"></div>';
      try {
        const { data, error } = await supabase
          .from("orders")
          .select("*")
          .in("status", ["pending", "preparing", "ready"]) // (‡πÅ‡∏Å‡πâ) ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
          .order("created_at", { ascending: true });
        
        if (error) throw error;
        renderAdminOrders(data);
      } catch (error) {
        console.error("‚ùå Error loading admin orders:", error);
        content.innerHTML = '<p class="text-red-500">Error loading orders</p>';
      }
    }

    function renderAdminOrders(orders) {
      const content = document.getElementById("admin-orders-content");
      if (orders.length === 0) {
        content.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á</p>';
        return;
      }

      content.innerHTML = '<div class="space-y-4">' + orders.map(order => {
        const itemsHtml = order.items.map(item => 
            `<div class="text-sm text-gray-700 ml-4">
              - ${item.baseName} (‡∏´‡∏ô‡πâ‡∏≤${item.toppingName}) x ${item.quantity}
             </div>`
          ).join('');
        
        return `
          <div class="card border-l-4 ${order.status === 'pending' ? 'border-red-500' : (order.status === 'preparing' ? 'border-blue-500' : 'border-green-500')}">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-bold text-lg">Order #${order.id}</div>
                <div class="text-sm text-gray-600">${order.customer_name}</div>
                <div class="text-xs text-gray-500">${new Date(order.created_at).toLocaleString('th-TH')}</div>
              </div>
              <div class="text-right">
                <div class="font-bold text-xl text-blue-600">${order.total} ‡∏ö‡∏≤‡∏ó</div>
                ${getStatusBadge(order.status)}
              </div>
            </div>
            <div class="my-3 py-3 border-y">${itemsHtml}</div>
            <div class="flex gap-2">
              ${order.status === 'pending' ? `<button onclick="updateOrderStatus(${order.id}, 'preparing', ${order.user_id}, ${order.points_earned})" class="btn-primary flex-1 py-2 rounded-lg text-sm">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>` : ''}
              ${order.status === 'preparing' ? `<button onclick="updateOrderStatus(${order.id}, 'ready', ${order.user_id}, ${order.points_earned})" class="btn-primary flex-1 py-2 rounded-lg text-sm bg-blue-500 hover:bg-blue-600">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</button>` : ''}
              ${order.status === 'ready' ? `<button onclick="updateOrderStatus(${order.id}, 'completed', ${order.user_id}, ${order.points_earned})" class="btn-primary flex-1 py-2 rounded-lg text-sm bg-green-500 hover:bg-green-600">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß (Complete)</button>` : ''}
              <button onclick="updateOrderStatus(${order.id}, 'cancelled', ${order.user_id}, ${order.points_earned})" class="btn-secondary flex-1 py-2 rounded-lg text-sm bg-red-100 text-red-700 border-red-200 hover:bg-red-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </div>
        `;
      }).join('') + '</div>';
    }

    async function updateOrderStatus(orderId, newStatus, userId, points) {
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Order #${orderId} ‡πÄ‡∏õ‡πá‡∏ô ${newStatus}?`)) return;

      try {
        // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const { error: statusError } = await supabase
          .from("orders")
          .update({ status: newStatus })
          .eq("id", orderId);
        
        if (statusError) throw statusError;

        // 2. (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏ñ‡πâ‡∏≤ 'completed' ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡πÅ‡∏ï‡πâ‡∏°
        if (newStatus === 'completed' && points > 0) {
          const { error: pointsError } = await supabase.rpc('add_points', {
            user_id_to_update: userId,
            points_to_add: points
          });
          if (pointsError) {
            // (‡πÅ‡∏Å‡πâ) ‡πÑ‡∏°‡πà throw ‡πÅ‡∏ï‡πà log error ‡πÑ‡∏ß‡πâ
            console.error("‚ùå Error adding points:", pointsError);
            showMessage("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏ö‡∏ß‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          }
        }
        
        // 3. (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏ñ‡πâ‡∏≤ 'cancelled' ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        if (newStatus === 'cancelled') {
          // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          await refundCouponUsage(orderId, userId);
        }


        showMessage(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Order #${orderId} ‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ‡πÅ‡∏•‡πâ‡∏ß`);
        loadAdminOrders(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
        loadDailySummary(); // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      } catch (error) {
        console.error("‚ùå Error updating status:", error);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }
    
    // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
    async function refundCouponUsage(orderId, userId) {
      try {
        // 1. ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const { data: userCoupon, error: findError } = await supabase
          .from("user_coupons")
          .select("id, coupon_id")
          .eq("order_id", orderId)
          .eq("user_id", userId)
          .maybeSingle();
        
        if (findError) throw findError;
        
        if (userCoupon) {
          // 2. ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ
          const { error: deleteError } = await supabase
            .from("user_coupons")
            .delete()
            .eq("id", userCoupon.id);
          if (deleteError) throw deleteError;
          
          // 3. ‡∏•‡∏î count ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          const { error: rpcError } = await supabase.rpc('decrement_coupon_usage', {
            c_id: userCoupon.coupon_id
          });
          if (rpcError) throw rpcError;
          
          console.log(`‚úÖ Refunded coupon ${userCoupon.coupon_id} for order ${orderId}`);
        }
      } catch (error) {
        console.error(`‚ùå Error refunding coupon for order ${orderId}:`, error);
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á user ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏Ñ‡πà log ‡πÑ‡∏ß‡πâ
      }
    }

    // --- Admin: Coupons ---
    function showCreateCouponForm() {
      document.getElementById("create-coupon-modal").classList.remove("hidden");
    }
    function closeCreateCoupon() {
      document.getElementById("create-coupon-modal").classList.add("hidden");
    }

    async function loadAdminCoupons() {
      const content = document.getElementById("admin-coupons-content");
      content.innerHTML = '<div class="spinner mx-auto"></div>';
      try {
        const { data, error } = await supabase
          .from("coupons")
          .select("*")
          .order("created_at", { ascending: false });
        
        if (error) throw error;
        renderAdminCoupons(data);
      } catch (error) {
        console.error("‚ùå Error loading admin coupons:", error);
        content.innerHTML = '<p class="text-red-500">Error loading coupons</p>';
      }
    }
    
    function renderAdminCoupons(coupons) {
      const content = document.getElementById("admin-coupons-content");
      if (coupons.length === 0) {
        content.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>';
        return;
      }
      content.innerHTML = `
        <table class="w-full text-left table-auto border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-3 border-b">Code</th>
              <th class="p-3 border-b">Name</th>
              <th class="p-3 border-b">Value</th>
              <th class="p-3 border-b">Usage</th>
              <th class="p-3 border-b">Status</th>
              <th class="p-3 border-b">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${coupons.map(c => `
              <tr class="hover:bg-gray-50">
                <td class="p-3 border-b">${c.code}</td>
                <td class="p-3 border-b">${c.name}</td>
                <td class="p-3 border-b">
                  ${c.type === 'percent' ? `${c.value}%` : `${c.value} ‡∏ö‡∏≤‡∏ó`}
                </td>
                <td class="p-3 border-b">${c.usage_count} / ${c.usage_limit}</td>
                <td class="p-3 border-b">
                  <span class="text-xs px-2 py-1 rounded-full ${c.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                    ${c.is_active ? 'Active' : 'Inactive'}
                  </span>
                  <span class="text-xs px-2 py-1 rounded-full ${c.show_in_list ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                    ${c.show_in_list ? 'Show' : 'Hide'}
                  </span>
                </td>
                <td class="p-3 border-b">
                  <button onclick="toggleCouponStatus(${c.id}, ${!c.is_active})" class="text-xs ${c.is_active ? 'text-yellow-600' : 'text-green-600'} hover:underline">
                    ${c.is_active ? 'Deactivate' : 'Activate'}
                  </button>
                  <button onclick="toggleCouponShow(${c.id}, ${!c.show_in_list})" class="text-xs ${c.show_in_list ? 'text-gray-600' : 'text-blue-600'} hover:underline ml-2">
                    ${c.show_in_list ? 'Hide' : 'Show'}
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function createCoupon(event) {
      event.preventDefault();
      try {
        const newData = {
          code: document.getElementById("coupon-code").value.trim().toUpperCase(),
          name: document.getElementById("coupon-title").value,
          description: document.getElementById("coupon-description").value,
          type: document.getElementById("coupon-type").value,
          value: parseFloat(document.getElementById("coupon-value").value),
          min_purchase: parseFloat(document.getElementById("coupon-min").value) || 0,
          usage_limit: parseInt(document.getElementById("coupon-usage").value) || 1,
          is_active: true,
          show_in_list: true, // (‡πÄ‡∏û‡∏¥‡πà‡∏°) default ‡πÄ‡∏õ‡πá‡∏ô true
          usage_count: 0
        };

        const { error } = await supabase.from("coupons").insert(newData);
        if (error) throw error;
        
        showMessage("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        closeCreateCoupon();
        loadAdminCoupons();
        loadCoupons(); // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á user
      } catch (error) {
        console.error("‚ùå Error creating coupon:", error);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }

    async function toggleCouponStatus(id, newStatus) {
      try {
        const { error } = await supabase
          .from("coupons")
          .update({ is_active: newStatus })
          .eq("id", id);
        if (error) throw error;
        showMessage(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á #${id} ‡πÄ‡∏õ‡πá‡∏ô ${newStatus}`);
        loadAdminCoupons();
        loadCoupons();
      } catch (error) {
        console.error("‚ùå Error toggling coupon status:", error);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }
    
    // (‡πÄ‡∏û‡∏¥‡πà‡∏°)
    async function toggleCouponShow(id, newStatus) {
      try {
        const { error } = await supabase
          .from("coupons")
          .update({ show_in_list: newStatus })
          .eq("id", id);
        if (error) throw error;
        showMessage(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á #${id} ‡πÄ‡∏õ‡πá‡∏ô ${newStatus}`);
        loadAdminCoupons();
        loadCoupons();
      } catch (error) {
        console.error("‚ùå Error toggling coupon show:", error);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }


    // --- Admin: Stats ---
    async function loadAdminStats() {
      const content = document.getElementById("admin-stats-content");
      content.innerHTML = '<div class="spinner mx-auto"></div>';
      try {
        const { data, error } = await supabase.rpc('get_admin_stats');
        if (error) throw error;
        
        const stats = data[0];
        content.innerHTML = `
          <div class="card text-center bg-blue-50 border-blue-200">
            <div class="text-4xl font-bold text-blue-600">${stats.total_revenue.toLocaleString()}</div>
            <div class="text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
          </div>
          <div class="card text-center bg-green-50 border-green-200">
            <div class="text-4xl font-bold text-green-600">${stats.total_orders}</div>
            <div class="text-gray-600">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="card text-center bg-purple-50 border-purple-200">
            <div class="text-4xl font-bold text-purple-600">${stats.total_users}</div>
            <div class="text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          </div>
        `;
      } catch (error) {
        console.error("‚ùå Error loading stats:", error);
        content.innerHTML = '<p class="text-red-500">Error loading stats</p>';
      }
    }

    // --- Admin: Brownie Menu --- (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    async function loadAdminBrownies() {
      const content = document.getElementById("admin-brownie-content");
      content.innerHTML = '<div class="spinner mx-auto"></div>';
      try {
        const { data: items, error } = await supabase
          .from("brownie_items")
          .select("*")
          .order("type", { ascending: true })
          .order("id", { ascending: true });
        if (error) throw error;

        const bases = items.filter(i => i.type === 'base');
        const toppings = items.filter(i => i.type === 'topping');
        
        content.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold">ü´ê ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h4>
                <button onclick="openBrownieModal('base')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                  + ‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
              </div>
              <div class="space-y-2">
                ${bases.map(renderBrownieItem).join('')}
              </div>
            </div>
            <div>
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold">üç´ ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà</h4>
                <button onclick="openBrownieModal('topping')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                  + ‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
              </div>
              <div class="space-y-2">
                ${toppings.map(renderBrownieItem).join('')}
              </div>
            </div>
          </div>
        `;

        // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏ú‡∏π‡∏Å event listener ‡πÉ‡∏´‡πâ form
        document.getElementById('brownie-form').onsubmit = saveBrownieItem;

      } catch (error) {
        console.error("‚ùå Error loading brownie items:", error);
        content.innerHTML = '<p class="text-red-500">Error loading items</p>';
      }
    }
    
    function renderBrownieItem(item) {
      return `
        <div class="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm">
          <div>
            <span class="font-medium">${item.name}</span>
            <span class="text-sm text-gray-600">(${item.price} ‡∏ö‡∏≤‡∏ó)</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs px-2 py-1 rounded-full ${item.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
              ${item.is_active ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢' : '‡∏õ‡∏¥‡∏î'}
            </span>
            <button onclick='openBrownieModal(null, ${JSON.stringify(item)})' 
                    class="text-blue-600 hover:underline text-sm">
              ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
          </div>
        </div>
      `;
    }

    function openBrownieModal(type, item = null) {
      const form = document.getElementById('brownie-form');
      form.reset();
      
      if (item) {
        // Edit mode
        document.getElementById('brownie-modal-title').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${item.name}`;
        document.getElementById('brownie-id').value = item.id;
        document.getElementById('brownie-type').value = item.type;
        document.getElementById('brownie-name').value = item.name;
        document.getElementById('brownie-desc').value = item.description || '';
        document.getElementById('brownie-price').value = item.price;
        document.getElementById('brownie-points').value = item.points_reward || 0;
        document.getElementById('brownie-active').checked = item.is_active;
      } else {
        // Create mode
        document.getElementById('brownie-modal-title').textContent = `‡πÄ‡∏û‡∏¥‡πà‡∏°${type === 'base' ? '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' : '‡∏´‡∏ô‡πâ‡∏≤'}‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà`;
        document.getElementById('brownie-id').value = '';
        document.getElementById('brownie-type').value = type;
      }
      
      document.getElementById('brownie-modal').classList.remove('hidden');
    }
    
    function closeBrownieModal() {
      document.getElementById('brownie-modal').classList.add('hidden');
    }

    async function saveBrownieItem(event) {
      event.preventDefault();
      const id = document.getElementById('brownie-id').value;
      const itemData = {
        type: document.getElementById('brownie-type').value,
        name: document.getElementById('brownie-name').value,
        description: document.getElementById('brownie-desc').value,
        price: parseFloat(document.getElementById('brownie-price').value),
        points_reward: parseInt(document.getElementById('brownie-points').value) || 0,
        is_active: document.getElementById('brownie-active').checked,
        // (‡πÄ‡∏û‡∏¥‡πà‡∏°) emoji
        emoji: document.getElementById('brownie-name').value.match(/(\p{Emoji})/u)?.[0] || null
      };

      try {
        let error;
        if (id) {
          // Update
          ({ error } = await supabase.from('brownie_items').update(itemData).eq('id', id));
        } else {
          // Create
          ({ error } = await supabase.from('brownie_items').insert(itemData));
        }
        if (error) throw error;
        
        showMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        closeBrownieModal();
        loadAdminBrownies(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ admin
        loadMenus(); // (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      } catch (error) {
        console.error("‚ùå Error saving brownie item:", error);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }
    
    // --- Admin: Daily Summary --- (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    async function loadDailySummary() {
      const date = document.getElementById('summary-date').value;
      const content = document.getElementById('summary-content');
      
      if (!date) {
        content.innerHTML = '<p class="text-gray-500 text-center">üìÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>';
        return;
      }
      
      content.innerHTML = '<div class="spinner mx-auto"></div>';
      
      try {
        const { data, error } = await supabase.rpc('get_daily_summary', { p_date: date });
        if (error) throw error;

        const summary = data[0];
        
        const itemsHtml = Object.entries(summary.item_summary)
          .sort(([, a], [, b]) => b.quantity - a.quantity)
          .map(([name, details]) => `
            <div class="flex justify-between p-2 hover:bg-gray-100 rounded">
              <span>${name}</span>
              <span class="font-medium">${details.quantity} ‡∏ä‡∏¥‡πâ‡∏ô ( ${details.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó )</span>
            </div>
          `).join('');

        content.innerHTML = `
          <h3 class="text-lg font-semibold mb-3">
            ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date(date + 'T00:00:00').toLocaleDateString('th-TH', { dateStyle: 'long' })}
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="card p-3 text-center ${summary.total_revenue > 0 ? 'bg-blue-50' : 'bg-gray-50'}">
              <div class="text-2xl font-bold text-blue-600">${summary.total_revenue.toLocaleString()}</div>
              <div class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
            </div>
            <div class="card p-3 text-center ${summary.total_orders > 0 ? 'bg-green-50' : 'bg-gray-50'}">
              <div class="text-2xl font-bold text-green-600">${summary.total_orders}</div>
              <div class="text-sm text-gray-600">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="card p-3 text-center ${summary.total_discount > 0 ? 'bg-yellow-50' : 'bg-gray-50'}">
              <div class="text-2xl font-bold text-yellow-600">${summary.total_discount.toLocaleString()}</div>
              <div class="text-sm text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó)</div>
            </div>
            <div class="card p-3 text-center ${summary.total_points > 0 ? 'bg-orange-50' : 'bg-gray-50'}">
              <div class="text-2xl font-bold text-orange-600">${summary.total_points}</div>
              <div class="text-sm text-gray-600">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏à‡∏Å</div>
            </div>
          </div>
          <h4 class="font-semibold mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</h4>
          <div class="text-sm space-y-1">${itemsHtml || '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>'}</div>
        `;
        
      } catch (error) {
        console.error("‚ùå Error loading daily summary:", error);
        content.innerHTML = `<p class="text-red-500 text-center">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
      }
    }
    
    // (‡πÄ‡∏û‡∏¥‡πà‡∏°)
    async function updateAllOrdersOfDay() {
      const date = document.getElementById('summary-date').value;
      if (!date || !confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (pending, preparing) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date} ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 'cancelled' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        return;
      }
      
      try {
        const { data, error } = await supabase.rpc('cancel_old_orders', { p_date: date });
        if (error) throw error;
        
        showMessage(`‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤ ${data} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        loadAdminOrders();
        loadDailySummary();
      } catch (error) {
        console.error("‚ùå Error cancelling old orders:", error);
        showMessage("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }


    // ===============================================================
    // 11. UTILITY FUNCTIONS
    // ===============================================================
    function showMessage(msg) {
      const el = document.getElementById("success-message");
      const text = document.getElementById("success-text");
      text.textContent = msg;
      el.classList.remove("hidden");
      setTimeout(() => {
        el.classList.add("hidden");
      }, 2500);
    }

    function closeModalOnBackdrop(event, modalId) {
      if (event.target.id === modalId) {
        document.getElementById(modalId).classList.add("hidden");
      }
    }

    // ===============================================================
    // 12. RUN APP
    // ===============================================================
    window.addEventListener("load", init);
  </script>
</body>
</html>
