<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SUAN KHANOM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
      min-height: 100vh;
    }
    * { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      font-weight: 500;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.8);
      color: #374151;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
    }
    .selected {
      border: 4px solid #1d4ed8 !important;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(29, 78, 216, 0.5);
    }
    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .float { animation: float 3s ease-in-out infinite; }
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-preparing { background: #dbeafe; color: #1e40af; }
    .badge-ready { background: #d1fae5; color: #065f46; }
    .badge-completed { background: #e0e7ff; color: #3730a3; }
    .badge-cancelled { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="min-h-full">
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="text-center">
      <div class="spinner mb-4 mx-auto"></div>
      <p class="text-white text-xl font-semibold">กำลังโหลด...</p>
    </div>
  </div>

  <!-- Header -->
  <header id="main-header" class="glass shadow-sm border-b border-white/20 sticky top-0 z-40 hidden">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-2xl float">🪙</div>
          <div>
            <div class="text-sm text-gray-500">แต้มสะสม</div>
            <div class="font-semibold text-gray-900">
              <span id="userPoints" class="text-orange-600 font-semibold">0</span> แต้ม
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-3">
          <div class="flex items-center space-x-2">
            <img id="userPic" src="" alt="Profile" class="w-8 h-8 rounded-full border border-gray-300" />
            <span id="userName" class="text-sm text-gray-600 hidden sm:block">กำลังโหลด...</span>
          </div>
          <button onclick="showCart()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-xl text-sm hover-lift relative">
            <span class="hidden sm:inline">🛒 ตะกร้า</span>
            <span class="sm:hidden">🛒</span>
            <span id="cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
          </button>
          <button onclick="showCoupons()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">🎫 คูปอง</span>
            <span class="sm:hidden">🎫</span>
          </button>
          <button onclick="openOrderHistory()" 
            class="btn-secondary px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">📋 ประวัติ</span>
            <span class="sm:hidden">📋</span>
          </button>
          <button id="admin-btn" onclick="showAdmin()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-xl text-sm hover-lift hidden">
            <span class="hidden sm:inline">👨‍💼 Admin</span>
            <span class="sm:hidden">👨‍💼</span>
          </button>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-xl text-sm hover-lift">
            <span class="hidden sm:inline">ออกจากระบบ</span>
            <span class="sm:hidden">🚪</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main App -->
  <main id="main-app" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <div class="text-center mb-12">
      <div class="text-6xl mb-4 float">🫐</div>
      <h1 class="text-4xl font-bold mb-2" style="background: linear-gradient(135deg, #1f2937, #374151); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SUAN KHANOM</h1>
      <p class="text-gray-600 text-lg mb-4">สั่งทำพิเศษเพื่อคุณ</p>
    </div>

    <!-- 🍰 เลือกเนื้อบราวนี่ -->
<section class="bg-white p-6 rounded-xl shadow-md mb-6">
  <h3 class="text-xl font-semibold mb-4">🫐 เลือกเนื้อบราวนี่</h3>
  <div id="base-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>

<!-- 🍫 เลือกหน้าบราวนี่ -->
<section class="bg-white p-6 rounded-xl shadow-md mb-6">
  <h3 class="text-xl font-semibold mb-4">🍫 เลือกหน้าบราวนี่</h3>
  <div id="topping-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>
<!-- จำนวนและราคารวม -->
<section id="quantity-section" class="card mb-8 hover-lift">
  <h2 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
    <span class="mr-3">📦</span> จำนวนและราคารวม
  </h2>
  
  <div class="flex items-center justify-center space-x-6">
    <button onclick="changeQuantity(-1)" 
            class="quantity-btn bg-red-500 hover:bg-red-600 text-white">
      −
    </button>

    <div class="text-center">
      <div class="text-5xl font-bold text-gray-900" id="quantity">1</div> <!-- 👈 ชื่อ id ต้องเป็น quantity -->
      <div class="text-sm text-gray-500 mt-2">ชิ้น</div>
    </div>

    <button onclick="changeQuantity(1)" 
            class="quantity-btn bg-green-500 hover:bg-green-600 text-white">
      +
    </button>
  </div>
</section>

<!-- ปุ่มเพิ่มลงตะกร้า -->
<section class="card text-center hover-lift">
  <div class="mb-6">
    <div class="text-3xl font-bold text-gray-900">
      💰 ราคารวม: <span id="total-price">0</span> บาท
    </div>
  </div>

  <button id="add-to-cart" 
          onclick="addToCart()" 
          class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed"
          disabled>
    🛒 เพิ่มลงตะกร้า
  </button>
</section>
  </main>

<section id="order-history" class="hidden px-4 py-6">
  <!-- แถวหัวข้อ + ปุ่ม -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-semibold text-purple-800 flex items-center gap-2">
      <span class="text-2xl">📦</span> ประวัติคำสั่งซื้อของฉัน
    </h2>
    <button 
      onclick="backToMain()" 
      class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md transition">
      ⬅️ กลับหน้าหลัก
    </button>
  </div>

  <!-- ส่วนแสดงรายการคำสั่งซื้อ -->
  <div id="order-list" class="space-y-4"></div>
</section>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'cart-modal')">
    <div class="card max-w-2xl w-full max-h-[80vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">🛒 ตะกร้าสินค้า</h3>
        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>
      <div id="cart-content" class="mb-6"></div>
      
      <!-- Coupon Section -->
      <div id="coupon-section" class="mb-6 p-4 bg-purple-50 rounded-xl">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-gray-900">🎫 ใช้คูปอง</h4>
          <button onclick="showCoupons()" class="text-purple-600 text-sm hover:underline">ดูคูปองทั้งหมด</button>
        </div>
        <div id="selected-coupon" class="hidden mb-3 p-3 bg-white rounded-lg border-2 border-purple-300">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium text-purple-900" id="coupon-name"></div>
              <div class="text-sm text-purple-700" id="coupon-desc"></div>
            </div>
            <button onclick="removeCoupon()" class="text-red-500 hover:text-red-700 text-sm font-medium">ลบ</button>
          </div>
        </div>
        <div class="flex gap-2">
          <input type="text" id="coupon-input" placeholder="กรอกโค้ดคูปอง" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
          <button onclick="applyCouponCode()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">ใช้</button>
        </div>
        <div id="coupon-message" class="text-sm mt-2 hidden"></div>
      </div>

      <div class="border-t pt-4">
        <div class="space-y-2 mb-4">
          <div class="flex justify-between text-gray-700">
            <span>ยอดรวม:</span>
            <span id="cart-subtotal">0 บาท</span>
          </div>
          <div id="discount-row" class="flex justify-between text-green-600 hidden">
            <span>ส่วนลด:</span>
            <span id="discount-amount">-0 บาท</span>
          </div>
          <div class="flex justify-between items-center text-xl font-bold border-t pt-2">
            <span>รวมทั้งหมด:</span>
            <span id="cart-total" class="text-blue-600">0 บาท</span>
          </div>
        </div>
        <button onclick="checkout()" class="btn-primary w-full py-3 rounded-xl font-semibold text-lg">✅ ยืนยันการสั่ง</button>
      </div>
    </div>
  </div>

  <!-- Coupons Modal -->
  <div id="coupons-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'coupons-modal')">
    <div class="card max-w-4xl w-full max-h-[80vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">🎫 คูปองของฉัน</h3>
        <button onclick="closeCoupons()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>
      <div id="coupons-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'admin-modal')">
    <div class="card max-w-6xl w-full max-h-[90vh] overflow-y-auto hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">👨‍💼 Admin Dashboard</h3>
        <button onclick="closeAdmin()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>

      <!-- Admin Tabs -->
     <div class="flex space-x-4 mb-6 border-b">
  <button onclick="showAdminTab('orders')" class="admin-tab px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600" data-tab="orders">
    📦 จัดการออเดอร์
  </button>
  <button onclick="showAdminTab('coupons')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="coupons">
    🎫 จัดการคูปอง
  </button>
  <button onclick="showAdminTab('stats')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="stats">
    📊 สถิติ
  </button>
  <!-- ✅ เพิ่มปุ่มใหม่ -->
  <button onclick="showAdminTab('brownie')" class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="brownie">
    🍰 เมนูบราวนี่
  </button>
  <button class="admin-tab px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="summary" onclick="showAdminTab('summary')">
    📅 สรุปออเดอร์รายวัน
  </button>
</div>

<!-- ✅ ส่วนเนื้อหาของแท็บเมนูบราวนี่ -->
<section id="admin-brownie-tab" class="admin-tab-content hidden">
  <div id="admin-brownie-content" class="p-4"></div>
</section>
<!-- Modal เพิ่ม/แก้ไข เมนูบราวนี่ -->
<div id="brownie-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h3 id="brownie-modal-title" class="text-xl font-semibold mb-4">🍰 เพิ่มเมนูบราวนี่</h3>

    <form id="brownie-form" class="space-y-3">
      <input type="hidden" id="brownie-id">
      <input type="hidden" id="brownie-type">

      <div>
        <label class="block text-sm font-medium mb-1">ชื่อเมนู (ใส่อิโมจิได้)</label>
        <input id="brownie-name" class="w-full border rounded px-3 py-2" placeholder="เช่น 🍫 บราวนี่โกโก้" required>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">คำอธิบาย</label>
        <textarea id="brownie-desc" class="w-full border rounded px-3 py-2" placeholder="คำอธิบายเมนู เช่น รสเข้มข้น หอมโกโก้"></textarea>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">ราคา (บาท)</label>
          <input id="brownie-price" type="number" step="0.01" class="w-full border rounded px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">แต้มที่จะได้</label>
          <input id="brownie-points" type="number" class="w-full border rounded px-3 py-2" required>
        </div>
      </div>

      <label class="flex items-center gap-2 mt-2">
        <input id="brownie-active" type="checkbox" class="w-4 h-4"> เปิดขายเมนูนี้
      </label>

      <div class="flex justify-end gap-2 pt-3 border-t mt-4">
        <button type="button" onclick="closeBrownieModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">ยกเลิก</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">บันทึก</button>
      </div>
    </form>
  </div>
</div>

      <!-- Orders Tab -->
      <div id="admin-orders-tab" class="admin-tab-content">
        <div id="admin-orders-content"></div>
      </div>

      <!-- Coupons Tab -->
      <div id="admin-coupons-tab" class="admin-tab-content hidden">
        <div class="mb-6">
          <button onclick="showCreateCouponForm()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">
            ➕ สร้างคูปองใหม่
          </button>
        </div>
        <div id="admin-coupons-content"></div>
      </div>
<!-- 📅 แท็บสรุปออเดอร์รายวัน -->
<div id="admin-summary-tab" class="admin-tab-content hidden space-y-4">
  <div class="flex flex-wrap gap-3 items-center">
    <input type="date" 
           id="summary-date" 
           class="border rounded-lg px-3 py-2 shadow-sm">
    <button onclick="loadDailySummary()" 
            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
      ดูสรุป
    </button>
    <button onclick="updateAllOrdersOfDay()" 
            class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
      อัปเดตสถานะทั้งหมดของวัน
    </button>
  </div>

  <div id="summary-content" 
       class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200 min-h-[150px]">
    <p class="text-gray-500 text-center">
      📆 กรุณาเลือกวันที่เพื่อดูสรุปออเดอร์
    </p>
  </div>
</div>

      <!-- Stats Tab -->
      <div id="admin-stats-tab" class="admin-tab-content hidden">
        <div id="admin-stats-content" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </div>
    </div>
  </div>
  <!-- Create Coupon Modal -->
  <div id="create-coupon-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event, 'create-coupon-modal')">
    <div class="card max-w-md w-full hover-lift" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">➕ สร้างคูปองใหม่</h3>
        <button onclick="closeCreateCoupon()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>
      <form onsubmit="createCoupon(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">รหัสคูปอง</label>
          <input type="text" id="coupon-code" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น WELCOME10" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อคูปอง</label>
          <input type="text" id="coupon-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น ลด 10%" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบาย</label>
          <input type="text" id="coupon-description" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น ลด 10% สำหรับสมาชิกใหม่" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทส่วนลด</label>
          <select id="coupon-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="percent">เปอร์เซ็นต์ (%)</option>
            <option value="fixed">จำนวนเงิน (บาท)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">มูลค่าส่วนลด</label>
          <input type="number" id="coupon-value" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น 10" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ยอดขั้นต่ำ (บาท)</label>
          <input type="number" id="coupon-min" value="0" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนการใช้งาน</label>
          <input type="number" id="coupon-usage" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>
        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold">
          สร้างคูปอง
        </button>
      </form>
    </div>
  </div>

  <!-- Success Message -->
  <div id="success-message" class="fixed top-20 right-4 card shadow-lg hidden z-50">
    <div class="flex items-center space-x-3">
      <div class="text-2xl">🎉</div>
      <div id="success-text" class="font-medium text-gray-900"></div>
    </div>
  </div>

  <script>
    // ===============================================================
    // 1. CONFIGURATION
    // ===============================================================
    const LIFF_ID = "2008357926-Ly07A5w2";
    const SUPABASE_URL = "https://dyorwbjagjlkqpbrdjwk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5b3J3YmphZ2psa3FwYnJkandrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjk2NjgsImV4cCI6MjA3Njk0NTY2OH0.bZJRcaM3u9NUBrux5AbPXOXVtcSnJHDdK15gCQ-9Zc4";
    // Admin User IDs (เพิ่ม LINE User ID ที่ต้องการให้เป็น Admin)
    const ADMIN_IDS = ["Ud21a04a5d66c9de0b4c6f1aaf8f050e2","U5301bd5962323787574d82f86f3d954e"]; // เปลี่ยนเป็น User ID ของคุณ

    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log("✅ Supabase initialized");
    } catch (error) {
      console.error("❌ Supabase initialization failed:", error);
    }

    // ===============================================================
    // 2. STATE VARIABLES
    // ===============================================================
    let userProfile = null; // เก็บข้อมูลโปรไฟล์ LINE (global ใช้ได้ทุกฟังก์ชัน)
    let currentUser = null;
    let selectedBase = null;
    let selectedTopping = null;
    let quantity = 1;
    let cart = [];
    let userPoints = 0;
    let selectedCoupon = null;
    let availableCoupons = [];

    const baseNames = {
      cocoa: "เนื้อโกโก้",
      greentea: "เนื้อชาเขียว",
      thaitea: "เนื้อชาไทย"
    };

    const toppingNames = {
      chocolate: "ช็อกโกแลตชิพ",
      almond: "อัลมอนด์แผ่น",
      oreo: "โอริโอ้บด"
    };

    // ===============================================================
    // 3. INITIALIZATION (Fix 1: Consolidate all init logic)
    // ===============================================================
   async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // ✅ ดึงข้อมูลผู้ใช้จาก LINE
        userProfile = await liff.getProfile();
        console.log("👤 Profile loaded:", userProfile);
        
        // ✅ ส่งข้อมูล userProfile ไปเก็บใน Supabase และโหลดข้อมูลเพิ่มเติม
        await saveUserToSupabase(userProfile);
        await loadUserData(userProfile.userId);
        await loadCoupons();

        // ✅ โหลดเมนูหลังจาก Supabase พร้อมแล้ว
        await loadMenus();
        
        // ✅ ตรวจสอบสิทธิ์แอดมิน
        if (ADMIN_IDS.includes(userProfile.userId)) {
          document.getElementById("admin-btn").classList.remove("hidden");
        }

        // ✅ แสดงหน้าเว็บหลังโหลดเสร็จ
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("main-header").classList.remove("hidden");
        document.getElementById("main-app").classList.remove("hidden");

      } catch (error) {
        console.error("❌ Init error:", error);
        showMessage("เกิดข้อผิดพลาดในการเข้าสู่ระบบ");
        // อาจจะต้องให้ผู้ใช้ลองเข้าใหม่ หรือตรวจสอบการตั้งค่า LIFF
      }
    }

    // ===============================================================
    // 4. USER MANAGEMENT
    // ===============================================================
    async function saveUserToSupabase(profile) {
      try {
        const { data: existingUser, error: findError } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", profile.userId)
          .maybeSingle();

        if (findError && findError.code !== "PGRST116") throw findError;

        if (!existingUser) {
          const { error: insertError } = await supabase
            .from("users")
            .insert([{
              line_id: profile.userId,
              display_name: profile.displayName,
              picture_url: profile.pictureUrl,
              points: 0
            }]);

          if (insertError) throw insertError;
          console.log("✅ New user created");
        } else {
          console.log("🟢 User exists");
        }
      } catch (error) {
        console.error("❌ Error saving user:", error);
        throw error;
      }
    }

    async function loadUserData(userId) {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("*")
          .eq("line_id", userId)
          .single();

        if (error) throw error;

        currentUser = data;
        userPoints = data.points || 0;

        document.getElementById("userName").textContent = data.display_name;
        document.getElementById("userPic").src = data.picture_url;
        document.getElementById("userPoints").textContent = userPoints;

        console.log("✅ User data loaded:", data);
      } catch (error) {
        console.error("❌ Error loading user data:", error);
        throw error;
      }
    }

    async function logout() {
      if (confirm("ต้องการออกจากระบบหรือไม่?")) {
        liff.logout();
        window.location.reload();
      }
    }

    // ===============================================================
    // 5. ORDER MANAGEMENT WITH QUANTITY
    // ===============================================================
// ✅ โหลดเมนูจาก Supabase
async function loadMenus() {
  try {
    const { data: items, error } = await supabase
      .from("brownie_items")
      .select("*")
      .eq("is_active", true)
      .order("id", { ascending: true });

    if (error) throw error;

    const bases = items.filter(i => i.type === "base");
    const toppings = items.filter(i => i.type === "topping");

    const baseList = document.getElementById("base-list");
    const toppingList = document.getElementById("topping-list");

    baseList.innerHTML = bases.map(b => `
      <div class="brownie-base card cursor-pointer text-center hover-lift" 
           onclick="selectBase(${b.id}, '${b.name}', ${b.price}, this)">
        <div class="text-5xl mb-1">${b.emoji || '🍫'}</div>
        <div class="font-semibold text-lg">${b.name}</div>
        <p class="text-gray-600 text-sm">${b.description || ''}</p>
        <p class="text-blue-600 font-semibold mt-2">💰 ${b.price} บาท</p>
      </div>
    `).join('');

    toppingList.innerHTML = toppings.map(t => `
      <div class="topping-item card cursor-pointer text-center hover-lift" 
           onclick="selectTopping(${t.id}, '${t.name}', ${t.price}, this)">
        <div class="text-5xl mb-1">${t.emoji || '🍪'}</div>
        <div class="font-semibold text-lg">${t.name}</div>
        <p class="text-gray-600 text-sm">${t.description || ''}</p>
        <p class="text-purple-600 font-semibold mt-2">🍫 ${t.price} บาท</p>
      </div>
    `).join('');

  } catch (err) {
    console.error("❌ Error loading menus:", err);
  }
}

// ✅ เมื่อเลือกเนื้อ
function selectBase(id, name, price, el) {
  document.querySelectorAll('.brownie-base').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedBase = { id, name, price };
  updateTotal();
}

// ✅ เมื่อเลือกหน้า
function selectTopping(id, name, price, el) {
  document.querySelectorAll('.topping-item').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedTopping = { id, name, price };
  updateTotal();
}

// ✅ ปรับจำนวน
function changeQuantity(v) {
  quantity = Math.max(1, quantity + v);
  document.getElementById("quantity").textContent = quantity;
  updateTotal();
}
// ✅ คำนวณราคารวม
function updateTotal() {
  const basePrice = selectedBase?.price || 0;
  const toppingPrice = selectedTopping?.price || 0;
  const total = (basePrice + toppingPrice) * quantity;
  document.getElementById("total-price").textContent = total.toLocaleString();
  document.getElementById("add-to-cart").disabled = !(selectedBase && selectedTopping);
}

// ✅ เพิ่มลงตะกร้า (Fix 2: Remove stray code outside the function and add validation)
function addToCart() {
  if (!selectedBase || !selectedTopping) {
    showMessage("⚠️ กรุณาเลือกเนื้อและหน้าบราวนี่ก่อน");
    return;
  }
    
  const total = (selectedBase.price + selectedTopping.price) * quantity;
  cart.push({
    baseName: selectedBase.name,
    toppingName: selectedTopping.name,
    quantity,
    unitPrice: selectedBase.price + selectedTopping.price,
    totalPrice: total
  });

  updateCartBadge();
  showMessage("🧺 เพิ่มลงตะกร้าแล้ว!");
  
  // Reset form state:
  quantity = 1;
  document.getElementById("quantity").textContent = "1";
  updateTotal();
}
    // ===============================================================
    // 6. CART & COUPON MANAGEMENT
    // ===============================================================
    function showCart() {
      const modal = document.getElementById("cart-modal");
      const content = document.getElementById("cart-content");

      if (cart.length === 0) {
        content.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">🛒</div>
            <p class="text-gray-600 text-lg">ตะกร้าว่างเปล่า</p>
          </div>
        `;
      } else {
        let html = '<div class="space-y-3">';
        cart.forEach((item, index) => {
          html += `
            <div class="card border border-gray-200 p-4">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="font-semibold">${item.baseName}</div>
                  <div class="text-sm text-gray-600">หน้า: ${item.toppingName}</div>
                  <div class="text-sm text-gray-500 mt-1">จำนวน: ${item.quantity} ชิ้น</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-blue-600">${item.totalPrice} บาท</div>
                  <div class="flex items-center gap-2 mt-2">
                    <button onclick="updateCartQuantity(${index}, -1)" class="quantity-btn bg-red-500 hover:bg-red-600 text-white text-sm w-6 h-6">−</button>
                    <span class="text-sm font-medium">${item.quantity}</span>
                    <button onclick="updateCartQuantity(${index}, 1)" class="quantity-btn bg-green-500 hover:bg-green-600 text-white text-sm w-6 h-6">+</button>
                  </div>
                  <button onclick="removeFromCart(${index})" class="text-red-500 text-sm mt-2 hover:underline">ลบ</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;
      }

      updateCartTotal();
      modal.classList.remove("hidden");
    }

    function updateCartQuantity(index, change) {
      if (cart[index]) {
        cart[index].quantity = Math.max(1, cart[index].quantity + change);
        cart[index].totalPrice = cart[index].unitPrice * cart[index].quantity;
        updateCartBadge();
        showCart();
      }
    }

    function updateCartTotal() {
      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      let discount = 0;
      if (selectedCoupon) {
        if (selectedCoupon.type === 'percent') {
          discount = Math.floor(subtotal * selectedCoupon.value / 100);
        } else {
          discount = Math.min(selectedCoupon.value, subtotal);
        }
      }
      const total = Math.max(0, subtotal - discount);

      document.getElementById("cart-subtotal").textContent = subtotal.toLocaleString() + " บาท";
      document.getElementById("cart-total").textContent = total.toLocaleString() + " บาท";

      if (discount > 0) {
        document.getElementById("discount-row").classList.remove("hidden");
        document.getElementById("discount-amount").textContent = "-" + discount.toLocaleString() + " บาท";
      } else {
        document.getElementById("discount-row").classList.add("hidden");
      }
    }

    function closeCart() {
      document.getElementById("cart-modal").classList.add("hidden");
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartBadge();
      showCart();
      showMessage("ลบสินค้าออกจากตะกร้าแล้ว");
    }
    
    function updateCartBadge() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const badge = document.getElementById("cart-badge");
        if (totalItems > 0) {
            badge.textContent = totalItems;
            badge.classList.remove("hidden");
        } else {
            badge.classList.add("hidden");
        }
    }

    // ===============================================================
    // 7. COUPON SYSTEM
    // ===============================================================
    async function loadCoupons() {
      try {
        const { data, error } = await supabase
          .from("coupons")
          .select("*")
          .eq("is_active", true)
          .eq("show_in_list", true) // ✅ แสดงเฉพาะคูปองที่เลือกให้โชว์
          .order("created_at", { ascending: false });
        if (error) throw error;
        availableCoupons = data || [];
        console.log("✅ Coupons loaded:", availableCoupons.length);
      } catch (error) {
        console.error("❌ Error loading coupons:", error);
      }
    }
    
    function showCoupons() {
      const modal = document.getElementById("coupons-modal");
      const content = document.getElementById("coupons-content");
      if (availableCoupons.length === 0) {
        content.innerHTML = `
          <div class="col-span-2 text-center py-12">
            <div class="text-6xl mb-4">🎫</div>
            <p class="text-gray-600 text-lg">ยังไม่มีคูปองที่ใช้ได้</p>
          </div>
        `;
      } else {
        let html = '';
        availableCoupons.forEach(coupon => {
          const canUse = coupon.usage_limit > coupon.usage_count;
          html += `
            <div class="card border-2 ${canUse ? 'border-purple-200 hover:border-purple-400 cursor-pointer' : 'border-gray-200 opacity-50'} p-4" 
                 ${canUse ? `onclick="selectCouponFromList('${coupon.code}')"` : ''}>
              <div class="flex items-start justify-between mb-3">
                <div class="text-3xl">🎫</div>
                <div class="text-xs ${canUse ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} px-2 py-1 rounded-full">
                  ${canUse ? 'ใช้ได้' : 'หมดแล้ว'}
                </div>
              </div>
              <div class="font-bold text-lg text-purple-900 mb-1">${coupon.name}</div>
              <div class="text-sm text-gray-600 mb-2">${coupon.description}</div>
              <div class="text-xs text-gray-500">รหัส: ${coupon.code}</div>
              <div class="text-xs text-gray-500">ยอดขั้นต่ำ: ${coupon.min_purchase} บาท</div>
              <div class="text-xs text-gray-500">เหลือ: ${coupon.usage_limit - coupon.usage_count} ครั้ง</div>
            </div>
          `;
        });
        content.innerHTML = html;
      }
      modal.classList.remove("hidden");
    }

    function closeCoupons() {
      document.getElementById("coupons-modal").classList.add("hidden");
    }

    function selectCouponFromList(code) {
      document.getElementById("coupon-input").value = code;
      closeCoupons();
      applyCouponCode();
    }

    async function applyCouponCode() {
      const code = document.getElementById("coupon-input").value.trim().toUpperCase();
      if (!code) {
        showCouponMessage("กรุณากรอกโค้ดคูปอง", "error");
        return;
      }
      const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);

      try {
        const { data: coupon, error } = await supabase
          .from("coupons")
          .select("*")
          .eq("code", code)
          .eq("is_active", true)
          .single();

        if (error || !coupon) {
          showCouponMessage("ไม่พบคูปองนี้หรือหมดอายุแล้ว", "error");
          return;
        }

        if (coupon.usage_count >= coupon.usage_limit) {
          showCouponMessage("คูปองนี้ถูกใช้หมดแล้ว", "error");
          return;
        }

        if (subtotal < coupon.min_purchase) {
          showCouponMessage(`ยอดขั้นต่ำ ${coupon.min_purchase} บาท`, "error");
          return;
        }

        selectedCoupon = coupon;
        document.getElementById("selected-coupon").classList.remove("hidden");
        document.getElementById("coupon-name").textContent = coupon.name;
        document.getElementById("coupon-desc").textContent = coupon.description;
        document.getElementById("coupon-input").value = "";
        updateCartTotal();
        showCouponMessage("ใช้คูปองสำเร็จ! 🎉", "success");
      } catch (error) {
        console.error("❌ Error applying coupon:", error);
        showCouponMessage("เกิดข้อผิดพลาด", "error");
      }
    }

    function removeCoupon() {
      selectedCoupon = null;
      document.getElementById("selected-coupon").classList.add("hidden");
      updateCartTotal();
      showMessage("ลบคูปองแล้ว");
    }

    function showCouponMessage(message, type) {
      const messageEl = document.getElementById("coupon-message");
      messageEl.textContent = message;
      messageEl.className = `text-sm mt-2 ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
      messageEl.classList.remove("hidden");
      
      // ซ่อนข้อความอัตโนมัติ
      setTimeout(() => {
        messageEl.classList.add("hidden");
      }, 3000);
    }
    
    // ===============================================================
    // 8. UTILITIES
    // ===============================================================
    function showMessage(text) {
      const messageEl = document.getElementById("success-message");
      document.getElementById("success-text").textContent = text;
      messageEl.classList.remove("hidden");
      setTimeout(() => {
        messageEl.classList.add("hidden");
      }, 3000);
    }

    function closeModalOnBackdrop(event, modalId) {
      if (event.target.id === modalId) {
        document.getElementById(modalId).classList.add("hidden");
      }
    }

    // ===============================================================
    // 9. ADMIN FUNCTIONS (Placeholder - functions need to be implemented)
    // ===============================================================
    function showAdmin() {
      document.getElementById("admin-modal").classList.remove("hidden");
      // Load initial admin data here
    }

    function closeAdmin() {
      document.getElementById("admin-modal").classList.add("hidden");
    }

    function showAdminTab(tabName) {
      document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.admin-tab').forEach(el => {
        el.classList.remove('border-blue-600', 'text-blue-600');
        el.classList.add('border-transparent', 'text-gray-600', 'hover:text-gray-900');
      });
      
      document.getElementById(`admin-${tabName}-tab`).classList.remove('hidden');
      document.querySelector(`.admin-tab[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-600', 'hover:text-gray-900');
      document.querySelector(`.admin-tab[data-tab="${tabName}"]`).classList.add('border-blue-600', 'text-blue-600');
      
      // Trigger load function for the selected tab
      if (tabName === 'orders') loadAdminOrders();
      if (tabName === 'coupons') loadAdminCoupons();
      if (tabName === 'stats') loadAdminStats();
      if (tabName === 'brownie') loadAdminBrownieItems();
      if (tabName === 'summary') {
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('summary-date').value = today;
          loadDailySummary();
      }
    }
    
    // Placeholder functions for Admin
    async function loadAdminOrders() {
        document.getElementById('admin-orders-content').innerHTML = '<p class="text-center text-gray-500">กำลังโหลดรายการออเดอร์...</p>';
        // Implement Supabase call to fetch orders
        const { data, error } = await supabase.from('orders').select('*, users(display_name)').order('created_at', { ascending: false });
        if (error) {
            document.getElementById('admin-orders-content').innerHTML = '<p class="text-red-500">❌ Error loading orders</p>';
            return;
        }
        
        let html = '<div class="space-y-4">';
        data.forEach(order => {
            const date = new Date(order.created_at).toLocaleString('th-TH');
            const statusClass = getStatusBadge(order.status);
            
            let itemHtml = order.items.map(item => `<div class="text-xs text-gray-600">${item.baseName} + ${item.toppingName} (x${item.quantity})</div>`).join('');

            html += `
                <div class="card border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-semibold text-lg">#${order.id} - ${order.users.display_name}</div>
                        <span class="${statusClass}">${order.status}</span>
                    </div>
                    <div class="text-sm text-gray-500 mb-3">เมื่อ: ${date}</div>
                    <div class="space-y-1 p-3 bg-gray-50 rounded mb-3">
                      ${itemHtml}
                    </div>
                    <div class="flex justify-between items-center border-t pt-2">
                        <div class="font-bold text-xl text-blue-600">${order.total_amount} บาท</div>
                        <select onchange="updateOrderStatus(${order.id}, this.value)" class="p-2 border rounded-lg text-sm">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                            <option value="Ready" ${order.status === 'Ready' ? 'selected' : ''}>Ready</option>
                            <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        document.getElementById('admin-orders-content').innerHTML = html;
    }
    
    function getStatusBadge(status) {
        switch (status) {
            case 'Pending': return 'badge badge-pending';
            case 'Preparing': return 'badge badge-preparing';
            case 'Ready': return 'badge badge-ready';
            case 'Completed': return 'badge badge-completed';
            case 'Cancelled': return 'badge badge-cancelled';
            default: return 'badge bg-gray-200 text-gray-800';
        }
    }
    
    async function updateOrderStatus(orderId, newStatus) {
        if (!confirm(`ยืนยันการเปลี่ยนสถานะออเดอร์ #${orderId} เป็น ${newStatus} หรือไม่?`)) return;

        const { error } = await supabase
            .from('orders')
            .update({ status: newStatus })
            .eq('id', orderId);

        if (error) {
            console.error('Error updating status:', error);
            showMessage('❌ อัปเดตสถานะไม่สำเร็จ');
        } else {
            showMessage('✅ อัปเดตสถานะสำเร็จ');
            loadAdminOrders(); // Reload orders to update UI
        }
    }
    
    async function loadAdminCoupons() {
        document.getElementById('admin-coupons-content').innerHTML = '<p class="text-center text-gray-500">กำลังโหลดรายการคูปอง...</p>';
        const { data, error } = await supabase.from('coupons').select('*').order('created_at', { ascending: false });
        if (error) {
            document.getElementById('admin-coupons-content').innerHTML = '<p class="text-red-500">❌ Error loading coupons</p>';
            return;
        }

        let html = '<div class="space-y-3">';
        data.forEach(coupon => {
            const usageText = `ใช้แล้ว ${coupon.usage_count} / ${coupon.usage_limit} ครั้ง`;
            const isActive = coupon.is_active ? '✅ เปิดใช้งาน' : '⛔ ปิดใช้งาน';
            const showInList = coupon.show_in_list ? '👁️ แสดงในรายการ' : '🚫 ซ่อนในรายการ';

            html += `
                <div class="card border border-gray-200 shadow-sm p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-xl text-purple-800">${coupon.code}</div>
                            <div class="text-lg">${coupon.name}</div>
                            <div class="text-sm text-gray-600">${coupon.description}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-blue-600">${coupon.type === 'percent' ? `${coupon.value}%` : `${coupon.value} บาท`}</div>
                            <div class="text-xs text-gray-500">ขั้นต่ำ ${coupon.min_purchase} บาท</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-3 border-t pt-3 text-sm">
                        <div class="space-x-2">
                            <span class="text-gray-700">${usageText}</span>
                            <span class="${coupon.is_active ? 'text-green-600' : 'text-red-600'}">${isActive}</span>
                            <span class="${coupon.show_in_list ? 'text-blue-600' : 'text-yellow-600'}">${showInList}</span>
                        </div>
                        <button onclick="deleteCoupon(${coupon.id})" class="text-red-500 hover:text-red-700">ลบ</button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        document.getElementById('admin-coupons-content').innerHTML = html;
    }

    function showCreateCouponForm() {
        document.getElementById('create-coupon-modal').classList.remove('hidden');
    }

    function closeCreateCoupon() {
        document.getElementById('create-coupon-modal').classList.add('hidden');
    }

    async function createCoupon(event) {
        event.preventDefault();
        const code = document.getElementById('coupon-code').value.trim().toUpperCase();
        const title = document.getElementById('coupon-title').value;
        const description = document.getElementById('coupon-description').value;
        const type = document.getElementById('coupon-type').value;
        const value = parseFloat(document.getElementById('coupon-value').value);
        const min = parseFloat(document.getElementById('coupon-min').value);
        const usage = parseInt(document.getElementById('coupon-usage').value);

        const { error } = await supabase.from('coupons').insert([{
            code,
            name: title,
            description,
            type,
            value,
            min_purchase: min,
            usage_limit: usage,
            usage_count: 0,
            is_active: true,
            show_in_list: true
        }]);

        if (error) {
            console.error('Error creating coupon:', error);
            showMessage('❌ สร้างคูปองไม่สำเร็จ');
        } else {
            showMessage('✅ สร้างคูปองสำเร็จ');
            closeCreateCoupon();
            loadAdminCoupons();
            loadCoupons(); // Reload client coupons
        }
    }

    async function deleteCoupon(couponId) {
        if (!confirm('ยืนยันการลบคูปองนี้หรือไม่? การกระทำนี้ไม่สามารถยกเลิกได้')) return;

        const { error } = await supabase.from('coupons').delete().eq('id', couponId);

        if (error) {
            console.error('Error deleting coupon:', error);
            showMessage('❌ ลบคูปองไม่สำเร็จ');
        } else {
            showMessage('✅ ลบคูปองสำเร็จ');
            loadAdminCoupons();
            loadCoupons(); // Reload client coupons
        }
    }

    async function loadAdminStats() {
        document.getElementById('admin-stats-content').innerHTML = '<p class="col-span-3 text-center text-gray-500">กำลังโหลดสถิติ...</p>';

        try {
            // Stat 1: Total Orders
            const { count: totalOrders, error: err1 } = await supabase.from('orders').select('*', { count: 'exact', head: true });
            if (err1) throw err1;

            // Stat 2: Total Revenue (Sum total_amount for Completed orders)
            const { data: revenueData, error: err2 } = await supabase.rpc('calculate_total_revenue'); 
            // Note: Assumes you have a Supabase RPC function named 'calculate_total_revenue' or a simple select sum
            
            // Fallback for revenue calculation if RPC not available
            let totalRevenue = 'N/A';
            if (revenueData && revenueData.length > 0) {
                 totalRevenue = revenueData[0].total_revenue.toLocaleString() || 0;
            } else {
                 const { data: simpleRevenue, error: err3 } = await supabase.from('orders').select('total_amount').eq('status', 'Completed');
                 if (!err3) {
                     totalRevenue = simpleRevenue.reduce((sum, order) => sum + order.total_amount, 0).toLocaleString();
                 }
            }


            // Stat 3: Total Users
            const { count: totalUsers, error: err4 } = await supabase.from('users').select('*', { count: 'exact', head: true });
            if (err4) throw err4;

            document.getElementById('admin-stats-content').innerHTML = `
                <div class="card bg-blue-100 border-blue-300">
                    <div class="text-sm font-medium text-blue-700">จำนวนออเดอร์ทั้งหมด</div>
                    <div class="text-3xl font-bold text-blue-900 mt-1">${totalOrders.toLocaleString()}</div>
                </div>
                <div class="card bg-green-100 border-green-300">
                    <div class="text-sm font-medium text-green-700">รายได้รวม (Completed)</div>
                    <div class="text-3xl font-bold text-green-900 mt-1">${totalRevenue} บาท</div>
                </div>
                <div class="card bg-purple-100 border-purple-300">
                    <div class="text-sm font-medium text-purple-700">จำนวนผู้ใช้ทั้งหมด</div>
                    <div class="text-3xl font-bold text-purple-900 mt-1">${totalUsers.toLocaleString()} คน</div>
                </div>
            `;
        } catch (error) {
            console.error("❌ Error loading stats:", error);
            document.getElementById('admin-stats-content').innerHTML = '<p class="col-span-3 text-red-500">❌ Error loading statistics</p>';
        }
    }

    async function loadAdminBrownieItems() {
        document.getElementById('admin-brownie-content').innerHTML = '<p class="text-center text-gray-500">กำลังโหลดเมนูบราวนี่...</p>';
        const { data, error } = await supabase.from('brownie_items').select('*').order('type').order('id');
        if (error) {
            document.getElementById('admin-brownie-content').innerHTML = '<p class="text-red-500">❌ Error loading brownie items</p>';
            return;
        }
        
        const bases = data.filter(i => i.type === 'base');
        const toppings = data.filter(i => i.type === 'topping');
        
        let html = `
            <div class="mb-4 flex gap-2">
                <button onclick="openBrownieModal('base')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    ➕ เพิ่มเนื้อบราวนี่
                </button>
                <button onclick="openBrownieModal('topping')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                    ➕ เพิ่มหน้าบราวนี่
                </button>
            </div>
            
            <h4 class="text-xl font-semibold mt-6 mb-3 text-blue-700">🫐 เนื้อบราวนี่ (Base)</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="admin-base-list">
                ${renderBrownieItems(bases)}
            </div>

            <h4 class="text-xl font-semibold mt-6 mb-3 text-indigo-700">🍫 หน้าบราวนี่ (Topping)</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="admin-topping-list">
                ${renderBrownieItems(toppings)}
            </div>
        `;
        document.getElementById('admin-brownie-content').innerHTML = html;
    }
    
    function renderBrownieItems(items) {
        if (items.length === 0) return '<p class="text-gray-500">ไม่มีรายการ</p>';
        return items.map(item => `
            <div class="card border ${item.is_active ? 'border-green-300' : 'border-red-300 opacity-70'} shadow-sm p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-2xl font-bold">${item.emoji || ''} ${item.name}</div>
                        <div class="text-sm text-gray-600">${item.description || ''}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg text-green-600">${item.price} บาท</div>
                        <div class="text-xs text-orange-600">${item.points} แต้ม</div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-3 border-t pt-3">
                    <button onclick="openBrownieModal('${item.type}', ${item.id})" class="text-sm text-blue-600 hover:text-blue-800">
                        แก้ไข
                    </button>
                    <button onclick="toggleBrownieActive(${item.id}, ${item.is_active})" class="text-sm ${item.is_active ? 'text-red-600' : 'text-green-600'} hover:opacity-70">
                        ${item.is_active ? 'ปิดขาย' : 'เปิดขาย'}
                    </button>
                </div>
            </div>
        `).join('');
    }

    function openBrownieModal(type, id = null) {
        const modal = document.getElementById('brownie-modal');
        const titleEl = document.getElementById('brownie-modal-title');
        const form = document.getElementById('brownie-form');
        
        form.reset();
        document.getElementById('brownie-id').value = id || '';
        document.getElementById('brownie-type').value = type;

        if (id) {
            titleEl.textContent = `📝 แก้ไขเมนู ${type === 'base' ? 'เนื้อบราวนี่' : 'หน้าบราวนี่'}`;
            // Load data for editing
            const item = (document.getElementById('admin-base-list').innerHTML + document.getElementById('admin-topping-list').innerHTML).match(new RegExp(`data-item-id="${id}"`)); // Simple placeholder logic
            
            // A proper implementation would fetch the data from Supabase again or store it in a local variable
            // For now, let's assume a function fetchItemById exists
            fetchBrownieItemById(id).then(item => {
                document.getElementById('brownie-name').value = item.name;
                document.getElementById('brownie-desc').value = item.description;
                document.getElementById('brownie-price').value = item.price;
                document.getElementById('brownie-points').value = item.points;
                document.getElementById('brownie-active').checked = item.is_active;
            });

        } else {
            titleEl.textContent = `🍰 เพิ่มเมนู ${type === 'base' ? 'เนื้อบราวนี่' : 'หน้าบราวนี่'}`;
            document.getElementById('brownie-active').checked = true;
        }

        form.onsubmit = (e) => saveBrownieItem(e, id);
        modal.classList.remove('hidden');
    }
    
    async function fetchBrownieItemById(id) {
        const { data, error } = await supabase.from('brownie_items').select('*').eq('id', id).single();
        if (error) {
            console.error('Error fetching item:', error);
            return {};
        }
        return data;
    }

    function closeBrownieModal() {
        document.getElementById('brownie-modal').classList.add('hidden');
    }

    async function saveBrownieItem(event, id) {
        event.preventDefault();
        const type = document.getElementById('brownie-type').value;
        const name = document.getElementById('brownie-name').value;
        const description = document.getElementById('brownie-desc').value;
        const price = parseFloat(document.getElementById('brownie-price').value);
        const points = parseInt(document.getElementById('brownie-points').value);
        const isActive = document.getElementById('brownie-active').checked;
        
        const itemData = {
            type,
            name,
            description,
            price,
            points,
            is_active: isActive
        };

        let result;
        if (id) {
            result = await supabase.from('brownie_items').update(itemData).eq('id', id);
        } else {
            // Assume emoji is the first char of the name if not explicitly provided
            itemData.emoji = name.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\s/)?.[0] || '❓'; 
            result = await supabase.from('brownie_items').insert([itemData]);
        }

        if (result.error) {
            console.error('Error saving item:', result.error);
            showMessage('❌ บันทึกเมนูไม่สำเร็จ');
        } else {
            showMessage('✅ บันทึกเมนูสำเร็จ');
            closeBrownieModal();
            loadAdminBrownieItems();
            loadMenus(); // Reload client menu
        }
    }

    async function toggleBrownieActive(id, currentStatus) {
        if (!confirm(`ยืนยันการ${currentStatus ? 'ปิดขาย' : 'เปิดขาย'}เมนูนี้หรือไม่?`)) return;
        
        const { error } = await supabase.from('brownie_items')
            .update({ is_active: !currentStatus })
            .eq('id', id);

        if (error) {
            console.error('Error toggling status:', error);
            showMessage('❌ อัปเดตสถานะไม่สำเร็จ');
        } else {
            showMessage('✅ อัปเดตสถานะสำเร็จ');
            loadAdminBrownieItems();
            loadMenus(); // Reload client menu
        }
    }
    
    async function loadDailySummary() {
        const date = document.getElementById('summary-date').value;
        const contentEl = document.getElementById('summary-content');
        if (!date) {
            contentEl.innerHTML = '<p class="text-red-500 text-center">กรุณาเลือกวันที่</p>';
            return;
        }

        contentEl.innerHTML = '<p class="text-center text-gray-500">กำลังโหลดสรุปออเดอร์...</p>';

        const startOfDay = `${date}T00:00:00.000Z`;
        const endOfDay = `${date}T23:59:59.999Z`;

        const { data: orders, error } = await supabase
            .from('orders')
            .select('id, created_at, total_amount, status, items')
            .gte('created_at', startOfDay)
            .lte('created_at', endOfDay)
            .order('created_at', { ascending: true });

        if (error) {
            contentEl.innerHTML = '<p class="text-red-500 text-center">❌ Error loading summary</p>';
            console.error(error);
            return;
        }

        if (orders.length === 0) {
            contentEl.innerHTML = '<p class="text-gray-500 text-center">ไม่พบออเดอร์ในวันที่เลือก</p>';
            return;
        }

        let totalRevenue = 0;
        let completedCount = 0;
        const itemSummary = {};

        orders.forEach(order => {
            if (order.status === 'Completed') {
                totalRevenue += order.total_amount;
                completedCount++;
            }
            order.items.forEach(item => {
                const key = `${item.baseName} + ${item.toppingName}`;
                itemSummary[key] = (itemSummary[key] || 0) + item.quantity;
            });
        });

        let summaryHtml = `
            <h5 class="text-2xl font-bold mb-4 text-purple-700">สรุปออเดอร์ประจำวันที่ ${new Date(date).toLocaleDateString('th-TH', { dateStyle: 'long' })}</h5>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="card bg-indigo-50 border-indigo-200 p-4">
                    <div class="text-sm text-indigo-700">ออเดอร์ทั้งหมด</div>
                    <div class="text-3xl font-bold text-indigo-900">${orders.length}</div>
                </div>
                <div class="card bg-green-50 border-green-200 p-4">
                    <div class="text-sm text-green-700">ออเดอร์เสร็จสิ้น</div>
                    <div class="text-3xl font-bold text-green-900">${completedCount}</div>
                </div>
                <div class="card bg-yellow-50 border-yellow-200 p-4">
                    <div class="text-sm text-yellow-700">รายได้รวม (Completed)</div>
                    <div class="text-3xl font-bold text-yellow-900">${totalRevenue.toLocaleString()} ฿</div>
                </div>
            </div>

            <h6 class="text-xl font-semibold mb-3">รายการเมนูที่สั่งทั้งหมด</h6>
            <ul class="space-y-2 mb-6">
                ${Object.entries(itemSummary).map(([name, quantity]) => `
                    <li class="flex justify-between items-center p-2 bg-white rounded shadow-sm">
                        <span class="text-gray-700">${name}</span>
                        <span class="font-bold text-lg text-red-600">${quantity} ชิ้น</span>
                    </li>
                `).join('')}
            </ul>
        `;
        
        let orderListHtml = `<h6 class="text-xl font-semibold mb-3 border-t pt-4">รายละเอียดออเดอร์</h6><div class="space-y-3">`;
        orders.forEach(order => {
            const dateStr = new Date(order.created_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            const statusClass = getStatusBadge(order.status);
            const itemsList = order.items.map(item => `
                <div class="text-xs">${item.baseName} + ${item.toppingName} (x${item.quantity})</div>
            `).join('');

            orderListHtml += `
                <div class="card border border-gray-200 p-3">
                    <div class="flex justify-between items-center">
                        <div class="font-semibold">#${order.id} (${dateStr})</div>
                        <span class="${statusClass}">${order.status}</span>
                    </div>
                    <div class="text-sm text-blue-600 font-bold">รวม: ${order.total_amount} ฿</div>
                    <div class="mt-2 space-y-1">${itemsList}</div>
                </div>
            `;
        });
        orderListHtml += '</div>';

        contentEl.innerHTML = summaryHtml + orderListHtml;
    }

    async function updateAllOrdersOfDay() {
        const date = document.getElementById('summary-date').value;
        if (!date) {
            showMessage('⚠️ กรุณาเลือกวันที่ก่อน');
            return;
        }
        if (!confirm(`ยืนยันการเปลี่ยนสถานะออเดอร์ทั้งหมดของวันที่ ${date} เป็น 'Completed' หรือไม่?`)) return;

        const startOfDay = `${date}T00:00:00.000Z`;
        const endOfDay = `${date}T23:59:59.999Z`;

        const { error } = await supabase
            .from('orders')
            .update({ status: 'Completed' })
            .gte('created_at', startOfDay)
            .lte('created_at', endOfDay);

        if (error) {
            console.error('Error updating all statuses:', error);
            showMessage('❌ อัปเดตสถานะทั้งหมดไม่สำเร็จ');
        } else {
            showMessage(`✅ อัปเดตสถานะออเดอร์วันที่ ${date} เป็น Completed ทั้งหมดแล้ว`);
            loadDailySummary(); // Reload summary
        }
    }
    
    // ===============================================================
    // 10. ORDER HISTORY (Placeholder)
    // ===============================================================
    function openOrderHistory() {
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('order-history').classList.remove('hidden');
        loadOrderHistory();
    }
    
    function backToMain() {
        document.getElementById('order-history').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    async function loadOrderHistory() {
        const userId = userProfile.userId;
        const orderListEl = document.getElementById('order-list');
        orderListEl.innerHTML = '<p class="text-center text-gray-500">กำลังโหลดประวัติคำสั่งซื้อ...</p>';
        
        const { data: orders, error } = await supabase
            .from('orders')
            .select('*')
            .eq('user_line_id', userId)
            .order('created_at', { ascending: false });

        if (error) {
            orderListEl.innerHTML = '<p class="text-red-500 text-center">❌ Error loading order history</p>';
            return;
        }

        if (orders.length === 0) {
            orderListEl.innerHTML = '<p class="text-gray-500 text-center">คุณยังไม่มีประวัติคำสั่งซื้อ</p>';
            return;
        }

        let html = '';
        orders.forEach(order => {
            const date = new Date(order.created_at).toLocaleString('th-TH');
            const statusClass = getStatusBadge(order.status);
            
            let itemHtml = order.items.map(item => `
                <li class="text-sm text-gray-600">${item.baseName} + ${item.toppingName} (x${item.quantity})</li>
            `).join('');

            html += `
                <div class="card border border-gray-200 shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-bold text-lg text-purple-700">ออเดอร์ #${order.id}</div>
                        <span class="${statusClass}">${order.status}</span>
                    </div>
                    <div class="text-sm text-gray-500 mb-3">สั่งเมื่อ: ${date}</div>
                    
                    <ul class="space-y-1 p-3 bg-gray-50 rounded mb-3 border-l-4 border-gray-200">
                      ${itemHtml}
                    </ul>
                    <div class="flex justify-between items-center border-t pt-2">
                        <div class="text-lg font-bold text-blue-600">รวม: ${order.total_amount.toLocaleString()} บาท</div>
                    </div>
                </div>
            `;
        });

        orderListEl.innerHTML = html;
    }
    
    // ===============================================================
    // 11. CHECKOUT (Placeholder)
    // ===============================================================
    async function checkout() {
        if (cart.length === 0) {
            showMessage("⚠️ ตะกร้าว่างเปล่า");
            return;
        }

        const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
        let discount = 0;
        let couponCode = null;

        if (selectedCoupon) {
            if (selectedCoupon.type === 'percent') {
                discount = Math.floor(subtotal * selectedCoupon.value / 100);
            } else {
                discount = Math.min(selectedCoupon.value, subtotal);
            }
            couponCode = selectedCoupon.code;
        }

        const totalAmount = Math.max(0, subtotal - discount);
        const totalPointsEarned = cart.reduce((sum, item) => sum + (item.quantity * 5), 0); // Assume 5 points per item for now, better to link to brownie_items table

        if (!confirm(`ยืนยันการสั่งซื้อ: ${totalAmount.toLocaleString()} บาท?`)) return;

        try {
            // 1. Create Order
            const { data: orderData, error: orderError } = await supabase
                .from('orders')
                .insert([{
                    user_line_id: userProfile.userId,
                    items: cart,
                    subtotal: subtotal,
                    discount: discount,
                    total_amount: totalAmount,
                    coupon_code: couponCode,
                    status: 'Pending'
                }])
                .select()
                .single();

            if (orderError) throw orderError;
            
            // 2. Update User Points
            const { error: pointError } = await supabase
                .from('users')
                .update({ points: currentUser.points + totalPointsEarned })
                .eq('line_id', userProfile.userId);

            if (pointError) throw pointError;

            // 3. Update Coupon Usage
            if (selectedCoupon) {
                const { error: couponError } = await supabase
                    .from('coupons')
                    .update({ usage_count: selectedCoupon.usage_count + 1 })
                    .eq('id', selectedCoupon.id);

                if (couponError) throw couponError;
            }

            // 4. Send LIFF message (Not implemented here, but good practice)
            
            // 5. Clear state
            cart = [];
            selectedCoupon = null;
            updateCartBadge();
            closeCart();
            await loadUserData(userProfile.userId); // Reload points
            await loadCoupons(); // Reload coupons
            
            showMessage(`✅ สั่งซื้อสำเร็จ! #${orderData.id}`);

        } catch (error) {
            console.error('❌ Checkout error:', error);
            showMessage('❌ สั่งซื้อไม่สำเร็จ กรุณาลองใหม่');
        }
    }


    window.addEventListener("load", init);

</script>
</body>
</html>
